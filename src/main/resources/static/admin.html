<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 - 医院门诊系统</title>
    <!-- 医院图标 -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc3545'%3E%3Cpath d='M19 8h-2v3h-3v2h3v3h2v-3h3v-2h-3zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z'/%3E%3C/svg%3E">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        body {
            background: linear-gradient(135deg, #F6F8FA 0%, #E8F4FD 100%);
            font-family: 'Microsoft YaHei', system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Hiragino Sans GB, sans-serif;
            position: relative;
            min-height: 100vh;
        }
        
        /* 添加装饰性背景元素 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .sidebar {
            background: var(--primary-gradient);
            min-height: 100vh;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }
        
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            pointer-events: none;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8) !important;
            border-radius: 12px;
            margin: 4px 0;
            padding: 12px 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .nav-link:hover::before {
            left: 100%;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            color: white !important;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .card:hover::before {
            opacity: 1;
            transform: rotate(45deg) translate(50%, 50%);
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .content-area {
            padding: 30px;
        }
        
        /* 统计卡片样式 */
        .stats-card {
            background: var(--primary-gradient);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stats-card .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* 图标圆形样式 */
        .icon-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 15px;
            transition: transform .3s ease;
            font-size: 1.5rem;
        }
        
        .icon-circle:hover {
            transform: scale(1.1) rotate(5deg);
        }
        
        /* 按钮水波纹效果 */
        .btn {
            position: relative;
            overflow: hidden;
        }
        
        .btn .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            opacity: 0.6;
            background: rgba(255,255,255,0.5);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* Toast 通知样式 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .custom-toast {
            min-width: 300px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        /* 侧边栏收缩样式 */
        .sidebar.collapsed {
            width: 80px;
            transition: width 0.3s ease;
        }
        
        .sidebar.collapsed .nav-link span {
            display: none;
        }
        
        .sidebar.collapsed .nav-link {
            justify-content: center;
            padding: 12px;
        }
        
        /* 粒子画布 */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        /* 药品管理样式 - 与其他板块保持一致 */
        .medicine-management-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 15px;
            padding: 1.5rem;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .icon-circle-medicine {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .btn-medicine-primary {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-medicine-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
            color: white;
            transform: translateY(-1px);
        }

        .btn-medicine-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-medicine-success:hover {
            background-color: #1e7e34;
            border-color: #1e7e34;
            color: white;
            transform: translateY(-1px);
        }

        .btn-medicine-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-medicine-info:hover {
            background-color: #117a8b;
            border-color: #117a8b;
            color: white;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- 粒子背景画布 -->
    <canvas id="particleCanvas"></canvas>
    
    <!-- Toast 通知容器 -->
    <div class="toast-container"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0"><i class="bi bi-hospital"></i> <span>管理后台</span></h4>
                        <button id="sidebarToggleBtn" class="btn btn-link text-white p-0" onclick="toggleSidebar()">
                            <i class="bi bi-list fs-4"></i>
                        </button>
                    </div>
                    <div id="userInfo" class="text-center mb-4">
                        <div class="icon-circle mx-auto mb-2">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <small>欢迎，<span id="userName"></span></small>
                    </div>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <i class="bi bi-speedometer2 me-2"></i><span>仪表板</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('patients')">
                            <i class="bi bi-people me-2"></i><span>病人管理</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('doctors')">
                            <i class="bi bi-person-badge me-2"></i><span>医生管理</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('registrations')">
                            <i class="bi bi-clipboard-check me-2"></i><span>挂号管理</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('payments')">
                            <i class="bi bi-credit-card me-2"></i><span>收费管理</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('medicines')">
                            <i class="bi bi-capsule me-2"></i><span>药品管理</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('feedbacks')">
                            <i class="bi bi-chat-dots me-2"></i><span>意见建议</span>
                        </a>
                        <hr class="my-3">
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i><span>退出登录</span>
                        </a>
                    </nav>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-9 col-lg-10 content-area">
                <!-- 仪表板 -->
                <div id="dashboard" class="section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-speedometer2 me-2"></i>仪表板</h2>
                        <span class="text-muted" id="currentTime"></span>
                    </div>

                    <!-- 核心统计数据 - 现代化设计 -->
                    <div class="row g-4 mb-5">
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="icon-circle">
                                    <i class="bi bi-people"></i>
                                </div>
                                <div class="stat-number" id="patientCount">-</div>
                                <div class="stat-label">病人总数</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card" style="background: var(--success-gradient);">
                                <div class="icon-circle">
                                    <i class="bi bi-person-badge"></i>
                                </div>
                                <div class="stat-number" id="doctorCount">-</div>
                                <div class="stat-label">医生总数</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card" style="background: var(--warning-gradient);">
                                <div class="icon-circle">
                                    <i class="bi bi-clipboard-check"></i>
                                </div>
                                <div class="stat-number" id="totalRegistrations">-</div>
                                <div class="stat-label">挂号总数</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card" style="background: var(--secondary-gradient);">
                                <div class="icon-circle">
                                    <i class="bi bi-currency-dollar"></i>
                                </div>
                                <div class="stat-number" id="totalRevenue">-</div>
                                <div class="stat-label">总收入</div>
                            </div>
                        </div>
                    </div>

                    <!-- 可视化图表区域 -->
                    <div class="row g-4 mb-5">
                        <div class="col-lg-8">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>业务趋势</h5>
                                </div>
                                <div class="card-body d-flex align-items-center">
                                    <canvas id="chartLine" style="min-height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>数据分布</h5>
                                </div>
                                <div class="card-body d-flex align-items-center justify-content-center">
                                    <canvas id="chartDonut" style="max-height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

        <!-- 简化统计图表 - 可选显示 -->
        <div class="row g-4 mt-5">
            <div class="col-md-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0">
                        <h5 class="mb-0 text-center">系统运营概览</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <h6 class="text-muted">热门科室</h6>
                                    <div id="topDepartment" class="fw-bold text-primary">-</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <h6 class="text-muted">待处理挂号</h6>
                                    <div id="pendingRegistrations" class="fw-bold text-warning">-</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <h6 class="text-muted">待支付订单</h6>
                                    <div id="pendingPayments" class="fw-bold text-danger">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                </div>

                <!-- 病人管理 -->
                <div id="patients" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>病人管理</h2>
                        <button class="btn btn-primary" onclick="showAddPatientModal()">
                            ➕ 添加病人
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>姓名</th>
                                            <th>性别</th>
                                            <th>年龄</th>
                                            <th>电话</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patientsTable">
                                        <tr>
                                            <td colspan="5" class="text-center">正在加载...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 医生管理 -->
                <div id="doctors" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>医生管理</h2>
                        <button class="btn btn-primary" onclick="showAddDoctorModal()">
                            ➕ 添加医生
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>姓名</th>
                                            <th>性别</th>
                                            <th>科室</th>
                                            <th>职称</th>
                                            <th>电话</th>
                                            <th>挂号费</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="doctorsTable">
                                        <tr>
                                            <td colspan="8" class="text-center">正在加载...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 挂号管理 -->
                <div id="registrations" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>挂号管理</h2>
                        <button class="btn btn-primary" onclick="showAddRegistrationModal()">
                            ➕ 新建挂号
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>病人姓名</th>
                                            <th>医生姓名</th>
                                            <th>科室</th>
                                            <th>预约时间</th>
                                            <th>挂号费</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="registrationsTable">
                                        <tr>
                                            <td colspan="7" class="text-center">正在加载...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="payments" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>收费管理</h2>
                        <button class="btn btn-primary" onclick="showAddPaymentModal()">
                            ➕ 新建收费
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>病人姓名</th>
                                            <th>收费类型</th>
                                            <th>金额</th>
                                            <th>数量</th>
                                            <th>支付方式</th>
                                            <th>支付状态</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentsTable">
                                        <tr>
                                            <td colspan="8" class="text-center">正在加载...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 药品管理 -->
                <div id="medicines" class="section d-none">
                    <div class="medicine-management-header mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle-medicine me-3">
                                    <i class="bi bi-capsule fs-3"></i>
                                </div>
                                <div>
                                    <h2 class="mb-0">药品管理</h2>
                                </div>
                            </div>
                            <div class="medicine-action-buttons">
                                <button class="btn btn-medicine-success me-2" onclick="showAddMedicineModal()">
                                    <i class="bi bi-plus-circle me-2"></i>添加药品
                                </button>
                                <button class="btn btn-medicine-info me-2" onclick="initializeMedicineData()">
                                    <i class="bi bi-hospital me-2"></i>初始化常用药品
                                </button>
                                <button class="btn btn-medicine-primary" onclick="loadMedicines()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>刷新数据
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 药品分类和搜索 -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">药品分类</label>
                                    <select class="form-select" id="medicineCategoryFilter" onchange="filterMedicinesByCategory()">
                                        <option value="">全部分类</option>
                                        <option value="感冒药">感冒药</option>
                                        <option value="消炎药">消炎药</option>
                                        <option value="止痛药">止痛药</option>
                                        <option value="维生素">维生素</option>
                                        <option value="抗生素">抗生素</option>
                                        <option value="心血管药">心血管药</option>
                                        <option value="消化系统药">消化系统药</option>
                                        <option value="呼吸系统药">呼吸系统药</option>
                                        <option value="神经系统药">神经系统药</option>
                                        <option value="外用药">外用药</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">库存状态</label>
                                    <select class="form-select" id="medicineStockFilter" onchange="filterMedicinesByStock()">
                                        <option value="">全部状态</option>
                                        <option value="sufficient">库存充足</option>
                                        <option value="low">库存不足</option>
                                        <option value="out">缺货</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">搜索药品</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="medicineSearchInput" 
                                               placeholder="输入药品名称或编码" onkeypress="handleMedicineSearchKeyPress(event)">
                                        <button class="btn btn-outline-primary" onclick="searchMedicinesAdmin()">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 药品统计卡片 -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">总药品数</h6>
                                            <h3 id="totalMedicinesCount">-</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-capsule-pill fs-1"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">库存充足</h6>
                                            <h3 id="sufficientStockCount">-</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-check-circle fs-1"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">库存不足</h6>
                                            <h3 id="lowStockCount">-</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-exclamation-triangle fs-1"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">缺货</h6>
                                            <h3 id="outOfStockCount">-</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-x-circle fs-1"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 药品列表 -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>药品名称</th>
                                            <th>编码</th>
                                            <th>分类</th>
                                            <th>规格</th>
                                            <th>价格</th>
                                            <th>库存</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="medicinesTable">
                                        <tr>
                                            <td colspan="8" class="text-center">正在加载...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 意见建议管理 -->
                <div id="feedbacks" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>意见建议管理</h2>
                        <button class="btn btn-primary" onclick="loadFeedbacks()">
                            🔄 刷新数据
                        </button>
                    </div>

                    <!-- 统计概览 -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-white bg-primary">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-chat-dots"></i> 总反馈数</h5>
                                    <p class="card-text fs-3" id="totalFeedbacks">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-warning">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-hourglass-split"></i> 待处理</h5>
                                    <p class="card-text fs-3" id="pendingFeedbacks">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-success">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-check-circle"></i> 已处理</h5>
                                    <p class="card-text fs-3" id="resolvedFeedbacks">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-info">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-lightbulb"></i> 建议数</h5>
                                    <p class="card-text fs-3" id="suggestionFeedbacks">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 筛选和搜索 -->
                    <div class="card mb-4">
                        <div class="card-header">筛选与搜索</div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="filterStatus" class="form-label">状态</label>
                                    <select class="form-select" id="filterStatus" onchange="filterFeedbacks()">
                                        <option value="">所有</option>
                                        <option value="PENDING">待处理</option>
                                        <option value="PROCESSED">已处理</option>
                                        <option value="CLOSED">已关闭</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="filterType" class="form-label">类型</label>
                                    <select class="form-select" id="filterType" onchange="filterFeedbacks()">
                                        <option value="">所有</option>
                                        <option value="投诉">投诉</option>
                                        <option value="建议">建议</option>
                                        <option value="表扬">表扬</option>
                                        <option value="咨询">咨询</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="searchKeyword" class="form-label">关键词</label>
                                    <input type="text" class="form-control" id="searchKeyword" placeholder="搜索姓名、内容" onkeyup="debounceSearchFeedbacks()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 反馈列表 -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>联系人</th>
                                            <th>电话/邮箱</th>
                                            <th>类型</th>
                                            <th>内容摘要</th>
                                            <th>提交时间</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="feedbacksTable">
                                        <tr>
                                            <td colspan="8" class="text-center">正在加载...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="noFeedbacksMessage" class="text-center text-muted py-4" style="display: none;">
                                <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
                                <p class="mt-2">暂无符合条件的反馈信息</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑药品模态框 -->
    <div class="modal fade" id="medicineModal" tabindex="-1" aria-labelledby="medicineModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="medicineModalLabel">添加药品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="medicineForm">
                        <input type="hidden" id="medicineId">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">药品名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="medicineName" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">药品编码 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="medicineCode" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">药品分类 <span class="text-danger">*</span></label>
                                <select class="form-select" id="medicineCategory" required>
                                    <option value="">请选择分类</option>
                                    <option value="感冒药">感冒药</option>
                                    <option value="消炎药">消炎药</option>
                                    <option value="止痛药">止痛药</option>
                                    <option value="维生素">维生素</option>
                                    <option value="抗生素">抗生素</option>
                                    <option value="心血管药">心血管药</option>
                                    <option value="消化系统药">消化系统药</option>
                                    <option value="呼吸系统药">呼吸系统药</option>
                                    <option value="神经系统药">神经系统药</option>
                                    <option value="外用药">外用药</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">规格 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="medicineSpecification" 
                                       placeholder="如：500mg" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">剂型</label>
                                <select class="form-select" id="medicineDosageForm">
                                    <option value="">请选择剂型</option>
                                    <option value="片剂">片剂</option>
                                    <option value="胶囊">胶囊</option>
                                    <option value="颗粒剂">颗粒剂</option>
                                    <option value="注射剂">注射剂</option>
                                    <option value="软膏剂">软膏剂</option>
                                    <option value="滴眼剂">滴眼剂</option>
                                    <option value="口服液">口服液</option>
                                    <option value="喷雾剂">喷雾剂</option>
                                    <option value="其他">其他</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">单位 <span class="text-danger">*</span></label>
                                <select class="form-select" id="medicineUnit" required>
                                    <option value="">请选择单位</option>
                                    <option value="片">片</option>
                                    <option value="粒">粒</option>
                                    <option value="瓶">瓶</option>
                                    <option value="盒">盒</option>
                                    <option value="支">支</option>
                                    <option value="袋">袋</option>
                                    <option value="ml">ml</option>
                                    <option value="g">g</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">价格 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" id="medicinePrice" 
                                           step="0.01" min="0" required>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">库存数量 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="medicineStock" 
                                       min="0" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">生产厂家</label>
                                <input type="text" class="form-control" id="medicineManufacturer">
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">适应症</label>
                                <textarea class="form-control" id="medicineIndication" rows="3" 
                                          placeholder="描述药品的适应症和主要用途"></textarea>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">用法用量</label>
                                <textarea class="form-control" id="medicineDosage" rows="3" 
                                          placeholder="详细说明用法用量"></textarea>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">不良反应</label>
                                <textarea class="form-control" id="medicineSideEffects" rows="2" 
                                          placeholder="列出可能的不良反应"></textarea>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">禁忌症</label>
                                <textarea class="form-control" id="medicineContraindications" rows="2" 
                                          placeholder="列出禁忌症和注意事项"></textarea>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="medicineAvailable" checked>
                                    <label class="form-check-label" for="medicineAvailable">
                                        药品可用
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveMedicine()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 药品详情模态框 -->
    <div class="modal fade" id="medicineDetailModal" tabindex="-1" aria-labelledby="medicineDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="medicineDetailModalLabel">药品详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="medicineDetailContent">
                    <!-- 详情内容将通过JavaScript动态填充 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 反馈详情模态框 -->
    <div class="modal fade" id="feedbackDetailModal" tabindex="-1" aria-labelledby="feedbackDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackDetailModalLabel">反馈详情与处理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>反馈ID:</strong> <span id="detailId"></span></div>
                        <div class="col-md-6"><strong>提交时间:</strong> <span id="detailCreatedAt"></span></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>联系人:</strong> <span id="detailContactName"></span></div>
                        <div class="col-md-6"><strong>联系电话:</strong> <span id="detailContactPhone"></span></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>邮箱:</strong> <span id="detailContactEmail"></span></div>
                        <div class="col-md-6"><strong>反馈类型:</strong> <span id="detailFeedbackType"></span></div>
                    </div>
                    <div class="mb-3">
                        <strong>反馈内容:</strong>
                        <div class="feedback-content border p-2 mt-2 bg-light" id="detailContent" style="white-space: pre-wrap; word-wrap: break-word; max-height: 150px; overflow-y: auto;"></div>
                    </div>
                    <div class="mb-3">
                        <strong>当前状态:</strong> <span id="detailStatus"></span>
                    </div>
                    <hr>
                    <h6>处理记录</h6>
                    <div class="mb-3">
                        <label for="resolutionNotes" class="form-label">处理备注:</label>
                        <textarea class="form-control" id="resolutionNotes" rows="4" placeholder="请输入处理意见或结果" maxlength="500"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="processStatus" class="form-label">更新状态:</label>
                            <select class="form-select" id="processStatus">
                                <option value="PENDING">待处理</option>
                                <option value="PROCESSED">已处理</option>
                                <option value="CLOSED">已关闭</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <strong>处理人:</strong> <span id="detailResolvedBy"></span>
                            <br>
                            <strong>处理时间:</strong> <span id="detailResolvedAt"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="saveProcessBtn" onclick="saveFeedbackProcess()">保存处理</button>
                    <button type="button" class="btn btn-danger" id="deleteFeedbackBtn" onclick="deleteFeedback()">删除反馈</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义美化弹出窗口 -->
    <div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="customAlertHeader">
                    <h5 class="modal-title" id="customAlertModalLabel">
                        <i class="bi bi-info-circle-fill" id="customAlertIcon"></i>
                        <span id="customAlertTitle">提示</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body" id="customAlertBody">
                    <div id="customAlertContent"></div>
                </div>
                <div class="modal-footer" id="customAlertFooter">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="customAlertOkBtn">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义确认对话框 -->
    <div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="customConfirmModalLabel">
                        <i class="bi bi-question-circle-fill"></i>
                        确认操作
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body" id="customConfirmBody">
                    <div id="customConfirmContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" id="customConfirmOkBtn">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 通知系统 -->
    <script src="notification-system.js"></script>
    <script>
        // ========== 管理端增强功能 ==========
        
        // 全局变量
        let chartLine, chartDonut;
        let particles = [];
        
        // 1) 数字滚动动画
        function animateNumber(el, to, isCurrency=false){
            const from = 0, dur = 800, start = performance.now();
            function step(now){
                const p = Math.min((now - start)/dur, 1);
                const val = Math.round(from + (to-from)*p);
                el.textContent = isCurrency ? ('¥' + (val.toFixed ? val.toFixed(2) : val).toString()) : String(val);
                if(p<1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        // 2) Toast 通知系统
        function showToast(message, variant='success') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast custom-toast align-items-center text-white bg-${variant} border-0 show`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            toastContainer.appendChild(toast);
            
            const bootstrapToast = new bootstrap.Toast(toast, { delay: 3000 });
            bootstrapToast.show();
            
            // 自动移除
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3500);
        }

        // 3) 侧边栏收缩功能
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // 4) 按钮水波纹效果
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn');
            if (!btn) return;
            
            const rect = btn.getBoundingClientRect();
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            ripple.style.left = (e.clientX - rect.left) + 'px';
            ripple.style.top = (e.clientY - rect.top) + 'px';
            ripple.style.width = ripple.style.height = '20px';
            
            btn.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        });

        // 5) 粒子背景动画
        function initParticles() {
            const canvas = document.getElementById('particleCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // 创建粒子
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 2 + 1,
                    opacity: Math.random() * 0.5 + 0.2
                });
            }

            function animateParticles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                particles.forEach(particle => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    if (particle.x < 0 || particle.x > canvas.width) particle.vx *= -1;
                    if (particle.y < 0 || particle.y > canvas.height) particle.vy *= -1;
                    
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(102, 126, 234, ${particle.opacity})`;
                    ctx.fill();
                });
                
                requestAnimationFrame(animateParticles);
            }
            
            animateParticles();
            
            // 窗口大小改变时重新调整
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // 6) 图表初始化
        function initCharts() {
            const lineCanvas = document.getElementById('chartLine');
            const donutCanvas = document.getElementById('chartDonut');
            
            if (lineCanvas) {
                chartLine = new Chart(lineCanvas, {
                    type: 'line',
                    data: {
                        labels: ['08:00', '10:00', '12:00', '14:00', '16:00', '18:00'],
                        datasets: [{
                            label: '挂号数',
                            data: [0, 0, 0, 0, 0, 0],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }, {
                            label: '收入(¥)',
                            data: [0, 0, 0, 0, 0, 0],
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '挂号数'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '收入(¥)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '时间'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        }
                    }
                });
            }

            if (donutCanvas) {
                chartDonut = new Chart(donutCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['已支付', '待支付', '已退款'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                '#667eea',
                                '#f093fb',
                                '#43e97b'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // 初始化后立即加载数据
            loadChartData();
        }
        
        // 加载图表数据
        async function loadChartData() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                // 加载时间序列数据
                const timeSeriesResponse = await fetch('/api/dashboard/time-series', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (timeSeriesResponse.ok) {
                    const timeSeriesResult = await timeSeriesResponse.json();
                    if (timeSeriesResult.success && chartLine) {
                        const data = timeSeriesResult.data;
                        chartLine.data.labels = data.labels;
                        chartLine.data.datasets[0].data = data.registrationData;
                        chartLine.data.datasets[1].data = data.revenueData.map(val => parseFloat(val));
                        chartLine.update('active');
                    }
                }
                
                // 加载统计数据更新甜甜圈图
                const statsResponse = await fetch('/api/dashboard/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (statsResponse.ok) {
                    const statsResult = await statsResponse.json();
                    if (statsResult.success && chartDonut) {
                        const stats = statsResult.data;
                        const paymentStats = stats.paymentStatusStats || {};
                        
                        chartDonut.data.datasets[0].data = [
                            paymentStats.PAID || 0,
                            paymentStats.PENDING || 0,
                            paymentStats.REFUNDED || 0
                        ];
                        chartDonut.update('active');
                    }
                }
                
            } catch (error) {
                console.error('加载图表数据失败:', error);
            }
        }

        // 7) 卡片温和美化效果
        function addCardEffects() {
            document.querySelectorAll('.card').forEach(card => {
                // 添加微妙的光晕效果
                card.addEventListener('mouseenter', (e) => {
                    card.style.boxShadow = '0 20px 50px rgba(102, 126, 234, 0.2)';
                    card.style.transform = 'translateY(-3px)';
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.boxShadow = '';
                    card.style.transform = '';
                });
                
                // 添加微妙的边框光效
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    card.style.background = `
                        radial-gradient(circle at ${x}px ${y}px, rgba(255,255,255,0.1) 0%, transparent 50%),
                        rgba(255, 255, 255, 0.95)
                    `;
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.background = '';
                });
            });
        }

        // 8) 更新统计数据显示
        function updateDashboardStats(stats) {
            if (stats.totalPatients !== undefined) {
                animateNumber(document.getElementById('patientCount'), stats.totalPatients);
            }
            if (stats.totalDoctors !== undefined) {
                animateNumber(document.getElementById('doctorCount'), stats.totalDoctors);
            }
            if (stats.totalRegistrations !== undefined) {
                animateNumber(document.getElementById('totalRegistrations'), stats.totalRegistrations);
            }
            if (stats.totalRevenue !== undefined) {
                animateNumber(document.getElementById('totalRevenue'), stats.totalRevenue, true);
            }
        }

        // 全局错误处理，防止音频播放相关错误
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.name === 'AbortError' && 
                event.reason.message && event.reason.message.includes('play()')) {
                // 忽略音频播放被中断的错误
                console.warn('音频播放被中断，已忽略此错误:', event.reason);
                event.preventDefault();
            }
        });
    </script>
    <style>
        /* 自定义弹出窗口样式 */
        .custom-alert-success .modal-header {
            background-color: #d1edff;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .custom-alert-success .bi {
            color: #28a745;
        }
        
        .custom-alert-error .modal-header {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .custom-alert-error .bi {
            color: #dc3545;
        }
        
        .custom-alert-warning .modal-header {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .custom-alert-warning .bi {
            color: #ffc107;
        }
        
        .custom-alert-info .modal-header {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .custom-alert-info .bi {
            color: #17a2b8;
        }
        
        #customAlertContent {
            white-space: pre-line;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 16px;
        }
        
        #customConfirmContent {
            white-space: pre-line;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 16px;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
    <script>
        // 自定义弹出窗口函数
        function showCustomAlert(message, type = 'info', title = '提示') {
            const modal = document.getElementById('customAlertModal');
            const header = document.getElementById('customAlertHeader');
            const icon = document.getElementById('customAlertIcon');
            const titleElement = document.getElementById('customAlertTitle');
            const content = document.getElementById('customAlertContent');
            const okBtn = document.getElementById('customAlertOkBtn');
            
            // 清除之前的样式类
            modal.className = 'modal fade';
            
            // 设置内容
            titleElement.textContent = title;
            content.textContent = message;
            
            // 根据类型设置样式和图标
            switch (type) {
                case 'success':
                    modal.classList.add('custom-alert-success');
                    icon.className = 'bi bi-check-circle-fill';
                    okBtn.className = 'btn btn-success';
                    break;
                case 'error':
                    modal.classList.add('custom-alert-error');
                    icon.className = 'bi bi-exclamation-triangle-fill';
                    okBtn.className = 'btn btn-danger';
                    break;
                case 'warning':
                    modal.classList.add('custom-alert-warning');
                    icon.className = 'bi bi-exclamation-triangle-fill';
                    okBtn.className = 'btn btn-warning';
                    break;
                case 'info':
                default:
                    modal.classList.add('custom-alert-info');
                    icon.className = 'bi bi-info-circle-fill';
                    okBtn.className = 'btn btn-primary';
                    break;
            }
            
            // 显示模态框
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }
        
        // 自定义确认对话框
        function showCustomConfirm(message, title = '确认操作') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const content = document.getElementById('customConfirmContent');
                const confirmBtn = document.getElementById('customConfirmOkBtn');
                
                // 设置内容
                content.textContent = message;
                
                // 清除之前的事件监听器
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                // 添加确定按钮事件监听器
                newConfirmBtn.addEventListener('click', function() {
                    const bootstrapModal = bootstrap.Modal.getInstance(modal);
                    bootstrapModal.hide();
                    resolve(true);
                });
                
                // 添加取消和关闭事件监听器
                const handleCancel = () => {
                    resolve(false);
                    modal.removeEventListener('hidden.bs.modal', handleCancel);
                };
                
                modal.addEventListener('hidden.bs.modal', handleCancel, { once: true });
                
                // 显示模态框
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
            });
        }
        
        // 重写原生alert函数
        window.originalAlert = window.alert;
        window.alert = function(message) {
            showCustomAlert(message, 'info');
        };

        // 检查登录状态
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || user.role !== 'ADMIN') {
                window.location.href = 'login.html';
                return false;
            }
            
            document.getElementById('userName').textContent = user.realName || user.username;
            return true;
        }

        // 显示不同的功能区域
        function showSection(sectionName) {
            // 隐藏所有section
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('d-none');
            });
            
            // 显示选中的section
            document.getElementById(sectionName).classList.remove('d-none');
            
            // 更新导航状态
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 加载对应数据
            if (sectionName === 'dashboard') {
                loadDashboard();
            } else if (sectionName === 'patients') {
                loadPatients();
            } else if (sectionName === 'doctors') {
                loadDoctors();
            } else if (sectionName === 'registrations') {
                loadRegistrations();
            } else if (sectionName === 'payments') {
                loadPayments();
            } else if (sectionName === 'medicines') {
                loadMedicines();
            } else if (sectionName === 'feedbacks') {
                loadFeedbacks();
            }
        }

        // 加载仪表盘数据
        async function loadDashboard() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/dashboard/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateDashboard(result.data);
                    } else {
                        console.error('加载仪表盘数据失败:', result.message);
                        showErrorMessage('加载仪表盘数据失败');
                    }
                } else {
                    console.error('HTTP错误:', response.status);
                    showErrorMessage('无法连接到服务器');
                }
            } catch (error) {
                console.error('加载仪表盘数据异常:', error);
                showErrorMessage('加载数据时发生错误');
            }
        }

        // 更新仪表盘显示 - 增强版本
        function updateDashboard(stats) {
            // 使用动画更新核心统计数据
            updateDashboardStats(stats);
            
            // 更新图表数据
            if (chartDonut && stats.paymentStatusStats) {
                const paymentStats = stats.paymentStatusStats;
                chartDonut.data.datasets[0].data = [
                    paymentStats.PAID || 0,
                    paymentStats.PENDING || 0,
                    paymentStats.REFUNDED || 0
                ];
                chartDonut.update('active');
            }
            
            // 刷新时间序列数据
            loadChartData();
            
            // 显示成功提示
            showToast('数据已更新', 'success');

            // 更新简化的运营概览
            updateSimpleStats(stats);
            
            console.log('仪表盘数据更新成功:', stats);
        }
        
        // 更新简化的运营统计
        function updateSimpleStats(stats) {
            // 热门科室
            const topDept = stats.topDepartments && stats.topDepartments.length > 0 
                ? stats.topDepartments[0].departmentName 
                : '暂无数据';
            document.getElementById('topDepartment').textContent = topDept;
            
            // 待处理挂号数量
            const pendingRegs = stats.registrationStatusStats 
                ? (stats.registrationStatusStats.PENDING || 0)
                : 0;
            document.getElementById('pendingRegistrations').textContent = pendingRegs;
            
            // 待支付订单数量
            const pendingPayments = stats.paymentStatusStats 
                ? (stats.paymentStatusStats.PENDING || 0)
                : 0;
            document.getElementById('pendingPayments').textContent = pendingPayments;
        }
        
        // 更新科室统计显示
        function updateDepartmentStats(departments) {
            const container = document.getElementById('departmentStats');
            if (!departments || departments.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">暂无数据</div>';
                return;
            }
            
            let html = '';
            departments.forEach((dept, index) => {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="badge bg-primary me-2">${index + 1}</span>
                            <strong>${dept.departmentName}</strong>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">${dept.registrationCount}次</div>
                            <small class="text-muted">${formatCurrency(dept.revenue)}</small>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // 更新医生工作量统计显示
        function updateDoctorStats(doctors) {
            const container = document.getElementById('doctorStats');
            if (!doctors || doctors.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">暂无数据</div>';
                return;
            }
            
            let html = '';
            doctors.forEach((doctor, index) => {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="badge bg-success me-2">${index + 1}</span>
                            <strong>${doctor.doctorName}</strong>
                            <br>
                            <small class="text-muted">${doctor.department}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">${doctor.registrationCount}次</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // 更新挂号状态统计显示
        function updateRegistrationStatusStats(statusStats) {
            const container = document.getElementById('registrationStatusStats');
            const statusLabels = {
                'PENDING': '待就诊',
                'IN_PROGRESS': '就诊中',
                'COMPLETED': '已完成',
                'CANCELLED': '已取消'
            };
            
            let html = '';
            let total = 0;
            Object.values(statusStats).forEach(count => total += count);
            
            if (total === 0) {
                container.innerHTML = '<div class="text-center text-muted">暂无数据</div>';
                return;
            }
            
            Object.entries(statusStats).forEach(([status, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${statusLabels[status] || status}</span>
                        <div class="text-end">
                            <strong>${count}</strong>
                            <small class="text-muted">(${percentage}%)</small>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // 更新支付状态统计显示
        function updatePaymentStatusStats(statusStats) {
            const container = document.getElementById('paymentStatusStats');
            const statusLabels = {
                'PENDING': '待支付',
                'PAID': '已支付',
                'REFUNDED': '已退款'
            };
            
            let html = '';
            let total = 0;
            Object.values(statusStats).forEach(count => total += count);
            
            if (total === 0) {
                container.innerHTML = '<div class="text-center text-muted">暂无数据</div>';
                return;
            }
            
            Object.entries(statusStats).forEach(([status, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${statusLabels[status] || status}</span>
                        <div class="text-end">
                            <strong>${count}</strong>
                            <small class="text-muted">(${percentage}%)</small>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 格式化货币显示
        function formatCurrency(amount) {
            return '¥' + parseFloat(amount || 0).toFixed(2);
        }

        // 显示错误消息
        function showErrorMessage(message) {
            // 可以使用alert或者更优雅的通知方式
            console.error(message);
        }


        // 加载病人数据
        async function loadPatients() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/patients?page=0&size=10&sortBy=id&sortDir=asc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const tbody = document.getElementById('patientsTable');
                        tbody.innerHTML = result.data.content.map(patient => `
                            <tr>
                                <td>${patient.name}</td>
                                <td>${patient.gender === 'MALE' ? '男' : '女'}</td>
                                <td>${calculateAge(patient.birthDate)}</td>
                                <td>${patient.phone || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewPatient(${patient.id})">查看</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="editPatient(${patient.id})">编辑</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deletePatient(${patient.id}, '${patient.name}')">删除</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('加载病人数据失败:', error);
                document.getElementById('patientsTable').innerHTML = '<tr><td colspan="5" class="text-center text-danger">加载失败</td></tr>';
            }
        }

        // 计算年龄
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // 更新时间
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN');
        }

        // 退出登录
        // 意见建议管理功能
        let allFeedbacks = [];
        let currentFeedbackId = null;
        let debounceTimer;

        async function loadFeedbacks() {
            if (!checkAuth()) return;

            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/feedbacks', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();

                if (result.success) {
                    // 处理分页数据结构
                    let feedbackData = result.data;
                    if (feedbackData && feedbackData.content) {
                        // 如果是分页数据，取content数组
                        allFeedbacks = feedbackData.content || [];
                    } else if (Array.isArray(feedbackData)) {
                        // 如果直接是数组
                        allFeedbacks = feedbackData;
                    } else {
                        // 其他情况，设为空数组
                        allFeedbacks = [];
                    }
                    
                    console.log('Loaded feedbacks:', allFeedbacks.length, allFeedbacks);
                    displayFeedbacks(allFeedbacks);
                    updateFeedbackStatistics(allFeedbacks);
                } else {
                    showCustomAlert('加载反馈失败:\n' + result.message, 'error', '加载失败');
                    allFeedbacks = [];
                    displayFeedbacks(allFeedbacks);
                    updateFeedbackStatistics(allFeedbacks);
                }
            } catch (error) {
                console.error('Error loading feedbacks:', error);
                showCustomAlert('加载反馈失败，请检查网络或服务器\n\n错误详情:\n' + error.message, 'error', '网络错误');
                allFeedbacks = [];
                displayFeedbacks(allFeedbacks);
                updateFeedbackStatistics(allFeedbacks);
            }
        }

        function displayFeedbacks(feedbacks) {
            const tableBody = document.getElementById('feedbacksTable');
            const noFeedbacksMessage = document.getElementById('noFeedbacksMessage');
            
            if (!tableBody) {
                console.error('feedbacksTable element not found');
                return;
            }
            
            tableBody.innerHTML = '';
            
            // 安全检查：确保 feedbacks 是数组
            if (!feedbacks || !Array.isArray(feedbacks) || feedbacks.length === 0) {
                if (noFeedbacksMessage) {
                    noFeedbacksMessage.style.display = 'block';
                }
                return;
            } else {
                if (noFeedbacksMessage) {
                    noFeedbacksMessage.style.display = 'none';
                }
            }

            feedbacks.forEach(feedback => {
                // 安全检查每个反馈对象
                if (!feedback || typeof feedback !== 'object') {
                    console.warn('Invalid feedback object:', feedback);
                    return;
                }
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${feedback.id || ''}</td>
                    <td>${feedback.contactName || 'N/A'}</td>
                    <td>${feedback.contactPhone || feedback.contactEmail || 'N/A'}</td>
                    <td><span class="badge ${getFeedbackTypeBadgeClass(feedback.feedbackType || '')}">${feedback.feedbackType || 'N/A'}</span></td>
                    <td>${feedback.content ? (feedback.content.substring(0, 50) + (feedback.content.length > 50 ? '...' : '')) : 'N/A'}</td>
                    <td>${feedback.createdAt ? new Date(feedback.createdAt).toLocaleString('zh-CN') : 'N/A'}</td>
                    <td><span class="badge ${getFeedbackStatusBadgeClass(feedback.status || '')}">${getFeedbackStatusText(feedback.status || '')}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewFeedbackDetail(${feedback.id || 0})">
                            <i class="bi bi-eye"></i> 详情
                        </button>
                    </td>
                `;
            });
        }

        function updateFeedbackStatistics(feedbacks) {
            // 安全检查：确保 feedbacks 是数组
            if (!feedbacks || !Array.isArray(feedbacks)) {
                feedbacks = [];
            }
            
            const totalElement = document.getElementById('totalFeedbacks');
            const pendingElement = document.getElementById('pendingFeedbacks');
            const resolvedElement = document.getElementById('resolvedFeedbacks');
            const suggestionElement = document.getElementById('suggestionFeedbacks');
            
            if (totalElement) totalElement.textContent = feedbacks.length;
            if (pendingElement) pendingElement.textContent = feedbacks.filter(f => f.status === 'PENDING').length;
            if (resolvedElement) resolvedElement.textContent = feedbacks.filter(f => f.status === 'PROCESSED').length;
            if (suggestionElement) suggestionElement.textContent = feedbacks.filter(f => f.feedbackType === '建议').length;
        }

        function filterFeedbacks() {
            const filterStatus = document.getElementById('filterStatus').value;
            const filterType = document.getElementById('filterType').value;
            const searchKeyword = document.getElementById('searchKeyword').value.toLowerCase();

            // 确保 allFeedbacks 是数组
            if (!Array.isArray(allFeedbacks)) {
                console.warn('allFeedbacks is not an array:', allFeedbacks);
                allFeedbacks = [];
            }

            const filteredFeedbacks = allFeedbacks.filter(feedback => {
                const matchesStatus = filterStatus ? feedback.status === filterStatus : true;
                const matchesType = filterType ? feedback.feedbackType === filterType : true;
                const matchesKeyword = searchKeyword ? 
                    feedback.contactName.toLowerCase().includes(searchKeyword) ||
                    feedback.content.toLowerCase().includes(searchKeyword) ||
                    (feedback.contactPhone && feedback.contactPhone.includes(searchKeyword)) ||
                    (feedback.contactEmail && feedback.contactEmail.toLowerCase().includes(searchKeyword))
                    : true;
                return matchesStatus && matchesType && matchesKeyword;
            });

            displayFeedbacks(filteredFeedbacks);
        }

        function debounceSearchFeedbacks() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                filterFeedbacks();
            }, 300);
        }

        function getFeedbackStatusBadgeClass(status) {
            switch (status) {
                case 'PENDING': return 'bg-warning text-dark';
                case 'PROCESSED': return 'bg-success';
                case 'CLOSED': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function getFeedbackStatusText(status) {
            switch (status) {
                case 'PENDING': return '待处理';
                case 'PROCESSED': return '已处理';
                case 'CLOSED': return '已关闭';
                default: return '未知';
            }
        }

        function getFeedbackTypeBadgeClass(type) {
            switch (type) {
                case '投诉': return 'bg-danger';
                case '建议': return 'bg-primary';
                case '表扬': return 'bg-success';
                case '咨询': return 'bg-info';
                case '其他': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        async function viewFeedbackDetail(id) {
            if (!checkAuth()) return;

            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/feedbacks/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();

                if (result.success) {
                    const feedback = result.data;
                    currentFeedbackId = feedback.id;

                    document.getElementById('detailId').textContent = feedback.id;
                    document.getElementById('detailCreatedAt').textContent = new Date(feedback.createdAt).toLocaleString('zh-CN');
                    document.getElementById('detailContactName').textContent = feedback.contactName;
                    document.getElementById('detailContactPhone').textContent = feedback.contactPhone || 'N/A';
                    document.getElementById('detailContactEmail').textContent = feedback.contactEmail || 'N/A';
                    document.getElementById('detailFeedbackType').innerHTML = `<span class="badge ${getFeedbackTypeBadgeClass(feedback.feedbackType)}">${feedback.feedbackType}</span>`;
                    document.getElementById('detailContent').textContent = feedback.content;
                    document.getElementById('detailStatus').innerHTML = `<span class="badge ${getFeedbackStatusBadgeClass(feedback.status)}">${getFeedbackStatusText(feedback.status)}</span>`;
                    
                    document.getElementById('resolutionNotes').value = feedback.resolutionNotes || '';
                    document.getElementById('processStatus').value = feedback.status;
                    document.getElementById('detailResolvedBy').textContent = feedback.resolvedBy ? feedback.resolvedBy.realName : 'N/A';
                    document.getElementById('detailResolvedAt').textContent = feedback.resolvedAt ? new Date(feedback.resolvedAt).toLocaleString('zh-CN') : 'N/A';

                    const feedbackDetailModal = new bootstrap.Modal(document.getElementById('feedbackDetailModal'));
                    feedbackDetailModal.show();
                } else {
                    showCustomAlert('加载反馈详情失败:\n' + result.message, 'error', '加载失败');
                }
            } catch (error) {
                console.error('Error loading feedback detail:', error);
                showCustomAlert('加载反馈详情失败，请检查网络或服务器\n\n错误详情:\n' + error.message, 'error', '网络错误');
            }
        }

        async function saveFeedbackProcess() {
            if (!checkAuth() || !currentFeedbackId) return;

            const token = localStorage.getItem('token');
            const status = document.getElementById('processStatus').value;
            const resolutionNotes = document.getElementById('resolutionNotes').value;

            try {
                let response;
                
                if (status === 'PROCESSED') {
                    // 使用 process 端点
                    response = await fetch(`/api/feedbacks/${currentFeedbackId}/process?processingNotes=${encodeURIComponent(resolutionNotes)}&processedByUserId=1`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                } else if (status === 'CLOSED') {
                    // 使用 close 端点
                    response = await fetch(`/api/feedbacks/${currentFeedbackId}/close`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                } else {
                    // 对于 PENDING 状态，我们暂时不做处理，或者可以显示提示
                    alert('暂不支持将状态改回待处理');
                    return;
                }
                
                const result = await response.json();

                if (result.success) {
                    showCustomAlert('反馈处理状态已更新！', 'success', '操作成功');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackDetailModal'));
                    modal.hide();
                    loadFeedbacks(); // 刷新列表
                } else {
                    showCustomAlert('更新处理状态失败:\n' + result.message, 'error', '操作失败');
                }
            } catch (error) {
                console.error('Error saving feedback process:', error);
                showCustomAlert('保存处理失败，请检查网络或服务器\n\n错误详情:\n' + error.message, 'error', '网络错误');
            }
        }

        async function deleteFeedback() {
            if (!checkAuth() || !currentFeedbackId) return;

            // 使用自定义确认对话框
            const confirmed = await showCustomConfirm(
                '确定要删除这条反馈吗？\n\n此操作不可逆，删除后将无法恢复！\n\n请谨慎操作。',
                '删除确认'
            );
            
            if (!confirmed) {
                return;
            }

            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/feedbacks/${currentFeedbackId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showCustomAlert('反馈已成功删除！', 'success', '删除成功');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackDetailModal'));
                    modal.hide();
                    loadFeedbacks(); // 刷新列表
                } else {
                    const result = await response.json();
                    showCustomAlert('删除反馈失败:\n' + result.message, 'error', '删除失败');
                }
            } catch (error) {
                console.error('Error deleting feedback:', error);
                showCustomAlert('删除反馈失败，请检查网络或服务器\n\n错误详情:\n' + error.message, 'error', '网络错误');
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAuth()) {
                // 初始化所有增强功能
                initParticles();
                initCharts();
                addCardEffects();
                
                updateTime();
                setInterval(updateTime, 1000);
                
                // 默认加载仪表盘数据
                loadDashboard();
                
                // 每5分钟自动刷新数据
                setInterval(() => {
                    if (document.querySelector('#dashboard').style.display !== 'none') {
                        console.log('定期刷新仪表盘数据...');
                        loadDashboard();
                    }
                }, 5 * 60 * 1000);
            }
        });

        // ============ 病人管理相关功能 ============

        // 显示添加病人模态框
        function showAddPatientModal() {
            document.getElementById('patientModalTitle').textContent = '添加病人';
            document.getElementById('patientForm').reset();
            document.getElementById('patientId').value = '';
            
            // 确保所有表单元素都是可编辑的
            const formInputs = document.querySelectorAll('#patientForm input, #patientForm select');
            formInputs.forEach(input => input.disabled = false);
            
            // 显示保存按钮
            document.getElementById('savePatientBtn').style.display = 'block';
            
            // 统一的Modal实例管理
            const modalElement = document.getElementById('patientModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }

        // 查看病人详情
        async function viewPatient(patientId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/patients/${patientId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const patient = result.data;
                        // 填充表单数据
                        document.getElementById('patientModalTitle').textContent = '查看病人信息';
                        document.getElementById('patientId').value = patient.id;
                        document.getElementById('patientName').value = patient.name;
                        document.getElementById('patientGender').value = patient.gender;
                        document.getElementById('patientBirthDate').value = patient.birthDate;
                        document.getElementById('patientPhone').value = patient.phone || '';
                        document.getElementById('patientAddress').value = patient.address || '';
                        document.getElementById('patientIdCard').value = patient.idCard || '';
                        document.getElementById('patientEmergencyContact').value = patient.emergencyContact || '';
                        document.getElementById('patientEmergencyPhone').value = patient.emergencyPhone || '';
                        
                        // 设为只读模式
                        const formInputs = document.querySelectorAll('#patientForm input, #patientForm select');
                        formInputs.forEach(input => input.disabled = true);
                        
                        document.getElementById('savePatientBtn').style.display = 'none';
                        
                        // 统一的Modal实例管理
                        const modalElement = document.getElementById('patientModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('获取病人信息失败:', error);
                alert('获取病人信息失败');
            }
        }

        // 编辑病人
        async function editPatient(patientId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/patients/${patientId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const patient = result.data;
                        // 填充表单数据
                        document.getElementById('patientModalTitle').textContent = '编辑病人信息';
                        document.getElementById('patientId').value = patient.id;
                        document.getElementById('patientName').value = patient.name;
                        document.getElementById('patientGender').value = patient.gender;
                        document.getElementById('patientBirthDate').value = patient.birthDate;
                        document.getElementById('patientPhone').value = patient.phone || '';
                        document.getElementById('patientAddress').value = patient.address || '';
                        document.getElementById('patientIdCard').value = patient.idCard || '';
                        document.getElementById('patientEmergencyContact').value = patient.emergencyContact || '';
                        document.getElementById('patientEmergencyPhone').value = patient.emergencyPhone || '';
                        
                        // 启用编辑模式
                        const formInputs = document.querySelectorAll('#patientForm input, #patientForm select');
                        formInputs.forEach(input => input.disabled = false);
                        
                        document.getElementById('savePatientBtn').style.display = 'block';
                        
                        // 统一的Modal实例管理
                        const modalElement = document.getElementById('patientModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('获取病人信息失败:', error);
                alert('获取病人信息失败');
            }
        }

        // 清除字段错误样式
        function clearFieldErrors() {
            const fields = ['patientName', 'patientGender', 'patientBirthDate', 'patientIdCard', 'patientPhone', 'patientAddress', 'patientEmail', 'patientEmergencyContact', 'patientEmergencyPhone'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('is-invalid');
                    // 移除已有的错误提示
                    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                }
            });
        }

        // 显示字段错误
        function showFieldErrors(fieldErrors) {
            // 字段名映射
            const fieldMap = {
                'name': 'patientName',
                'gender': 'patientGender', 
                'birthDate': 'patientBirthDate',
                'idCard': 'patientIdCard',
                'phone': 'patientPhone',
                'address': 'patientAddress',
                'email': 'patientEmail',
                'emergencyContact': 'patientEmergencyContact',
                'emergencyPhone': 'patientEmergencyPhone'
            };

            for (const [fieldName, errorMessage] of Object.entries(fieldErrors)) {
                const fieldId = fieldMap[fieldName];
                if (fieldId) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // 添加错误样式
                        field.classList.add('is-invalid');
                        
                        // 添加错误提示
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = errorMessage;
                        field.parentNode.appendChild(errorDiv);
                    }
                }
            }
        }

        // 保存病人信息
        async function savePatient() {
            // 防止重复提交
            const saveBtn = document.getElementById('savePatientBtn');
            if (saveBtn.disabled) {
                return; // 如果按钮已禁用，直接返回
            }
            
            // 禁用保存按钮，防止重复点击
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';
            
            // 清除之前的错误提示
            clearFieldErrors();

            // 获取表单数据
            const name = document.getElementById('patientName').value.trim();
            const gender = document.getElementById('patientGender').value;
            const birthDate = document.getElementById('patientBirthDate').value;
            const phone = document.getElementById('patientPhone').value.trim();
            const address = document.getElementById('patientAddress').value.trim();
            const idCard = document.getElementById('patientIdCard').value.trim();
            const emergencyContact = document.getElementById('patientEmergencyContact').value.trim();
            const emergencyPhone = document.getElementById('patientEmergencyPhone').value.trim();

            // 验证必填字段
            if (!name) {
                alert('请输入病人姓名');
                document.getElementById('patientName').focus();
                return;
            }
            
            if (!gender) {
                alert('请选择病人性别');
                document.getElementById('patientGender').focus();
                return;
            }
            
            if (!birthDate) {
                alert('请选择出生日期');
                document.getElementById('patientBirthDate').focus();
                return;
            }
            
            if (!idCard) {
                alert('请输入身份证号');
                document.getElementById('patientIdCard').focus();
                return;
            }

            // 构建数据对象（包含所有必填字段）
            const patientData = {
                name: name,
                gender: gender,
                birthDate: birthDate,
                idCard: idCard
            };

            // 添加可选字段（如果不为空）
            if (phone) patientData.phone = phone;
            if (address) patientData.address = address;
            if (emergencyContact) patientData.emergencyContact = emergencyContact;
            if (emergencyPhone) patientData.emergencyPhone = emergencyPhone;

            const patientId = document.getElementById('patientId').value;
            const isEdit = patientId && patientId.trim() !== '';

            try {
                const token = localStorage.getItem('token');
                const url = isEdit ? `/api/patients/${patientId}` : '/api/patients';
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('发送数据:', patientData); // 调试日志
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(patientData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    const operation = isEdit ? 'UPDATE' : 'CREATE';
                    const successMessage = isEdit ? '病人信息更新成功！' : '病人添加成功！';
                    
                    alert(successMessage);
                    
                    // 发送通知
                    if (window.notificationHelper) {
                        try {
                            console.log('准备发送病人通知...', operation);
                            const notificationData = {
                                id: result.data?.id || patientData.id,
                                name: patientData.name,
                                phone: patientData.phone,
                                idCard: patientData.idCard
                            };
                            await window.notificationHelper.sendPatientNotification(operation.toLowerCase(), notificationData);
                            console.log('病人通知发送成功');
                        } catch (notifyError) {
                            console.error('发送通知失败:', notifyError);
                        }
                    } else {
                        console.error('通知系统未初始化');
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('patientModal')).hide();
                    loadPatients(); // 重新加载病人列表
                } else {
                    // 处理验证错误
                    if (result.data && typeof result.data === 'object') {
                        // 显示字段级别的错误
                        showFieldErrors(result.data);
                        alert('输入信息有误，请查看标红的字段提示并修正');
                    } else {
                        // 显示通用错误信息
                        alert('保存失败：' + (result.message || '未知错误'));
                    }
                }
            } catch (error) {
                console.error('保存病人信息失败:', error);
                alert('保存失败，请稍后重试');
            } finally {
                // 恢复按钮状态
                saveBtn.disabled = false;
                saveBtn.textContent = '保存';
            }
        }

        // 删除病人
        async function deletePatient(patientId, patientName) {
            // 确认删除
            const confirmMessage = `确定要删除病人 "${patientName}" 吗？\n\n注意：删除后将无法恢复，并且会同时删除该病人的所有挂号和收费记录。`;
            
            if (!confirm(confirmMessage)) {
                return; // 用户取消删除
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/patients/${patientId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`病人 "${patientName}" 删除成功！`);
                        
                        // 发送删除通知
                        if (window.notificationHelper) {
                            try {
                                const notificationData = {
                                    id: patientId,
                                    name: patientName
                                };
                                await window.notificationHelper.sendPatientNotification('delete', notificationData);
                            } catch (notifyError) {
                                console.error('发送通知失败:', notifyError);
                            }
                        }
                        
                        loadPatients(); // 重新加载病人列表
                    } else {
                        alert('删除失败：' + result.message);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('删除失败:', response.status, errorText);
                    
                    if (response.status === 403) {
                        alert('权限不足：只有管理员可以删除病人');
                    } else {
                        alert('删除失败，请稍后重试');
                    }
                }
            } catch (error) {
                console.error('删除病人失败:', error);
                alert('删除失败，请稍后重试');
            }
        }

        // ============ 医生管理相关功能 ============

        // 加载医生数据
        async function loadDoctors() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/doctors?page=0&size=10&sortBy=id&sortDir=asc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const tbody = document.getElementById('doctorsTable');
                        tbody.innerHTML = result.data.content.map(doctor => `
                            <tr>
                                <td>${doctor.name}</td>
                                <td>${doctor.gender === 'MALE' ? '男' : '女'}</td>
                                <td>${doctor.department}</td>
                                <td>${doctor.title}</td>
                                <td>${doctor.phone || '-'}</td>
                                <td>¥${doctor.consultationFee?.toFixed(2) || '0.00'}</td>
                                <td>
                                    <span class="badge ${doctor.available ? 'bg-success' : 'bg-secondary'}">
                                        ${doctor.available ? '可用' : '不可用'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewDoctor(${doctor.id})">查看</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="editDoctor(${doctor.id})">编辑</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor(${doctor.id}, '${doctor.name}')">删除</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('加载医生数据失败:', error);
                document.getElementById('doctorsTable').innerHTML = '<tr><td colspan="8" class="text-center text-danger">加载失败</td></tr>';
            }
        }

        // 显示添加医生模态框
        function showAddDoctorModal() {
            document.getElementById('doctorModalTitle').textContent = '添加医生';
            document.getElementById('doctorForm').reset();
            document.getElementById('doctorId').value = '';
            
            // 确保所有表单元素都是可编辑的
            const formInputs = document.querySelectorAll('#doctorForm input, #doctorForm select, #doctorForm textarea');
            formInputs.forEach(input => input.disabled = false);
            
            // 显示保存按钮
            document.getElementById('saveDoctorBtn').style.display = 'block';
            
            // 统一的Modal实例管理
            const modalElement = document.getElementById('doctorModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }

        // 查看医生详情
        async function viewDoctor(doctorId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/doctors/${doctorId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const doctor = result.data;
                        // 填充表单数据
                        document.getElementById('doctorModalTitle').textContent = '查看医生信息';
                        document.getElementById('doctorId').value = doctor.id;
                        document.getElementById('doctorName').value = doctor.name;
                        document.getElementById('doctorGender').value = doctor.gender;
                        document.getElementById('doctorDepartment').value = doctor.department;
                        document.getElementById('doctorTitle').value = doctor.title;
                        document.getElementById('doctorPhone').value = doctor.phone || '';
                        document.getElementById('doctorEmail').value = doctor.email || '';
                        document.getElementById('doctorSpecialization').value = doctor.specialization || '';
                        document.getElementById('doctorIntroduction').value = doctor.introduction || '';
                        document.getElementById('doctorConsultationFee').value = doctor.consultationFee || '';
                        document.getElementById('doctorAvailable').checked = doctor.available;
                        
                        // 设为只读模式
                        const formInputs = document.querySelectorAll('#doctorForm input, #doctorForm select, #doctorForm textarea');
                        formInputs.forEach(input => input.disabled = true);
                        
                        document.getElementById('saveDoctorBtn').style.display = 'none';
                        
                        // 统一的Modal实例管理
                        const modalElement = document.getElementById('doctorModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('获取医生信息失败:', error);
                alert('获取医生信息失败');
            }
        }

        // 编辑医生
        async function editDoctor(doctorId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/doctors/${doctorId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const doctor = result.data;
                        // 填充表单数据
                        document.getElementById('doctorModalTitle').textContent = '编辑医生信息';
                        document.getElementById('doctorId').value = doctor.id;
                        document.getElementById('doctorName').value = doctor.name;
                        document.getElementById('doctorGender').value = doctor.gender;
                        document.getElementById('doctorDepartment').value = doctor.department;
                        document.getElementById('doctorTitle').value = doctor.title;
                        document.getElementById('doctorPhone').value = doctor.phone || '';
                        document.getElementById('doctorEmail').value = doctor.email || '';
                        document.getElementById('doctorSpecialization').value = doctor.specialization || '';
                        document.getElementById('doctorIntroduction').value = doctor.introduction || '';
                        document.getElementById('doctorConsultationFee').value = doctor.consultationFee || '';
                        document.getElementById('doctorAvailable').checked = doctor.available;
                        
                        // 启用编辑模式
                        const formInputs = document.querySelectorAll('#doctorForm input, #doctorForm select, #doctorForm textarea');
                        formInputs.forEach(input => input.disabled = false);
                        
                        document.getElementById('saveDoctorBtn').style.display = 'block';
                        
                        // 统一的Modal实例管理
                        const modalElement = document.getElementById('doctorModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('获取医生信息失败:', error);
                alert('获取医生信息失败');
            }
        }

        // 清除医生字段错误样式
        function clearDoctorFieldErrors() {
            const fields = ['doctorName', 'doctorGender', 'doctorDepartment', 'doctorTitle', 'doctorPhone', 'doctorEmail', 'doctorSpecialization', 'doctorIntroduction', 'doctorConsultationFee'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('is-invalid');
                    // 移除已有的错误提示
                    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                }
            });
        }

        // 显示医生字段错误
        function showDoctorFieldErrors(fieldErrors) {
            // 字段名映射
            const fieldMap = {
                'name': 'doctorName',
                'gender': 'doctorGender', 
                'department': 'doctorDepartment',
                'title': 'doctorTitle',
                'phone': 'doctorPhone',
                'email': 'doctorEmail',
                'specialization': 'doctorSpecialization',
                'introduction': 'doctorIntroduction',
                'consultationFee': 'doctorConsultationFee'
            };

            for (const [fieldName, errorMessage] of Object.entries(fieldErrors)) {
                const fieldId = fieldMap[fieldName];
                if (fieldId) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // 添加错误样式
                        field.classList.add('is-invalid');
                        
                        // 添加错误提示
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = errorMessage;
                        field.parentNode.appendChild(errorDiv);
                    }
                }
            }
        }

        // 保存医生信息
        async function saveDoctor() {
            // 防止重复提交
            const saveBtn = document.getElementById('saveDoctorBtn');
            if (saveBtn.disabled) {
                return; // 如果按钮已禁用，直接返回
            }
            
            // 禁用保存按钮，防止重复点击
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';
            
            try {
                // 清除之前的错误提示
                clearDoctorFieldErrors();

                // 获取表单数据
                const name = document.getElementById('doctorName').value.trim();
                const gender = document.getElementById('doctorGender').value;
                const department = document.getElementById('doctorDepartment').value.trim();
                const title = document.getElementById('doctorTitle').value.trim();
                const phone = document.getElementById('doctorPhone').value.trim();
                const email = document.getElementById('doctorEmail').value.trim();
                const specialization = document.getElementById('doctorSpecialization').value.trim();
                const introduction = document.getElementById('doctorIntroduction').value.trim();
                const consultationFee = document.getElementById('doctorConsultationFee').value.trim();
                const available = document.getElementById('doctorAvailable').checked;

                // 验证必填字段
                if (!name) {
                    alert('请输入医生姓名');
                    document.getElementById('doctorName').focus();
                    return;
                }
                
                if (!gender) {
                    alert('请选择医生性别');
                    document.getElementById('doctorGender').focus();
                    return;
                }
                
                if (!department) {
                    alert('请输入科室');
                    document.getElementById('doctorDepartment').focus();
                    return;
                }

                if (!title) {
                    alert('请输入职称');
                    document.getElementById('doctorTitle').focus();
                    return;
                }

                // 验证邮箱格式（如果有输入的话）
                if (email && email.trim() !== '') {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        alert('请输入正确的邮箱格式');
                        document.getElementById('doctorEmail').focus();
                        return;
                    }
                }

                // 验证电话格式（如果有输入的话）
                if (phone && phone.trim() !== '') {
                    const phoneRegex = /^1[3-9]\d{9}$|^0\d{2,3}-?\d{7,8}$/;
                    if (!phoneRegex.test(phone.replace(/[-\s]/g, ''))) {
                        console.warn('电话格式可能不正确，但允许保存');
                    }
                }

                // 构建数据对象
                const doctorData = {
                    name: name,
                    gender: gender,
                    department: department,
                    title: title,
                    available: available
                };

                // 添加可选字段（只有当字段有有效内容时才添加）
                if (phone && phone.trim() !== '') {
                    doctorData.phone = phone.trim();
                }
                if (email && email.trim() !== '') {
                    // 邮箱格式已在上面验证过
                    doctorData.email = email.trim();
                }
                if (specialization && specialization.trim() !== '') {
                    doctorData.specialization = specialization.trim();
                }
                if (introduction && introduction.trim() !== '') {
                    doctorData.introduction = introduction.trim();
                }
                if (consultationFee && consultationFee.trim() !== '' && !isNaN(parseFloat(consultationFee))) {
                    doctorData.consultationFee = parseFloat(consultationFee);
                }

                const doctorId = document.getElementById('doctorId').value;
                const isEdit = doctorId && doctorId.trim() !== '';
                
                const token = localStorage.getItem('token');
                const url = isEdit ? `/api/doctors/${doctorId}` : '/api/doctors';
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('发送数据:', doctorData); // 调试日志
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(doctorData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    const operation = isEdit ? 'UPDATE' : 'CREATE';
                    const successMessage = isEdit ? '医生信息更新成功！' : '医生添加成功！';
                    
                    alert(successMessage);
                    
                    // 发送通知
                    if (window.notificationHelper) {
                        try {
                            const notificationData = {
                                id: result.data?.id || doctorData.id,
                                name: doctorData.name,
                                department: doctorData.department,
                                title: doctorData.title,
                                phone: doctorData.phone,
                                email: doctorData.email
                            };
                            await window.notificationHelper.sendDoctorNotification(operation.toLowerCase(), notificationData);
                        } catch (notifyError) {
                            console.error('发送通知失败:', notifyError);
                        }
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('doctorModal')).hide();
                    loadDoctors(); // 重新加载医生列表
                } else {
                    // 处理验证错误
                    if (result.data && typeof result.data === 'object') {
                        // 显示字段级别的错误
                        showDoctorFieldErrors(result.data);
                        alert('输入信息有误，请查看标红的字段提示并修正');
                    } else {
                        // 特殊处理重复邮箱错误
                        const errorMessage = result.message || '未知错误';
                        if (errorMessage.includes('邮箱') || errorMessage.includes('email') || errorMessage.includes('Duplicate') || errorMessage.includes('duplicate')) {
                            alert('保存失败：该邮箱地址已被其他医生使用，请更换邮箱地址');
                            document.getElementById('doctorEmail').focus();
                            document.getElementById('doctorEmail').select(); // 选中邮箱字段内容便于修改
                        } else {
                            alert('保存失败：' + errorMessage);
                        }
                    }
                }
            } catch (error) {
                console.error('保存医生信息失败:', error);
                alert('保存失败，请稍后重试');
            } finally {
                // 恢复按钮状态
                saveBtn.disabled = false;
                saveBtn.textContent = '保存';
            }
        }

        // 删除医生
        async function deleteDoctor(doctorId, doctorName) {
            // 确认删除
            const confirmMessage = `确定要删除医生 "${doctorName}" 吗？\n\n注意：删除后将无法恢复，并且会同时删除该医生的所有挂号记录。`;
            
            if (!confirm(confirmMessage)) {
                return; // 用户取消删除
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/doctors/${doctorId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`医生 "${doctorName}" 删除成功！`);
                        
                        // 发送删除通知
                        if (window.notificationHelper) {
                            try {
                                const notificationData = {
                                    id: doctorId,
                                    name: doctorName
                                };
                                await window.notificationHelper.sendDoctorNotification('delete', notificationData);
                            } catch (notifyError) {
                                console.error('发送通知失败:', notifyError);
                            }
                        }
                        
                        loadDoctors(); // 重新加载医生列表
                    } else {
                        alert('删除失败：' + result.message);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('删除失败:', response.status, errorText);
                    
                    if (response.status === 403) {
                        alert('权限不足：只有管理员可以删除医生');
                    } else {
                        alert('删除失败，请稍后重试');
                    }
                }
            } catch (error) {
                console.error('删除医生失败:', error);
                alert('删除失败，请稍后重试');
            }
        }

        // ============ 挂号管理相关功能 ============

        // 加载挂号数据
        async function loadRegistrations() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/registrations?page=0&size=10&sortBy=id&sortDir=desc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const tbody = document.getElementById('registrationsTable');
                        tbody.innerHTML = result.data.content.map(registration => {
                            const appointmentTime = new Date(registration.appointmentTime).toLocaleString('zh-CN');
                            const statusBadge = getStatusBadge(registration.status);
                            
                            return `
                                <tr>
                                    <td>${registration.patient?.name || '未知'}</td>
                                    <td>${registration.doctor?.name || '未知'}</td>
                                    <td>${registration.doctor?.department || '-'}</td>
                                    <td>${appointmentTime}</td>
                                    <td>¥${registration.registrationFee?.toFixed(2) || '0.00'}</td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewRegistration(${registration.id})">查看</button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="editRegistration(${registration.id})">编辑</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRegistration(${registration.id}, '${registration.patient?.name}')">删除</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('加载挂号数据失败:', error);
                document.getElementById('registrationsTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">加载失败</td></tr>';
            }
        }

        // 获取状态徽章
        function getStatusBadge(status) {
            const statusMap = {
                'PENDING': '<span class="badge bg-warning">待就诊</span>',
                'IN_PROGRESS': '<span class="badge bg-info">就诊中</span>',
                'COMPLETED': '<span class="badge bg-success">已完成</span>',
                'CANCELLED': '<span class="badge bg-secondary">已取消</span>'
            };
            return statusMap[status] || '<span class="badge bg-secondary">未知</span>';
        }

        // 显示添加挂号模态框
        async function showAddRegistrationModal() {
            document.getElementById('registrationModalTitle').textContent = '新建挂号';
            document.getElementById('registrationForm').reset();
            document.getElementById('registrationId').value = '';
            
            // 确保所有表单元素都是可编辑的
            const formInputs = document.querySelectorAll('#registrationForm input, #registrationForm select, #registrationForm textarea');
            formInputs.forEach(input => input.disabled = false);
            
            // 显示保存按钮
            document.getElementById('saveRegistrationBtn').style.display = 'block';
            
            // 加载病人和医生选项
            await Promise.all([loadPatientOptions(), loadDoctorOptions()]);
            
            // 设置默认预约时间为当前时间后1小时
            const now = new Date();
            now.setHours(now.getHours() + 1);
            document.getElementById('registrationAppointmentTime').value = formatDateTimeLocal(now);
            
            // 统一的Modal实例管理
            const modalElement = document.getElementById('registrationModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }

        // 加载病人选项
        async function loadPatientOptions(selectId = 'registrationPatient') {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/patients?page=0&size=100&sortBy=name&sortDir=asc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = '<option value="">请选择病人</option>';
                            result.data.content.forEach(patient => {
                                select.innerHTML += `<option value="${patient.id}">${patient.name} (${patient.gender === 'MALE' ? '男' : '女'}, ${calculateAge(patient.birthDate)}岁)</option>`;
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('加载病人选项失败:', error);
            }
        }

        // 加载医生选项
        async function loadDoctorOptions() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/doctors?page=0&size=100&sortBy=name&sortDir=asc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const select = document.getElementById('registrationDoctor');
                        select.innerHTML = '<option value="">请选择医生</option>';
                        result.data.content.forEach(doctor => {
                            if (doctor.available) { // 只显示可用的医生
                                const fee = doctor.consultationFee ? `¥${doctor.consultationFee.toFixed(2)}` : '¥0.00';
                                select.innerHTML += `<option value="${doctor.id}" data-fee="${doctor.consultationFee || 0}">${doctor.name} - ${doctor.department} (${fee})</option>`;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('加载医生选项失败:', error);
            }
        }

        // 医生选择变更时自动更新挂号费
        function onDoctorChange() {
            const select = document.getElementById('registrationDoctor');
            const selectedOption = select.options[select.selectedIndex];
            const fee = selectedOption.getAttribute('data-fee') || 0;
            document.getElementById('registrationFee').value = parseFloat(fee).toFixed(2);
        }

        // 格式化日期时间为input datetime-local格式
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // 查看挂号详情
        async function viewRegistration(registrationId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/registrations/${registrationId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const registration = result.data;
                        // 填充表单数据
                        document.getElementById('registrationModalTitle').textContent = '查看挂号信息';
                        document.getElementById('registrationId').value = registration.id;
                        document.getElementById('registrationPatient').innerHTML = `<option value="${registration.patient.id}" selected>${registration.patient.name}</option>`;
                        document.getElementById('registrationDoctor').innerHTML = `<option value="${registration.doctor.id}" selected>${registration.doctor.name} - ${registration.doctor.department}</option>`;
                        document.getElementById('registrationAppointmentTime').value = formatDateTimeLocal(new Date(registration.appointmentTime));
                        document.getElementById('registrationFee').value = registration.registrationFee?.toFixed(2) || '0.00';
                        document.getElementById('registrationStatus').value = registration.status;
                        document.getElementById('registrationSymptoms').value = registration.symptoms || '';
                        document.getElementById('registrationDiagnosis').value = registration.diagnosis || '';
                        document.getElementById('registrationTreatment').value = registration.treatment || '';
                        document.getElementById('registrationPrescription').value = registration.prescription || '';
                        document.getElementById('registrationNotes').value = registration.notes || '';
                        
                        // 设为只读模式
                        const formInputs = document.querySelectorAll('#registrationForm input, #registrationForm select, #registrationForm textarea');
                        formInputs.forEach(input => input.disabled = true);
                        
                        document.getElementById('saveRegistrationBtn').style.display = 'none';
                        
                        // 统一的Modal实例管理
                        const modalElement = document.getElementById('registrationModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('获取挂号信息失败:', error);
                alert('获取挂号信息失败');
            }
        }

        // 编辑挂号
        async function editRegistration(registrationId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/registrations/${registrationId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const registration = result.data;
                        // 填充表单数据
                        document.getElementById('registrationModalTitle').textContent = '编辑挂号信息';
                        document.getElementById('registrationId').value = registration.id;
                        
                        // 先加载选项，再设置选中值
                        await Promise.all([loadPatientOptions(), loadDoctorOptions()]);
                        
                        document.getElementById('registrationPatient').value = registration.patient.id;
                        document.getElementById('registrationDoctor').value = registration.doctor.id;
                        document.getElementById('registrationAppointmentTime').value = formatDateTimeLocal(new Date(registration.appointmentTime));
                        document.getElementById('registrationFee').value = registration.registrationFee?.toFixed(2) || '0.00';
                        document.getElementById('registrationStatus').value = registration.status;
                        document.getElementById('registrationSymptoms').value = registration.symptoms || '';
                        document.getElementById('registrationDiagnosis').value = registration.diagnosis || '';
                        document.getElementById('registrationTreatment').value = registration.treatment || '';
                        document.getElementById('registrationPrescription').value = registration.prescription || '';
                        document.getElementById('registrationNotes').value = registration.notes || '';
                        
                        // 启用编辑模式
                        const formInputs = document.querySelectorAll('#registrationForm input, #registrationForm select, #registrationForm textarea');
                        formInputs.forEach(input => input.disabled = false);
                        
                        document.getElementById('saveRegistrationBtn').style.display = 'block';
                        
                        // 统一的Modal实例管理
                        const modalElement = document.getElementById('registrationModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('获取挂号信息失败:', error);
                alert('获取挂号信息失败');
            }
        }

        // 清除挂号字段错误样式
        function clearRegistrationFieldErrors() {
            const fields = ['registrationPatient', 'registrationDoctor', 'registrationAppointmentTime', 'registrationFee', 'registrationStatus', 'registrationSymptoms', 'registrationDiagnosis', 'registrationTreatment', 'registrationPrescription', 'registrationNotes'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('is-invalid');
                    // 移除已有的错误提示
                    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                }
            });
        }

        // 显示挂号字段错误
        function showRegistrationFieldErrors(fieldErrors) {
            // 字段名映射
            const fieldMap = {
                'patient': 'registrationPatient',
                'doctor': 'registrationDoctor', 
                'appointmentTime': 'registrationAppointmentTime',
                'registrationFee': 'registrationFee',
                'status': 'registrationStatus',
                'symptoms': 'registrationSymptoms',
                'diagnosis': 'registrationDiagnosis',
                'treatment': 'registrationTreatment',
                'prescription': 'registrationPrescription',
                'notes': 'registrationNotes'
            };

            for (const [fieldName, errorMessage] of Object.entries(fieldErrors)) {
                const fieldId = fieldMap[fieldName];
                if (fieldId) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // 添加错误样式
                        field.classList.add('is-invalid');
                        
                        // 添加错误提示
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = errorMessage;
                        field.parentNode.appendChild(errorDiv);
                    }
                }
            }
        }

        // 保存挂号信息
        async function saveRegistration() {
            // 防止重复提交
            const saveBtn = document.getElementById('saveRegistrationBtn');
            if (saveBtn.disabled) {
                return; // 如果按钮已禁用，直接返回
            }
            
            // 禁用保存按钮，防止重复点击
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';
            
            // 清除之前的错误提示
            clearRegistrationFieldErrors();

            // 获取表单数据
            const patientId = document.getElementById('registrationPatient').value;
            const doctorId = document.getElementById('registrationDoctor').value;
            const appointmentTime = document.getElementById('registrationAppointmentTime').value;
            const registrationFee = document.getElementById('registrationFee').value.trim();
            const status = document.getElementById('registrationStatus').value;
            const symptoms = document.getElementById('registrationSymptoms').value.trim();
            const diagnosis = document.getElementById('registrationDiagnosis').value.trim();
            const treatment = document.getElementById('registrationTreatment').value.trim();
            const prescription = document.getElementById('registrationPrescription').value.trim();
            const notes = document.getElementById('registrationNotes').value.trim();

            // 验证必填字段
            if (!patientId) {
                alert('请选择病人');
                document.getElementById('registrationPatient').focus();
                return;
            }
            
            if (!doctorId) {
                alert('请选择医生');
                document.getElementById('registrationDoctor').focus();
                return;
            }
            
            if (!appointmentTime) {
                alert('请选择预约时间');
                document.getElementById('registrationAppointmentTime').focus();
                return;
            }

            if (!registrationFee || isNaN(parseFloat(registrationFee))) {
                alert('请输入有效的挂号费');
                document.getElementById('registrationFee').focus();
                return;
            }

            if (!status) {
                alert('请选择挂号状态');
                document.getElementById('registrationStatus').focus();
                return;
            }

            // 构建数据对象
            const registrationData = {
                patient: { id: parseInt(patientId) },
                doctor: { id: parseInt(doctorId) },
                appointmentTime: new Date(appointmentTime).toISOString(),
                registrationFee: parseFloat(registrationFee),
                status: status
            };

            // 添加可选字段
            if (symptoms && symptoms.trim() !== '') {
                registrationData.symptoms = symptoms.trim();
            }
            if (diagnosis && diagnosis.trim() !== '') {
                registrationData.diagnosis = diagnosis.trim();
            }
            if (treatment && treatment.trim() !== '') {
                registrationData.treatment = treatment.trim();
            }
            if (prescription && prescription.trim() !== '') {
                registrationData.prescription = prescription.trim();
            }
            if (notes && notes.trim() !== '') {
                registrationData.notes = notes.trim();
            }

            const registrationId = document.getElementById('registrationId').value;
            const isEdit = registrationId && registrationId.trim() !== '';

            try {
                const token = localStorage.getItem('token');
                const url = isEdit ? `/api/registrations/${registrationId}` : '/api/registrations';
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('发送数据:', registrationData); // 调试日志
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registrationData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    const operation = isEdit ? 'UPDATE' : 'CREATE';
                    const successMessage = isEdit ? '挂号信息更新成功！' : '挂号创建成功！';
                    
                    alert(successMessage);
                    
                    // 发送通知
                    if (window.notificationHelper) {
                        try {
                            console.log('准备发送挂号通知...', operation);
                            // 获取病人和医生的名称
                            const patientSelect = document.getElementById('registrationPatient');
                            const doctorSelect = document.getElementById('registrationDoctor');
                            const patientName = patientSelect.options[patientSelect.selectedIndex]?.text || '未知病人';
                            const doctorName = doctorSelect.options[doctorSelect.selectedIndex]?.text || '未知医生';
                            
                            const notificationData = {
                                id: result.data?.id || registrationData.id,
                                patientName: patientName,
                                doctorName: doctorName,
                                appointmentTime: registrationData.appointmentTime
                            };
                            await window.notificationHelper.sendRegistrationNotification(operation.toLowerCase(), notificationData);
                            console.log('挂号通知发送成功');
                        } catch (notifyError) {
                            console.error('发送通知失败:', notifyError);
                        }
                    } else {
                        console.error('通知系统未初始化');
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('registrationModal')).hide();
                    loadRegistrations(); // 重新加载挂号列表
                } else {
                    // 处理验证错误
                    if (result.data && typeof result.data === 'object') {
                        // 显示字段级别的错误
                        showRegistrationFieldErrors(result.data);
                        alert('输入信息有误，请查看标红的字段提示并修正');
                    } else {
                        // 显示通用错误信息
                        alert('保存失败：' + (result.message || '未知错误'));
                    }
                }
            } catch (error) {
                console.error('保存挂号信息失败:', error);
                alert('保存失败，请稍后重试');
            } finally {
                // 恢复按钮状态
                saveBtn.disabled = false;
                saveBtn.textContent = '保存';
            }
        }

        // 删除挂号
        async function deleteRegistration(registrationId, patientName) {
            // 确认删除
            const confirmMessage = `确定要删除病人 "${patientName}" 的挂号记录吗？\n\n注意：删除后将无法恢复。`;
            
            if (!confirm(confirmMessage)) {
                return; // 用户取消删除
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/registrations/${registrationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`挂号记录删除成功！`);
                        
                        // 发送删除通知
                        if (window.notificationHelper) {
                            try {
                                const notificationData = {
                                    id: registrationId,
                                    patientName: patientName
                                };
                                await window.notificationHelper.sendRegistrationNotification('delete', notificationData);
                            } catch (notifyError) {
                                console.error('发送通知失败:', notifyError);
                            }
                        }
                        
                        loadRegistrations(); // 重新加载挂号列表
                    } else {
                        alert('删除失败：' + result.message);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('删除失败:', response.status, errorText);
                    
                    if (response.status === 403) {
                        alert('权限不足：只有管理员可以删除挂号');
                    } else {
                        alert('删除失败，请稍后重试');
                    }
                }
            } catch (error) {
                console.error('删除挂号失败:', error);
                alert('删除失败，请稍后重试');
            }
        }

        // ================== 收费管理相关函数 ==================

        // 加载收费数据
        async function loadPayments() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/payments?page=0&size=10&sortBy=id&sortDir=desc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const tbody = document.getElementById('paymentsTable');
                        tbody.innerHTML = result.data.content.map(payment => {
                            const createdAt = new Date(payment.createdAt).toLocaleString('zh-CN');
                            const statusBadge = getPaymentStatusBadge(payment.status);
                            const typeName = getPaymentTypeName(payment.paymentType);
                            
                            return `
                                <tr>
                                    <td>${payment.patient?.name || '未知'}</td>
                                    <td>${typeName}</td>
                                    <td>¥${payment.amount?.toFixed(2) || '0.00'}</td>
                                    <td>${payment.quantity || 1}</td>
                                    <td>${payment.paymentMethod || '-'}</td>
                                    <td>${statusBadge}</td>
                                    <td>${createdAt}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewPayment(${payment.id})">查看</button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="editPayment(${payment.id})">编辑</button>
                                        ${payment.status === 'PENDING' ? `<button class="btn btn-sm btn-outline-success" onclick="processPayment(${payment.id})">支付</button>` : ''}
                                        ${payment.status === 'PAID' ? `<button class="btn btn-sm btn-outline-info" onclick="processRefund(${payment.id})">退费</button>` : ''}
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePayment(${payment.id}, '${payment.patient?.name}')">删除</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('加载收费数据失败:', error);
                document.getElementById('paymentsTable').innerHTML = '<tr><td colspan="8" class="text-center text-danger">加载失败</td></tr>';
            }
        }

        // 获取支付状态徽章
        function getPaymentStatusBadge(status) {
            const badges = {
                'PENDING': '<span class="badge bg-warning">待支付</span>',
                'PAID': '<span class="badge bg-success">已支付</span>',
                'REFUNDED': '<span class="badge bg-secondary">已退费</span>'
            };
            return badges[status] || '<span class="badge bg-light">未知</span>';
        }

        // 获取支付类型名称
        function getPaymentTypeName(type) {
            const types = {
                'REGISTRATION': '挂号费',
                'MEDICINE': '药费',
                'EXAMINATION': '检查费',
                'TREATMENT': '治疗费'
            };
            return types[type] || '未知类型';
        }

        // 显示添加收费模态框
        function showAddPaymentModal() {
            document.getElementById('paymentModalTitle').textContent = '新建收费记录';
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentId').value = '';
            
            // 设置默认值
            document.getElementById('paymentQuantity').value = 1;
            document.getElementById('paymentStatus').value = 'PENDING';
            
            // 启用编辑模式
            const formInputs = document.querySelectorAll('#paymentForm input, #paymentForm select, #paymentForm textarea');
            formInputs.forEach(input => input.disabled = false);
            
            document.getElementById('savePaymentBtn').style.display = 'block';
            
            // 加载选项
            Promise.all([loadPatientOptions('paymentPatient'), loadRegistrationOptions()]).then(() => {
                // 统一的Modal实例管理
                const modalElement = document.getElementById('paymentModal');
                let modal = bootstrap.Modal.getInstance(modalElement);
                if (!modal) {
                    modal = new bootstrap.Modal(modalElement);
                }
                modal.show();
            });
        }

        // 查看收费记录
        async function viewPayment(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const payment = result.data;
                        
                        // 填充基本字段
                        document.getElementById('paymentModalTitle').textContent = '查看收费记录';
                        document.getElementById('paymentId').value = payment.id;
                        
                        // 安全地处理病人信息
                        if (payment.patient) {
                            const genderText = payment.patient.gender === 'MALE' ? '男' : '女';
                            document.getElementById('paymentPatient').innerHTML = `<option value="${payment.patient.id}" selected>${payment.patient.name} (${genderText})</option>`;
                        } else {
                            document.getElementById('paymentPatient').innerHTML = '<option value="" selected>病人信息缺失</option>';
                        }
                        document.getElementById('paymentType').value = payment.paymentType;
                        document.getElementById('paymentAmount').value = payment.amount?.toFixed(2) || '0.00';
                        document.getElementById('paymentQuantity').value = payment.quantity || 1;
                        document.getElementById('paymentMethod').value = payment.paymentMethod || '';
                        document.getElementById('paymentDescription').value = payment.description || '';
                        
                        // 隐藏字段赋值
                        document.getElementById('paymentStatus').value = payment.status || 'PENDING';
                        document.getElementById('paymentTransactionId').value = payment.transactionId || '';
                        document.getElementById('paymentNotes').value = payment.notes || '';
                        
                        // 关联挂号字段
                        if (payment.registration) {
                            document.getElementById('paymentRegistration').innerHTML = `<option value="${payment.registration.id}" selected>【关联】${payment.registration.patient?.name} → ${payment.registration.doctor?.name}</option>`;
                        } else {
                            document.getElementById('paymentRegistration').innerHTML = '<option value="" selected>不关联任何挂号</option>';
                        }
                        
                        // 设为只读模式
                        const formInputs = document.querySelectorAll('#paymentForm input:not([type="hidden"]), #paymentForm select, #paymentForm textarea');
                        formInputs.forEach(input => input.disabled = true);
                        
                        document.getElementById('savePaymentBtn').style.display = 'none';
                        
                        // 统一的Modal实例管理
                        const modalElement = document.getElementById('paymentModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    } else {
                        alert('获取收费记录失败：' + result.message);
                    }
                } else {
                    alert('获取收费记录失败，请稍后重试');
                }
            } catch (error) {
                console.error('获取收费记录失败:', error);
                alert('获取收费记录失败，请稍后重试');
            }
        }

        // 编辑收费记录
        async function editPayment(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const payment = result.data;
                        
                        // 设置标题和ID
                        document.getElementById('paymentModalTitle').textContent = '编辑收费记录';
                        document.getElementById('paymentId').value = payment.id;
                        
                        // 先加载选项，再设置选中值
                        await Promise.all([loadPatientOptions('paymentPatient'), loadRegistrationOptions()]);
                        
                        // 填充表单数据
                        if (payment.patient) {
                            document.getElementById('paymentPatient').value = payment.patient.id;
                        } else {
                            document.getElementById('paymentPatient').value = '';
                        }
                        document.getElementById('paymentType').value = payment.paymentType;
                        document.getElementById('paymentAmount').value = payment.amount?.toFixed(2) || '0.00';
                        document.getElementById('paymentQuantity').value = payment.quantity || 1;
                        document.getElementById('paymentMethod').value = payment.paymentMethod || '';
                        document.getElementById('paymentDescription').value = payment.description || '';
                        
                        // 隐藏字段赋值
                        document.getElementById('paymentStatus').value = payment.status || 'PENDING';
                        document.getElementById('paymentTransactionId').value = payment.transactionId || '';
                        document.getElementById('paymentNotes').value = payment.notes || '';
                        
                        // 设置关联挂号
                        if (payment.registration) {
                            document.getElementById('paymentRegistration').value = payment.registration.id;
                        } else {
                            document.getElementById('paymentRegistration').value = '';
                        }
                        
                        // 启用编辑模式（只启用可见的字段）
                        const formInputs = document.querySelectorAll('#paymentForm input:not([type="hidden"]), #paymentForm select, #paymentForm textarea');
                        formInputs.forEach(input => input.disabled = false);
                        
                        document.getElementById('savePaymentBtn').style.display = 'block';
                        
                        // 统一的Modal实例管理
                        const modalElement = document.getElementById('paymentModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    } else {
                        alert('获取收费记录失败：' + result.message);
                    }
                } else {
                    alert('获取收费记录失败，请稍后重试');
                }
            } catch (error) {
                console.error('获取收费记录失败:', error);
                alert('获取收费记录失败，请稍后重试');
            }
        }

        // 保存收费记录
        async function savePayment() {
            // 防止重复提交
            const saveBtn = document.getElementById('savePaymentBtn');
            if (saveBtn.disabled) {
                return; // 如果按钮已禁用，直接返回
            }
            
            // 禁用保存按钮，防止重复点击
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';
            
            const id = document.getElementById('paymentId').value;
            const patientId = document.getElementById('paymentPatient').value;
            const paymentType = document.getElementById('paymentType').value;
            const amount = document.getElementById('paymentAmount').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            // 可选字段
            const quantity = document.getElementById('paymentQuantity').value || 1;
            const description = document.getElementById('paymentDescription').value;
            const registrationId = document.getElementById('paymentRegistration').value;

            // 简单验证：只检查核心必填字段
            if (!patientId) {
                alert('请选择要收费的病人');
                return;
            }
            if (!paymentType) {
                alert('请选择收费类型');
                return;
            }
            if (!amount || amount <= 0) {
                alert('请输入正确的收费金额');
                return;
            }
            if (!paymentMethod) {
                alert('请选择支付方式');
                return;
            }

            const paymentData = {
                patient: { id: parseInt(patientId) },
                paymentType: paymentType,
                amount: parseFloat(amount),
                quantity: parseInt(quantity),
                paymentMethod: paymentMethod,
                status: 'PENDING', // 新建收费单默认为待支付
                description: description || null,
                registration: registrationId ? { id: parseInt(registrationId) } : null
            };

            try {
                const token = localStorage.getItem('token');
                const url = id ? `/api/payments/${id}` : '/api/payments';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(paymentData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const operation = id ? 'UPDATE' : 'CREATE';
                        const successMessage = id ? '收费记录更新成功！' : '收费记录创建成功！可以在列表中点击"支付"按钮完成收费。';
                        
                        alert(successMessage);
                        
                        // 发送通知
                        if (window.notificationHelper) {
                            try {
                                // 获取病人名称
                                const patientSelect = document.getElementById('paymentPatient');
                                const patientName = patientSelect.options[patientSelect.selectedIndex]?.text || '未知病人';
                                
                                const notificationData = {
                                    id: result.data?.id || id,
                                    patientName: patientName,
                                    amount: paymentData.amount,
                                    paymentType: paymentData.paymentType
                                };
                                await window.notificationHelper.sendPaymentNotification(operation.toLowerCase(), notificationData);
                            } catch (notifyError) {
                                console.error('发送通知失败:', notifyError);
                            }
                        }
                        
                        bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                        loadPayments(); // 重新加载收费列表
                    } else {
                        alert('保存失败：' + result.message);
                    }
                } else {
                    alert('保存失败，请检查网络连接或稍后重试');
                }
            } catch (error) {
                console.error('保存收费记录失败:', error);
                alert('保存失败，请稍后重试');
            } finally {
                // 恢复按钮状态
                saveBtn.disabled = false;
                saveBtn.textContent = '保存';
            }
        }

        // 删除收费记录
        async function deletePayment(id, patientName) {
            if (!confirm(`确定要删除病人"${patientName}"的收费记录吗？此操作无法撤销。`)) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        loadPayments(); // 重新加载收费列表
                    } else {
                        alert('删除失败：' + result.message);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('删除失败:', response.status, errorText);
                    
                    if (response.status === 403) {
                        alert('权限不足：只有管理员可以删除收费记录');
                    } else {
                        alert('删除失败，请稍后重试');
                    }
                }
            } catch (error) {
                console.error('删除收费记录失败:', error);
                alert('删除失败，请稍后重试');
            }
        }

        // 处理支付
        async function processPayment(id) {
            if (!confirm('确认病人已经付款了吗？点击确定后将标记为"已支付"。')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${id}/pay?transactionId=`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('✅ 支付成功！该收费记录已标记为"已支付"状态。');
                        loadPayments(); // 重新加载收费列表
                    } else {
                        alert('支付失败：' + result.message);
                    }
                } else {
                    alert('支付失败，请稍后重试');
                }
            } catch (error) {
                console.error('处理支付失败:', error);
                alert('支付失败，请稍后重试');
            }
        }

        // 处理退费
        async function processRefund(id) {
            if (!confirm('⚠️ 确定要给病人退费吗？\n\n退费后这笔收费记录将变成"已退费"状态，此操作无法撤销！')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${id}/refund`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('💰 退费成功！该收费记录已标记为"已退费"状态。请将款项退给病人。');
                        loadPayments(); // 重新加载收费列表
                    } else {
                        alert('退费失败：' + result.message);
                    }
                } else {
                    alert('退费失败，请稍后重试');
                }
            } catch (error) {
                console.error('处理退费失败:', error);
                alert('退费失败，请稍后重试');
            }
        }

        // 加载挂号选项（用于收费时关联挂号记录）
        async function loadRegistrationOptions() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/registrations?page=0&size=100&sortBy=id&sortDir=desc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const select = document.getElementById('paymentRegistration');
                        if (select) {
                            select.innerHTML = '<option value="">不关联任何挂号（推荐）</option>';
                            
                            // 只显示最近的挂号记录，让选择更简单
                            const recentRegistrations = result.data.content.slice(0, 10);
                            recentRegistrations.forEach(registration => {
                                const date = new Date(registration.createdAt).toLocaleDateString('zh-CN');
                                select.innerHTML += `<option value="${registration.id}">【${date}】${registration.patient?.name} → ${registration.doctor?.name}</option>`;
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('加载挂号选项失败:', error);
                // 即使加载失败也不影响主要功能
                const select = document.getElementById('paymentRegistration');
                if (select) {
                    select.innerHTML = '<option value="">不关联任何挂号</option>';
                }
            }
        }

        // ========== 药品管理相关函数 ==========

        // 全局变量
        let allMedicines = [];
        let filteredMedicines = [];

        // 加载药品数据
        async function loadMedicines() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/medicines?page=0&size=1000', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        allMedicines = result.data.content || [];
                        filteredMedicines = [...allMedicines];
                        displayMedicines(filteredMedicines);
                        updateMedicineStatistics();
                    } else {
                        console.error('加载药品数据失败:', result.message);
                        showCustomAlert('加载药品数据失败: ' + result.message, 'error', '错误');
                    }
                } else {
                    console.error('HTTP错误:', response.status);
                    showCustomAlert('无法连接到服务器', 'error', '网络错误');
                }
            } catch (error) {
                console.error('加载药品数据异常:', error);
                showCustomAlert('加载药品数据时发生错误', 'error', '系统错误');
            }
        }

        // 显示药品列表
        function displayMedicines(medicines) {
            const tbody = document.getElementById('medicinesTable');
            if (!tbody) return;

            if (medicines.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暂无药品数据</td></tr>';
                return;
            }

            tbody.innerHTML = medicines.map(medicine => {
                const stockStatus = getMedicineStockStatus(medicine.stock);
                const availableStatus = medicine.available ? 
                    '<span class="badge bg-success">可用</span>' : 
                    '<span class="badge bg-danger">停用</span>';

                return `
                    <tr data-medicine-id="${medicine.id}">
                        <td>
                            <strong>${medicine.name}</strong>
                            ${medicine.category ? `<br><small class="text-muted">${medicine.category}</small>` : ''}
                        </td>
                        <td><code>${medicine.code}</code></td>
                        <td>
                            <span class="badge bg-info">${medicine.category || '未分类'}</span>
                        </td>
                        <td>${medicine.specification}</td>
                        <td class="text-primary fw-bold">¥${medicine.price}/${medicine.unit}</td>
                        <td>
                            <span class="fw-bold ${stockStatus.class}">${medicine.stock}</span> 
                            <small class="text-muted">${medicine.unit}</small>
                        </td>
                        <td>
                            ${stockStatus.badge}
                            ${availableStatus}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewMedicineDetail(${medicine.id})" title="查看详情">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="editMedicine(${medicine.id})" title="编辑">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="updateMedicineStock(${medicine.id})" title="调整库存">
                                    <i class="bi bi-box-seam"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteMedicine(${medicine.id})" title="删除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 获取药品库存状态
        function getMedicineStockStatus(stock) {
            if (stock <= 0) {
                return {
                    badge: '<span class="badge bg-danger">缺货</span>',
                    class: 'text-danger'
                };
            } else if (stock <= 10) {
                return {
                    badge: '<span class="badge bg-warning">库存不足</span>',
                    class: 'text-warning'
                };
            } else {
                return {
                    badge: '<span class="badge bg-success">库存充足</span>',
                    class: 'text-success'
                };
            }
        }

        // 更新药品统计
        function updateMedicineStatistics() {
            const total = allMedicines.length;
            const sufficient = allMedicines.filter(m => m.stock > 10).length;
            const low = allMedicines.filter(m => m.stock > 0 && m.stock <= 10).length;
            const out = allMedicines.filter(m => m.stock <= 0).length;

            document.getElementById('totalMedicinesCount').textContent = total;
            document.getElementById('sufficientStockCount').textContent = sufficient;
            document.getElementById('lowStockCount').textContent = low;
            document.getElementById('outOfStockCount').textContent = out;
        }

        // 显示添加药品模态框
        function showAddMedicineModal() {
            document.getElementById('medicineModalLabel').textContent = '添加药品';
            document.getElementById('medicineForm').reset();
            document.getElementById('medicineId').value = '';
            document.getElementById('medicineAvailable').checked = true;
            clearMedicineFieldErrors();
            
            // 统一的Modal实例管理
            const modalElement = document.getElementById('medicineModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }

        // 编辑药品
        async function editMedicine(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/medicines/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const medicine = result.data;
                        
                        document.getElementById('medicineModalLabel').textContent = '编辑药品';
                        document.getElementById('medicineId').value = medicine.id;
                        document.getElementById('medicineName').value = medicine.name;
                        document.getElementById('medicineCode').value = medicine.code;
                        document.getElementById('medicineCategory').value = medicine.category || '';
                        document.getElementById('medicineSpecification').value = medicine.specification;
                        document.getElementById('medicineDosageForm').value = medicine.dosageForm || '';
                        document.getElementById('medicineUnit').value = medicine.unit;
                        document.getElementById('medicinePrice').value = medicine.price;
                        document.getElementById('medicineStock').value = medicine.stock;
                        document.getElementById('medicineManufacturer').value = medicine.manufacturer || '';
                        document.getElementById('medicineIndication').value = medicine.indication || '';
                        document.getElementById('medicineDosage').value = medicine.dosage || '';
                        document.getElementById('medicineSideEffects').value = medicine.sideEffects || '';
                        document.getElementById('medicineContraindications').value = medicine.contraindications || '';
                        document.getElementById('medicineAvailable').checked = medicine.available;
                        
                        clearMedicineFieldErrors();
                        
                        // 统一的Modal实例管理
                        const modalElement = document.getElementById('medicineModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('获取药品信息失败:', error);
                showCustomAlert('获取药品信息失败', 'error', '错误');
            }
        }

        // 保存药品
        async function saveMedicine() {
            // 防止重复提交
            const saveBtn = document.querySelector('#medicineModal .btn-primary');
            if (saveBtn && saveBtn.disabled) {
                return; // 如果按钮已禁用，直接返回
            }
            
            // 禁用保存按钮，防止重复点击
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '保存中...';
            }
            
            clearMedicineFieldErrors();
            
            const id = document.getElementById('medicineId').value;
            
            // 获取表单数据并进行基本验证
            const name = document.getElementById('medicineName').value.trim();
            const code = document.getElementById('medicineCode').value.trim().toUpperCase();
            const category = document.getElementById('medicineCategory').value;
            const specification = document.getElementById('medicineSpecification').value.trim();
            const unit = document.getElementById('medicineUnit').value;
            const price = parseFloat(document.getElementById('medicinePrice').value);
            const stock = parseInt(document.getElementById('medicineStock').value);
            
            // 前端验证
            if (!name) {
                showCustomAlert('请输入药品名称', 'warning', '验证错误');
                return;
            }
            if (!code || !/^[A-Z0-9]{4,20}$/.test(code)) {
                showCustomAlert('药品编码格式不正确，应为4-20位大写字母和数字组合', 'warning', '验证错误');
                return;
            }
            if (!category) {
                showCustomAlert('请选择药品分类', 'warning', '验证错误');
                return;
            }
            if (!specification) {
                showCustomAlert('请输入药品规格', 'warning', '验证错误');
                return;
            }
            if (!unit) {
                showCustomAlert('请选择药品单位', 'warning', '验证错误');
                return;
            }
            if (isNaN(price) || price <= 0) {
                showCustomAlert('请输入有效的药品价格', 'warning', '验证错误');
                return;
            }
            if (isNaN(stock) || stock < 0) {
                showCustomAlert('请输入有效的库存数量', 'warning', '验证错误');
                return;
            }
            
            const medicineData = {
                name: name,
                code: code,
                category: category,
                specification: specification,
                dosageForm: document.getElementById('medicineDosageForm').value.trim() || '',
                unit: unit,
                price: price,
                stock: stock,
                manufacturer: document.getElementById('medicineManufacturer').value.trim() || '',
                indication: document.getElementById('medicineIndication').value.trim() || '',
                dosage: document.getElementById('medicineDosage').value.trim() || '',
                sideEffects: document.getElementById('medicineSideEffects').value.trim() || '',
                contraindications: document.getElementById('medicineContraindications').value.trim() || '',
                available: document.getElementById('medicineAvailable').checked
            };

            try {
                const token = localStorage.getItem('token');
                const url = id ? `/api/medicines/${id}` : '/api/medicines';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(medicineData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const operation = id ? 'UPDATE' : 'CREATE';
                    const successMessage = id ? '药品更新成功' : '药品添加成功';
                    
                    showCustomAlert(successMessage, 'success', '成功');
                    
                    // 发送通知
                    if (window.notificationHelper) {
                        try {
                            const notificationData = {
                                id: result.data?.id || id,
                                name: name,
                                code: code,
                                stock: stock,
                                category: category
                            };
                            await window.notificationHelper.sendMedicineNotification(operation.toLowerCase(), notificationData);
                        } catch (notifyError) {
                            console.error('发送通知失败:', notifyError);
                        }
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('medicineModal')).hide();
                    loadMedicines();
                } else {
                    if (response.status === 400 && result.errors) {
                        showMedicineFieldErrors(result.errors);
                    } else {
                        showCustomAlert(result.message || '保存药品失败', 'error', '错误');
                    }
                }
            } catch (error) {
                console.error('保存药品失败:', error);
                showCustomAlert('保存药品时发生错误', 'error', '系统错误');
            } finally {
                // 恢复按钮状态
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '保存';
                }
            }
        }

        // 清除药品字段错误
        function clearMedicineFieldErrors() {
            const form = document.getElementById('medicineForm');
            form.querySelectorAll('.is-invalid').forEach(field => {
                field.classList.remove('is-invalid');
            });
            form.querySelectorAll('.invalid-feedback').forEach(feedback => {
                feedback.textContent = '';
            });
        }

        // 显示药品字段错误
        function showMedicineFieldErrors(errors) {
            const fieldMap = {
                'name': 'medicineName',
                'code': 'medicineCode',
                'category': 'medicineCategory',
                'specification': 'medicineSpecification',
                'unit': 'medicineUnit',
                'price': 'medicinePrice',
                'stock': 'medicineStock',
                'manufacturer': 'medicineManufacturer',
                'indication': 'medicineIndication',
                'dosage': 'medicineDosage',
                'sideEffects': 'medicineSideEffects',
                'contraindications': 'medicineContraindications'
            };

            Object.keys(errors).forEach(field => {
                const fieldId = fieldMap[field];
                if (fieldId) {
                    const fieldElement = document.getElementById(fieldId);
                    const feedbackElement = fieldElement.nextElementSibling;
                    
                    fieldElement.classList.add('is-invalid');
                    if (feedbackElement && feedbackElement.classList.contains('invalid-feedback')) {
                        feedbackElement.textContent = errors[field];
                    }
                }
            });
        }

        // 删除药品
        async function deleteMedicine(id) {
            const confirmed = await showCustomConfirm('确定要删除这个药品吗？\n删除后将无法恢复。', '确认删除');
            if (!confirmed) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/medicines/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showCustomAlert('药品删除成功', 'success', '成功');
                    loadMedicines();
                } else {
                    showCustomAlert(result.message || '删除药品失败', 'error', '错误');
                }
            } catch (error) {
                console.error('删除药品失败:', error);
                showCustomAlert('删除药品时发生错误', 'error', '系统错误');
            }
        }

        // 查看药品详情
        async function viewMedicineDetail(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/medicines/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        showMedicineDetailModal(result.data);
                    }
                }
            } catch (error) {
                console.error('获取药品详情失败:', error);
                showCustomAlert('获取药品详情失败', 'error', '错误');
            }
        }

        // 显示药品详情模态框
        function showMedicineDetailModal(medicine) {
            const stockStatus = getMedicineStockStatus(medicine.stock);
            
            const content = `
                <div class="row g-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-capsule-pill me-2"></i>${medicine.name}
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">药品编码</label>
                                        <div class="form-control-plaintext"><code>${medicine.code}</code></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">药品分类</label>
                                        <div class="form-control-plaintext">
                                            <span class="badge bg-info">${medicine.category || '未分类'}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">规格</label>
                                        <div class="form-control-plaintext">${medicine.specification}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">单位</label>
                                        <div class="form-control-plaintext">${medicine.unit}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">价格</label>
                                        <div class="form-control-plaintext text-primary fw-bold">¥${medicine.price}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">库存数量</label>
                                        <div class="form-control-plaintext">
                                            <span class="fw-bold ${stockStatus.class}">${medicine.stock}</span> ${medicine.unit}
                                        </div>
                                    </div>
                                    ${medicine.manufacturer ? `
                                        <div class="col-12">
                                            <label class="form-label text-muted">生产厂家</label>
                                            <div class="form-control-plaintext">${medicine.manufacturer}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-info-circle me-2"></i>状态信息
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label text-muted">可用状态</label>
                                    <div>
                                        ${medicine.available ? 
                                            '<span class="badge bg-success fs-6">可用</span>' : 
                                            '<span class="badge bg-danger fs-6">停用</span>'
                                        }
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted">库存状态</label>
                                    <div>${stockStatus.badge}</div>
                                </div>
                                <div>
                                    <label class="form-label text-muted">创建时间</label>
                                    <div class="form-control-plaintext">
                                        <small>${new Date(medicine.createdAt).toLocaleString()}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                ${medicine.indication || medicine.dosage || medicine.sideEffects || medicine.contraindications ? `
                    <div class="mt-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-book me-2"></i>药品说明
                                </h6>
                            </div>
                            <div class="card-body">
                                ${medicine.indication ? `
                                    <div class="mb-3">
                                        <h6 class="text-primary">
                                            <i class="bi bi-check-circle me-2"></i>适应症
                                        </h6>
                                        <p class="mb-0">${medicine.indication}</p>
                                    </div>
                                ` : ''}
                                
                                ${medicine.dosage ? `
                                    <div class="mb-3">
                                        <h6 class="text-info">
                                            <i class="bi bi-clock me-2"></i>用法用量
                                        </h6>
                                        <p class="mb-0">${medicine.dosage}</p>
                                    </div>
                                ` : ''}
                                
                                ${medicine.sideEffects ? `
                                    <div class="mb-3">
                                        <h6 class="text-warning">
                                            <i class="bi bi-exclamation-triangle me-2"></i>不良反应
                                        </h6>
                                        <p class="mb-0">${medicine.sideEffects}</p>
                                    </div>
                                ` : ''}
                                
                                ${medicine.contraindications ? `
                                    <div class="mb-0">
                                        <h6 class="text-danger">
                                            <i class="bi bi-x-circle me-2"></i>禁忌症
                                        </h6>
                                        <p class="mb-0">${medicine.contraindications}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('medicineDetailContent').innerHTML = content;
            // 统一的Modal实例管理
            const modalElement = document.getElementById('medicineDetailModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }

        // 按分类筛选药品
        function filterMedicinesByCategory() {
            const category = document.getElementById('medicineCategoryFilter').value;
            applyMedicineFilters();
        }

        // 按库存状态筛选药品
        function filterMedicinesByStock() {
            const stockFilter = document.getElementById('medicineStockFilter').value;
            applyMedicineFilters();
        }

        // 应用药品筛选
        function applyMedicineFilters() {
            const category = document.getElementById('medicineCategoryFilter').value;
            const stockFilter = document.getElementById('medicineStockFilter').value;
            const searchTerm = document.getElementById('medicineSearchInput').value.toLowerCase();

            filteredMedicines = allMedicines.filter(medicine => {
                // 分类筛选
                if (category && medicine.category !== category) {
                    return false;
                }

                // 库存状态筛选
                if (stockFilter) {
                    if (stockFilter === 'sufficient' && medicine.stock <= 10) return false;
                    if (stockFilter === 'low' && (medicine.stock <= 0 || medicine.stock > 10)) return false;
                    if (stockFilter === 'out' && medicine.stock > 0) return false;
                }

                // 搜索筛选
                if (searchTerm) {
                    return medicine.name.toLowerCase().includes(searchTerm) ||
                           medicine.code.toLowerCase().includes(searchTerm) ||
                           (medicine.manufacturer && medicine.manufacturer.toLowerCase().includes(searchTerm));
                }

                return true;
            });

            displayMedicines(filteredMedicines);
        }

        // 处理药品搜索键盘事件
        function handleMedicineSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchMedicinesAdmin();
            }
        }

        // 管理端药品搜索
        function searchMedicinesAdmin() {
            applyMedicineFilters();
        }

        // 初始化常用药品数据
        async function initializeMedicineData() {
            const confirmed = await showCustomConfirm(
                '确定要初始化常用药品数据吗？\n\n这将添加约50种常用药品到数据库中。\n如果药品已存在，将跳过添加。', 
                '初始化药品数据'
            );
            if (!confirmed) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/medicines/init-common-medicines', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showCustomAlert(`成功初始化 ${result.data.added} 种常用药品！\n跳过 ${result.data.skipped} 种已存在的药品。`, 'success', '初始化完成');
                    loadMedicines();
                } else {
                    showCustomAlert(result.message || '初始化药品数据失败', 'error', '错误');
                }
            } catch (error) {
                console.error('初始化药品数据失败:', error);
                showCustomAlert('初始化药品数据时发生错误', 'error', '系统错误');
            }
        }

        // 调整药品库存
        async function updateMedicineStock(id) {
            const medicine = allMedicines.find(m => m.id === id);
            if (!medicine) return;

            const newStock = prompt(`请输入 "${medicine.name}" 的新库存数量：\n当前库存：${medicine.stock} ${medicine.unit}`, medicine.stock);
            if (newStock === null) return;

            const stockNumber = parseInt(newStock);
            if (isNaN(stockNumber) || stockNumber < 0) {
                showCustomAlert('请输入有效的库存数量（非负整数）', 'warning', '输入错误');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/medicines/${id}/stock?quantity=${stockNumber}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showCustomAlert(`${medicine.name} 库存已更新为 ${stockNumber} ${medicine.unit}`, 'success', '库存更新成功');
                    loadMedicines();
                } else {
                    showCustomAlert(result.message || '更新库存失败', 'error', '错误');
                }
            } catch (error) {
                console.error('更新库存失败:', error);
                showCustomAlert('更新库存时发生错误', 'error', '系统错误');
            }
        }
    </script>

    <!-- 收费信息模态框 -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalTitle">收费信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="paymentId">
                        
                        <!-- 基本收费信息 -->
                        <div class="alert alert-info">
                            <small><strong>💡 操作说明：</strong> 填写基本信息创建收费单，然后可以点击"支付"按钮完成收费</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="paymentPatient" class="form-label">选择病人 *</label>
                                <select class="form-select" id="paymentPatient" required>
                                    <option value="">请选择要收费的病人</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="paymentType" class="form-label">收费类型 *</label>
                                <select class="form-select" id="paymentType" required>
                                    <option value="">请选择收费类型</option>
                                    <option value="REGISTRATION">挂号费（病人挂号时收取）</option>
                                    <option value="MEDICINE">药费（医生开药时收取）</option>
                                    <option value="EXAMINATION">检查费（医生安排检查时收取）</option>
                                    <option value="TREATMENT">治疗费（医生治疗时收取）</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="paymentAmount" class="form-label">收费金额（元）*</label>
                                <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0" required placeholder="例如：50.00">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="paymentMethod" class="form-label">支付方式 *</label>
                                <select class="form-select" id="paymentMethod" required>
                                    <option value="">病人如何付款</option>
                                    <option value="现金">现金</option>
                                    <option value="支付宝">支付宝</option>
                                    <option value="微信支付">微信支付</option>
                                    <option value="银行卡">银行卡</option>
                                    <option value="医保">医保</option>
                                </select>
                            </div>
                        </div>

                        <!-- 可选信息 -->
                        <hr>
                        <h6 class="mb-3 text-secondary">可选信息（不填也可以）</h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="paymentRegistration" class="form-label">关联挂号 <small class="text-muted">（如果这笔费用是因为某次挂号产生的）</small></label>
                                <select class="form-select" id="paymentRegistration">
                                    <option value="">不关联任何挂号</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="paymentQuantity" class="form-label">数量 <small class="text-muted">（默认为1）</small></label>
                                <input type="number" class="form-control" id="paymentQuantity" value="1" min="1">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="paymentDescription" class="form-label">收费说明 <small class="text-muted">（例如：感冒药费、血常规检查费等）</small></label>
                            <textarea class="form-control" id="paymentDescription" rows="2" placeholder="可以写明具体的收费项目..."></textarea>
                        </div>
                        
                        <!-- 隐藏的高级字段 -->
                        <input type="hidden" id="paymentStatus" value="PENDING">
                        <input type="hidden" id="paymentTransactionId">
                        <input type="hidden" id="paymentNotes">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="savePaymentBtn" onclick="savePayment()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 病人信息模态框 -->
    <div class="modal fade" id="patientModal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patientModalTitle">病人信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="patientForm">
                        <input type="hidden" id="patientId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patientName" class="form-label">姓名 *</label>
                                <input type="text" class="form-control" id="patientName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patientGender" class="form-label">性别 *</label>
                                <select class="form-select" id="patientGender" required>
                                    <option value="">请选择</option>
                                    <option value="MALE">男</option>
                                    <option value="FEMALE">女</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patientBirthDate" class="form-label">出生日期 *</label>
                                <input type="date" class="form-control" id="patientBirthDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patientPhone" class="form-label">电话</label>
                                <input type="tel" class="form-control" id="patientPhone">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="patientAddress" class="form-label">地址</label>
                            <input type="text" class="form-control" id="patientAddress">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patientIdCard" class="form-label">身份证号 *</label>
                                <input type="text" class="form-control" id="patientIdCard" required maxlength="18">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patientEmergencyContact" class="form-label">紧急联系人</label>
                                <input type="text" class="form-control" id="patientEmergencyContact">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="patientEmergencyPhone" class="form-label">紧急联系人电话</label>
                            <input type="tel" class="form-control" id="patientEmergencyPhone">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="savePatientBtn" onclick="savePatient()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 医生信息模态框 -->
    <div class="modal fade" id="doctorModal" tabindex="-1" aria-labelledby="doctorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="doctorModalTitle">医生信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="doctorForm">
                        <input type="hidden" id="doctorId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="doctorName" class="form-label">姓名 *</label>
                                <input type="text" class="form-control" id="doctorName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="doctorGender" class="form-label">性别 *</label>
                                <select class="form-select" id="doctorGender" required>
                                    <option value="">请选择</option>
                                    <option value="MALE">男</option>
                                    <option value="FEMALE">女</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="doctorDepartment" class="form-label">科室 *</label>
                                <input type="text" class="form-control" id="doctorDepartment" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="doctorTitle" class="form-label">职称 *</label>
                                <input type="text" class="form-control" id="doctorTitle" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="doctorPhone" class="form-label">电话</label>
                                <input type="tel" class="form-control" id="doctorPhone" placeholder="例：13800138000 或 010-12345678">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="doctorEmail" class="form-label">邮箱</label>
                                <input type="email" class="form-control" id="doctorEmail" placeholder="例：doctor@hospital.com">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="doctorConsultationFee" class="form-label">挂号费（元）</label>
                                <input type="number" class="form-control" id="doctorConsultationFee" step="0.01" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="doctorAvailable" checked>
                                    <label class="form-check-label" for="doctorAvailable">
                                        可用状态
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="doctorSpecialization" class="form-label">专长</label>
                            <textarea class="form-control" id="doctorSpecialization" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="doctorIntroduction" class="form-label">简介</label>
                            <textarea class="form-control" id="doctorIntroduction" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="saveDoctorBtn" onclick="saveDoctor()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 挂号信息模态框 -->
    <div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registrationModalTitle">挂号信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registrationForm">
                        <input type="hidden" id="registrationId">
                        
                        <!-- 基本信息 -->
                        <h6 class="mb-3 text-primary">基本信息</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="registrationPatient" class="form-label">病人 *</label>
                                <select class="form-select" id="registrationPatient" required>
                                    <option value="">请选择病人</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="registrationDoctor" class="form-label">医生 *</label>
                                <select class="form-select" id="registrationDoctor" required onchange="onDoctorChange()">
                                    <option value="">请选择医生</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="registrationAppointmentTime" class="form-label">预约时间 *</label>
                                <input type="datetime-local" class="form-control" id="registrationAppointmentTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="registrationFee" class="form-label">挂号费（元）*</label>
                                <input type="number" class="form-control" id="registrationFee" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="registrationStatus" class="form-label">挂号状态 *</label>
                                <select class="form-select" id="registrationStatus" required>
                                    <option value="">请选择状态</option>
                                    <option value="PENDING">待就诊</option>
                                    <option value="IN_PROGRESS">就诊中</option>
                                    <option value="COMPLETED">已完成</option>
                                    <option value="CANCELLED">已取消</option>
                                </select>
                            </div>
                        </div>

                        <!-- 就诊信息 -->
                        <hr>
                        <h6 class="mb-3 text-primary">就诊信息</h6>
                        <div class="mb-3">
                            <label for="registrationSymptoms" class="form-label">症状</label>
                            <textarea class="form-control" id="registrationSymptoms" rows="2" placeholder="患者主诉症状..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="registrationDiagnosis" class="form-label">诊断</label>
                            <textarea class="form-control" id="registrationDiagnosis" rows="2" placeholder="医生诊断结果..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="registrationTreatment" class="form-label">治疗方案</label>
                            <textarea class="form-control" id="registrationTreatment" rows="2" placeholder="治疗方案和建议..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="registrationPrescription" class="form-label">处方</label>
                            <textarea class="form-control" id="registrationPrescription" rows="3" placeholder="开具的药物处方..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="registrationNotes" class="form-label">备注</label>
                            <textarea class="form-control" id="registrationNotes" rows="2" placeholder="其他备注信息..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="saveRegistrationBtn" onclick="saveRegistration()">保存</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
