<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜åå° - åŒ»é™¢é—¨è¯Šç³»ç»Ÿ</title>
    <!-- åŒ»é™¢å›¾æ ‡ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc3545'%3E%3Cpath d='M19 8h-2v3h-3v2h3v3h2v-3h3v-2h-3zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z'/%3E%3C/svg%3E">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        body {
            background: linear-gradient(135deg, #F6F8FA 0%, #E8F4FD 100%);
            font-family: 'Microsoft YaHei', system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Hiragino Sans GB, sans-serif;
            position: relative;
            min-height: 100vh;
        }
        
        /* æ·»åŠ è£…é¥°æ€§èƒŒæ™¯å…ƒç´  */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .sidebar {
            background: var(--primary-gradient);
            min-height: 100vh;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }
        
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            pointer-events: none;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8) !important;
            border-radius: 12px;
            margin: 4px 0;
            padding: 12px 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .nav-link:hover::before {
            left: 100%;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            color: white !important;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .card:hover::before {
            opacity: 1;
            transform: rotate(45deg) translate(50%, 50%);
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .content-area {
            padding: 30px;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
        .stats-card {
            background: var(--primary-gradient);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stats-card .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* å›¾æ ‡åœ†å½¢æ ·å¼ */
        .icon-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 15px;
            transition: transform .3s ease;
            font-size: 1.5rem;
        }
        
        .icon-circle:hover {
            transform: scale(1.1) rotate(5deg);
        }
        
        /* æŒ‰é’®æ°´æ³¢çº¹æ•ˆæœ */
        .btn {
            position: relative;
            overflow: hidden;
        }
        
        .btn .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            opacity: 0.6;
            background: rgba(255,255,255,0.5);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* Toast é€šçŸ¥æ ·å¼ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .custom-toast {
            min-width: 300px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        /* ä¾§è¾¹æ æ”¶ç¼©æ ·å¼ */
        .sidebar.collapsed {
            width: 80px;
            transition: width 0.3s ease;
        }
        
        .sidebar.collapsed .nav-link span {
            display: none;
        }
        
        .sidebar.collapsed .nav-link {
            justify-content: center;
            padding: 12px;
        }
        
        /* ç²’å­ç”»å¸ƒ */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        /* è¯å“ç®¡ç†æ ·å¼ - ä¸å…¶ä»–æ¿å—ä¿æŒä¸€è‡´ */
        .medicine-management-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 15px;
            padding: 1.5rem;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .icon-circle-medicine {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .btn-medicine-primary {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-medicine-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
            color: white;
            transform: translateY(-1px);
        }

        .btn-medicine-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-medicine-success:hover {
            background-color: #1e7e34;
            border-color: #1e7e34;
            color: white;
            transform: translateY(-1px);
        }

        .btn-medicine-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-medicine-info:hover {
            background-color: #117a8b;
            border-color: #117a8b;
            color: white;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- ç²’å­èƒŒæ™¯ç”»å¸ƒ -->
    <canvas id="particleCanvas"></canvas>
    
    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div class="toast-container"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- ä¾§è¾¹æ  -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0"><i class="bi bi-hospital"></i> <span>ç®¡ç†åå°</span></h4>
                        <button id="sidebarToggleBtn" class="btn btn-link text-white p-0" onclick="toggleSidebar()">
                            <i class="bi bi-list fs-4"></i>
                        </button>
                    </div>
                    <div id="userInfo" class="text-center mb-4">
                        <div class="icon-circle mx-auto mb-2">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <small>æ¬¢è¿ï¼Œ<span id="userName"></span></small>
                    </div>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <i class="bi bi-speedometer2 me-2"></i><span>ä»ªè¡¨æ¿</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('patients')">
                            <i class="bi bi-people me-2"></i><span>ç—…äººç®¡ç†</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('doctors')">
                            <i class="bi bi-person-badge me-2"></i><span>åŒ»ç”Ÿç®¡ç†</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('registrations')">
                            <i class="bi bi-clipboard-check me-2"></i><span>æŒ‚å·ç®¡ç†</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('payments')">
                            <i class="bi bi-credit-card me-2"></i><span>æ”¶è´¹ç®¡ç†</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('medicines')">
                            <i class="bi bi-capsule me-2"></i><span>è¯å“ç®¡ç†</span>
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('feedbacks')">
                            <i class="bi bi-chat-dots me-2"></i><span>æ„è§å»ºè®®</span>
                        </a>
                        <hr class="my-3">
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i><span>é€€å‡ºç™»å½•</span>
                        </a>
                    </nav>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="col-md-9 col-lg-10 content-area">
                <!-- ä»ªè¡¨æ¿ -->
                <div id="dashboard" class="section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-speedometer2 me-2"></i>ä»ªè¡¨æ¿</h2>
                        <span class="text-muted" id="currentTime"></span>
                    </div>

                    <!-- æ ¸å¿ƒç»Ÿè®¡æ•°æ® - ç°ä»£åŒ–è®¾è®¡ -->
                    <div class="row g-4 mb-5">
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="icon-circle">
                                    <i class="bi bi-people"></i>
                                </div>
                                <div class="stat-number" id="patientCount">-</div>
                                <div class="stat-label">ç—…äººæ€»æ•°</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card" style="background: var(--success-gradient);">
                                <div class="icon-circle">
                                    <i class="bi bi-person-badge"></i>
                                </div>
                                <div class="stat-number" id="doctorCount">-</div>
                                <div class="stat-label">åŒ»ç”Ÿæ€»æ•°</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card" style="background: var(--warning-gradient);">
                                <div class="icon-circle">
                                    <i class="bi bi-clipboard-check"></i>
                                </div>
                                <div class="stat-number" id="totalRegistrations">-</div>
                                <div class="stat-label">æŒ‚å·æ€»æ•°</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card" style="background: var(--secondary-gradient);">
                                <div class="icon-circle">
                                    <i class="bi bi-currency-dollar"></i>
                                </div>
                                <div class="stat-number" id="totalRevenue">-</div>
                                <div class="stat-label">æ€»æ”¶å…¥</div>
                            </div>
                        </div>
                    </div>

                    <!-- å¯è§†åŒ–å›¾è¡¨åŒºåŸŸ -->
                    <div class="row g-4 mb-5">
                        <div class="col-lg-8">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>ä¸šåŠ¡è¶‹åŠ¿</h5>
                                </div>
                                <div class="card-body d-flex align-items-center">
                                    <canvas id="chartLine" style="min-height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>æ•°æ®åˆ†å¸ƒ</h5>
                                </div>
                                <div class="card-body d-flex align-items-center justify-content-center">
                                    <canvas id="chartDonut" style="max-height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

        <!-- ç®€åŒ–ç»Ÿè®¡å›¾è¡¨ - å¯é€‰æ˜¾ç¤º -->
        <div class="row g-4 mt-5">
            <div class="col-md-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0">
                        <h5 class="mb-0 text-center">ç³»ç»Ÿè¿è¥æ¦‚è§ˆ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <h6 class="text-muted">çƒ­é—¨ç§‘å®¤</h6>
                                    <div id="topDepartment" class="fw-bold text-primary">-</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <h6 class="text-muted">å¾…å¤„ç†æŒ‚å·</h6>
                                    <div id="pendingRegistrations" class="fw-bold text-warning">-</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <h6 class="text-muted">å¾…æ”¯ä»˜è®¢å•</h6>
                                    <div id="pendingPayments" class="fw-bold text-danger">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                </div>

                <!-- ç—…äººç®¡ç† -->
                <div id="patients" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>ç—…äººç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="showAddPatientModal()">
                            â• æ·»åŠ ç—…äºº
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>å§“å</th>
                                            <th>æ€§åˆ«</th>
                                            <th>å¹´é¾„</th>
                                            <th>ç”µè¯</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patientsTable">
                                        <tr>
                                            <td colspan="5" class="text-center">æ­£åœ¨åŠ è½½...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŒ»ç”Ÿç®¡ç† -->
                <div id="doctors" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>åŒ»ç”Ÿç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="showAddDoctorModal()">
                            â• æ·»åŠ åŒ»ç”Ÿ
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>å§“å</th>
                                            <th>æ€§åˆ«</th>
                                            <th>ç§‘å®¤</th>
                                            <th>èŒç§°</th>
                                            <th>ç”µè¯</th>
                                            <th>æŒ‚å·è´¹</th>
                                            <th>çŠ¶æ€</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="doctorsTable">
                                        <tr>
                                            <td colspan="8" class="text-center">æ­£åœ¨åŠ è½½...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æŒ‚å·ç®¡ç† -->
                <div id="registrations" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>æŒ‚å·ç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="showAddRegistrationModal()">
                            â• æ–°å»ºæŒ‚å·
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ç—…äººå§“å</th>
                                            <th>åŒ»ç”Ÿå§“å</th>
                                            <th>ç§‘å®¤</th>
                                            <th>é¢„çº¦æ—¶é—´</th>
                                            <th>æŒ‚å·è´¹</th>
                                            <th>çŠ¶æ€</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="registrationsTable">
                                        <tr>
                                            <td colspan="7" class="text-center">æ­£åœ¨åŠ è½½...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="payments" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>æ”¶è´¹ç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="showAddPaymentModal()">
                            â• æ–°å»ºæ”¶è´¹
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ç—…äººå§“å</th>
                                            <th>æ”¶è´¹ç±»å‹</th>
                                            <th>é‡‘é¢</th>
                                            <th>æ•°é‡</th>
                                            <th>æ”¯ä»˜æ–¹å¼</th>
                                            <th>æ”¯ä»˜çŠ¶æ€</th>
                                            <th>åˆ›å»ºæ—¶é—´</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentsTable">
                                        <tr>
                                            <td colspan="8" class="text-center">æ­£åœ¨åŠ è½½...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¯å“ç®¡ç† -->
                <div id="medicines" class="section d-none">
                    <div class="medicine-management-header mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle-medicine me-3">
                                    <i class="bi bi-capsule fs-3"></i>
                                </div>
                                <div>
                                    <h2 class="mb-0">è¯å“ç®¡ç†</h2>
                                </div>
                            </div>
                            <div class="medicine-action-buttons">
                                <button class="btn btn-medicine-success me-2" onclick="showAddMedicineModal()">
                                    <i class="bi bi-plus-circle me-2"></i>æ·»åŠ è¯å“
                                </button>
                                <button class="btn btn-medicine-info me-2" onclick="initializeMedicineData()">
                                    <i class="bi bi-hospital me-2"></i>åˆå§‹åŒ–å¸¸ç”¨è¯å“
                                </button>
                                <button class="btn btn-medicine-primary" onclick="loadMedicines()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>åˆ·æ–°æ•°æ®
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- è¯å“åˆ†ç±»å’Œæœç´¢ -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">è¯å“åˆ†ç±»</label>
                                    <select class="form-select" id="medicineCategoryFilter" onchange="filterMedicinesByCategory()">
                                        <option value="">å…¨éƒ¨åˆ†ç±»</option>
                                        <option value="æ„Ÿå†’è¯">æ„Ÿå†’è¯</option>
                                        <option value="æ¶ˆç‚è¯">æ¶ˆç‚è¯</option>
                                        <option value="æ­¢ç—›è¯">æ­¢ç—›è¯</option>
                                        <option value="ç»´ç”Ÿç´ ">ç»´ç”Ÿç´ </option>
                                        <option value="æŠ—ç”Ÿç´ ">æŠ—ç”Ÿç´ </option>
                                        <option value="å¿ƒè¡€ç®¡è¯">å¿ƒè¡€ç®¡è¯</option>
                                        <option value="æ¶ˆåŒ–ç³»ç»Ÿè¯">æ¶ˆåŒ–ç³»ç»Ÿè¯</option>
                                        <option value="å‘¼å¸ç³»ç»Ÿè¯">å‘¼å¸ç³»ç»Ÿè¯</option>
                                        <option value="ç¥ç»ç³»ç»Ÿè¯">ç¥ç»ç³»ç»Ÿè¯</option>
                                        <option value="å¤–ç”¨è¯">å¤–ç”¨è¯</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">åº“å­˜çŠ¶æ€</label>
                                    <select class="form-select" id="medicineStockFilter" onchange="filterMedicinesByStock()">
                                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                        <option value="sufficient">åº“å­˜å……è¶³</option>
                                        <option value="low">åº“å­˜ä¸è¶³</option>
                                        <option value="out">ç¼ºè´§</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">æœç´¢è¯å“</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="medicineSearchInput" 
                                               placeholder="è¾“å…¥è¯å“åç§°æˆ–ç¼–ç " onkeypress="handleMedicineSearchKeyPress(event)">
                                        <button class="btn btn-outline-primary" onclick="searchMedicinesAdmin()">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¯å“ç»Ÿè®¡å¡ç‰‡ -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">æ€»è¯å“æ•°</h6>
                                            <h3 id="totalMedicinesCount">-</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-capsule-pill fs-1"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">åº“å­˜å……è¶³</h6>
                                            <h3 id="sufficientStockCount">-</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-check-circle fs-1"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">åº“å­˜ä¸è¶³</h6>
                                            <h3 id="lowStockCount">-</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-exclamation-triangle fs-1"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">ç¼ºè´§</h6>
                                            <h3 id="outOfStockCount">-</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-x-circle fs-1"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¯å“åˆ—è¡¨ -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>è¯å“åç§°</th>
                                            <th>ç¼–ç </th>
                                            <th>åˆ†ç±»</th>
                                            <th>è§„æ ¼</th>
                                            <th>ä»·æ ¼</th>
                                            <th>åº“å­˜</th>
                                            <th>çŠ¶æ€</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="medicinesTable">
                                        <tr>
                                            <td colspan="8" class="text-center">æ­£åœ¨åŠ è½½...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ„è§å»ºè®®ç®¡ç† -->
                <div id="feedbacks" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>æ„è§å»ºè®®ç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="loadFeedbacks()">
                            ğŸ”„ åˆ·æ–°æ•°æ®
                        </button>
                    </div>

                    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-white bg-primary">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-chat-dots"></i> æ€»åé¦ˆæ•°</h5>
                                    <p class="card-text fs-3" id="totalFeedbacks">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-warning">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-hourglass-split"></i> å¾…å¤„ç†</h5>
                                    <p class="card-text fs-3" id="pendingFeedbacks">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-success">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-check-circle"></i> å·²å¤„ç†</h5>
                                    <p class="card-text fs-3" id="resolvedFeedbacks">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-info">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-lightbulb"></i> å»ºè®®æ•°</h5>
                                    <p class="card-text fs-3" id="suggestionFeedbacks">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç­›é€‰å’Œæœç´¢ -->
                    <div class="card mb-4">
                        <div class="card-header">ç­›é€‰ä¸æœç´¢</div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="filterStatus" class="form-label">çŠ¶æ€</label>
                                    <select class="form-select" id="filterStatus" onchange="filterFeedbacks()">
                                        <option value="">æ‰€æœ‰</option>
                                        <option value="PENDING">å¾…å¤„ç†</option>
                                        <option value="PROCESSED">å·²å¤„ç†</option>
                                        <option value="CLOSED">å·²å…³é—­</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="filterType" class="form-label">ç±»å‹</label>
                                    <select class="form-select" id="filterType" onchange="filterFeedbacks()">
                                        <option value="">æ‰€æœ‰</option>
                                        <option value="æŠ•è¯‰">æŠ•è¯‰</option>
                                        <option value="å»ºè®®">å»ºè®®</option>
                                        <option value="è¡¨æ‰¬">è¡¨æ‰¬</option>
                                        <option value="å’¨è¯¢">å’¨è¯¢</option>
                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="searchKeyword" class="form-label">å…³é”®è¯</label>
                                    <input type="text" class="form-control" id="searchKeyword" placeholder="æœç´¢å§“åã€å†…å®¹" onkeyup="debounceSearchFeedbacks()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åé¦ˆåˆ—è¡¨ -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>è”ç³»äºº</th>
                                            <th>ç”µè¯/é‚®ç®±</th>
                                            <th>ç±»å‹</th>
                                            <th>å†…å®¹æ‘˜è¦</th>
                                            <th>æäº¤æ—¶é—´</th>
                                            <th>çŠ¶æ€</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="feedbacksTable">
                                        <tr>
                                            <td colspan="8" class="text-center">æ­£åœ¨åŠ è½½...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="noFeedbacksMessage" class="text-center text-muted py-4" style="display: none;">
                                <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
                                <p class="mt-2">æš‚æ— ç¬¦åˆæ¡ä»¶çš„åé¦ˆä¿¡æ¯</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘è¯å“æ¨¡æ€æ¡† -->
    <div class="modal fade" id="medicineModal" tabindex="-1" aria-labelledby="medicineModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="medicineModalLabel">æ·»åŠ è¯å“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="medicineForm">
                        <input type="hidden" id="medicineId">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">è¯å“åç§° <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="medicineName" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">è¯å“ç¼–ç  <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="medicineCode" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">è¯å“åˆ†ç±» <span class="text-danger">*</span></label>
                                <select class="form-select" id="medicineCategory" required>
                                    <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                                    <option value="æ„Ÿå†’è¯">æ„Ÿå†’è¯</option>
                                    <option value="æ¶ˆç‚è¯">æ¶ˆç‚è¯</option>
                                    <option value="æ­¢ç—›è¯">æ­¢ç—›è¯</option>
                                    <option value="ç»´ç”Ÿç´ ">ç»´ç”Ÿç´ </option>
                                    <option value="æŠ—ç”Ÿç´ ">æŠ—ç”Ÿç´ </option>
                                    <option value="å¿ƒè¡€ç®¡è¯">å¿ƒè¡€ç®¡è¯</option>
                                    <option value="æ¶ˆåŒ–ç³»ç»Ÿè¯">æ¶ˆåŒ–ç³»ç»Ÿè¯</option>
                                    <option value="å‘¼å¸ç³»ç»Ÿè¯">å‘¼å¸ç³»ç»Ÿè¯</option>
                                    <option value="ç¥ç»ç³»ç»Ÿè¯">ç¥ç»ç³»ç»Ÿè¯</option>
                                    <option value="å¤–ç”¨è¯">å¤–ç”¨è¯</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">è§„æ ¼ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="medicineSpecification" 
                                       placeholder="å¦‚ï¼š500mg" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">å‰‚å‹</label>
                                <select class="form-select" id="medicineDosageForm">
                                    <option value="">è¯·é€‰æ‹©å‰‚å‹</option>
                                    <option value="ç‰‡å‰‚">ç‰‡å‰‚</option>
                                    <option value="èƒ¶å›Š">èƒ¶å›Š</option>
                                    <option value="é¢—ç²’å‰‚">é¢—ç²’å‰‚</option>
                                    <option value="æ³¨å°„å‰‚">æ³¨å°„å‰‚</option>
                                    <option value="è½¯è†å‰‚">è½¯è†å‰‚</option>
                                    <option value="æ»´çœ¼å‰‚">æ»´çœ¼å‰‚</option>
                                    <option value="å£æœæ¶²">å£æœæ¶²</option>
                                    <option value="å–·é›¾å‰‚">å–·é›¾å‰‚</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">å•ä½ <span class="text-danger">*</span></label>
                                <select class="form-select" id="medicineUnit" required>
                                    <option value="">è¯·é€‰æ‹©å•ä½</option>
                                    <option value="ç‰‡">ç‰‡</option>
                                    <option value="ç²’">ç²’</option>
                                    <option value="ç“¶">ç“¶</option>
                                    <option value="ç›’">ç›’</option>
                                    <option value="æ”¯">æ”¯</option>
                                    <option value="è¢‹">è¢‹</option>
                                    <option value="ml">ml</option>
                                    <option value="g">g</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">ä»·æ ¼ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">Â¥</span>
                                    <input type="number" class="form-control" id="medicinePrice" 
                                           step="0.01" min="0" required>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">åº“å­˜æ•°é‡ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="medicineStock" 
                                       min="0" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">ç”Ÿäº§å‚å®¶</label>
                                <input type="text" class="form-control" id="medicineManufacturer">
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">é€‚åº”ç—‡</label>
                                <textarea class="form-control" id="medicineIndication" rows="3" 
                                          placeholder="æè¿°è¯å“çš„é€‚åº”ç—‡å’Œä¸»è¦ç”¨é€”"></textarea>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">ç”¨æ³•ç”¨é‡</label>
                                <textarea class="form-control" id="medicineDosage" rows="3" 
                                          placeholder="è¯¦ç»†è¯´æ˜ç”¨æ³•ç”¨é‡"></textarea>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">ä¸è‰¯ååº”</label>
                                <textarea class="form-control" id="medicineSideEffects" rows="2" 
                                          placeholder="åˆ—å‡ºå¯èƒ½çš„ä¸è‰¯ååº”"></textarea>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">ç¦å¿Œç—‡</label>
                                <textarea class="form-control" id="medicineContraindications" rows="2" 
                                          placeholder="åˆ—å‡ºç¦å¿Œç—‡å’Œæ³¨æ„äº‹é¡¹"></textarea>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="medicineAvailable" checked>
                                    <label class="form-check-label" for="medicineAvailable">
                                        è¯å“å¯ç”¨
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveMedicine()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯å“è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="medicineDetailModal" tabindex="-1" aria-labelledby="medicineDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="medicineDetailModalLabel">è¯å“è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="medicineDetailContent">
                    <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åé¦ˆè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="feedbackDetailModal" tabindex="-1" aria-labelledby="feedbackDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackDetailModalLabel">åé¦ˆè¯¦æƒ…ä¸å¤„ç†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>åé¦ˆID:</strong> <span id="detailId"></span></div>
                        <div class="col-md-6"><strong>æäº¤æ—¶é—´:</strong> <span id="detailCreatedAt"></span></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>è”ç³»äºº:</strong> <span id="detailContactName"></span></div>
                        <div class="col-md-6"><strong>è”ç³»ç”µè¯:</strong> <span id="detailContactPhone"></span></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>é‚®ç®±:</strong> <span id="detailContactEmail"></span></div>
                        <div class="col-md-6"><strong>åé¦ˆç±»å‹:</strong> <span id="detailFeedbackType"></span></div>
                    </div>
                    <div class="mb-3">
                        <strong>åé¦ˆå†…å®¹:</strong>
                        <div class="feedback-content border p-2 mt-2 bg-light" id="detailContent" style="white-space: pre-wrap; word-wrap: break-word; max-height: 150px; overflow-y: auto;"></div>
                    </div>
                    <div class="mb-3">
                        <strong>å½“å‰çŠ¶æ€:</strong> <span id="detailStatus"></span>
                    </div>
                    <hr>
                    <h6>å¤„ç†è®°å½•</h6>
                    <div class="mb-3">
                        <label for="resolutionNotes" class="form-label">å¤„ç†å¤‡æ³¨:</label>
                        <textarea class="form-control" id="resolutionNotes" rows="4" placeholder="è¯·è¾“å…¥å¤„ç†æ„è§æˆ–ç»“æœ" maxlength="500"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="processStatus" class="form-label">æ›´æ–°çŠ¶æ€:</label>
                            <select class="form-select" id="processStatus">
                                <option value="PENDING">å¾…å¤„ç†</option>
                                <option value="PROCESSED">å·²å¤„ç†</option>
                                <option value="CLOSED">å·²å…³é—­</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <strong>å¤„ç†äºº:</strong> <span id="detailResolvedBy"></span>
                            <br>
                            <strong>å¤„ç†æ—¶é—´:</strong> <span id="detailResolvedAt"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="saveProcessBtn" onclick="saveFeedbackProcess()">ä¿å­˜å¤„ç†</button>
                    <button type="button" class="btn btn-danger" id="deleteFeedbackBtn" onclick="deleteFeedback()">åˆ é™¤åé¦ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç¾åŒ–å¼¹å‡ºçª—å£ -->
    <div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="customAlertHeader">
                    <h5 class="modal-title" id="customAlertModalLabel">
                        <i class="bi bi-info-circle-fill" id="customAlertIcon"></i>
                        <span id="customAlertTitle">æç¤º</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                </div>
                <div class="modal-body" id="customAlertBody">
                    <div id="customAlertContent"></div>
                </div>
                <div class="modal-footer" id="customAlertFooter">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="customAlertOkBtn">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="customConfirmModalLabel">
                        <i class="bi bi-question-circle-fill"></i>
                        ç¡®è®¤æ“ä½œ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                </div>
                <div class="modal-body" id="customConfirmBody">
                    <div id="customConfirmContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-warning" id="customConfirmOkBtn">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- é€šçŸ¥ç³»ç»Ÿ -->
    <script src="notification-system.js"></script>
    <script>
        // ========== ç®¡ç†ç«¯å¢å¼ºåŠŸèƒ½ ==========
        
        // å…¨å±€å˜é‡
        let chartLine, chartDonut;
        let particles = [];
        
        // 1) æ•°å­—æ»šåŠ¨åŠ¨ç”»
        function animateNumber(el, to, isCurrency=false){
            const from = 0, dur = 800, start = performance.now();
            function step(now){
                const p = Math.min((now - start)/dur, 1);
                const val = Math.round(from + (to-from)*p);
                el.textContent = isCurrency ? ('Â¥' + (val.toFixed ? val.toFixed(2) : val).toString()) : String(val);
                if(p<1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        // 2) Toast é€šçŸ¥ç³»ç»Ÿ
        function showToast(message, variant='success') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast custom-toast align-items-center text-white bg-${variant} border-0 show`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            toastContainer.appendChild(toast);
            
            const bootstrapToast = new bootstrap.Toast(toast, { delay: 3000 });
            bootstrapToast.show();
            
            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3500);
        }

        // 3) ä¾§è¾¹æ æ”¶ç¼©åŠŸèƒ½
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // 4) æŒ‰é’®æ°´æ³¢çº¹æ•ˆæœ
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn');
            if (!btn) return;
            
            const rect = btn.getBoundingClientRect();
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            ripple.style.left = (e.clientX - rect.left) + 'px';
            ripple.style.top = (e.clientY - rect.top) + 'px';
            ripple.style.width = ripple.style.height = '20px';
            
            btn.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        });

        // 5) ç²’å­èƒŒæ™¯åŠ¨ç”»
        function initParticles() {
            const canvas = document.getElementById('particleCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // åˆ›å»ºç²’å­
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 2 + 1,
                    opacity: Math.random() * 0.5 + 0.2
                });
            }

            function animateParticles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                particles.forEach(particle => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    if (particle.x < 0 || particle.x > canvas.width) particle.vx *= -1;
                    if (particle.y < 0 || particle.y > canvas.height) particle.vy *= -1;
                    
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(102, 126, 234, ${particle.opacity})`;
                    ctx.fill();
                });
                
                requestAnimationFrame(animateParticles);
            }
            
            animateParticles();
            
            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // 6) å›¾è¡¨åˆå§‹åŒ–
        function initCharts() {
            const lineCanvas = document.getElementById('chartLine');
            const donutCanvas = document.getElementById('chartDonut');
            
            if (lineCanvas) {
                chartLine = new Chart(lineCanvas, {
                    type: 'line',
                    data: {
                        labels: ['08:00', '10:00', '12:00', '14:00', '16:00', '18:00'],
                        datasets: [{
                            label: 'æŒ‚å·æ•°',
                            data: [0, 0, 0, 0, 0, 0],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'æ”¶å…¥(Â¥)',
                            data: [0, 0, 0, 0, 0, 0],
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'æŒ‚å·æ•°'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'æ”¶å…¥(Â¥)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¶é—´'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        }
                    }
                });
            }

            if (donutCanvas) {
                chartDonut = new Chart(donutCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['å·²æ”¯ä»˜', 'å¾…æ”¯ä»˜', 'å·²é€€æ¬¾'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                '#667eea',
                                '#f093fb',
                                '#43e97b'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // åˆå§‹åŒ–åç«‹å³åŠ è½½æ•°æ®
            loadChartData();
        }
        
        // åŠ è½½å›¾è¡¨æ•°æ®
        async function loadChartData() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                // åŠ è½½æ—¶é—´åºåˆ—æ•°æ®
                const timeSeriesResponse = await fetch('/api/dashboard/time-series', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (timeSeriesResponse.ok) {
                    const timeSeriesResult = await timeSeriesResponse.json();
                    if (timeSeriesResult.success && chartLine) {
                        const data = timeSeriesResult.data;
                        chartLine.data.labels = data.labels;
                        chartLine.data.datasets[0].data = data.registrationData;
                        chartLine.data.datasets[1].data = data.revenueData.map(val => parseFloat(val));
                        chartLine.update('active');
                    }
                }
                
                // åŠ è½½ç»Ÿè®¡æ•°æ®æ›´æ–°ç”œç”œåœˆå›¾
                const statsResponse = await fetch('/api/dashboard/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (statsResponse.ok) {
                    const statsResult = await statsResponse.json();
                    if (statsResult.success && chartDonut) {
                        const stats = statsResult.data;
                        const paymentStats = stats.paymentStatusStats || {};
                        
                        chartDonut.data.datasets[0].data = [
                            paymentStats.PAID || 0,
                            paymentStats.PENDING || 0,
                            paymentStats.REFUNDED || 0
                        ];
                        chartDonut.update('active');
                    }
                }
                
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // 7) å¡ç‰‡æ¸©å’Œç¾åŒ–æ•ˆæœ
        function addCardEffects() {
            document.querySelectorAll('.card').forEach(card => {
                // æ·»åŠ å¾®å¦™çš„å…‰æ™•æ•ˆæœ
                card.addEventListener('mouseenter', (e) => {
                    card.style.boxShadow = '0 20px 50px rgba(102, 126, 234, 0.2)';
                    card.style.transform = 'translateY(-3px)';
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.boxShadow = '';
                    card.style.transform = '';
                });
                
                // æ·»åŠ å¾®å¦™çš„è¾¹æ¡†å…‰æ•ˆ
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    card.style.background = `
                        radial-gradient(circle at ${x}px ${y}px, rgba(255,255,255,0.1) 0%, transparent 50%),
                        rgba(255, 255, 255, 0.95)
                    `;
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.background = '';
                });
            });
        }

        // 8) æ›´æ–°ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
        function updateDashboardStats(stats) {
            if (stats.totalPatients !== undefined) {
                animateNumber(document.getElementById('patientCount'), stats.totalPatients);
            }
            if (stats.totalDoctors !== undefined) {
                animateNumber(document.getElementById('doctorCount'), stats.totalDoctors);
            }
            if (stats.totalRegistrations !== undefined) {
                animateNumber(document.getElementById('totalRegistrations'), stats.totalRegistrations);
            }
            if (stats.totalRevenue !== undefined) {
                animateNumber(document.getElementById('totalRevenue'), stats.totalRevenue, true);
            }
        }

        // å…¨å±€é”™è¯¯å¤„ç†ï¼Œé˜²æ­¢éŸ³é¢‘æ’­æ”¾ç›¸å…³é”™è¯¯
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.name === 'AbortError' && 
                event.reason.message && event.reason.message.includes('play()')) {
                // å¿½ç•¥éŸ³é¢‘æ’­æ”¾è¢«ä¸­æ–­çš„é”™è¯¯
                console.warn('éŸ³é¢‘æ’­æ”¾è¢«ä¸­æ–­ï¼Œå·²å¿½ç•¥æ­¤é”™è¯¯:', event.reason);
                event.preventDefault();
            }
        });
    </script>
    <style>
        /* è‡ªå®šä¹‰å¼¹å‡ºçª—å£æ ·å¼ */
        .custom-alert-success .modal-header {
            background-color: #d1edff;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .custom-alert-success .bi {
            color: #28a745;
        }
        
        .custom-alert-error .modal-header {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .custom-alert-error .bi {
            color: #dc3545;
        }
        
        .custom-alert-warning .modal-header {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .custom-alert-warning .bi {
            color: #ffc107;
        }
        
        .custom-alert-info .modal-header {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .custom-alert-info .bi {
            color: #17a2b8;
        }
        
        #customAlertContent {
            white-space: pre-line;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 16px;
        }
        
        #customConfirmContent {
            white-space: pre-line;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 16px;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
    <script>
        // è‡ªå®šä¹‰å¼¹å‡ºçª—å£å‡½æ•°
        function showCustomAlert(message, type = 'info', title = 'æç¤º') {
            const modal = document.getElementById('customAlertModal');
            const header = document.getElementById('customAlertHeader');
            const icon = document.getElementById('customAlertIcon');
            const titleElement = document.getElementById('customAlertTitle');
            const content = document.getElementById('customAlertContent');
            const okBtn = document.getElementById('customAlertOkBtn');
            
            // æ¸…é™¤ä¹‹å‰çš„æ ·å¼ç±»
            modal.className = 'modal fade';
            
            // è®¾ç½®å†…å®¹
            titleElement.textContent = title;
            content.textContent = message;
            
            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼å’Œå›¾æ ‡
            switch (type) {
                case 'success':
                    modal.classList.add('custom-alert-success');
                    icon.className = 'bi bi-check-circle-fill';
                    okBtn.className = 'btn btn-success';
                    break;
                case 'error':
                    modal.classList.add('custom-alert-error');
                    icon.className = 'bi bi-exclamation-triangle-fill';
                    okBtn.className = 'btn btn-danger';
                    break;
                case 'warning':
                    modal.classList.add('custom-alert-warning');
                    icon.className = 'bi bi-exclamation-triangle-fill';
                    okBtn.className = 'btn btn-warning';
                    break;
                case 'info':
                default:
                    modal.classList.add('custom-alert-info');
                    icon.className = 'bi bi-info-circle-fill';
                    okBtn.className = 'btn btn-primary';
                    break;
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }
        
        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function showCustomConfirm(message, title = 'ç¡®è®¤æ“ä½œ') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const content = document.getElementById('customConfirmContent');
                const confirmBtn = document.getElementById('customConfirmOkBtn');
                
                // è®¾ç½®å†…å®¹
                content.textContent = message;
                
                // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                // æ·»åŠ ç¡®å®šæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                newConfirmBtn.addEventListener('click', function() {
                    const bootstrapModal = bootstrap.Modal.getInstance(modal);
                    bootstrapModal.hide();
                    resolve(true);
                });
                
                // æ·»åŠ å–æ¶ˆå’Œå…³é—­äº‹ä»¶ç›‘å¬å™¨
                const handleCancel = () => {
                    resolve(false);
                    modal.removeEventListener('hidden.bs.modal', handleCancel);
                };
                
                modal.addEventListener('hidden.bs.modal', handleCancel, { once: true });
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
            });
        }
        
        // é‡å†™åŸç”Ÿalertå‡½æ•°
        window.originalAlert = window.alert;
        window.alert = function(message) {
            showCustomAlert(message, 'info');
        };

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || user.role !== 'ADMIN') {
                window.location.href = 'login.html';
                return false;
            }
            
            document.getElementById('userName').textContent = user.realName || user.username;
            return true;
        }

        // æ˜¾ç¤ºä¸åŒçš„åŠŸèƒ½åŒºåŸŸ
        function showSection(sectionName) {
            // éšè—æ‰€æœ‰section
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('d-none');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„section
            document.getElementById(sectionName).classList.remove('d-none');
            
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (sectionName === 'dashboard') {
                loadDashboard();
            } else if (sectionName === 'patients') {
                loadPatients();
            } else if (sectionName === 'doctors') {
                loadDoctors();
            } else if (sectionName === 'registrations') {
                loadRegistrations();
            } else if (sectionName === 'payments') {
                loadPayments();
            } else if (sectionName === 'medicines') {
                loadMedicines();
            } else if (sectionName === 'feedbacks') {
                loadFeedbacks();
            }
        }

        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboard() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/dashboard/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateDashboard(result.data);
                    } else {
                        console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', result.message);
                        showErrorMessage('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥');
                    }
                } else {
                    console.error('HTTPé”™è¯¯:', response.status);
                    showErrorMessage('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                }
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¼‚å¸¸:', error);
                showErrorMessage('åŠ è½½æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯');
            }
        }

        // æ›´æ–°ä»ªè¡¨ç›˜æ˜¾ç¤º - å¢å¼ºç‰ˆæœ¬
        function updateDashboard(stats) {
            // ä½¿ç”¨åŠ¨ç”»æ›´æ–°æ ¸å¿ƒç»Ÿè®¡æ•°æ®
            updateDashboardStats(stats);
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            if (chartDonut && stats.paymentStatusStats) {
                const paymentStats = stats.paymentStatusStats;
                chartDonut.data.datasets[0].data = [
                    paymentStats.PAID || 0,
                    paymentStats.PENDING || 0,
                    paymentStats.REFUNDED || 0
                ];
                chartDonut.update('active');
            }
            
            // åˆ·æ–°æ—¶é—´åºåˆ—æ•°æ®
            loadChartData();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('æ•°æ®å·²æ›´æ–°', 'success');

            // æ›´æ–°ç®€åŒ–çš„è¿è¥æ¦‚è§ˆ
            updateSimpleStats(stats);
            
            console.log('ä»ªè¡¨ç›˜æ•°æ®æ›´æ–°æˆåŠŸ:', stats);
        }
        
        // æ›´æ–°ç®€åŒ–çš„è¿è¥ç»Ÿè®¡
        function updateSimpleStats(stats) {
            // çƒ­é—¨ç§‘å®¤
            const topDept = stats.topDepartments && stats.topDepartments.length > 0 
                ? stats.topDepartments[0].departmentName 
                : 'æš‚æ— æ•°æ®';
            document.getElementById('topDepartment').textContent = topDept;
            
            // å¾…å¤„ç†æŒ‚å·æ•°é‡
            const pendingRegs = stats.registrationStatusStats 
                ? (stats.registrationStatusStats.PENDING || 0)
                : 0;
            document.getElementById('pendingRegistrations').textContent = pendingRegs;
            
            // å¾…æ”¯ä»˜è®¢å•æ•°é‡
            const pendingPayments = stats.paymentStatusStats 
                ? (stats.paymentStatusStats.PENDING || 0)
                : 0;
            document.getElementById('pendingPayments').textContent = pendingPayments;
        }
        
        // æ›´æ–°ç§‘å®¤ç»Ÿè®¡æ˜¾ç¤º
        function updateDepartmentStats(departments) {
            const container = document.getElementById('departmentStats');
            if (!departments || departments.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            let html = '';
            departments.forEach((dept, index) => {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="badge bg-primary me-2">${index + 1}</span>
                            <strong>${dept.departmentName}</strong>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">${dept.registrationCount}æ¬¡</div>
                            <small class="text-muted">${formatCurrency(dept.revenue)}</small>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // æ›´æ–°åŒ»ç”Ÿå·¥ä½œé‡ç»Ÿè®¡æ˜¾ç¤º
        function updateDoctorStats(doctors) {
            const container = document.getElementById('doctorStats');
            if (!doctors || doctors.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            let html = '';
            doctors.forEach((doctor, index) => {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="badge bg-success me-2">${index + 1}</span>
                            <strong>${doctor.doctorName}</strong>
                            <br>
                            <small class="text-muted">${doctor.department}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">${doctor.registrationCount}æ¬¡</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // æ›´æ–°æŒ‚å·çŠ¶æ€ç»Ÿè®¡æ˜¾ç¤º
        function updateRegistrationStatusStats(statusStats) {
            const container = document.getElementById('registrationStatusStats');
            const statusLabels = {
                'PENDING': 'å¾…å°±è¯Š',
                'IN_PROGRESS': 'å°±è¯Šä¸­',
                'COMPLETED': 'å·²å®Œæˆ',
                'CANCELLED': 'å·²å–æ¶ˆ'
            };
            
            let html = '';
            let total = 0;
            Object.values(statusStats).forEach(count => total += count);
            
            if (total === 0) {
                container.innerHTML = '<div class="text-center text-muted">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            Object.entries(statusStats).forEach(([status, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${statusLabels[status] || status}</span>
                        <div class="text-end">
                            <strong>${count}</strong>
                            <small class="text-muted">(${percentage}%)</small>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // æ›´æ–°æ”¯ä»˜çŠ¶æ€ç»Ÿè®¡æ˜¾ç¤º
        function updatePaymentStatusStats(statusStats) {
            const container = document.getElementById('paymentStatusStats');
            const statusLabels = {
                'PENDING': 'å¾…æ”¯ä»˜',
                'PAID': 'å·²æ”¯ä»˜',
                'REFUNDED': 'å·²é€€æ¬¾'
            };
            
            let html = '';
            let total = 0;
            Object.values(statusStats).forEach(count => total += count);
            
            if (total === 0) {
                container.innerHTML = '<div class="text-center text-muted">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            Object.entries(statusStats).forEach(([status, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${statusLabels[status] || status}</span>
                        <div class="text-end">
                            <strong>${count}</strong>
                            <small class="text-muted">(${percentage}%)</small>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // æ ¼å¼åŒ–è´§å¸æ˜¾ç¤º
        function formatCurrency(amount) {
            return 'Â¥' + parseFloat(amount || 0).toFixed(2);
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showErrorMessage(message) {
            // å¯ä»¥ä½¿ç”¨alertæˆ–è€…æ›´ä¼˜é›…çš„é€šçŸ¥æ–¹å¼
            console.error(message);
        }


        // åŠ è½½ç—…äººæ•°æ®
        async function loadPatients() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/patients?page=0&size=10&sortBy=id&sortDir=asc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const tbody = document.getElementById('patientsTable');
                        tbody.innerHTML = result.data.content.map(patient => `
                            <tr>
                                <td>${patient.name}</td>
                                <td>${patient.gender === 'MALE' ? 'ç”·' : 'å¥³'}</td>
                                <td>${calculateAge(patient.birthDate)}</td>
                                <td>${patient.phone || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewPatient(${patient.id})">æŸ¥çœ‹</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="editPatient(${patient.id})">ç¼–è¾‘</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deletePatient(${patient.id}, '${patient.name}')">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç—…äººæ•°æ®å¤±è´¥:', error);
                document.getElementById('patientsTable').innerHTML = '<tr><td colspan="5" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // è®¡ç®—å¹´é¾„
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // æ›´æ–°æ—¶é—´
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN');
        }

        // é€€å‡ºç™»å½•
        // æ„è§å»ºè®®ç®¡ç†åŠŸèƒ½
        let allFeedbacks = [];
        let currentFeedbackId = null;
        let debounceTimer;

        async function loadFeedbacks() {
            if (!checkAuth()) return;

            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/feedbacks', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();

                if (result.success) {
                    // å¤„ç†åˆ†é¡µæ•°æ®ç»“æ„
                    let feedbackData = result.data;
                    if (feedbackData && feedbackData.content) {
                        // å¦‚æœæ˜¯åˆ†é¡µæ•°æ®ï¼Œå–contentæ•°ç»„
                        allFeedbacks = feedbackData.content || [];
                    } else if (Array.isArray(feedbackData)) {
                        // å¦‚æœç›´æ¥æ˜¯æ•°ç»„
                        allFeedbacks = feedbackData;
                    } else {
                        // å…¶ä»–æƒ…å†µï¼Œè®¾ä¸ºç©ºæ•°ç»„
                        allFeedbacks = [];
                    }
                    
                    console.log('Loaded feedbacks:', allFeedbacks.length, allFeedbacks);
                    displayFeedbacks(allFeedbacks);
                    updateFeedbackStatistics(allFeedbacks);
                } else {
                    showCustomAlert('åŠ è½½åé¦ˆå¤±è´¥:\n' + result.message, 'error', 'åŠ è½½å¤±è´¥');
                    allFeedbacks = [];
                    displayFeedbacks(allFeedbacks);
                    updateFeedbackStatistics(allFeedbacks);
                }
            } catch (error) {
                console.error('Error loading feedbacks:', error);
                showCustomAlert('åŠ è½½åé¦ˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨\n\né”™è¯¯è¯¦æƒ…:\n' + error.message, 'error', 'ç½‘ç»œé”™è¯¯');
                allFeedbacks = [];
                displayFeedbacks(allFeedbacks);
                updateFeedbackStatistics(allFeedbacks);
            }
        }

        function displayFeedbacks(feedbacks) {
            const tableBody = document.getElementById('feedbacksTable');
            const noFeedbacksMessage = document.getElementById('noFeedbacksMessage');
            
            if (!tableBody) {
                console.error('feedbacksTable element not found');
                return;
            }
            
            tableBody.innerHTML = '';
            
            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ feedbacks æ˜¯æ•°ç»„
            if (!feedbacks || !Array.isArray(feedbacks) || feedbacks.length === 0) {
                if (noFeedbacksMessage) {
                    noFeedbacksMessage.style.display = 'block';
                }
                return;
            } else {
                if (noFeedbacksMessage) {
                    noFeedbacksMessage.style.display = 'none';
                }
            }

            feedbacks.forEach(feedback => {
                // å®‰å…¨æ£€æŸ¥æ¯ä¸ªåé¦ˆå¯¹è±¡
                if (!feedback || typeof feedback !== 'object') {
                    console.warn('Invalid feedback object:', feedback);
                    return;
                }
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${feedback.id || ''}</td>
                    <td>${feedback.contactName || 'N/A'}</td>
                    <td>${feedback.contactPhone || feedback.contactEmail || 'N/A'}</td>
                    <td><span class="badge ${getFeedbackTypeBadgeClass(feedback.feedbackType || '')}">${feedback.feedbackType || 'N/A'}</span></td>
                    <td>${feedback.content ? (feedback.content.substring(0, 50) + (feedback.content.length > 50 ? '...' : '')) : 'N/A'}</td>
                    <td>${feedback.createdAt ? new Date(feedback.createdAt).toLocaleString('zh-CN') : 'N/A'}</td>
                    <td><span class="badge ${getFeedbackStatusBadgeClass(feedback.status || '')}">${getFeedbackStatusText(feedback.status || '')}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewFeedbackDetail(${feedback.id || 0})">
                            <i class="bi bi-eye"></i> è¯¦æƒ…
                        </button>
                    </td>
                `;
            });
        }

        function updateFeedbackStatistics(feedbacks) {
            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ feedbacks æ˜¯æ•°ç»„
            if (!feedbacks || !Array.isArray(feedbacks)) {
                feedbacks = [];
            }
            
            const totalElement = document.getElementById('totalFeedbacks');
            const pendingElement = document.getElementById('pendingFeedbacks');
            const resolvedElement = document.getElementById('resolvedFeedbacks');
            const suggestionElement = document.getElementById('suggestionFeedbacks');
            
            if (totalElement) totalElement.textContent = feedbacks.length;
            if (pendingElement) pendingElement.textContent = feedbacks.filter(f => f.status === 'PENDING').length;
            if (resolvedElement) resolvedElement.textContent = feedbacks.filter(f => f.status === 'PROCESSED').length;
            if (suggestionElement) suggestionElement.textContent = feedbacks.filter(f => f.feedbackType === 'å»ºè®®').length;
        }

        function filterFeedbacks() {
            const filterStatus = document.getElementById('filterStatus').value;
            const filterType = document.getElementById('filterType').value;
            const searchKeyword = document.getElementById('searchKeyword').value.toLowerCase();

            // ç¡®ä¿ allFeedbacks æ˜¯æ•°ç»„
            if (!Array.isArray(allFeedbacks)) {
                console.warn('allFeedbacks is not an array:', allFeedbacks);
                allFeedbacks = [];
            }

            const filteredFeedbacks = allFeedbacks.filter(feedback => {
                const matchesStatus = filterStatus ? feedback.status === filterStatus : true;
                const matchesType = filterType ? feedback.feedbackType === filterType : true;
                const matchesKeyword = searchKeyword ? 
                    feedback.contactName.toLowerCase().includes(searchKeyword) ||
                    feedback.content.toLowerCase().includes(searchKeyword) ||
                    (feedback.contactPhone && feedback.contactPhone.includes(searchKeyword)) ||
                    (feedback.contactEmail && feedback.contactEmail.toLowerCase().includes(searchKeyword))
                    : true;
                return matchesStatus && matchesType && matchesKeyword;
            });

            displayFeedbacks(filteredFeedbacks);
        }

        function debounceSearchFeedbacks() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                filterFeedbacks();
            }, 300);
        }

        function getFeedbackStatusBadgeClass(status) {
            switch (status) {
                case 'PENDING': return 'bg-warning text-dark';
                case 'PROCESSED': return 'bg-success';
                case 'CLOSED': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function getFeedbackStatusText(status) {
            switch (status) {
                case 'PENDING': return 'å¾…å¤„ç†';
                case 'PROCESSED': return 'å·²å¤„ç†';
                case 'CLOSED': return 'å·²å…³é—­';
                default: return 'æœªçŸ¥';
            }
        }

        function getFeedbackTypeBadgeClass(type) {
            switch (type) {
                case 'æŠ•è¯‰': return 'bg-danger';
                case 'å»ºè®®': return 'bg-primary';
                case 'è¡¨æ‰¬': return 'bg-success';
                case 'å’¨è¯¢': return 'bg-info';
                case 'å…¶ä»–': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        async function viewFeedbackDetail(id) {
            if (!checkAuth()) return;

            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/feedbacks/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();

                if (result.success) {
                    const feedback = result.data;
                    currentFeedbackId = feedback.id;

                    document.getElementById('detailId').textContent = feedback.id;
                    document.getElementById('detailCreatedAt').textContent = new Date(feedback.createdAt).toLocaleString('zh-CN');
                    document.getElementById('detailContactName').textContent = feedback.contactName;
                    document.getElementById('detailContactPhone').textContent = feedback.contactPhone || 'N/A';
                    document.getElementById('detailContactEmail').textContent = feedback.contactEmail || 'N/A';
                    document.getElementById('detailFeedbackType').innerHTML = `<span class="badge ${getFeedbackTypeBadgeClass(feedback.feedbackType)}">${feedback.feedbackType}</span>`;
                    document.getElementById('detailContent').textContent = feedback.content;
                    document.getElementById('detailStatus').innerHTML = `<span class="badge ${getFeedbackStatusBadgeClass(feedback.status)}">${getFeedbackStatusText(feedback.status)}</span>`;
                    
                    document.getElementById('resolutionNotes').value = feedback.resolutionNotes || '';
                    document.getElementById('processStatus').value = feedback.status;
                    document.getElementById('detailResolvedBy').textContent = feedback.resolvedBy ? feedback.resolvedBy.realName : 'N/A';
                    document.getElementById('detailResolvedAt').textContent = feedback.resolvedAt ? new Date(feedback.resolvedAt).toLocaleString('zh-CN') : 'N/A';

                    const feedbackDetailModal = new bootstrap.Modal(document.getElementById('feedbackDetailModal'));
                    feedbackDetailModal.show();
                } else {
                    showCustomAlert('åŠ è½½åé¦ˆè¯¦æƒ…å¤±è´¥:\n' + result.message, 'error', 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('Error loading feedback detail:', error);
                showCustomAlert('åŠ è½½åé¦ˆè¯¦æƒ…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨\n\né”™è¯¯è¯¦æƒ…:\n' + error.message, 'error', 'ç½‘ç»œé”™è¯¯');
            }
        }

        async function saveFeedbackProcess() {
            if (!checkAuth() || !currentFeedbackId) return;

            const token = localStorage.getItem('token');
            const status = document.getElementById('processStatus').value;
            const resolutionNotes = document.getElementById('resolutionNotes').value;

            try {
                let response;
                
                if (status === 'PROCESSED') {
                    // ä½¿ç”¨ process ç«¯ç‚¹
                    response = await fetch(`/api/feedbacks/${currentFeedbackId}/process?processingNotes=${encodeURIComponent(resolutionNotes)}&processedByUserId=1`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                } else if (status === 'CLOSED') {
                    // ä½¿ç”¨ close ç«¯ç‚¹
                    response = await fetch(`/api/feedbacks/${currentFeedbackId}/close`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                } else {
                    // å¯¹äº PENDING çŠ¶æ€ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸åšå¤„ç†ï¼Œæˆ–è€…å¯ä»¥æ˜¾ç¤ºæç¤º
                    alert('æš‚ä¸æ”¯æŒå°†çŠ¶æ€æ”¹å›å¾…å¤„ç†');
                    return;
                }
                
                const result = await response.json();

                if (result.success) {
                    showCustomAlert('åé¦ˆå¤„ç†çŠ¶æ€å·²æ›´æ–°ï¼', 'success', 'æ“ä½œæˆåŠŸ');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackDetailModal'));
                    modal.hide();
                    loadFeedbacks(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showCustomAlert('æ›´æ–°å¤„ç†çŠ¶æ€å¤±è´¥:\n' + result.message, 'error', 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error('Error saving feedback process:', error);
                showCustomAlert('ä¿å­˜å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨\n\né”™è¯¯è¯¦æƒ…:\n' + error.message, 'error', 'ç½‘ç»œé”™è¯¯');
            }
        }

        async function deleteFeedback() {
            if (!checkAuth() || !currentFeedbackId) return;

            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const confirmed = await showCustomConfirm(
                'ç¡®å®šè¦åˆ é™¤è¿™æ¡åé¦ˆå—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯é€†ï¼Œåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼\n\nè¯·è°¨æ…æ“ä½œã€‚',
                'åˆ é™¤ç¡®è®¤'
            );
            
            if (!confirmed) {
                return;
            }

            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/feedbacks/${currentFeedbackId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showCustomAlert('åé¦ˆå·²æˆåŠŸåˆ é™¤ï¼', 'success', 'åˆ é™¤æˆåŠŸ');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackDetailModal'));
                    modal.hide();
                    loadFeedbacks(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    const result = await response.json();
                    showCustomAlert('åˆ é™¤åé¦ˆå¤±è´¥:\n' + result.message, 'error', 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('Error deleting feedback:', error);
                showCustomAlert('åˆ é™¤åé¦ˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨\n\né”™è¯¯è¯¦æƒ…:\n' + error.message, 'error', 'ç½‘ç»œé”™è¯¯');
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAuth()) {
                // åˆå§‹åŒ–æ‰€æœ‰å¢å¼ºåŠŸèƒ½
                initParticles();
                initCharts();
                addCardEffects();
                
                updateTime();
                setInterval(updateTime, 1000);
                
                // é»˜è®¤åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
                loadDashboard();
                
                // æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°æ•°æ®
                setInterval(() => {
                    if (document.querySelector('#dashboard').style.display !== 'none') {
                        console.log('å®šæœŸåˆ·æ–°ä»ªè¡¨ç›˜æ•°æ®...');
                        loadDashboard();
                    }
                }, 5 * 60 * 1000);
            }
        });

        // ============ ç—…äººç®¡ç†ç›¸å…³åŠŸèƒ½ ============

        // æ˜¾ç¤ºæ·»åŠ ç—…äººæ¨¡æ€æ¡†
        function showAddPatientModal() {
            document.getElementById('patientModalTitle').textContent = 'æ·»åŠ ç—…äºº';
            document.getElementById('patientForm').reset();
            document.getElementById('patientId').value = '';
            
            // ç¡®ä¿æ‰€æœ‰è¡¨å•å…ƒç´ éƒ½æ˜¯å¯ç¼–è¾‘çš„
            const formInputs = document.querySelectorAll('#patientForm input, #patientForm select');
            formInputs.forEach(input => input.disabled = false);
            
            // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
            document.getElementById('savePatientBtn').style.display = 'block';
            
            // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
            const modalElement = document.getElementById('patientModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }

        // æŸ¥çœ‹ç—…äººè¯¦æƒ…
        async function viewPatient(patientId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/patients/${patientId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const patient = result.data;
                        // å¡«å……è¡¨å•æ•°æ®
                        document.getElementById('patientModalTitle').textContent = 'æŸ¥çœ‹ç—…äººä¿¡æ¯';
                        document.getElementById('patientId').value = patient.id;
                        document.getElementById('patientName').value = patient.name;
                        document.getElementById('patientGender').value = patient.gender;
                        document.getElementById('patientBirthDate').value = patient.birthDate;
                        document.getElementById('patientPhone').value = patient.phone || '';
                        document.getElementById('patientAddress').value = patient.address || '';
                        document.getElementById('patientIdCard').value = patient.idCard || '';
                        document.getElementById('patientEmergencyContact').value = patient.emergencyContact || '';
                        document.getElementById('patientEmergencyPhone').value = patient.emergencyPhone || '';
                        
                        // è®¾ä¸ºåªè¯»æ¨¡å¼
                        const formInputs = document.querySelectorAll('#patientForm input, #patientForm select');
                        formInputs.forEach(input => input.disabled = true);
                        
                        document.getElementById('savePatientBtn').style.display = 'none';
                        
                        // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
                        const modalElement = document.getElementById('patientModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('è·å–ç—…äººä¿¡æ¯å¤±è´¥:', error);
                alert('è·å–ç—…äººä¿¡æ¯å¤±è´¥');
            }
        }

        // ç¼–è¾‘ç—…äºº
        async function editPatient(patientId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/patients/${patientId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const patient = result.data;
                        // å¡«å……è¡¨å•æ•°æ®
                        document.getElementById('patientModalTitle').textContent = 'ç¼–è¾‘ç—…äººä¿¡æ¯';
                        document.getElementById('patientId').value = patient.id;
                        document.getElementById('patientName').value = patient.name;
                        document.getElementById('patientGender').value = patient.gender;
                        document.getElementById('patientBirthDate').value = patient.birthDate;
                        document.getElementById('patientPhone').value = patient.phone || '';
                        document.getElementById('patientAddress').value = patient.address || '';
                        document.getElementById('patientIdCard').value = patient.idCard || '';
                        document.getElementById('patientEmergencyContact').value = patient.emergencyContact || '';
                        document.getElementById('patientEmergencyPhone').value = patient.emergencyPhone || '';
                        
                        // å¯ç”¨ç¼–è¾‘æ¨¡å¼
                        const formInputs = document.querySelectorAll('#patientForm input, #patientForm select');
                        formInputs.forEach(input => input.disabled = false);
                        
                        document.getElementById('savePatientBtn').style.display = 'block';
                        
                        // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
                        const modalElement = document.getElementById('patientModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('è·å–ç—…äººä¿¡æ¯å¤±è´¥:', error);
                alert('è·å–ç—…äººä¿¡æ¯å¤±è´¥');
            }
        }

        // æ¸…é™¤å­—æ®µé”™è¯¯æ ·å¼
        function clearFieldErrors() {
            const fields = ['patientName', 'patientGender', 'patientBirthDate', 'patientIdCard', 'patientPhone', 'patientAddress', 'patientEmail', 'patientEmergencyContact', 'patientEmergencyPhone'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('is-invalid');
                    // ç§»é™¤å·²æœ‰çš„é”™è¯¯æç¤º
                    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                }
            });
        }

        // æ˜¾ç¤ºå­—æ®µé”™è¯¯
        function showFieldErrors(fieldErrors) {
            // å­—æ®µåæ˜ å°„
            const fieldMap = {
                'name': 'patientName',
                'gender': 'patientGender', 
                'birthDate': 'patientBirthDate',
                'idCard': 'patientIdCard',
                'phone': 'patientPhone',
                'address': 'patientAddress',
                'email': 'patientEmail',
                'emergencyContact': 'patientEmergencyContact',
                'emergencyPhone': 'patientEmergencyPhone'
            };

            for (const [fieldName, errorMessage] of Object.entries(fieldErrors)) {
                const fieldId = fieldMap[fieldName];
                if (fieldId) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // æ·»åŠ é”™è¯¯æ ·å¼
                        field.classList.add('is-invalid');
                        
                        // æ·»åŠ é”™è¯¯æç¤º
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = errorMessage;
                        field.parentNode.appendChild(errorDiv);
                    }
                }
            }
        }

        // ä¿å­˜ç—…äººä¿¡æ¯
        async function savePatient() {
            // é˜²æ­¢é‡å¤æäº¤
            const saveBtn = document.getElementById('savePatientBtn');
            if (saveBtn.disabled) {
                return; // å¦‚æœæŒ‰é’®å·²ç¦ç”¨ï¼Œç›´æ¥è¿”å›
            }
            
            // ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æç¤º
            clearFieldErrors();

            // è·å–è¡¨å•æ•°æ®
            const name = document.getElementById('patientName').value.trim();
            const gender = document.getElementById('patientGender').value;
            const birthDate = document.getElementById('patientBirthDate').value;
            const phone = document.getElementById('patientPhone').value.trim();
            const address = document.getElementById('patientAddress').value.trim();
            const idCard = document.getElementById('patientIdCard').value.trim();
            const emergencyContact = document.getElementById('patientEmergencyContact').value.trim();
            const emergencyPhone = document.getElementById('patientEmergencyPhone').value.trim();

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!name) {
                alert('è¯·è¾“å…¥ç—…äººå§“å');
                document.getElementById('patientName').focus();
                return;
            }
            
            if (!gender) {
                alert('è¯·é€‰æ‹©ç—…äººæ€§åˆ«');
                document.getElementById('patientGender').focus();
                return;
            }
            
            if (!birthDate) {
                alert('è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ');
                document.getElementById('patientBirthDate').focus();
                return;
            }
            
            if (!idCard) {
                alert('è¯·è¾“å…¥èº«ä»½è¯å·');
                document.getElementById('patientIdCard').focus();
                return;
            }

            // æ„å»ºæ•°æ®å¯¹è±¡ï¼ˆåŒ…å«æ‰€æœ‰å¿…å¡«å­—æ®µï¼‰
            const patientData = {
                name: name,
                gender: gender,
                birthDate: birthDate,
                idCard: idCard
            };

            // æ·»åŠ å¯é€‰å­—æ®µï¼ˆå¦‚æœä¸ä¸ºç©ºï¼‰
            if (phone) patientData.phone = phone;
            if (address) patientData.address = address;
            if (emergencyContact) patientData.emergencyContact = emergencyContact;
            if (emergencyPhone) patientData.emergencyPhone = emergencyPhone;

            const patientId = document.getElementById('patientId').value;
            const isEdit = patientId && patientId.trim() !== '';

            try {
                const token = localStorage.getItem('token');
                const url = isEdit ? `/api/patients/${patientId}` : '/api/patients';
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('å‘é€æ•°æ®:', patientData); // è°ƒè¯•æ—¥å¿—
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(patientData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    const operation = isEdit ? 'UPDATE' : 'CREATE';
                    const successMessage = isEdit ? 'ç—…äººä¿¡æ¯æ›´æ–°æˆåŠŸï¼' : 'ç—…äººæ·»åŠ æˆåŠŸï¼';
                    
                    alert(successMessage);
                    
                    // å‘é€é€šçŸ¥
                    if (window.notificationHelper) {
                        try {
                            console.log('å‡†å¤‡å‘é€ç—…äººé€šçŸ¥...', operation);
                            const notificationData = {
                                id: result.data?.id || patientData.id,
                                name: patientData.name,
                                phone: patientData.phone,
                                idCard: patientData.idCard
                            };
                            await window.notificationHelper.sendPatientNotification(operation.toLowerCase(), notificationData);
                            console.log('ç—…äººé€šçŸ¥å‘é€æˆåŠŸ');
                        } catch (notifyError) {
                            console.error('å‘é€é€šçŸ¥å¤±è´¥:', notifyError);
                        }
                    } else {
                        console.error('é€šçŸ¥ç³»ç»Ÿæœªåˆå§‹åŒ–');
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('patientModal')).hide();
                    loadPatients(); // é‡æ–°åŠ è½½ç—…äººåˆ—è¡¨
                } else {
                    // å¤„ç†éªŒè¯é”™è¯¯
                    if (result.data && typeof result.data === 'object') {
                        // æ˜¾ç¤ºå­—æ®µçº§åˆ«çš„é”™è¯¯
                        showFieldErrors(result.data);
                        alert('è¾“å…¥ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·æŸ¥çœ‹æ ‡çº¢çš„å­—æ®µæç¤ºå¹¶ä¿®æ­£');
                    } else {
                        // æ˜¾ç¤ºé€šç”¨é”™è¯¯ä¿¡æ¯
                        alert('ä¿å­˜å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                }
            } catch (error) {
                console.error('ä¿å­˜ç—…äººä¿¡æ¯å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.disabled = false;
                saveBtn.textContent = 'ä¿å­˜';
            }
        }

        // åˆ é™¤ç—…äºº
        async function deletePatient(patientId, patientName) {
            // ç¡®è®¤åˆ é™¤
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤ç—…äºº "${patientName}" å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œå¹¶ä¸”ä¼šåŒæ—¶åˆ é™¤è¯¥ç—…äººçš„æ‰€æœ‰æŒ‚å·å’Œæ”¶è´¹è®°å½•ã€‚`;
            
            if (!confirm(confirmMessage)) {
                return; // ç”¨æˆ·å–æ¶ˆåˆ é™¤
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/patients/${patientId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`ç—…äºº "${patientName}" åˆ é™¤æˆåŠŸï¼`);
                        
                        // å‘é€åˆ é™¤é€šçŸ¥
                        if (window.notificationHelper) {
                            try {
                                const notificationData = {
                                    id: patientId,
                                    name: patientName
                                };
                                await window.notificationHelper.sendPatientNotification('delete', notificationData);
                            } catch (notifyError) {
                                console.error('å‘é€é€šçŸ¥å¤±è´¥:', notifyError);
                            }
                        }
                        
                        loadPatients(); // é‡æ–°åŠ è½½ç—…äººåˆ—è¡¨
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('åˆ é™¤å¤±è´¥:', response.status, errorText);
                    
                    if (response.status === 403) {
                        alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ç—…äºº');
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                }
            } catch (error) {
                console.error('åˆ é™¤ç—…äººå¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ============ åŒ»ç”Ÿç®¡ç†ç›¸å…³åŠŸèƒ½ ============

        // åŠ è½½åŒ»ç”Ÿæ•°æ®
        async function loadDoctors() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/doctors?page=0&size=10&sortBy=id&sortDir=asc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const tbody = document.getElementById('doctorsTable');
                        tbody.innerHTML = result.data.content.map(doctor => `
                            <tr>
                                <td>${doctor.name}</td>
                                <td>${doctor.gender === 'MALE' ? 'ç”·' : 'å¥³'}</td>
                                <td>${doctor.department}</td>
                                <td>${doctor.title}</td>
                                <td>${doctor.phone || '-'}</td>
                                <td>Â¥${doctor.consultationFee?.toFixed(2) || '0.00'}</td>
                                <td>
                                    <span class="badge ${doctor.available ? 'bg-success' : 'bg-secondary'}">
                                        ${doctor.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewDoctor(${doctor.id})">æŸ¥çœ‹</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="editDoctor(${doctor.id})">ç¼–è¾‘</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor(${doctor.id}, '${doctor.name}')">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½åŒ»ç”Ÿæ•°æ®å¤±è´¥:', error);
                document.getElementById('doctorsTable').innerHTML = '<tr><td colspan="8" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ˜¾ç¤ºæ·»åŠ åŒ»ç”Ÿæ¨¡æ€æ¡†
        function showAddDoctorModal() {
            document.getElementById('doctorModalTitle').textContent = 'æ·»åŠ åŒ»ç”Ÿ';
            document.getElementById('doctorForm').reset();
            document.getElementById('doctorId').value = '';
            
            // ç¡®ä¿æ‰€æœ‰è¡¨å•å…ƒç´ éƒ½æ˜¯å¯ç¼–è¾‘çš„
            const formInputs = document.querySelectorAll('#doctorForm input, #doctorForm select, #doctorForm textarea');
            formInputs.forEach(input => input.disabled = false);
            
            // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
            document.getElementById('saveDoctorBtn').style.display = 'block';
            
            // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
            const modalElement = document.getElementById('doctorModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }

        // æŸ¥çœ‹åŒ»ç”Ÿè¯¦æƒ…
        async function viewDoctor(doctorId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/doctors/${doctorId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const doctor = result.data;
                        // å¡«å……è¡¨å•æ•°æ®
                        document.getElementById('doctorModalTitle').textContent = 'æŸ¥çœ‹åŒ»ç”Ÿä¿¡æ¯';
                        document.getElementById('doctorId').value = doctor.id;
                        document.getElementById('doctorName').value = doctor.name;
                        document.getElementById('doctorGender').value = doctor.gender;
                        document.getElementById('doctorDepartment').value = doctor.department;
                        document.getElementById('doctorTitle').value = doctor.title;
                        document.getElementById('doctorPhone').value = doctor.phone || '';
                        document.getElementById('doctorEmail').value = doctor.email || '';
                        document.getElementById('doctorSpecialization').value = doctor.specialization || '';
                        document.getElementById('doctorIntroduction').value = doctor.introduction || '';
                        document.getElementById('doctorConsultationFee').value = doctor.consultationFee || '';
                        document.getElementById('doctorAvailable').checked = doctor.available;
                        
                        // è®¾ä¸ºåªè¯»æ¨¡å¼
                        const formInputs = document.querySelectorAll('#doctorForm input, #doctorForm select, #doctorForm textarea');
                        formInputs.forEach(input => input.disabled = true);
                        
                        document.getElementById('saveDoctorBtn').style.display = 'none';
                        
                        // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
                        const modalElement = document.getElementById('doctorModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('è·å–åŒ»ç”Ÿä¿¡æ¯å¤±è´¥:', error);
                alert('è·å–åŒ»ç”Ÿä¿¡æ¯å¤±è´¥');
            }
        }

        // ç¼–è¾‘åŒ»ç”Ÿ
        async function editDoctor(doctorId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/doctors/${doctorId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const doctor = result.data;
                        // å¡«å……è¡¨å•æ•°æ®
                        document.getElementById('doctorModalTitle').textContent = 'ç¼–è¾‘åŒ»ç”Ÿä¿¡æ¯';
                        document.getElementById('doctorId').value = doctor.id;
                        document.getElementById('doctorName').value = doctor.name;
                        document.getElementById('doctorGender').value = doctor.gender;
                        document.getElementById('doctorDepartment').value = doctor.department;
                        document.getElementById('doctorTitle').value = doctor.title;
                        document.getElementById('doctorPhone').value = doctor.phone || '';
                        document.getElementById('doctorEmail').value = doctor.email || '';
                        document.getElementById('doctorSpecialization').value = doctor.specialization || '';
                        document.getElementById('doctorIntroduction').value = doctor.introduction || '';
                        document.getElementById('doctorConsultationFee').value = doctor.consultationFee || '';
                        document.getElementById('doctorAvailable').checked = doctor.available;
                        
                        // å¯ç”¨ç¼–è¾‘æ¨¡å¼
                        const formInputs = document.querySelectorAll('#doctorForm input, #doctorForm select, #doctorForm textarea');
                        formInputs.forEach(input => input.disabled = false);
                        
                        document.getElementById('saveDoctorBtn').style.display = 'block';
                        
                        // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
                        const modalElement = document.getElementById('doctorModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('è·å–åŒ»ç”Ÿä¿¡æ¯å¤±è´¥:', error);
                alert('è·å–åŒ»ç”Ÿä¿¡æ¯å¤±è´¥');
            }
        }

        // æ¸…é™¤åŒ»ç”Ÿå­—æ®µé”™è¯¯æ ·å¼
        function clearDoctorFieldErrors() {
            const fields = ['doctorName', 'doctorGender', 'doctorDepartment', 'doctorTitle', 'doctorPhone', 'doctorEmail', 'doctorSpecialization', 'doctorIntroduction', 'doctorConsultationFee'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('is-invalid');
                    // ç§»é™¤å·²æœ‰çš„é”™è¯¯æç¤º
                    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                }
            });
        }

        // æ˜¾ç¤ºåŒ»ç”Ÿå­—æ®µé”™è¯¯
        function showDoctorFieldErrors(fieldErrors) {
            // å­—æ®µåæ˜ å°„
            const fieldMap = {
                'name': 'doctorName',
                'gender': 'doctorGender', 
                'department': 'doctorDepartment',
                'title': 'doctorTitle',
                'phone': 'doctorPhone',
                'email': 'doctorEmail',
                'specialization': 'doctorSpecialization',
                'introduction': 'doctorIntroduction',
                'consultationFee': 'doctorConsultationFee'
            };

            for (const [fieldName, errorMessage] of Object.entries(fieldErrors)) {
                const fieldId = fieldMap[fieldName];
                if (fieldId) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // æ·»åŠ é”™è¯¯æ ·å¼
                        field.classList.add('is-invalid');
                        
                        // æ·»åŠ é”™è¯¯æç¤º
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = errorMessage;
                        field.parentNode.appendChild(errorDiv);
                    }
                }
            }
        }

        // ä¿å­˜åŒ»ç”Ÿä¿¡æ¯
        async function saveDoctor() {
            // é˜²æ­¢é‡å¤æäº¤
            const saveBtn = document.getElementById('saveDoctorBtn');
            if (saveBtn.disabled) {
                return; // å¦‚æœæŒ‰é’®å·²ç¦ç”¨ï¼Œç›´æ¥è¿”å›
            }
            
            // ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            
            try {
                // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æç¤º
                clearDoctorFieldErrors();

                // è·å–è¡¨å•æ•°æ®
                const name = document.getElementById('doctorName').value.trim();
                const gender = document.getElementById('doctorGender').value;
                const department = document.getElementById('doctorDepartment').value.trim();
                const title = document.getElementById('doctorTitle').value.trim();
                const phone = document.getElementById('doctorPhone').value.trim();
                const email = document.getElementById('doctorEmail').value.trim();
                const specialization = document.getElementById('doctorSpecialization').value.trim();
                const introduction = document.getElementById('doctorIntroduction').value.trim();
                const consultationFee = document.getElementById('doctorConsultationFee').value.trim();
                const available = document.getElementById('doctorAvailable').checked;

                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!name) {
                    alert('è¯·è¾“å…¥åŒ»ç”Ÿå§“å');
                    document.getElementById('doctorName').focus();
                    return;
                }
                
                if (!gender) {
                    alert('è¯·é€‰æ‹©åŒ»ç”Ÿæ€§åˆ«');
                    document.getElementById('doctorGender').focus();
                    return;
                }
                
                if (!department) {
                    alert('è¯·è¾“å…¥ç§‘å®¤');
                    document.getElementById('doctorDepartment').focus();
                    return;
                }

                if (!title) {
                    alert('è¯·è¾“å…¥èŒç§°');
                    document.getElementById('doctorTitle').focus();
                    return;
                }

                // éªŒè¯é‚®ç®±æ ¼å¼ï¼ˆå¦‚æœæœ‰è¾“å…¥çš„è¯ï¼‰
                if (email && email.trim() !== '') {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        alert('è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼');
                        document.getElementById('doctorEmail').focus();
                        return;
                    }
                }

                // éªŒè¯ç”µè¯æ ¼å¼ï¼ˆå¦‚æœæœ‰è¾“å…¥çš„è¯ï¼‰
                if (phone && phone.trim() !== '') {
                    const phoneRegex = /^1[3-9]\d{9}$|^0\d{2,3}-?\d{7,8}$/;
                    if (!phoneRegex.test(phone.replace(/[-\s]/g, ''))) {
                        console.warn('ç”µè¯æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼Œä½†å…è®¸ä¿å­˜');
                    }
                }

                // æ„å»ºæ•°æ®å¯¹è±¡
                const doctorData = {
                    name: name,
                    gender: gender,
                    department: department,
                    title: title,
                    available: available
                };

                // æ·»åŠ å¯é€‰å­—æ®µï¼ˆåªæœ‰å½“å­—æ®µæœ‰æœ‰æ•ˆå†…å®¹æ—¶æ‰æ·»åŠ ï¼‰
                if (phone && phone.trim() !== '') {
                    doctorData.phone = phone.trim();
                }
                if (email && email.trim() !== '') {
                    // é‚®ç®±æ ¼å¼å·²åœ¨ä¸Šé¢éªŒè¯è¿‡
                    doctorData.email = email.trim();
                }
                if (specialization && specialization.trim() !== '') {
                    doctorData.specialization = specialization.trim();
                }
                if (introduction && introduction.trim() !== '') {
                    doctorData.introduction = introduction.trim();
                }
                if (consultationFee && consultationFee.trim() !== '' && !isNaN(parseFloat(consultationFee))) {
                    doctorData.consultationFee = parseFloat(consultationFee);
                }

                const doctorId = document.getElementById('doctorId').value;
                const isEdit = doctorId && doctorId.trim() !== '';
                
                const token = localStorage.getItem('token');
                const url = isEdit ? `/api/doctors/${doctorId}` : '/api/doctors';
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('å‘é€æ•°æ®:', doctorData); // è°ƒè¯•æ—¥å¿—
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(doctorData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    const operation = isEdit ? 'UPDATE' : 'CREATE';
                    const successMessage = isEdit ? 'åŒ»ç”Ÿä¿¡æ¯æ›´æ–°æˆåŠŸï¼' : 'åŒ»ç”Ÿæ·»åŠ æˆåŠŸï¼';
                    
                    alert(successMessage);
                    
                    // å‘é€é€šçŸ¥
                    if (window.notificationHelper) {
                        try {
                            const notificationData = {
                                id: result.data?.id || doctorData.id,
                                name: doctorData.name,
                                department: doctorData.department,
                                title: doctorData.title,
                                phone: doctorData.phone,
                                email: doctorData.email
                            };
                            await window.notificationHelper.sendDoctorNotification(operation.toLowerCase(), notificationData);
                        } catch (notifyError) {
                            console.error('å‘é€é€šçŸ¥å¤±è´¥:', notifyError);
                        }
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('doctorModal')).hide();
                    loadDoctors(); // é‡æ–°åŠ è½½åŒ»ç”Ÿåˆ—è¡¨
                } else {
                    // å¤„ç†éªŒè¯é”™è¯¯
                    if (result.data && typeof result.data === 'object') {
                        // æ˜¾ç¤ºå­—æ®µçº§åˆ«çš„é”™è¯¯
                        showDoctorFieldErrors(result.data);
                        alert('è¾“å…¥ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·æŸ¥çœ‹æ ‡çº¢çš„å­—æ®µæç¤ºå¹¶ä¿®æ­£');
                    } else {
                        // ç‰¹æ®Šå¤„ç†é‡å¤é‚®ç®±é”™è¯¯
                        const errorMessage = result.message || 'æœªçŸ¥é”™è¯¯';
                        if (errorMessage.includes('é‚®ç®±') || errorMessage.includes('email') || errorMessage.includes('Duplicate') || errorMessage.includes('duplicate')) {
                            alert('ä¿å­˜å¤±è´¥ï¼šè¯¥é‚®ç®±åœ°å€å·²è¢«å…¶ä»–åŒ»ç”Ÿä½¿ç”¨ï¼Œè¯·æ›´æ¢é‚®ç®±åœ°å€');
                            document.getElementById('doctorEmail').focus();
                            document.getElementById('doctorEmail').select(); // é€‰ä¸­é‚®ç®±å­—æ®µå†…å®¹ä¾¿äºä¿®æ”¹
                        } else {
                            alert('ä¿å­˜å¤±è´¥ï¼š' + errorMessage);
                        }
                    }
                }
            } catch (error) {
                console.error('ä¿å­˜åŒ»ç”Ÿä¿¡æ¯å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.disabled = false;
                saveBtn.textContent = 'ä¿å­˜';
            }
        }

        // åˆ é™¤åŒ»ç”Ÿ
        async function deleteDoctor(doctorId, doctorName) {
            // ç¡®è®¤åˆ é™¤
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤åŒ»ç”Ÿ "${doctorName}" å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œå¹¶ä¸”ä¼šåŒæ—¶åˆ é™¤è¯¥åŒ»ç”Ÿçš„æ‰€æœ‰æŒ‚å·è®°å½•ã€‚`;
            
            if (!confirm(confirmMessage)) {
                return; // ç”¨æˆ·å–æ¶ˆåˆ é™¤
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/doctors/${doctorId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`åŒ»ç”Ÿ "${doctorName}" åˆ é™¤æˆåŠŸï¼`);
                        
                        // å‘é€åˆ é™¤é€šçŸ¥
                        if (window.notificationHelper) {
                            try {
                                const notificationData = {
                                    id: doctorId,
                                    name: doctorName
                                };
                                await window.notificationHelper.sendDoctorNotification('delete', notificationData);
                            } catch (notifyError) {
                                console.error('å‘é€é€šçŸ¥å¤±è´¥:', notifyError);
                            }
                        }
                        
                        loadDoctors(); // é‡æ–°åŠ è½½åŒ»ç”Ÿåˆ—è¡¨
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('åˆ é™¤å¤±è´¥:', response.status, errorText);
                    
                    if (response.status === 403) {
                        alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤åŒ»ç”Ÿ');
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                }
            } catch (error) {
                console.error('åˆ é™¤åŒ»ç”Ÿå¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ============ æŒ‚å·ç®¡ç†ç›¸å…³åŠŸèƒ½ ============

        // åŠ è½½æŒ‚å·æ•°æ®
        async function loadRegistrations() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/registrations?page=0&size=10&sortBy=id&sortDir=desc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const tbody = document.getElementById('registrationsTable');
                        tbody.innerHTML = result.data.content.map(registration => {
                            const appointmentTime = new Date(registration.appointmentTime).toLocaleString('zh-CN');
                            const statusBadge = getStatusBadge(registration.status);
                            
                            return `
                                <tr>
                                    <td>${registration.patient?.name || 'æœªçŸ¥'}</td>
                                    <td>${registration.doctor?.name || 'æœªçŸ¥'}</td>
                                    <td>${registration.doctor?.department || '-'}</td>
                                    <td>${appointmentTime}</td>
                                    <td>Â¥${registration.registrationFee?.toFixed(2) || '0.00'}</td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewRegistration(${registration.id})">æŸ¥çœ‹</button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="editRegistration(${registration.id})">ç¼–è¾‘</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRegistration(${registration.id}, '${registration.patient?.name}')">åˆ é™¤</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æŒ‚å·æ•°æ®å¤±è´¥:', error);
                document.getElementById('registrationsTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // è·å–çŠ¶æ€å¾½ç« 
        function getStatusBadge(status) {
            const statusMap = {
                'PENDING': '<span class="badge bg-warning">å¾…å°±è¯Š</span>',
                'IN_PROGRESS': '<span class="badge bg-info">å°±è¯Šä¸­</span>',
                'COMPLETED': '<span class="badge bg-success">å·²å®Œæˆ</span>',
                'CANCELLED': '<span class="badge bg-secondary">å·²å–æ¶ˆ</span>'
            };
            return statusMap[status] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
        }

        // æ˜¾ç¤ºæ·»åŠ æŒ‚å·æ¨¡æ€æ¡†
        async function showAddRegistrationModal() {
            document.getElementById('registrationModalTitle').textContent = 'æ–°å»ºæŒ‚å·';
            document.getElementById('registrationForm').reset();
            document.getElementById('registrationId').value = '';
            
            // ç¡®ä¿æ‰€æœ‰è¡¨å•å…ƒç´ éƒ½æ˜¯å¯ç¼–è¾‘çš„
            const formInputs = document.querySelectorAll('#registrationForm input, #registrationForm select, #registrationForm textarea');
            formInputs.forEach(input => input.disabled = false);
            
            // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
            document.getElementById('saveRegistrationBtn').style.display = 'block';
            
            // åŠ è½½ç—…äººå’ŒåŒ»ç”Ÿé€‰é¡¹
            await Promise.all([loadPatientOptions(), loadDoctorOptions()]);
            
            // è®¾ç½®é»˜è®¤é¢„çº¦æ—¶é—´ä¸ºå½“å‰æ—¶é—´å1å°æ—¶
            const now = new Date();
            now.setHours(now.getHours() + 1);
            document.getElementById('registrationAppointmentTime').value = formatDateTimeLocal(now);
            
            // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
            const modalElement = document.getElementById('registrationModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }

        // åŠ è½½ç—…äººé€‰é¡¹
        async function loadPatientOptions(selectId = 'registrationPatient') {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/patients?page=0&size=100&sortBy=name&sortDir=asc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = '<option value="">è¯·é€‰æ‹©ç—…äºº</option>';
                            result.data.content.forEach(patient => {
                                select.innerHTML += `<option value="${patient.id}">${patient.name} (${patient.gender === 'MALE' ? 'ç”·' : 'å¥³'}, ${calculateAge(patient.birthDate)}å²)</option>`;
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç—…äººé€‰é¡¹å¤±è´¥:', error);
            }
        }

        // åŠ è½½åŒ»ç”Ÿé€‰é¡¹
        async function loadDoctorOptions() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/doctors?page=0&size=100&sortBy=name&sortDir=asc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const select = document.getElementById('registrationDoctor');
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©åŒ»ç”Ÿ</option>';
                        result.data.content.forEach(doctor => {
                            if (doctor.available) { // åªæ˜¾ç¤ºå¯ç”¨çš„åŒ»ç”Ÿ
                                const fee = doctor.consultationFee ? `Â¥${doctor.consultationFee.toFixed(2)}` : 'Â¥0.00';
                                select.innerHTML += `<option value="${doctor.id}" data-fee="${doctor.consultationFee || 0}">${doctor.name} - ${doctor.department} (${fee})</option>`;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('åŠ è½½åŒ»ç”Ÿé€‰é¡¹å¤±è´¥:', error);
            }
        }

        // åŒ»ç”Ÿé€‰æ‹©å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°æŒ‚å·è´¹
        function onDoctorChange() {
            const select = document.getElementById('registrationDoctor');
            const selectedOption = select.options[select.selectedIndex];
            const fee = selectedOption.getAttribute('data-fee') || 0;
            document.getElementById('registrationFee').value = parseFloat(fee).toFixed(2);
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºinput datetime-localæ ¼å¼
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // æŸ¥çœ‹æŒ‚å·è¯¦æƒ…
        async function viewRegistration(registrationId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/registrations/${registrationId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const registration = result.data;
                        // å¡«å……è¡¨å•æ•°æ®
                        document.getElementById('registrationModalTitle').textContent = 'æŸ¥çœ‹æŒ‚å·ä¿¡æ¯';
                        document.getElementById('registrationId').value = registration.id;
                        document.getElementById('registrationPatient').innerHTML = `<option value="${registration.patient.id}" selected>${registration.patient.name}</option>`;
                        document.getElementById('registrationDoctor').innerHTML = `<option value="${registration.doctor.id}" selected>${registration.doctor.name} - ${registration.doctor.department}</option>`;
                        document.getElementById('registrationAppointmentTime').value = formatDateTimeLocal(new Date(registration.appointmentTime));
                        document.getElementById('registrationFee').value = registration.registrationFee?.toFixed(2) || '0.00';
                        document.getElementById('registrationStatus').value = registration.status;
                        document.getElementById('registrationSymptoms').value = registration.symptoms || '';
                        document.getElementById('registrationDiagnosis').value = registration.diagnosis || '';
                        document.getElementById('registrationTreatment').value = registration.treatment || '';
                        document.getElementById('registrationPrescription').value = registration.prescription || '';
                        document.getElementById('registrationNotes').value = registration.notes || '';
                        
                        // è®¾ä¸ºåªè¯»æ¨¡å¼
                        const formInputs = document.querySelectorAll('#registrationForm input, #registrationForm select, #registrationForm textarea');
                        formInputs.forEach(input => input.disabled = true);
                        
                        document.getElementById('saveRegistrationBtn').style.display = 'none';
                        
                        // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
                        const modalElement = document.getElementById('registrationModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('è·å–æŒ‚å·ä¿¡æ¯å¤±è´¥:', error);
                alert('è·å–æŒ‚å·ä¿¡æ¯å¤±è´¥');
            }
        }

        // ç¼–è¾‘æŒ‚å·
        async function editRegistration(registrationId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/registrations/${registrationId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const registration = result.data;
                        // å¡«å……è¡¨å•æ•°æ®
                        document.getElementById('registrationModalTitle').textContent = 'ç¼–è¾‘æŒ‚å·ä¿¡æ¯';
                        document.getElementById('registrationId').value = registration.id;
                        
                        // å…ˆåŠ è½½é€‰é¡¹ï¼Œå†è®¾ç½®é€‰ä¸­å€¼
                        await Promise.all([loadPatientOptions(), loadDoctorOptions()]);
                        
                        document.getElementById('registrationPatient').value = registration.patient.id;
                        document.getElementById('registrationDoctor').value = registration.doctor.id;
                        document.getElementById('registrationAppointmentTime').value = formatDateTimeLocal(new Date(registration.appointmentTime));
                        document.getElementById('registrationFee').value = registration.registrationFee?.toFixed(2) || '0.00';
                        document.getElementById('registrationStatus').value = registration.status;
                        document.getElementById('registrationSymptoms').value = registration.symptoms || '';
                        document.getElementById('registrationDiagnosis').value = registration.diagnosis || '';
                        document.getElementById('registrationTreatment').value = registration.treatment || '';
                        document.getElementById('registrationPrescription').value = registration.prescription || '';
                        document.getElementById('registrationNotes').value = registration.notes || '';
                        
                        // å¯ç”¨ç¼–è¾‘æ¨¡å¼
                        const formInputs = document.querySelectorAll('#registrationForm input, #registrationForm select, #registrationForm textarea');
                        formInputs.forEach(input => input.disabled = false);
                        
                        document.getElementById('saveRegistrationBtn').style.display = 'block';
                        
                        // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
                        const modalElement = document.getElementById('registrationModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('è·å–æŒ‚å·ä¿¡æ¯å¤±è´¥:', error);
                alert('è·å–æŒ‚å·ä¿¡æ¯å¤±è´¥');
            }
        }

        // æ¸…é™¤æŒ‚å·å­—æ®µé”™è¯¯æ ·å¼
        function clearRegistrationFieldErrors() {
            const fields = ['registrationPatient', 'registrationDoctor', 'registrationAppointmentTime', 'registrationFee', 'registrationStatus', 'registrationSymptoms', 'registrationDiagnosis', 'registrationTreatment', 'registrationPrescription', 'registrationNotes'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('is-invalid');
                    // ç§»é™¤å·²æœ‰çš„é”™è¯¯æç¤º
                    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                }
            });
        }

        // æ˜¾ç¤ºæŒ‚å·å­—æ®µé”™è¯¯
        function showRegistrationFieldErrors(fieldErrors) {
            // å­—æ®µåæ˜ å°„
            const fieldMap = {
                'patient': 'registrationPatient',
                'doctor': 'registrationDoctor', 
                'appointmentTime': 'registrationAppointmentTime',
                'registrationFee': 'registrationFee',
                'status': 'registrationStatus',
                'symptoms': 'registrationSymptoms',
                'diagnosis': 'registrationDiagnosis',
                'treatment': 'registrationTreatment',
                'prescription': 'registrationPrescription',
                'notes': 'registrationNotes'
            };

            for (const [fieldName, errorMessage] of Object.entries(fieldErrors)) {
                const fieldId = fieldMap[fieldName];
                if (fieldId) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // æ·»åŠ é”™è¯¯æ ·å¼
                        field.classList.add('is-invalid');
                        
                        // æ·»åŠ é”™è¯¯æç¤º
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = errorMessage;
                        field.parentNode.appendChild(errorDiv);
                    }
                }
            }
        }

        // ä¿å­˜æŒ‚å·ä¿¡æ¯
        async function saveRegistration() {
            // é˜²æ­¢é‡å¤æäº¤
            const saveBtn = document.getElementById('saveRegistrationBtn');
            if (saveBtn.disabled) {
                return; // å¦‚æœæŒ‰é’®å·²ç¦ç”¨ï¼Œç›´æ¥è¿”å›
            }
            
            // ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æç¤º
            clearRegistrationFieldErrors();

            // è·å–è¡¨å•æ•°æ®
            const patientId = document.getElementById('registrationPatient').value;
            const doctorId = document.getElementById('registrationDoctor').value;
            const appointmentTime = document.getElementById('registrationAppointmentTime').value;
            const registrationFee = document.getElementById('registrationFee').value.trim();
            const status = document.getElementById('registrationStatus').value;
            const symptoms = document.getElementById('registrationSymptoms').value.trim();
            const diagnosis = document.getElementById('registrationDiagnosis').value.trim();
            const treatment = document.getElementById('registrationTreatment').value.trim();
            const prescription = document.getElementById('registrationPrescription').value.trim();
            const notes = document.getElementById('registrationNotes').value.trim();

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!patientId) {
                alert('è¯·é€‰æ‹©ç—…äºº');
                document.getElementById('registrationPatient').focus();
                return;
            }
            
            if (!doctorId) {
                alert('è¯·é€‰æ‹©åŒ»ç”Ÿ');
                document.getElementById('registrationDoctor').focus();
                return;
            }
            
            if (!appointmentTime) {
                alert('è¯·é€‰æ‹©é¢„çº¦æ—¶é—´');
                document.getElementById('registrationAppointmentTime').focus();
                return;
            }

            if (!registrationFee || isNaN(parseFloat(registrationFee))) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŒ‚å·è´¹');
                document.getElementById('registrationFee').focus();
                return;
            }

            if (!status) {
                alert('è¯·é€‰æ‹©æŒ‚å·çŠ¶æ€');
                document.getElementById('registrationStatus').focus();
                return;
            }

            // æ„å»ºæ•°æ®å¯¹è±¡
            const registrationData = {
                patient: { id: parseInt(patientId) },
                doctor: { id: parseInt(doctorId) },
                appointmentTime: new Date(appointmentTime).toISOString(),
                registrationFee: parseFloat(registrationFee),
                status: status
            };

            // æ·»åŠ å¯é€‰å­—æ®µ
            if (symptoms && symptoms.trim() !== '') {
                registrationData.symptoms = symptoms.trim();
            }
            if (diagnosis && diagnosis.trim() !== '') {
                registrationData.diagnosis = diagnosis.trim();
            }
            if (treatment && treatment.trim() !== '') {
                registrationData.treatment = treatment.trim();
            }
            if (prescription && prescription.trim() !== '') {
                registrationData.prescription = prescription.trim();
            }
            if (notes && notes.trim() !== '') {
                registrationData.notes = notes.trim();
            }

            const registrationId = document.getElementById('registrationId').value;
            const isEdit = registrationId && registrationId.trim() !== '';

            try {
                const token = localStorage.getItem('token');
                const url = isEdit ? `/api/registrations/${registrationId}` : '/api/registrations';
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('å‘é€æ•°æ®:', registrationData); // è°ƒè¯•æ—¥å¿—
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registrationData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    const operation = isEdit ? 'UPDATE' : 'CREATE';
                    const successMessage = isEdit ? 'æŒ‚å·ä¿¡æ¯æ›´æ–°æˆåŠŸï¼' : 'æŒ‚å·åˆ›å»ºæˆåŠŸï¼';
                    
                    alert(successMessage);
                    
                    // å‘é€é€šçŸ¥
                    if (window.notificationHelper) {
                        try {
                            console.log('å‡†å¤‡å‘é€æŒ‚å·é€šçŸ¥...', operation);
                            // è·å–ç—…äººå’ŒåŒ»ç”Ÿçš„åç§°
                            const patientSelect = document.getElementById('registrationPatient');
                            const doctorSelect = document.getElementById('registrationDoctor');
                            const patientName = patientSelect.options[patientSelect.selectedIndex]?.text || 'æœªçŸ¥ç—…äºº';
                            const doctorName = doctorSelect.options[doctorSelect.selectedIndex]?.text || 'æœªçŸ¥åŒ»ç”Ÿ';
                            
                            const notificationData = {
                                id: result.data?.id || registrationData.id,
                                patientName: patientName,
                                doctorName: doctorName,
                                appointmentTime: registrationData.appointmentTime
                            };
                            await window.notificationHelper.sendRegistrationNotification(operation.toLowerCase(), notificationData);
                            console.log('æŒ‚å·é€šçŸ¥å‘é€æˆåŠŸ');
                        } catch (notifyError) {
                            console.error('å‘é€é€šçŸ¥å¤±è´¥:', notifyError);
                        }
                    } else {
                        console.error('é€šçŸ¥ç³»ç»Ÿæœªåˆå§‹åŒ–');
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('registrationModal')).hide();
                    loadRegistrations(); // é‡æ–°åŠ è½½æŒ‚å·åˆ—è¡¨
                } else {
                    // å¤„ç†éªŒè¯é”™è¯¯
                    if (result.data && typeof result.data === 'object') {
                        // æ˜¾ç¤ºå­—æ®µçº§åˆ«çš„é”™è¯¯
                        showRegistrationFieldErrors(result.data);
                        alert('è¾“å…¥ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·æŸ¥çœ‹æ ‡çº¢çš„å­—æ®µæç¤ºå¹¶ä¿®æ­£');
                    } else {
                        // æ˜¾ç¤ºé€šç”¨é”™è¯¯ä¿¡æ¯
                        alert('ä¿å­˜å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                }
            } catch (error) {
                console.error('ä¿å­˜æŒ‚å·ä¿¡æ¯å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.disabled = false;
                saveBtn.textContent = 'ä¿å­˜';
            }
        }

        // åˆ é™¤æŒ‚å·
        async function deleteRegistration(registrationId, patientName) {
            // ç¡®è®¤åˆ é™¤
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤ç—…äºº "${patientName}" çš„æŒ‚å·è®°å½•å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚`;
            
            if (!confirm(confirmMessage)) {
                return; // ç”¨æˆ·å–æ¶ˆåˆ é™¤
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/registrations/${registrationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`æŒ‚å·è®°å½•åˆ é™¤æˆåŠŸï¼`);
                        
                        // å‘é€åˆ é™¤é€šçŸ¥
                        if (window.notificationHelper) {
                            try {
                                const notificationData = {
                                    id: registrationId,
                                    patientName: patientName
                                };
                                await window.notificationHelper.sendRegistrationNotification('delete', notificationData);
                            } catch (notifyError) {
                                console.error('å‘é€é€šçŸ¥å¤±è´¥:', notifyError);
                            }
                        }
                        
                        loadRegistrations(); // é‡æ–°åŠ è½½æŒ‚å·åˆ—è¡¨
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('åˆ é™¤å¤±è´¥:', response.status, errorText);
                    
                    if (response.status === 403) {
                        alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤æŒ‚å·');
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                }
            } catch (error) {
                console.error('åˆ é™¤æŒ‚å·å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ================== æ”¶è´¹ç®¡ç†ç›¸å…³å‡½æ•° ==================

        // åŠ è½½æ”¶è´¹æ•°æ®
        async function loadPayments() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/payments?page=0&size=10&sortBy=id&sortDir=desc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const tbody = document.getElementById('paymentsTable');
                        tbody.innerHTML = result.data.content.map(payment => {
                            const createdAt = new Date(payment.createdAt).toLocaleString('zh-CN');
                            const statusBadge = getPaymentStatusBadge(payment.status);
                            const typeName = getPaymentTypeName(payment.paymentType);
                            
                            return `
                                <tr>
                                    <td>${payment.patient?.name || 'æœªçŸ¥'}</td>
                                    <td>${typeName}</td>
                                    <td>Â¥${payment.amount?.toFixed(2) || '0.00'}</td>
                                    <td>${payment.quantity || 1}</td>
                                    <td>${payment.paymentMethod || '-'}</td>
                                    <td>${statusBadge}</td>
                                    <td>${createdAt}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewPayment(${payment.id})">æŸ¥çœ‹</button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="editPayment(${payment.id})">ç¼–è¾‘</button>
                                        ${payment.status === 'PENDING' ? `<button class="btn btn-sm btn-outline-success" onclick="processPayment(${payment.id})">æ”¯ä»˜</button>` : ''}
                                        ${payment.status === 'PAID' ? `<button class="btn btn-sm btn-outline-info" onclick="processRefund(${payment.id})">é€€è´¹</button>` : ''}
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePayment(${payment.id}, '${payment.patient?.name}')">åˆ é™¤</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ”¶è´¹æ•°æ®å¤±è´¥:', error);
                document.getElementById('paymentsTable').innerHTML = '<tr><td colspan="8" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // è·å–æ”¯ä»˜çŠ¶æ€å¾½ç« 
        function getPaymentStatusBadge(status) {
            const badges = {
                'PENDING': '<span class="badge bg-warning">å¾…æ”¯ä»˜</span>',
                'PAID': '<span class="badge bg-success">å·²æ”¯ä»˜</span>',
                'REFUNDED': '<span class="badge bg-secondary">å·²é€€è´¹</span>'
            };
            return badges[status] || '<span class="badge bg-light">æœªçŸ¥</span>';
        }

        // è·å–æ”¯ä»˜ç±»å‹åç§°
        function getPaymentTypeName(type) {
            const types = {
                'REGISTRATION': 'æŒ‚å·è´¹',
                'MEDICINE': 'è¯è´¹',
                'EXAMINATION': 'æ£€æŸ¥è´¹',
                'TREATMENT': 'æ²»ç–—è´¹'
            };
            return types[type] || 'æœªçŸ¥ç±»å‹';
        }

        // æ˜¾ç¤ºæ·»åŠ æ”¶è´¹æ¨¡æ€æ¡†
        function showAddPaymentModal() {
            document.getElementById('paymentModalTitle').textContent = 'æ–°å»ºæ”¶è´¹è®°å½•';
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentId').value = '';
            
            // è®¾ç½®é»˜è®¤å€¼
            document.getElementById('paymentQuantity').value = 1;
            document.getElementById('paymentStatus').value = 'PENDING';
            
            // å¯ç”¨ç¼–è¾‘æ¨¡å¼
            const formInputs = document.querySelectorAll('#paymentForm input, #paymentForm select, #paymentForm textarea');
            formInputs.forEach(input => input.disabled = false);
            
            document.getElementById('savePaymentBtn').style.display = 'block';
            
            // åŠ è½½é€‰é¡¹
            Promise.all([loadPatientOptions('paymentPatient'), loadRegistrationOptions()]).then(() => {
                // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
                const modalElement = document.getElementById('paymentModal');
                let modal = bootstrap.Modal.getInstance(modalElement);
                if (!modal) {
                    modal = new bootstrap.Modal(modalElement);
                }
                modal.show();
            });
        }

        // æŸ¥çœ‹æ”¶è´¹è®°å½•
        async function viewPayment(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const payment = result.data;
                        
                        // å¡«å……åŸºæœ¬å­—æ®µ
                        document.getElementById('paymentModalTitle').textContent = 'æŸ¥çœ‹æ”¶è´¹è®°å½•';
                        document.getElementById('paymentId').value = payment.id;
                        
                        // å®‰å…¨åœ°å¤„ç†ç—…äººä¿¡æ¯
                        if (payment.patient) {
                            const genderText = payment.patient.gender === 'MALE' ? 'ç”·' : 'å¥³';
                            document.getElementById('paymentPatient').innerHTML = `<option value="${payment.patient.id}" selected>${payment.patient.name} (${genderText})</option>`;
                        } else {
                            document.getElementById('paymentPatient').innerHTML = '<option value="" selected>ç—…äººä¿¡æ¯ç¼ºå¤±</option>';
                        }
                        document.getElementById('paymentType').value = payment.paymentType;
                        document.getElementById('paymentAmount').value = payment.amount?.toFixed(2) || '0.00';
                        document.getElementById('paymentQuantity').value = payment.quantity || 1;
                        document.getElementById('paymentMethod').value = payment.paymentMethod || '';
                        document.getElementById('paymentDescription').value = payment.description || '';
                        
                        // éšè—å­—æ®µèµ‹å€¼
                        document.getElementById('paymentStatus').value = payment.status || 'PENDING';
                        document.getElementById('paymentTransactionId').value = payment.transactionId || '';
                        document.getElementById('paymentNotes').value = payment.notes || '';
                        
                        // å…³è”æŒ‚å·å­—æ®µ
                        if (payment.registration) {
                            document.getElementById('paymentRegistration').innerHTML = `<option value="${payment.registration.id}" selected>ã€å…³è”ã€‘${payment.registration.patient?.name} â†’ ${payment.registration.doctor?.name}</option>`;
                        } else {
                            document.getElementById('paymentRegistration').innerHTML = '<option value="" selected>ä¸å…³è”ä»»ä½•æŒ‚å·</option>';
                        }
                        
                        // è®¾ä¸ºåªè¯»æ¨¡å¼
                        const formInputs = document.querySelectorAll('#paymentForm input:not([type="hidden"]), #paymentForm select, #paymentForm textarea');
                        formInputs.forEach(input => input.disabled = true);
                        
                        document.getElementById('savePaymentBtn').style.display = 'none';
                        
                        // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
                        const modalElement = document.getElementById('paymentModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    } else {
                        alert('è·å–æ”¶è´¹è®°å½•å¤±è´¥ï¼š' + result.message);
                    }
                } else {
                    alert('è·å–æ”¶è´¹è®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('è·å–æ”¶è´¹è®°å½•å¤±è´¥:', error);
                alert('è·å–æ”¶è´¹è®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ç¼–è¾‘æ”¶è´¹è®°å½•
        async function editPayment(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const payment = result.data;
                        
                        // è®¾ç½®æ ‡é¢˜å’ŒID
                        document.getElementById('paymentModalTitle').textContent = 'ç¼–è¾‘æ”¶è´¹è®°å½•';
                        document.getElementById('paymentId').value = payment.id;
                        
                        // å…ˆåŠ è½½é€‰é¡¹ï¼Œå†è®¾ç½®é€‰ä¸­å€¼
                        await Promise.all([loadPatientOptions('paymentPatient'), loadRegistrationOptions()]);
                        
                        // å¡«å……è¡¨å•æ•°æ®
                        if (payment.patient) {
                            document.getElementById('paymentPatient').value = payment.patient.id;
                        } else {
                            document.getElementById('paymentPatient').value = '';
                        }
                        document.getElementById('paymentType').value = payment.paymentType;
                        document.getElementById('paymentAmount').value = payment.amount?.toFixed(2) || '0.00';
                        document.getElementById('paymentQuantity').value = payment.quantity || 1;
                        document.getElementById('paymentMethod').value = payment.paymentMethod || '';
                        document.getElementById('paymentDescription').value = payment.description || '';
                        
                        // éšè—å­—æ®µèµ‹å€¼
                        document.getElementById('paymentStatus').value = payment.status || 'PENDING';
                        document.getElementById('paymentTransactionId').value = payment.transactionId || '';
                        document.getElementById('paymentNotes').value = payment.notes || '';
                        
                        // è®¾ç½®å…³è”æŒ‚å·
                        if (payment.registration) {
                            document.getElementById('paymentRegistration').value = payment.registration.id;
                        } else {
                            document.getElementById('paymentRegistration').value = '';
                        }
                        
                        // å¯ç”¨ç¼–è¾‘æ¨¡å¼ï¼ˆåªå¯ç”¨å¯è§çš„å­—æ®µï¼‰
                        const formInputs = document.querySelectorAll('#paymentForm input:not([type="hidden"]), #paymentForm select, #paymentForm textarea');
                        formInputs.forEach(input => input.disabled = false);
                        
                        document.getElementById('savePaymentBtn').style.display = 'block';
                        
                        // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
                        const modalElement = document.getElementById('paymentModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    } else {
                        alert('è·å–æ”¶è´¹è®°å½•å¤±è´¥ï¼š' + result.message);
                    }
                } else {
                    alert('è·å–æ”¶è´¹è®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('è·å–æ”¶è´¹è®°å½•å¤±è´¥:', error);
                alert('è·å–æ”¶è´¹è®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ä¿å­˜æ”¶è´¹è®°å½•
        async function savePayment() {
            // é˜²æ­¢é‡å¤æäº¤
            const saveBtn = document.getElementById('savePaymentBtn');
            if (saveBtn.disabled) {
                return; // å¦‚æœæŒ‰é’®å·²ç¦ç”¨ï¼Œç›´æ¥è¿”å›
            }
            
            // ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            
            const id = document.getElementById('paymentId').value;
            const patientId = document.getElementById('paymentPatient').value;
            const paymentType = document.getElementById('paymentType').value;
            const amount = document.getElementById('paymentAmount').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            // å¯é€‰å­—æ®µ
            const quantity = document.getElementById('paymentQuantity').value || 1;
            const description = document.getElementById('paymentDescription').value;
            const registrationId = document.getElementById('paymentRegistration').value;

            // ç®€å•éªŒè¯ï¼šåªæ£€æŸ¥æ ¸å¿ƒå¿…å¡«å­—æ®µ
            if (!patientId) {
                alert('è¯·é€‰æ‹©è¦æ”¶è´¹çš„ç—…äºº');
                return;
            }
            if (!paymentType) {
                alert('è¯·é€‰æ‹©æ”¶è´¹ç±»å‹');
                return;
            }
            if (!amount || amount <= 0) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„æ”¶è´¹é‡‘é¢');
                return;
            }
            if (!paymentMethod) {
                alert('è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼');
                return;
            }

            const paymentData = {
                patient: { id: parseInt(patientId) },
                paymentType: paymentType,
                amount: parseFloat(amount),
                quantity: parseInt(quantity),
                paymentMethod: paymentMethod,
                status: 'PENDING', // æ–°å»ºæ”¶è´¹å•é»˜è®¤ä¸ºå¾…æ”¯ä»˜
                description: description || null,
                registration: registrationId ? { id: parseInt(registrationId) } : null
            };

            try {
                const token = localStorage.getItem('token');
                const url = id ? `/api/payments/${id}` : '/api/payments';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(paymentData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const operation = id ? 'UPDATE' : 'CREATE';
                        const successMessage = id ? 'æ”¶è´¹è®°å½•æ›´æ–°æˆåŠŸï¼' : 'æ”¶è´¹è®°å½•åˆ›å»ºæˆåŠŸï¼å¯ä»¥åœ¨åˆ—è¡¨ä¸­ç‚¹å‡»"æ”¯ä»˜"æŒ‰é’®å®Œæˆæ”¶è´¹ã€‚';
                        
                        alert(successMessage);
                        
                        // å‘é€é€šçŸ¥
                        if (window.notificationHelper) {
                            try {
                                // è·å–ç—…äººåç§°
                                const patientSelect = document.getElementById('paymentPatient');
                                const patientName = patientSelect.options[patientSelect.selectedIndex]?.text || 'æœªçŸ¥ç—…äºº';
                                
                                const notificationData = {
                                    id: result.data?.id || id,
                                    patientName: patientName,
                                    amount: paymentData.amount,
                                    paymentType: paymentData.paymentType
                                };
                                await window.notificationHelper.sendPaymentNotification(operation.toLowerCase(), notificationData);
                            } catch (notifyError) {
                                console.error('å‘é€é€šçŸ¥å¤±è´¥:', notifyError);
                            }
                        }
                        
                        bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                        loadPayments(); // é‡æ–°åŠ è½½æ”¶è´¹åˆ—è¡¨
                    } else {
                        alert('ä¿å­˜å¤±è´¥ï¼š' + result.message);
                    }
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('ä¿å­˜æ”¶è´¹è®°å½•å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.disabled = false;
                saveBtn.textContent = 'ä¿å­˜';
            }
        }

        // åˆ é™¤æ”¶è´¹è®°å½•
        async function deletePayment(id, patientName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç—…äºº"${patientName}"çš„æ”¶è´¹è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        loadPayments(); // é‡æ–°åŠ è½½æ”¶è´¹åˆ—è¡¨
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('åˆ é™¤å¤±è´¥:', response.status, errorText);
                    
                    if (response.status === 403) {
                        alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤æ”¶è´¹è®°å½•');
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                }
            } catch (error) {
                console.error('åˆ é™¤æ”¶è´¹è®°å½•å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // å¤„ç†æ”¯ä»˜
        async function processPayment(id) {
            if (!confirm('ç¡®è®¤ç—…äººå·²ç»ä»˜æ¬¾äº†å—ï¼Ÿç‚¹å‡»ç¡®å®šåå°†æ ‡è®°ä¸º"å·²æ”¯ä»˜"ã€‚')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${id}/pay?transactionId=`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… æ”¯ä»˜æˆåŠŸï¼è¯¥æ”¶è´¹è®°å½•å·²æ ‡è®°ä¸º"å·²æ”¯ä»˜"çŠ¶æ€ã€‚');
                        loadPayments(); // é‡æ–°åŠ è½½æ”¶è´¹åˆ—è¡¨
                    } else {
                        alert('æ”¯ä»˜å¤±è´¥ï¼š' + result.message);
                    }
                } else {
                    alert('æ”¯ä»˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('å¤„ç†æ”¯ä»˜å¤±è´¥:', error);
                alert('æ”¯ä»˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // å¤„ç†é€€è´¹
        async function processRefund(id) {
            if (!confirm('âš ï¸ ç¡®å®šè¦ç»™ç—…äººé€€è´¹å—ï¼Ÿ\n\né€€è´¹åè¿™ç¬”æ”¶è´¹è®°å½•å°†å˜æˆ"å·²é€€è´¹"çŠ¶æ€ï¼Œæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${id}/refund`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('ğŸ’° é€€è´¹æˆåŠŸï¼è¯¥æ”¶è´¹è®°å½•å·²æ ‡è®°ä¸º"å·²é€€è´¹"çŠ¶æ€ã€‚è¯·å°†æ¬¾é¡¹é€€ç»™ç—…äººã€‚');
                        loadPayments(); // é‡æ–°åŠ è½½æ”¶è´¹åˆ—è¡¨
                    } else {
                        alert('é€€è´¹å¤±è´¥ï¼š' + result.message);
                    }
                } else {
                    alert('é€€è´¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('å¤„ç†é€€è´¹å¤±è´¥:', error);
                alert('é€€è´¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åŠ è½½æŒ‚å·é€‰é¡¹ï¼ˆç”¨äºæ”¶è´¹æ—¶å…³è”æŒ‚å·è®°å½•ï¼‰
        async function loadRegistrationOptions() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/registrations?page=0&size=100&sortBy=id&sortDir=desc', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const select = document.getElementById('paymentRegistration');
                        if (select) {
                            select.innerHTML = '<option value="">ä¸å…³è”ä»»ä½•æŒ‚å·ï¼ˆæ¨èï¼‰</option>';
                            
                            // åªæ˜¾ç¤ºæœ€è¿‘çš„æŒ‚å·è®°å½•ï¼Œè®©é€‰æ‹©æ›´ç®€å•
                            const recentRegistrations = result.data.content.slice(0, 10);
                            recentRegistrations.forEach(registration => {
                                const date = new Date(registration.createdAt).toLocaleDateString('zh-CN');
                                select.innerHTML += `<option value="${registration.id}">ã€${date}ã€‘${registration.patient?.name} â†’ ${registration.doctor?.name}</option>`;
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æŒ‚å·é€‰é¡¹å¤±è´¥:', error);
                // å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿä¸å½±å“ä¸»è¦åŠŸèƒ½
                const select = document.getElementById('paymentRegistration');
                if (select) {
                    select.innerHTML = '<option value="">ä¸å…³è”ä»»ä½•æŒ‚å·</option>';
                }
            }
        }

        // ========== è¯å“ç®¡ç†ç›¸å…³å‡½æ•° ==========

        // å…¨å±€å˜é‡
        let allMedicines = [];
        let filteredMedicines = [];

        // åŠ è½½è¯å“æ•°æ®
        async function loadMedicines() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/medicines?page=0&size=1000', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        allMedicines = result.data.content || [];
                        filteredMedicines = [...allMedicines];
                        displayMedicines(filteredMedicines);
                        updateMedicineStatistics();
                    } else {
                        console.error('åŠ è½½è¯å“æ•°æ®å¤±è´¥:', result.message);
                        showCustomAlert('åŠ è½½è¯å“æ•°æ®å¤±è´¥: ' + result.message, 'error', 'é”™è¯¯');
                    }
                } else {
                    console.error('HTTPé”™è¯¯:', response.status);
                    showCustomAlert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error', 'ç½‘ç»œé”™è¯¯');
                }
            } catch (error) {
                console.error('åŠ è½½è¯å“æ•°æ®å¼‚å¸¸:', error);
                showCustomAlert('åŠ è½½è¯å“æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error', 'ç³»ç»Ÿé”™è¯¯');
            }
        }

        // æ˜¾ç¤ºè¯å“åˆ—è¡¨
        function displayMedicines(medicines) {
            const tbody = document.getElementById('medicinesTable');
            if (!tbody) return;

            if (medicines.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æš‚æ— è¯å“æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = medicines.map(medicine => {
                const stockStatus = getMedicineStockStatus(medicine.stock);
                const availableStatus = medicine.available ? 
                    '<span class="badge bg-success">å¯ç”¨</span>' : 
                    '<span class="badge bg-danger">åœç”¨</span>';

                return `
                    <tr data-medicine-id="${medicine.id}">
                        <td>
                            <strong>${medicine.name}</strong>
                            ${medicine.category ? `<br><small class="text-muted">${medicine.category}</small>` : ''}
                        </td>
                        <td><code>${medicine.code}</code></td>
                        <td>
                            <span class="badge bg-info">${medicine.category || 'æœªåˆ†ç±»'}</span>
                        </td>
                        <td>${medicine.specification}</td>
                        <td class="text-primary fw-bold">Â¥${medicine.price}/${medicine.unit}</td>
                        <td>
                            <span class="fw-bold ${stockStatus.class}">${medicine.stock}</span> 
                            <small class="text-muted">${medicine.unit}</small>
                        </td>
                        <td>
                            ${stockStatus.badge}
                            ${availableStatus}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewMedicineDetail(${medicine.id})" title="æŸ¥çœ‹è¯¦æƒ…">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="editMedicine(${medicine.id})" title="ç¼–è¾‘">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="updateMedicineStock(${medicine.id})" title="è°ƒæ•´åº“å­˜">
                                    <i class="bi bi-box-seam"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteMedicine(${medicine.id})" title="åˆ é™¤">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // è·å–è¯å“åº“å­˜çŠ¶æ€
        function getMedicineStockStatus(stock) {
            if (stock <= 0) {
                return {
                    badge: '<span class="badge bg-danger">ç¼ºè´§</span>',
                    class: 'text-danger'
                };
            } else if (stock <= 10) {
                return {
                    badge: '<span class="badge bg-warning">åº“å­˜ä¸è¶³</span>',
                    class: 'text-warning'
                };
            } else {
                return {
                    badge: '<span class="badge bg-success">åº“å­˜å……è¶³</span>',
                    class: 'text-success'
                };
            }
        }

        // æ›´æ–°è¯å“ç»Ÿè®¡
        function updateMedicineStatistics() {
            const total = allMedicines.length;
            const sufficient = allMedicines.filter(m => m.stock > 10).length;
            const low = allMedicines.filter(m => m.stock > 0 && m.stock <= 10).length;
            const out = allMedicines.filter(m => m.stock <= 0).length;

            document.getElementById('totalMedicinesCount').textContent = total;
            document.getElementById('sufficientStockCount').textContent = sufficient;
            document.getElementById('lowStockCount').textContent = low;
            document.getElementById('outOfStockCount').textContent = out;
        }

        // æ˜¾ç¤ºæ·»åŠ è¯å“æ¨¡æ€æ¡†
        function showAddMedicineModal() {
            document.getElementById('medicineModalLabel').textContent = 'æ·»åŠ è¯å“';
            document.getElementById('medicineForm').reset();
            document.getElementById('medicineId').value = '';
            document.getElementById('medicineAvailable').checked = true;
            clearMedicineFieldErrors();
            
            // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
            const modalElement = document.getElementById('medicineModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }

        // ç¼–è¾‘è¯å“
        async function editMedicine(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/medicines/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const medicine = result.data;
                        
                        document.getElementById('medicineModalLabel').textContent = 'ç¼–è¾‘è¯å“';
                        document.getElementById('medicineId').value = medicine.id;
                        document.getElementById('medicineName').value = medicine.name;
                        document.getElementById('medicineCode').value = medicine.code;
                        document.getElementById('medicineCategory').value = medicine.category || '';
                        document.getElementById('medicineSpecification').value = medicine.specification;
                        document.getElementById('medicineDosageForm').value = medicine.dosageForm || '';
                        document.getElementById('medicineUnit').value = medicine.unit;
                        document.getElementById('medicinePrice').value = medicine.price;
                        document.getElementById('medicineStock').value = medicine.stock;
                        document.getElementById('medicineManufacturer').value = medicine.manufacturer || '';
                        document.getElementById('medicineIndication').value = medicine.indication || '';
                        document.getElementById('medicineDosage').value = medicine.dosage || '';
                        document.getElementById('medicineSideEffects').value = medicine.sideEffects || '';
                        document.getElementById('medicineContraindications').value = medicine.contraindications || '';
                        document.getElementById('medicineAvailable').checked = medicine.available;
                        
                        clearMedicineFieldErrors();
                        
                        // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
                        const modalElement = document.getElementById('medicineModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('è·å–è¯å“ä¿¡æ¯å¤±è´¥:', error);
                showCustomAlert('è·å–è¯å“ä¿¡æ¯å¤±è´¥', 'error', 'é”™è¯¯');
            }
        }

        // ä¿å­˜è¯å“
        async function saveMedicine() {
            // é˜²æ­¢é‡å¤æäº¤
            const saveBtn = document.querySelector('#medicineModal .btn-primary');
            if (saveBtn && saveBtn.disabled) {
                return; // å¦‚æœæŒ‰é’®å·²ç¦ç”¨ï¼Œç›´æ¥è¿”å›
            }
            
            // ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'ä¿å­˜ä¸­...';
            }
            
            clearMedicineFieldErrors();
            
            const id = document.getElementById('medicineId').value;
            
            // è·å–è¡¨å•æ•°æ®å¹¶è¿›è¡ŒåŸºæœ¬éªŒè¯
            const name = document.getElementById('medicineName').value.trim();
            const code = document.getElementById('medicineCode').value.trim().toUpperCase();
            const category = document.getElementById('medicineCategory').value;
            const specification = document.getElementById('medicineSpecification').value.trim();
            const unit = document.getElementById('medicineUnit').value;
            const price = parseFloat(document.getElementById('medicinePrice').value);
            const stock = parseInt(document.getElementById('medicineStock').value);
            
            // å‰ç«¯éªŒè¯
            if (!name) {
                showCustomAlert('è¯·è¾“å…¥è¯å“åç§°', 'warning', 'éªŒè¯é”™è¯¯');
                return;
            }
            if (!code || !/^[A-Z0-9]{4,20}$/.test(code)) {
                showCustomAlert('è¯å“ç¼–ç æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º4-20ä½å¤§å†™å­—æ¯å’Œæ•°å­—ç»„åˆ', 'warning', 'éªŒè¯é”™è¯¯');
                return;
            }
            if (!category) {
                showCustomAlert('è¯·é€‰æ‹©è¯å“åˆ†ç±»', 'warning', 'éªŒè¯é”™è¯¯');
                return;
            }
            if (!specification) {
                showCustomAlert('è¯·è¾“å…¥è¯å“è§„æ ¼', 'warning', 'éªŒè¯é”™è¯¯');
                return;
            }
            if (!unit) {
                showCustomAlert('è¯·é€‰æ‹©è¯å“å•ä½', 'warning', 'éªŒè¯é”™è¯¯');
                return;
            }
            if (isNaN(price) || price <= 0) {
                showCustomAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„è¯å“ä»·æ ¼', 'warning', 'éªŒè¯é”™è¯¯');
                return;
            }
            if (isNaN(stock) || stock < 0) {
                showCustomAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„åº“å­˜æ•°é‡', 'warning', 'éªŒè¯é”™è¯¯');
                return;
            }
            
            const medicineData = {
                name: name,
                code: code,
                category: category,
                specification: specification,
                dosageForm: document.getElementById('medicineDosageForm').value.trim() || '',
                unit: unit,
                price: price,
                stock: stock,
                manufacturer: document.getElementById('medicineManufacturer').value.trim() || '',
                indication: document.getElementById('medicineIndication').value.trim() || '',
                dosage: document.getElementById('medicineDosage').value.trim() || '',
                sideEffects: document.getElementById('medicineSideEffects').value.trim() || '',
                contraindications: document.getElementById('medicineContraindications').value.trim() || '',
                available: document.getElementById('medicineAvailable').checked
            };

            try {
                const token = localStorage.getItem('token');
                const url = id ? `/api/medicines/${id}` : '/api/medicines';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(medicineData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const operation = id ? 'UPDATE' : 'CREATE';
                    const successMessage = id ? 'è¯å“æ›´æ–°æˆåŠŸ' : 'è¯å“æ·»åŠ æˆåŠŸ';
                    
                    showCustomAlert(successMessage, 'success', 'æˆåŠŸ');
                    
                    // å‘é€é€šçŸ¥
                    if (window.notificationHelper) {
                        try {
                            const notificationData = {
                                id: result.data?.id || id,
                                name: name,
                                code: code,
                                stock: stock,
                                category: category
                            };
                            await window.notificationHelper.sendMedicineNotification(operation.toLowerCase(), notificationData);
                        } catch (notifyError) {
                            console.error('å‘é€é€šçŸ¥å¤±è´¥:', notifyError);
                        }
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('medicineModal')).hide();
                    loadMedicines();
                } else {
                    if (response.status === 400 && result.errors) {
                        showMedicineFieldErrors(result.errors);
                    } else {
                        showCustomAlert(result.message || 'ä¿å­˜è¯å“å¤±è´¥', 'error', 'é”™è¯¯');
                    }
                }
            } catch (error) {
                console.error('ä¿å­˜è¯å“å¤±è´¥:', error);
                showCustomAlert('ä¿å­˜è¯å“æ—¶å‘ç”Ÿé”™è¯¯', 'error', 'ç³»ç»Ÿé”™è¯¯');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ä¿å­˜';
                }
            }
        }

        // æ¸…é™¤è¯å“å­—æ®µé”™è¯¯
        function clearMedicineFieldErrors() {
            const form = document.getElementById('medicineForm');
            form.querySelectorAll('.is-invalid').forEach(field => {
                field.classList.remove('is-invalid');
            });
            form.querySelectorAll('.invalid-feedback').forEach(feedback => {
                feedback.textContent = '';
            });
        }

        // æ˜¾ç¤ºè¯å“å­—æ®µé”™è¯¯
        function showMedicineFieldErrors(errors) {
            const fieldMap = {
                'name': 'medicineName',
                'code': 'medicineCode',
                'category': 'medicineCategory',
                'specification': 'medicineSpecification',
                'unit': 'medicineUnit',
                'price': 'medicinePrice',
                'stock': 'medicineStock',
                'manufacturer': 'medicineManufacturer',
                'indication': 'medicineIndication',
                'dosage': 'medicineDosage',
                'sideEffects': 'medicineSideEffects',
                'contraindications': 'medicineContraindications'
            };

            Object.keys(errors).forEach(field => {
                const fieldId = fieldMap[field];
                if (fieldId) {
                    const fieldElement = document.getElementById(fieldId);
                    const feedbackElement = fieldElement.nextElementSibling;
                    
                    fieldElement.classList.add('is-invalid');
                    if (feedbackElement && feedbackElement.classList.contains('invalid-feedback')) {
                        feedbackElement.textContent = errors[field];
                    }
                }
            });
        }

        // åˆ é™¤è¯å“
        async function deleteMedicine(id) {
            const confirmed = await showCustomConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯å“å—ï¼Ÿ\nåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚', 'ç¡®è®¤åˆ é™¤');
            if (!confirmed) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/medicines/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showCustomAlert('è¯å“åˆ é™¤æˆåŠŸ', 'success', 'æˆåŠŸ');
                    loadMedicines();
                } else {
                    showCustomAlert(result.message || 'åˆ é™¤è¯å“å¤±è´¥', 'error', 'é”™è¯¯');
                }
            } catch (error) {
                console.error('åˆ é™¤è¯å“å¤±è´¥:', error);
                showCustomAlert('åˆ é™¤è¯å“æ—¶å‘ç”Ÿé”™è¯¯', 'error', 'ç³»ç»Ÿé”™è¯¯');
            }
        }

        // æŸ¥çœ‹è¯å“è¯¦æƒ…
        async function viewMedicineDetail(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/medicines/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        showMedicineDetailModal(result.data);
                    }
                }
            } catch (error) {
                console.error('è·å–è¯å“è¯¦æƒ…å¤±è´¥:', error);
                showCustomAlert('è·å–è¯å“è¯¦æƒ…å¤±è´¥', 'error', 'é”™è¯¯');
            }
        }

        // æ˜¾ç¤ºè¯å“è¯¦æƒ…æ¨¡æ€æ¡†
        function showMedicineDetailModal(medicine) {
            const stockStatus = getMedicineStockStatus(medicine.stock);
            
            const content = `
                <div class="row g-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-capsule-pill me-2"></i>${medicine.name}
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">è¯å“ç¼–ç </label>
                                        <div class="form-control-plaintext"><code>${medicine.code}</code></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">è¯å“åˆ†ç±»</label>
                                        <div class="form-control-plaintext">
                                            <span class="badge bg-info">${medicine.category || 'æœªåˆ†ç±»'}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">è§„æ ¼</label>
                                        <div class="form-control-plaintext">${medicine.specification}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">å•ä½</label>
                                        <div class="form-control-plaintext">${medicine.unit}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">ä»·æ ¼</label>
                                        <div class="form-control-plaintext text-primary fw-bold">Â¥${medicine.price}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-muted">åº“å­˜æ•°é‡</label>
                                        <div class="form-control-plaintext">
                                            <span class="fw-bold ${stockStatus.class}">${medicine.stock}</span> ${medicine.unit}
                                        </div>
                                    </div>
                                    ${medicine.manufacturer ? `
                                        <div class="col-12">
                                            <label class="form-label text-muted">ç”Ÿäº§å‚å®¶</label>
                                            <div class="form-control-plaintext">${medicine.manufacturer}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-info-circle me-2"></i>çŠ¶æ€ä¿¡æ¯
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label text-muted">å¯ç”¨çŠ¶æ€</label>
                                    <div>
                                        ${medicine.available ? 
                                            '<span class="badge bg-success fs-6">å¯ç”¨</span>' : 
                                            '<span class="badge bg-danger fs-6">åœç”¨</span>'
                                        }
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted">åº“å­˜çŠ¶æ€</label>
                                    <div>${stockStatus.badge}</div>
                                </div>
                                <div>
                                    <label class="form-label text-muted">åˆ›å»ºæ—¶é—´</label>
                                    <div class="form-control-plaintext">
                                        <small>${new Date(medicine.createdAt).toLocaleString()}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                ${medicine.indication || medicine.dosage || medicine.sideEffects || medicine.contraindications ? `
                    <div class="mt-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-book me-2"></i>è¯å“è¯´æ˜
                                </h6>
                            </div>
                            <div class="card-body">
                                ${medicine.indication ? `
                                    <div class="mb-3">
                                        <h6 class="text-primary">
                                            <i class="bi bi-check-circle me-2"></i>é€‚åº”ç—‡
                                        </h6>
                                        <p class="mb-0">${medicine.indication}</p>
                                    </div>
                                ` : ''}
                                
                                ${medicine.dosage ? `
                                    <div class="mb-3">
                                        <h6 class="text-info">
                                            <i class="bi bi-clock me-2"></i>ç”¨æ³•ç”¨é‡
                                        </h6>
                                        <p class="mb-0">${medicine.dosage}</p>
                                    </div>
                                ` : ''}
                                
                                ${medicine.sideEffects ? `
                                    <div class="mb-3">
                                        <h6 class="text-warning">
                                            <i class="bi bi-exclamation-triangle me-2"></i>ä¸è‰¯ååº”
                                        </h6>
                                        <p class="mb-0">${medicine.sideEffects}</p>
                                    </div>
                                ` : ''}
                                
                                ${medicine.contraindications ? `
                                    <div class="mb-0">
                                        <h6 class="text-danger">
                                            <i class="bi bi-x-circle me-2"></i>ç¦å¿Œç—‡
                                        </h6>
                                        <p class="mb-0">${medicine.contraindications}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('medicineDetailContent').innerHTML = content;
            // ç»Ÿä¸€çš„Modalå®ä¾‹ç®¡ç†
            const modalElement = document.getElementById('medicineDetailModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }

        // æŒ‰åˆ†ç±»ç­›é€‰è¯å“
        function filterMedicinesByCategory() {
            const category = document.getElementById('medicineCategoryFilter').value;
            applyMedicineFilters();
        }

        // æŒ‰åº“å­˜çŠ¶æ€ç­›é€‰è¯å“
        function filterMedicinesByStock() {
            const stockFilter = document.getElementById('medicineStockFilter').value;
            applyMedicineFilters();
        }

        // åº”ç”¨è¯å“ç­›é€‰
        function applyMedicineFilters() {
            const category = document.getElementById('medicineCategoryFilter').value;
            const stockFilter = document.getElementById('medicineStockFilter').value;
            const searchTerm = document.getElementById('medicineSearchInput').value.toLowerCase();

            filteredMedicines = allMedicines.filter(medicine => {
                // åˆ†ç±»ç­›é€‰
                if (category && medicine.category !== category) {
                    return false;
                }

                // åº“å­˜çŠ¶æ€ç­›é€‰
                if (stockFilter) {
                    if (stockFilter === 'sufficient' && medicine.stock <= 10) return false;
                    if (stockFilter === 'low' && (medicine.stock <= 0 || medicine.stock > 10)) return false;
                    if (stockFilter === 'out' && medicine.stock > 0) return false;
                }

                // æœç´¢ç­›é€‰
                if (searchTerm) {
                    return medicine.name.toLowerCase().includes(searchTerm) ||
                           medicine.code.toLowerCase().includes(searchTerm) ||
                           (medicine.manufacturer && medicine.manufacturer.toLowerCase().includes(searchTerm));
                }

                return true;
            });

            displayMedicines(filteredMedicines);
        }

        // å¤„ç†è¯å“æœç´¢é”®ç›˜äº‹ä»¶
        function handleMedicineSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchMedicinesAdmin();
            }
        }

        // ç®¡ç†ç«¯è¯å“æœç´¢
        function searchMedicinesAdmin() {
            applyMedicineFilters();
        }

        // åˆå§‹åŒ–å¸¸ç”¨è¯å“æ•°æ®
        async function initializeMedicineData() {
            const confirmed = await showCustomConfirm(
                'ç¡®å®šè¦åˆå§‹åŒ–å¸¸ç”¨è¯å“æ•°æ®å—ï¼Ÿ\n\nè¿™å°†æ·»åŠ çº¦50ç§å¸¸ç”¨è¯å“åˆ°æ•°æ®åº“ä¸­ã€‚\nå¦‚æœè¯å“å·²å­˜åœ¨ï¼Œå°†è·³è¿‡æ·»åŠ ã€‚', 
                'åˆå§‹åŒ–è¯å“æ•°æ®'
            );
            if (!confirmed) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/medicines/init-common-medicines', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showCustomAlert(`æˆåŠŸåˆå§‹åŒ– ${result.data.added} ç§å¸¸ç”¨è¯å“ï¼\nè·³è¿‡ ${result.data.skipped} ç§å·²å­˜åœ¨çš„è¯å“ã€‚`, 'success', 'åˆå§‹åŒ–å®Œæˆ');
                    loadMedicines();
                } else {
                    showCustomAlert(result.message || 'åˆå§‹åŒ–è¯å“æ•°æ®å¤±è´¥', 'error', 'é”™è¯¯');
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–è¯å“æ•°æ®å¤±è´¥:', error);
                showCustomAlert('åˆå§‹åŒ–è¯å“æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error', 'ç³»ç»Ÿé”™è¯¯');
            }
        }

        // è°ƒæ•´è¯å“åº“å­˜
        async function updateMedicineStock(id) {
            const medicine = allMedicines.find(m => m.id === id);
            if (!medicine) return;

            const newStock = prompt(`è¯·è¾“å…¥ "${medicine.name}" çš„æ–°åº“å­˜æ•°é‡ï¼š\nå½“å‰åº“å­˜ï¼š${medicine.stock} ${medicine.unit}`, medicine.stock);
            if (newStock === null) return;

            const stockNumber = parseInt(newStock);
            if (isNaN(stockNumber) || stockNumber < 0) {
                showCustomAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„åº“å­˜æ•°é‡ï¼ˆéè´Ÿæ•´æ•°ï¼‰', 'warning', 'è¾“å…¥é”™è¯¯');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/medicines/${id}/stock?quantity=${stockNumber}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showCustomAlert(`${medicine.name} åº“å­˜å·²æ›´æ–°ä¸º ${stockNumber} ${medicine.unit}`, 'success', 'åº“å­˜æ›´æ–°æˆåŠŸ');
                    loadMedicines();
                } else {
                    showCustomAlert(result.message || 'æ›´æ–°åº“å­˜å¤±è´¥', 'error', 'é”™è¯¯');
                }
            } catch (error) {
                console.error('æ›´æ–°åº“å­˜å¤±è´¥:', error);
                showCustomAlert('æ›´æ–°åº“å­˜æ—¶å‘ç”Ÿé”™è¯¯', 'error', 'ç³»ç»Ÿé”™è¯¯');
            }
        }
    </script>

    <!-- æ”¶è´¹ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalTitle">æ”¶è´¹ä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="paymentId">
                        
                        <!-- åŸºæœ¬æ”¶è´¹ä¿¡æ¯ -->
                        <div class="alert alert-info">
                            <small><strong>ğŸ’¡ æ“ä½œè¯´æ˜ï¼š</strong> å¡«å†™åŸºæœ¬ä¿¡æ¯åˆ›å»ºæ”¶è´¹å•ï¼Œç„¶åå¯ä»¥ç‚¹å‡»"æ”¯ä»˜"æŒ‰é’®å®Œæˆæ”¶è´¹</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="paymentPatient" class="form-label">é€‰æ‹©ç—…äºº *</label>
                                <select class="form-select" id="paymentPatient" required>
                                    <option value="">è¯·é€‰æ‹©è¦æ”¶è´¹çš„ç—…äºº</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="paymentType" class="form-label">æ”¶è´¹ç±»å‹ *</label>
                                <select class="form-select" id="paymentType" required>
                                    <option value="">è¯·é€‰æ‹©æ”¶è´¹ç±»å‹</option>
                                    <option value="REGISTRATION">æŒ‚å·è´¹ï¼ˆç—…äººæŒ‚å·æ—¶æ”¶å–ï¼‰</option>
                                    <option value="MEDICINE">è¯è´¹ï¼ˆåŒ»ç”Ÿå¼€è¯æ—¶æ”¶å–ï¼‰</option>
                                    <option value="EXAMINATION">æ£€æŸ¥è´¹ï¼ˆåŒ»ç”Ÿå®‰æ’æ£€æŸ¥æ—¶æ”¶å–ï¼‰</option>
                                    <option value="TREATMENT">æ²»ç–—è´¹ï¼ˆåŒ»ç”Ÿæ²»ç–—æ—¶æ”¶å–ï¼‰</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="paymentAmount" class="form-label">æ”¶è´¹é‡‘é¢ï¼ˆå…ƒï¼‰*</label>
                                <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0" required placeholder="ä¾‹å¦‚ï¼š50.00">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="paymentMethod" class="form-label">æ”¯ä»˜æ–¹å¼ *</label>
                                <select class="form-select" id="paymentMethod" required>
                                    <option value="">ç—…äººå¦‚ä½•ä»˜æ¬¾</option>
                                    <option value="ç°é‡‘">ç°é‡‘</option>
                                    <option value="æ”¯ä»˜å®">æ”¯ä»˜å®</option>
                                    <option value="å¾®ä¿¡æ”¯ä»˜">å¾®ä¿¡æ”¯ä»˜</option>
                                    <option value="é“¶è¡Œå¡">é“¶è¡Œå¡</option>
                                    <option value="åŒ»ä¿">åŒ»ä¿</option>
                                </select>
                            </div>
                        </div>

                        <!-- å¯é€‰ä¿¡æ¯ -->
                        <hr>
                        <h6 class="mb-3 text-secondary">å¯é€‰ä¿¡æ¯ï¼ˆä¸å¡«ä¹Ÿå¯ä»¥ï¼‰</h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="paymentRegistration" class="form-label">å…³è”æŒ‚å· <small class="text-muted">ï¼ˆå¦‚æœè¿™ç¬”è´¹ç”¨æ˜¯å› ä¸ºæŸæ¬¡æŒ‚å·äº§ç”Ÿçš„ï¼‰</small></label>
                                <select class="form-select" id="paymentRegistration">
                                    <option value="">ä¸å…³è”ä»»ä½•æŒ‚å·</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="paymentQuantity" class="form-label">æ•°é‡ <small class="text-muted">ï¼ˆé»˜è®¤ä¸º1ï¼‰</small></label>
                                <input type="number" class="form-control" id="paymentQuantity" value="1" min="1">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="paymentDescription" class="form-label">æ”¶è´¹è¯´æ˜ <small class="text-muted">ï¼ˆä¾‹å¦‚ï¼šæ„Ÿå†’è¯è´¹ã€è¡€å¸¸è§„æ£€æŸ¥è´¹ç­‰ï¼‰</small></label>
                            <textarea class="form-control" id="paymentDescription" rows="2" placeholder="å¯ä»¥å†™æ˜å…·ä½“çš„æ”¶è´¹é¡¹ç›®..."></textarea>
                        </div>
                        
                        <!-- éšè—çš„é«˜çº§å­—æ®µ -->
                        <input type="hidden" id="paymentStatus" value="PENDING">
                        <input type="hidden" id="paymentTransactionId">
                        <input type="hidden" id="paymentNotes">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="savePaymentBtn" onclick="savePayment()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç—…äººä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="patientModal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patientModalTitle">ç—…äººä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="patientForm">
                        <input type="hidden" id="patientId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patientName" class="form-label">å§“å *</label>
                                <input type="text" class="form-control" id="patientName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patientGender" class="form-label">æ€§åˆ« *</label>
                                <select class="form-select" id="patientGender" required>
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="MALE">ç”·</option>
                                    <option value="FEMALE">å¥³</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patientBirthDate" class="form-label">å‡ºç”Ÿæ—¥æœŸ *</label>
                                <input type="date" class="form-control" id="patientBirthDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patientPhone" class="form-label">ç”µè¯</label>
                                <input type="tel" class="form-control" id="patientPhone">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="patientAddress" class="form-label">åœ°å€</label>
                            <input type="text" class="form-control" id="patientAddress">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patientIdCard" class="form-label">èº«ä»½è¯å· *</label>
                                <input type="text" class="form-control" id="patientIdCard" required maxlength="18">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patientEmergencyContact" class="form-label">ç´§æ€¥è”ç³»äºº</label>
                                <input type="text" class="form-control" id="patientEmergencyContact">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="patientEmergencyPhone" class="form-label">ç´§æ€¥è”ç³»äººç”µè¯</label>
                            <input type="tel" class="form-control" id="patientEmergencyPhone">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="savePatientBtn" onclick="savePatient()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŒ»ç”Ÿä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="doctorModal" tabindex="-1" aria-labelledby="doctorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="doctorModalTitle">åŒ»ç”Ÿä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="doctorForm">
                        <input type="hidden" id="doctorId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="doctorName" class="form-label">å§“å *</label>
                                <input type="text" class="form-control" id="doctorName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="doctorGender" class="form-label">æ€§åˆ« *</label>
                                <select class="form-select" id="doctorGender" required>
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="MALE">ç”·</option>
                                    <option value="FEMALE">å¥³</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="doctorDepartment" class="form-label">ç§‘å®¤ *</label>
                                <input type="text" class="form-control" id="doctorDepartment" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="doctorTitle" class="form-label">èŒç§° *</label>
                                <input type="text" class="form-control" id="doctorTitle" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="doctorPhone" class="form-label">ç”µè¯</label>
                                <input type="tel" class="form-control" id="doctorPhone" placeholder="ä¾‹ï¼š13800138000 æˆ– 010-12345678">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="doctorEmail" class="form-label">é‚®ç®±</label>
                                <input type="email" class="form-control" id="doctorEmail" placeholder="ä¾‹ï¼šdoctor@hospital.com">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="doctorConsultationFee" class="form-label">æŒ‚å·è´¹ï¼ˆå…ƒï¼‰</label>
                                <input type="number" class="form-control" id="doctorConsultationFee" step="0.01" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="doctorAvailable" checked>
                                    <label class="form-check-label" for="doctorAvailable">
                                        å¯ç”¨çŠ¶æ€
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="doctorSpecialization" class="form-label">ä¸“é•¿</label>
                            <textarea class="form-control" id="doctorSpecialization" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="doctorIntroduction" class="form-label">ç®€ä»‹</label>
                            <textarea class="form-control" id="doctorIntroduction" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="saveDoctorBtn" onclick="saveDoctor()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŒ‚å·ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registrationModalTitle">æŒ‚å·ä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registrationForm">
                        <input type="hidden" id="registrationId">
                        
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <h6 class="mb-3 text-primary">åŸºæœ¬ä¿¡æ¯</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="registrationPatient" class="form-label">ç—…äºº *</label>
                                <select class="form-select" id="registrationPatient" required>
                                    <option value="">è¯·é€‰æ‹©ç—…äºº</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="registrationDoctor" class="form-label">åŒ»ç”Ÿ *</label>
                                <select class="form-select" id="registrationDoctor" required onchange="onDoctorChange()">
                                    <option value="">è¯·é€‰æ‹©åŒ»ç”Ÿ</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="registrationAppointmentTime" class="form-label">é¢„çº¦æ—¶é—´ *</label>
                                <input type="datetime-local" class="form-control" id="registrationAppointmentTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="registrationFee" class="form-label">æŒ‚å·è´¹ï¼ˆå…ƒï¼‰*</label>
                                <input type="number" class="form-control" id="registrationFee" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="registrationStatus" class="form-label">æŒ‚å·çŠ¶æ€ *</label>
                                <select class="form-select" id="registrationStatus" required>
                                    <option value="">è¯·é€‰æ‹©çŠ¶æ€</option>
                                    <option value="PENDING">å¾…å°±è¯Š</option>
                                    <option value="IN_PROGRESS">å°±è¯Šä¸­</option>
                                    <option value="COMPLETED">å·²å®Œæˆ</option>
                                    <option value="CANCELLED">å·²å–æ¶ˆ</option>
                                </select>
                            </div>
                        </div>

                        <!-- å°±è¯Šä¿¡æ¯ -->
                        <hr>
                        <h6 class="mb-3 text-primary">å°±è¯Šä¿¡æ¯</h6>
                        <div class="mb-3">
                            <label for="registrationSymptoms" class="form-label">ç—‡çŠ¶</label>
                            <textarea class="form-control" id="registrationSymptoms" rows="2" placeholder="æ‚£è€…ä¸»è¯‰ç—‡çŠ¶..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="registrationDiagnosis" class="form-label">è¯Šæ–­</label>
                            <textarea class="form-control" id="registrationDiagnosis" rows="2" placeholder="åŒ»ç”Ÿè¯Šæ–­ç»“æœ..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="registrationTreatment" class="form-label">æ²»ç–—æ–¹æ¡ˆ</label>
                            <textarea class="form-control" id="registrationTreatment" rows="2" placeholder="æ²»ç–—æ–¹æ¡ˆå’Œå»ºè®®..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="registrationPrescription" class="form-label">å¤„æ–¹</label>
                            <textarea class="form-control" id="registrationPrescription" rows="3" placeholder="å¼€å…·çš„è¯ç‰©å¤„æ–¹..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="registrationNotes" class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="registrationNotes" rows="2" placeholder="å…¶ä»–å¤‡æ³¨ä¿¡æ¯..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="saveRegistrationBtn" onclick="saveRegistration()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
