<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>员工服务台 - 医院门诊系统</title>
    <!-- 医院图标 -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23667eea'%3E%3Cpath d='M19 8h-2v3h-3v2h3v3h2v-3h3v-2h-3zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z'/%3E%3C/svg%3E">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            /* 语义色（队列/分诊/风险） */
            --queue-color: #3b82f6;      /* 等候/队列 */
            --triage-color: #06b6d4;     /* 分诊/引导 */
            --risk-low: #CDE8FF;         /* 低风险 */
            --risk-mid: #FFE9A6;         /* 中风险 */
            --risk-high: #FFD1D1;        /* 高风险 */
        }
        
        body {
            background: linear-gradient(135deg, #F6F8FA 0%, #E8F4FD 100%);
            min-height: 100vh;
            font-family: 'Microsoft YaHei', system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Hiragino Sans GB, sans-serif;
            position: relative;
        }
        
        /* 添加装饰性背景元素 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .main-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            border-radius: 15px;
            margin: 20px;
            color: var(--primary-color);
            position: relative;
            overflow: hidden;
        }
        
        /* 头部波浪装饰 */
        .header-wave{ 
            position:absolute; 
            left:0; 
            bottom:-1px; 
            width:100%; 
            height:80px; 
            pointer-events: none; /* 防止阻挡按钮点击 */
            z-index: -1; /* 确保在内容下方 */
        }
        
        /* 添加装饰性分隔线 */
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            margin: 2rem 0;
            border-radius: 1px;
        }
        
        /* 优化容器间距 */
        .container {
            padding: 0 15px;
        }
        
        /* 添加微妙的阴影层次 */
        .stats-section {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(5px);
        }
        
        /* 卡片阴影/圆角更克制 */
        .stats-card,.function-card,.info-card{
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,.06);
            transition: transform .2s ease, box-shadow .2s ease;
        }
        .stats-card:hover,.function-card:hover,.info-card:hover{
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0,0,0,.15);
        }
        
        /* 添加微妙的动画效果 */
        .function-card {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .function-card:nth-child(1) { animation-delay: 0.1s; }
        .function-card:nth-child(2) { animation-delay: 0.2s; }
        .function-card:nth-child(3) { animation-delay: 0.3s; }
        .function-card:nth-child(4) { animation-delay: 0.4s; }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .function-card {
            cursor: pointer;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        /* 添加装饰性元素 */
        .function-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .function-card:hover::before {
            opacity: 1;
            transform: rotate(45deg) translate(50%, 50%);
        }
        
        .function-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2rem;
        }
        
        .icon-primary { background: linear-gradient(45deg, #667eea, #764ba2); color: white; }
        .icon-success { background: linear-gradient(45deg, #56ab2f, #a8e6cf); color: white; }
        .icon-warning { background: linear-gradient(45deg, #f7b733, #fc4a1a); color: white; }
        .icon-info { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; }
        .icon-danger { background: linear-gradient(45deg, #ff416c, #ff4b2b); color: white; }
        .icon-secondary { background: linear-gradient(45deg, #667eea, #764ba2); color: white; }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* KPI 数字左对齐（更利扫读） */
        .stats-card .stat-number,
        .stats-card .stat-label{ 
            text-align: left !important; 
        }
        
        /* 添加进度条可视化 */
        .progress-ring {
            width: 60px;
            height: 60px;
            transform: rotate(-90deg);
        }
        
        .progress-ring circle {
            fill: transparent;
            stroke-width: 4;
            stroke-linecap: round;
        }
        
        .progress-ring .progress-ring-background {
            stroke: rgba(0,0,0,0.1);
        }
        
        .progress-ring .progress-ring-progress {
            stroke: var(--primary-color);
            stroke-dasharray: 157;
            stroke-dashoffset: 157;
            transition: stroke-dashoffset 0.5s ease;
        }
        
        /* 添加数据趋势指示器 */
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }
        .trend-stable { color: var(--warning-color); }
        
        /* 通用图标圆 */
        .feature-icon {
            width: 72px; 
            height: 72px;
            border-radius: 999px;
            display: grid; 
            place-items: center;
            color: #fff; 
            font-size: 32px;
            box-shadow: 0 10px 24px rgba(0,0,0,.12), inset 0 2px 6px rgba(255,255,255,.25);
            margin: 0 auto 12px;   /* 居中并与标题留距 */
        }
        
        /* 配色：与你其它卡片保持一致 */
        .feature-icon.is-purple { background: linear-gradient(135deg,#8B5CF6,#6366F1); }  /* 病人接待 */
        .feature-icon.is-green  { background: linear-gradient(135deg,#10B981,#059669); }  /* 待收费 */
        .feature-icon.is-amber  { background: linear-gradient(135deg,#F59E0B,#D97706); }  /* 通知 */
        .feature-icon.is-red    { background: linear-gradient(135deg,#F87171,#EF4444); }  /* 药品咨询 */
        
        .function-card:hover .feature-icon { 
            transform: translateY(-1px); 
            transition: transform .2s ease; 
        }
        
        /* 按钮点击水波纹（所有 .btn/.btn-modern 适用） */
        .btn, .btn-modern { position: relative; overflow: hidden; }
        .btn .ripple, .btn-modern .ripple{
            position:absolute; border-radius:50%; transform:scale(0);
            opacity:.6; background:#fff; animation:ripple .6s linear;
            pointer-events:none; width:20px; height:20px; left:0; top:0;
        }
        @keyframes ripple { to { transform:scale(8); opacity:0; } }
        
        /* 通知角标呼吸光 */
        #notificationBadge{ animation: pulse 1.6s ease-in-out infinite; transform-origin:center; }
        @keyframes pulse{ 0%{transform:scale(1);} 50%{transform:scale(1.15);} 100%{transform:scale(1);} }

        /* 功能卡的按钮更现代 */
        .btn-modern{
            border-radius: 999px;
            padding: .5rem 1rem;
        }

        /* 趋势样式 */
        .stat-delta{
            display: inline-flex; 
            align-items: center; 
            gap: .25rem;
            font-size: .85rem; 
            margin-left: .5rem;
        }
        .stat-delta.up{ 
            color: #16a34a; 
        }     /* 绿色 ↑ */
        .stat-delta.down{ 
            color: #dc2626; 
        }   /* 红色 ↓ */

        /* 骨架屏样式 */
        .skeleton{ 
            position: relative; 
            background: #E5E7EB; 
            color: transparent; 
            border-radius: 8px; 
        }
        .skeleton::after{
            content: ''; 
            position: absolute; 
            inset: 0; 
            background: linear-gradient(90deg, transparent, rgba(255,255,255,.5), transparent);
            animation: shimmer 1.2s infinite;
        }
        @keyframes shimmer{ 
            0%{ transform: translateX(-100%);} 
            100%{ transform: translateX(100%);} 
        }

        /* 药品搜索吸顶样式 */
        #medicineConsultationTabs{ 
            position: sticky; 
            top: 0; 
            z-index: 2; 
            background: #fff; 
            padding-top: .5rem; 
        }
        #medicine-search .card .card-body{ 
            position: sticky; 
            top: 64px; 
            z-index: 1; 
            background: #fff; 
        }

        /* 可访问性与触控优化 */
        .function-card:focus{ 
            outline: 3px solid rgba(14,165,233,.5); 
            outline-offset: 2px; 
        }
        .function-card:active{ 
            transform: translateY(0); 
            box-shadow: 0 2px 8px rgba(0,0,0,.12); 
        }
        
        .btn-modern {
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            border-bottom: none;
            border-radius: 20px 20px 0 0;
        }
        
        .workflow-step {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 15px;
            background: rgba(255,255,255,0.8);
            border-left: 4px solid var(--primary-color);
        }
        
        .workflow-step.active {
            background: rgba(102, 126, 234, 0.1);
            border-left-color: var(--secondary-color);
        }
        
        .task-item {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-left: 3px solid var(--warning-color);
        }
        
        .task-item.completed {
            border-left-color: var(--success-color);
            opacity: 0.7;
        }
        
        .service-option {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .service-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--bs-primary);
        }
        
        .service-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }
        
        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: var(--bs-primary);
        }
        
        .info-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* ========== 药品咨询模块样式 ========== */
        .medicine-consultation-center {
            max-width: 100%;
        }

        .consultation-header .icon-circle {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }

        .medicine-consultation-center .nav-pills .nav-link {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: none;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0 5px;
        }

        .medicine-consultation-center .nav-pills .nav-link:hover {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .medicine-consultation-center .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .medicine-card {
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .medicine-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
            border-color: #007bff;
        }

        .medicine-card .card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .medicine-info .text-sm {
            font-size: 0.875rem;
        }

        .medicine-actions .btn {
            font-size: 0.8rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .medicine-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .medicine-consultation-center .info-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: default;
        }

        .medicine-consultation-center .info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .medicine-consultation-center .info-card:hover::before {
            left: 100%;
        }

        .medicine-consultation-center .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border-color: #007bff;
        }

        .info-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .info-card-header i {
            font-size: 1.5rem;
            margin-right: 0.75rem;
            width: 30px;
            text-align: center;
        }

        .info-card-header h6 {
            margin: 0;
            font-weight: 600;
            color: #495057;
        }

        .info-card-body ul li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f8f9fa;
            transition: all 0.3s ease;
        }

        .info-card-body ul li:last-child {
            border-bottom: none;
        }

        .info-card-body ul li:hover {
            background-color: #f8f9fa;
            padding-left: 1rem;
            border-radius: 8px;
        }

        .search-results-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }

        .no-results, .search-error, .loading-state {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .no-results .icon-circle, .search-error .icon-circle, .loading-state .icon-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-circle-muted {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }

        .icon-circle-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .interaction-results-header {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
        }

        .medicine-details .card-header {
            font-weight: 600;
            border-bottom: none;
        }

        .medicine-details .form-control-plaintext {
            font-weight: 500;
            color: #495057;
        }

        .medicine-details .badge.fs-6 {
            font-size: 0.9rem !important;
            padding: 0.5rem 1rem;
        }

        /* 快速查询按钮样式 */
        .btn-outline-primary.btn-sm.rounded-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn-outline-success.btn-sm.rounded-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-outline-warning.btn-sm.rounded-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .btn-outline-info.btn-sm.rounded-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .btn-outline-secondary.btn-sm.rounded-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .btn-outline-danger.btn-sm.rounded-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-outline-dark.btn-sm.rounded-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 58, 64, 0.3);
        }

        /* 自定义颜色按钮 */
        .btn-outline-purple {
            color: #6f42c1;
            border-color: #6f42c1;
        }
        .btn-outline-purple:hover {
            color: #fff;
            background-color: #6f42c1;
            border-color: #6f42c1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        }

        .btn-outline-orange {
            color: #fd7e14;
            border-color: #fd7e14;
        }
        .btn-outline-orange:hover {
            color: #fff;
            background-color: #fd7e14;
            border-color: #fd7e14;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3);
        }

        /* 动画效果 */
        @keyframes medicineCardFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .medicine-card {
            animation: medicineCardFadeIn 0.6s ease forwards;
        }

        .medicine-card:nth-child(1) { animation-delay: 0.1s; }
        .medicine-card:nth-child(2) { animation-delay: 0.2s; }
        .medicine-card:nth-child(3) { animation-delay: 0.3s; }
        .medicine-card:nth-child(4) { animation-delay: 0.4s; }
        .medicine-card:nth-child(5) { animation-delay: 0.5s; }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .medicine-consultation-center .nav-pills .nav-link {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
                margin: 0 2px;
            }
            
            .medicine-consultation-center .info-card {
                padding: 1rem;
            }
            
            .medicine-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .medicine-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 头部信息 -->
        <div class="main-header p-4">
            <div class="row align-items-center">
            <div class="col-md-6">
                    <h3 class="mb-1"><i class="bi bi-hospital"></i> 员工服务台</h3>
                    <p class="mb-0">欢迎，<span id="userName" class="fw-bold text-primary">员工</span> | <span id="userRole" class="text-muted">前台服务</span></p>
            </div>
            <div class="col-md-6 text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <div class="me-4">
                            <small class="text-muted">当前时间</small><br>
                            <span id="currentTime" class="fw-bold"></span>
                        </div>
                        <button class="btn btn-outline-danger btn-modern" onclick="logout()" style="position: relative; z-index: 10;">
                            <i class="bi bi-box-arrow-right"></i> 退出
                        </button>
                    </div>
                </div>
            </div>
            <svg class="header-wave" viewBox="0 0 1440 80" preserveAspectRatio="none">
                <path d="M0,32 C240,80 480,0 720,32 C960,64 1200,48 1440,16 L1440,80 L0,80 Z" fill="url(#hdrGrad)"/>
                <defs>
                    <linearGradient id="hdrGrad" x1="0" x2="1" y1="0" y2="0">
                        <stop offset="0" stop-color="rgba(102,126,234,.25)"/>
                        <stop offset="1" stop-color="rgba(118,75,162,.25)"/>
                    </linearGradient>
                </defs>
            </svg>
        </div>

        <!-- 工作概览统计 -->
        <div class="container mt-4">
            <div class="stats-section">
                <div class="row g-4 mb-5">
                <div class="col-md-3 col-sm-6">
                    <div class="card stats-card text-center p-4">
                        <div class="function-icon icon-primary mx-auto">
                            <i class="bi bi-person-plus"></i>
                        </div>
                        <div class="stat-number" id="todayRegistrations">-</div>
                        <div class="stat-label">今日挂号</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card stats-card text-center p-4">
                        <div class="function-icon icon-success mx-auto">
                            <i class="bi bi-cash-coin"></i>
                        </div>
                        <div class="stat-number" id="todayRevenue">-</div>
                        <div class="stat-label">今日收入</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card stats-card text-center p-4">
                        <div class="function-icon icon-warning mx-auto">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="stat-number" id="pendingPayments">-</div>
                        <div class="stat-label">待收费</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card stats-card text-center p-4">
                        <div class="function-icon icon-info mx-auto">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="stat-number" id="activePatients">-</div>
                        <div class="stat-label">在院病人</div>
                    </div>
                </div>
            </div>
            </div>
            
            <!-- 装饰性分隔线 -->
            <div class="section-divider"></div>

            <!-- 可视化面板 -->
            <div class="row g-4 mb-5" id="analytics">
                <div class="col-lg-8">
                    <div class="card stats-card p-3">
                        <h6 class="mb-3"><i class="bi bi-activity me-2"></i>今日趋势</h6>
                        <canvas id="chartLine"></canvas>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card stats-card p-3">
                        <h6 class="mb-3"><i class="bi bi-pie-chart me-2"></i>候诊/在院占比</h6>
                        <canvas id="chartDonut"></canvas>
                    </div>
                </div>
            </div>

            <!-- 核心服务功能 - 2x2布局 -->
            <div class="row g-4 mb-5">
                <!-- 第一行 -->
                <div class="col-md-6">
                    <div class="card function-card p-4 text-center" role="button" tabindex="0"
                         aria-label="病人接待：病人信息查询，引导挂号就诊" onclick="openPatientReception()"
                         onkeydown="if(event.key==='Enter' || event.key===' '){ openPatientReception(); }">
                        <div class="function-icon icon-primary">
                            <i class="bi bi-person-hearts"></i>
                        </div>
                        <h5 class="card-title">病人接待</h5>
                        <p class="card-text text-muted">病人信息查询<br>引导挂号就诊</p>
                        <button class="btn btn-primary btn-modern">接待服务</button>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card function-card p-4 text-center" role="button" tabindex="0"
                         aria-label="待收费处理：处理待收费订单，确认收费状态" onclick="openPendingPayments()"
                         onkeydown="if(event.key==='Enter' || event.key===' '){ openPendingPayments(); }">
                        <div class="function-icon icon-success">
                            <i class="bi bi-receipt"></i>
                        </div>
                        <h5 class="card-title">待收费处理</h5>
                        <p class="card-text text-muted">处理待收费订单<br>确认收费状态</p>
                        <button class="btn btn-success btn-modern">处理收费</button>
                    </div>
                </div>
                
                <!-- 第二行 -->
                <div class="col-md-6">
                    <div class="card function-card p-4 text-center" role="button" tabindex="0"
                         aria-label="药品咨询：药品信息查询，用法用量说明" onclick="openMedicineQuery()"
                         onkeydown="if(event.key==='Enter' || event.key===' '){ openMedicineQuery(); }">
                        <!-- 药品咨询卡片顶部图标 -->
                        <span class="feature-icon is-red" aria-hidden="true">
                            <i class="bi bi-capsule-pill"></i>
                        </span>
                        <h5 class="card-title">药品咨询</h5>
                        <p class="card-text text-muted">药品信息查询<br>用法用量说明</p>
                        <button class="btn btn-danger btn-modern">药品查询</button>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card function-card p-4 text-center" role="button" tabindex="0"
                         aria-label="工作通知：查看工作通知，管理操作提醒" onclick="openNotificationCenter()"
                         onkeydown="if(event.key==='Enter' || event.key===' '){ openNotificationCenter(); }">
                        <div class="function-icon icon-warning position-relative">
                            <i class="bi bi-bell-fill"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
                                0
                            </span>
                        </div>
                        <h5 class="card-title">工作通知</h5>
                        <p class="card-text text-muted">查看工作通知<br>管理操作提醒</p>
                        <button class="btn btn-warning btn-modern">通知中心</button>
                    </div>
                </div>
                
            </div>

        </div>
    </div>

    <!-- 通用模态框 -->
    <div class="modal fade" id="universalModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">功能模块</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- 动态内容 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 通知中心模态框 -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning bg-opacity-10">
                    <h5 class="modal-title" id="notificationModalLabel">
                        <i class="bi bi-bell-fill text-warning me-2"></i>
                        工作通知中心
                        <span class="badge bg-primary ms-2" id="modalOnlineStatus">在线</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <!-- 统计卡片 -->
                    <div class="row g-3 mb-4 notification-stats">
                        <div class="col-md-3 col-sm-6">
                            <div class="card bg-primary bg-opacity-10 border-0">
                                <div class="card-body text-center p-3">
                                    <div class="text-primary mb-2">
                                        <i class="bi bi-bell display-6"></i>
                                    </div>
                                    <h4 class="mb-1" id="modalTotalNotifications">0</h4>
                                    <p class="text-muted mb-0 small">总通知数</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="card bg-danger bg-opacity-10 border-0">
                                <div class="card-body text-center p-3">
                                    <div class="text-danger mb-2">
                                        <i class="bi bi-exclamation-circle display-6"></i>
                                    </div>
                                    <h4 class="mb-1" id="modalUnreadNotifications">0</h4>
                                    <p class="text-muted mb-0 small">未读通知</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="card bg-success bg-opacity-10 border-0">
                                <div class="card-body text-center p-3">
                                    <div class="text-success mb-2">
                                        <i class="bi bi-calendar-check display-6"></i>
                                    </div>
                                    <h4 class="mb-1" id="modalTodayNotifications">0</h4>
                                    <p class="text-muted mb-0 small">今日通知</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="card bg-info bg-opacity-10 border-0">
                                <div class="card-body text-center p-3">
                                    <div class="text-info mb-2">
                                        <i class="bi bi-graph-up display-6"></i>
                                    </div>
                                    <h4 class="mb-1" id="modalWeeklyNotifications">0</h4>
                                    <p class="text-muted mb-0 small">本周通知</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 操作栏 -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>通知列表
                        </h6>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-success" onclick="markAllAsReadModal()">
                                <i class="bi bi-check-all"></i> 全部已读
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshNotificationsModal()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>
                    </div>
                    
                    <!-- 过滤器 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="modalModuleFilter" onchange="filterNotificationsModal()">
                                <option value="all">全部模块</option>
                                <option value="patient">病人管理</option>
                                <option value="doctor">医生管理</option>
                                <option value="registration">挂号管理</option>
                                <option value="payment">收费管理</option>
                                <option value="medicine">药品管理</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="modalStatusFilter" onchange="filterNotificationsModal()">
                                <option value="all">全部状态</option>
                                <option value="unread">未读</option>
                                <option value="read">已读</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 通知列表 -->
                    <div class="notification-container" style="max-height: 400px; overflow-y: auto;">
                        <div id="modalNotificationList">
                            <!-- 通知项将通过JavaScript动态加载 -->
                            <div class="text-center text-muted p-4" id="modalNoNotifications">
                                <i class="bi bi-inbox display-4 mb-3"></i>
                                <h6>暂无工作通知</h6>
                                <p class="text-muted small">当管理员进行操作时，相关通知会显示在这里</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" onclick="clearAllNotificationsModal()">
                        <i class="bi bi-trash"></i> 清空通知
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 通知系统 -->
    <script src="notification-system.js"></script>
    <script>
        // 全局错误处理，防止音频播放相关错误
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.name === 'AbortError' && 
                event.reason.message && event.reason.message.includes('play()')) {
                // 忽略音频播放被中断的错误
                console.warn('音频播放被中断，已忽略此错误:', event.reason);
                event.preventDefault();
            }
        });

        let currentUser = null;

        // 检查权限
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || user.role !== 'STAFF') {
                window.location.href = 'login.html';
                return false;
            }
            
            currentUser = user;
            document.getElementById('userName').textContent = user.realName || user.username;
            return true;
        }

        // 更新时间
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN');
        }

        // 加载今日统计数据
        async function loadTodayStats() {
            // 添加骨架屏效果
            ['todayRegistrations','todayRevenue','pendingPayments','activePatients']
                .forEach(id => document.getElementById(id)?.classList.add('skeleton'));
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/dashboard/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateStaffStats(result.data);
                    } else {
                        console.error('加载统计数据失败:', result.message);
                        setDefaultStats();
                    }
                } else {
                    console.error('HTTP错误:', response.status);
                    setDefaultStats();
                }
            } catch (error) {
                console.error('加载统计数据异常:', error);
                setDefaultStats();
            } finally {
                // 移除骨架屏效果
                ['todayRegistrations','todayRevenue','pendingPayments','activePatients']
                    .forEach(id => document.getElementById(id)?.classList.remove('skeleton'));
            }
        }

        // 更新员工端统计显示
        function updateStaffStats(stats) {
            const pendingPayments = stats.paymentStatusStats 
                ? (stats.paymentStatusStats.PENDING || 0)
                : 0;
            
            // 使用新的函数来设置KPI数据（带趋势）
            setKpiWithDelta('todayRegistrations', stats.totalRegistrations ?? 0, stats.yesterdayRegistrations ?? undefined);
            setKpiWithDelta('todayRevenue', stats.totalRevenue ?? 0, stats.yesterdayRevenue ?? undefined);
            setKpiWithDelta('pendingPayments', pendingPayments ?? 0, stats.yesterdayPending ?? undefined);
            setKpiWithDelta('activePatients', stats.totalPatients ?? 0, stats.yesterdayPatients ?? undefined);
            
            // 更新甜甜圈图数据
            if (chartDonut) {
                const pendingPayments = stats.paymentStatusStats ? (stats.paymentStatusStats.PENDING||0) : 0;
                const totalPatients = stats.totalPatients || 0;
                
                chartDonut.data.datasets[0].data = [pendingPayments, totalPatients];
                chartDonut.update('active');
                
                console.log('甜甜圈图数据更新:', {pendingPayments, totalPatients});
            }
            
            // 同时刷新折线图数据
            loadTimeSeriesData();
            
            console.log('员工端统计数据更新成功:', stats);
        }

        // KPI数据设置函数（带趋势）
        function setKpiWithDelta(numberId, value, yesterday){
            const el = document.getElementById(numberId);
            if(!el) return;
            // 使用数字动画而不是直接设置文本
            animateNumber(el, value, numberId==='todayRevenue');
            // 注入/更新 Δ
            let delta = null;
            if(typeof yesterday === 'number'){
                const diff = value - yesterday;
                const pct  = yesterday ? Math.round(diff / yesterday * 100) : 0;
                const dir  = diff >= 0 ? 'up' : 'down';
                delta = {dir, pct: Math.abs(pct)};
            }
            // 清除旧的
            const old = el.parentElement.querySelector('.stat-delta');
            if(old) old.remove();
            // 新增
            if(delta){
                const span = document.createElement('span');
                span.className = `stat-delta ${delta.dir}`;
                span.innerHTML = delta.dir === 'up' ? `↑ ${delta.pct}%` : `↓ ${delta.pct}%`;
                el.insertAdjacentElement('afterend', span);
            }
        }

        // 设置默认统计数据
        function setDefaultStats() {
            setKpiWithDelta('todayRegistrations', 0, 8);
            setKpiWithDelta('todayRevenue', 0, 500);
            setKpiWithDelta('pendingPayments', 0, 1);
            setKpiWithDelta('activePatients', 0, 5);
        }

        // 格式化货币显示
        function formatCurrency(amount) {
            return '¥' + parseFloat(amount || 0).toFixed(2);
        }

        // 核心功能模块
        function openPatientReception() {
            showModal('病人接待服务中心', `
                <div class="p-4">
                    <!-- 服务中心标题 -->
                    <div class="text-center mb-4">
                        <div class="icon-circle bg-primary bg-opacity-10 mx-auto mb-3">
                            <i class="bi bi-person-hearts display-6 text-primary"></i>
                        </div>
                        <h4 class="fw-bold">病人接待服务中心</h4>
                        <p class="text-muted mb-0">为病人提供专业、贴心的接待和咨询服务</p>
                    </div>
                    
                    <!-- 服务选项卡片 -->
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100 service-card" onclick="openPatientSearchAndRegistration()">
                                <div class="card-body p-4 text-center">
                                    <div class="icon-circle bg-primary bg-opacity-10 mx-auto mb-3">
                                        <i class="bi bi-person-plus-fill display-6 text-primary"></i>
                                    </div>
                                    <h5 class="card-title fw-bold mb-2">病人查询与挂号</h5>
                                    <p class="text-muted mb-3">查询现有病人信息，提供专业挂号协助服务</p>
                                    <div class="service-features mb-3">
                                        <small class="badge bg-primary bg-opacity-10 text-primary me-2">
                                            <i class="bi bi-search me-1"></i>快速查询
                                        </small>
                                        <small class="badge bg-primary bg-opacity-10 text-primary">
                                            <i class="bi bi-calendar-plus me-1"></i>协助挂号
                                        </small>
                                    </div>
                                    <div class="service-arrow">
                                        <i class="bi bi-arrow-right text-primary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100 service-card" onclick="showHospitalInfo()">
                                <div class="card-body p-4 text-center">
                                    <div class="icon-circle bg-info bg-opacity-10 mx-auto mb-3">
                                        <i class="bi bi-info-circle-fill display-6 text-info"></i>
                                    </div>
                                    <h5 class="card-title fw-bold mb-2">医院信息咨询</h5>
                                    <p class="text-muted mb-3">提供详细的医院信息和就诊流程指导</p>
                                    <div class="service-features mb-3">
                                        <small class="badge bg-info bg-opacity-10 text-info me-2">
                                            <i class="bi bi-building me-1"></i>科室导航
                                        </small>
                                        <small class="badge bg-info bg-opacity-10 text-info">
                                            <i class="bi bi-clock me-1"></i>就诊流程
                                        </small>
                                    </div>
                                    <div class="service-arrow">
                                        <i class="bi bi-arrow-right text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100 service-card" onclick="collectFeedback()">
                                <div class="card-body p-4 text-center">
                                    <div class="icon-circle bg-warning bg-opacity-10 mx-auto mb-3">
                                        <i class="bi bi-chat-left-text-fill display-6 text-warning"></i>
                                    </div>
                                    <h5 class="card-title fw-bold mb-2">意见建议收集</h5>
                                    <p class="text-muted mb-3">收集宝贵意见建议，永久存储至数据库</p>
                                    <div class="service-features mb-3">
                                        <small class="badge bg-warning bg-opacity-10 text-warning me-2">
                                            <i class="bi bi-database me-1"></i>数据存储
                                        </small>
                                        <small class="badge bg-warning bg-opacity-10 text-warning">
                                            <i class="bi bi-heart me-1"></i>用心聆听
                                        </small>
                                    </div>
                                    <div class="service-arrow">
                                        <i class="bi bi-arrow-right text-warning"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100 service-card" onclick="openComprehensiveService()">
                                <div class="card-body p-4 text-center">
                                    <div class="icon-circle bg-success bg-opacity-10 mx-auto mb-3">
                                        <i class="bi bi-headset display-6 text-success"></i>
                                    </div>
                                    <h5 class="card-title fw-bold mb-2">综合服务台</h5>
                                    <p class="text-muted mb-3">提供全方位服务咨询和专业问题解答</p>
                                    <div class="service-features mb-3">
                                        <small class="badge bg-success bg-opacity-10 text-success me-2">
                                            <i class="bi bi-telephone me-1"></i>紧急联系
                                        </small>
                                        <small class="badge bg-success bg-opacity-10 text-success">
                                            <i class="bi bi-question-circle me-1"></i>专业解答
                                        </small>
                                    </div>
                                    <div class="service-arrow">
                                        <i class="bi bi-arrow-right text-success"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 服务提示 -->
                    <div class="mt-4">
                        <div class="alert alert-light border-0 shadow-sm">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-info bg-opacity-10 me-3" style="width: 40px; height: 40px;">
                                    <i class="bi bi-lightbulb text-info"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 fw-bold">温馨提示</h6>
                                    <small class="text-muted">点击任意服务卡片即可开始为病人提供专业服务，我们致力于为每一位病人创造温暖的就医体验。</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 病人接待专用样式 -->
                <style>
                    .service-card {
                        cursor: pointer;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    }
                    .service-card:hover {
                        transform: translateY(-8px);
                        box-shadow: 0 15px 35px rgba(0,0,0,0.1) !important;
                    }
                    .service-card::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                        transition: left 0.5s ease;
                    }
                    .service-card:hover::before {
                        left: 100%;
                    }
                    .service-features .badge {
                        font-size: 0.7rem;
                        padding: 0.35rem 0.6rem;
                    }
                    .service-arrow {
                        opacity: 0;
                        transform: translateX(-10px);
                        transition: all 0.3s ease;
                        font-size: 1.2rem;
                    }
                    .service-card:hover .service-arrow {
                        opacity: 1;
                        transform: translateX(0);
                    }
                    .alert-light {
                        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                    }
                </style>
            `);
        }

        function openPendingPayments() {
            showModal('待收费处理', `
                <div class="p-4">
                    <div class="text-center mb-4">
                        <div class="function-icon icon-success mx-auto mb-3">
                            <i class="bi bi-receipt"></i>
                        </div>
                        <h5>待收费订单处理</h5>
                        <p class="text-muted">处理系统中的待收费订单，确认收费状态</p>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>功能说明：</strong>此功能用于处理医生开具的收费订单，确认病人付费状态。
                    </div>
                    
                    <div class="text-center">
                        <button class="btn btn-success" onclick="loadPendingPayments()">
                            <i class="bi bi-list"></i> 查看待收费订单
                        </button>
                    </div>
                </div>
            `);
        }


        function openMedicineQuery() {
            showModal('药品咨询中心', `
                <div class="medicine-consultation-center">
                    <!-- 头部导航 -->
                    <div class="consultation-header text-center mb-4">
                        <div class="icon-circle icon-circle-danger mx-auto mb-3">
                            <i class="bi bi-capsule" style="font-size: 2rem;"></i>
                        </div>
                        <h4 class="mb-2">药品咨询中心</h4>
                        <p class="text-muted">专业药品信息查询与用药指导服务</p>
                    </div>

                    <!-- 功能选项卡导航 -->
                    <ul class="nav nav-pills nav-fill mb-4" id="medicineConsultationTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active rounded-pill" id="medicine-search-tab" data-bs-toggle="pill" 
                                    data-bs-target="#medicine-search" type="button" role="tab">
                                <i class="bi bi-search me-2"></i>药品查询
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-pill" id="medicine-guide-tab" data-bs-toggle="pill" 
                                    data-bs-target="#medicine-guide" type="button" role="tab">
                                <i class="bi bi-book me-2"></i>用药指导
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-pill" id="medicine-interaction-tab" data-bs-toggle="pill" 
                                    data-bs-target="#medicine-interaction" type="button" role="tab">
                                <i class="bi bi-exclamation-triangle me-2"></i>药物相互作用
                            </button>
                        </li>
                    </ul>

                    <!-- 选项卡内容 -->
                    <div class="tab-content" id="medicineConsultationTabContent">
                        <!-- 药品查询 -->
                        <div class="tab-pane fade show active" id="medicine-search" role="tabpanel">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="bi bi-search text-primary me-2"></i>药品信息查询
                                    </h6>
                                    
                                    <!-- 搜索表单 -->
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-8">
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="bi bi-search"></i>
                                                </span>
                                                <input type="text" class="form-control" id="medicineSearchInput" 
                                                       placeholder="输入药品名称、编码或关键词" 
                                                       onkeypress="handleMedicineSearchKeyPress(event)">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-primary w-100" onclick="searchMedicines()">
                                                <i class="bi bi-search me-2"></i>查询
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 快速查询按钮 -->
                                    <div class="mb-4">
                                        <h6 class="text-muted mb-2">常用药品分类</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="searchMedicinesByCategory('感冒药')">
                                                <i class="bi bi-thermometer me-1"></i>感冒药
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm rounded-pill" onclick="searchMedicinesByCategory('抗生素')">
                                                <i class="bi bi-prescription me-1"></i>抗生素
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm rounded-pill" onclick="searchMedicinesByCategory('止痛药')">
                                                <i class="bi bi-bandaid me-1"></i>止痛药
                                            </button>
                                            <button class="btn btn-outline-info btn-sm rounded-pill" onclick="searchMedicinesByCategory('维生素')">
                                                <i class="bi bi-heart me-1"></i>维生素
                                            </button>
                                            <button class="btn btn-outline-success btn-sm rounded-pill" onclick="searchMedicinesByCategory('心血管药')">
                                                <i class="bi bi-heart-pulse me-1"></i>心血管药
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="searchMedicinesByCategory('消化系统药')">
                                                <i class="bi bi-stomach me-1"></i>消化系统药
                                            </button>
                                            <button class="btn btn-outline-dark btn-sm rounded-pill" onclick="searchMedicinesByCategory('呼吸系统药')">
                                                <i class="bi bi-lungs me-1"></i>呼吸系统药
                                            </button>
                                            <button class="btn btn-outline-purple btn-sm rounded-pill" onclick="searchMedicinesByCategory('神经系统药')">
                                                <i class="bi bi-brain me-1"></i>神经系统药
                                            </button>
                                            <button class="btn btn-outline-orange btn-sm rounded-pill" onclick="searchMedicinesByCategory('外用药')">
                                                <i class="bi bi-bandaid-fill me-1"></i>外用药
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 搜索结果 -->
                                    <div id="medicineSearchResults" class="search-results"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 用药指导 -->
                        <div class="tab-pane fade" id="medicine-guide" role="tabpanel">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="bi bi-book text-success me-2"></i>用药安全指导
                                    </h6>
                                    
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <div class="info-card h-100">
                                                <div class="info-card-header">
                                                    <i class="bi bi-clock text-primary"></i>
                                                    <h6>服药时间</h6>
                                                </div>
                                                <div class="info-card-body">
                                                    <ul class="list-unstyled mb-0">
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>餐前服用：饭前30-60分钟</li>
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>餐后服用：饭后15-30分钟</li>
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>空腹服用：餐前1小时或餐后2小时</li>
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>睡前服用：睡前30分钟</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="info-card h-100">
                                                <div class="info-card-header">
                                                    <i class="bi bi-droplet text-info"></i>
                                                    <h6>服药方法</h6>
                                                </div>
                                                <div class="info-card-body">
                                                    <ul class="list-unstyled mb-0">
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>用温开水送服</li>
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>整片吞服，不要咀嚼</li>
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>液体药物摇匀后服用</li>
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>按照医嘱规定剂量</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="info-card h-100">
                                                <div class="info-card-header">
                                                    <i class="bi bi-thermometer text-warning"></i>
                                                    <h6>储存条件</h6>
                                                </div>
                                                <div class="info-card-body">
                                                    <ul class="list-unstyled mb-0">
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>常温保存：15-25℃</li>
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>避光保存：密闭容器</li>
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>冷藏保存：2-8℃</li>
                                                        <li><i class="bi bi-check-circle text-success me-2"></i>防潮防热，儿童不宜接触</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="info-card h-100">
                                                <div class="info-card-header">
                                                    <i class="bi bi-exclamation-triangle text-danger"></i>
                                                    <h6>注意事项</h6>
                                                </div>
                                                <div class="info-card-body">
                                                    <ul class="list-unstyled mb-0">
                                                        <li><i class="bi bi-x-circle text-danger me-2"></i>不要擅自增减剂量</li>
                                                        <li><i class="bi bi-x-circle text-danger me-2"></i>不要与酒精同服</li>
                                                        <li><i class="bi bi-x-circle text-danger me-2"></i>过期药品及时丢弃</li>
                                                        <li><i class="bi bi-x-circle text-danger me-2"></i>出现不良反应立即停药</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 药物相互作用 -->
                        <div class="tab-pane fade" id="medicine-interaction" role="tabpanel">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>药物相互作用检查
                                    </h6>
                                    
                                    <div class="alert alert-warning">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>重要提醒：</strong>同时服用多种药物时，可能会发生相互作用，影响药效或产生不良反应。
                                    </div>
                                    
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-5">
                                            <label class="form-label">第一种药物</label>
                                            <select class="form-select" id="medicine1Select">
                                                <option value="">请选择药物...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label">第二种药物</label>
                                            <select class="form-select" id="medicine2Select">
                                                <option value="">请选择药物...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button class="btn btn-warning w-100" onclick="checkMedicineInteraction()">
                                                <i class="bi bi-search me-2"></i>检查
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- 快速选择按钮 -->
                                    <div class="mb-4">
                                        <h6 class="text-muted mb-3">
                                            <i class="bi bi-lightning me-2"></i>快速选择常用药物组合
                                        </h6>
                                        <div class="row g-2">
                                            <div class="col-md-3">
                                                <button class="btn btn-outline-danger btn-sm w-100" 
                                                        onclick="selectMedicinePair('华法林', '阿司匹林')">
                                                    华法林 + 阿司匹林
                                                </button>
                                            </div>
                                            <div class="col-md-3">
                                                <button class="btn btn-outline-warning btn-sm w-100" 
                                                        onclick="selectMedicinePair('布洛芬', '阿司匹林')">
                                                    布洛芬 + 阿司匹林
                                                </button>
                                            </div>
                                            <div class="col-md-3">
                                                <button class="btn btn-outline-warning btn-sm w-100" 
                                                        onclick="selectMedicinePair('钙尔奇d', '阿莫西林')">
                                                    钙尔奇D + 阿莫西林
                                                </button>
                                            </div>
                                            <div class="col-md-3">
                                                <button class="btn btn-outline-info btn-sm w-100" 
                                                        onclick="selectMedicinePair('连花清瘟', '板蓝根')">
                                                    连花清瘟 + 板蓝根
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="interactionResults" class="interaction-results"></div>
                                    
                                    <!-- 常见相互作用示例 -->
                                    <div class="mt-4">
                                        <h6 class="text-muted mb-3">常见药物相互作用示例</h6>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <div class="alert alert-danger">
                                                    <h6 class="alert-heading">
                                                        <i class="bi bi-exclamation-triangle me-2"></i>严重相互作用
                                                    </h6>
                                                    <p class="mb-1"><strong>华法林 + 阿司匹林</strong></p>
                                                    <small>显著增加出血风险</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="alert alert-danger">
                                                    <h6 class="alert-heading">
                                                        <i class="bi bi-exclamation-triangle me-2"></i>严重相互作用
                                                    </h6>
                                                    <p class="mb-1"><strong>安定 + 999感冒灵</strong></p>
                                                    <small>过度镇静和呼吸抑制</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="alert alert-warning">
                                                    <h6 class="alert-heading">
                                                        <i class="bi bi-exclamation-circle me-2"></i>中等相互作用
                                                    </h6>
                                                    <p class="mb-1"><strong>布洛芬 + 阿司匹林</strong></p>
                                                    <small>胃肠道刺激增强</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="alert alert-warning">
                                                    <h6 class="alert-heading">
                                                        <i class="bi bi-exclamation-circle me-2"></i>中等相互作用
                                                    </h6>
                                                    <p class="mb-1"><strong>钙尔奇D + 阿莫西林</strong></p>
                                                    <small>影响抗生素吸收</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="alert alert-warning">
                                                    <h6 class="alert-heading">
                                                        <i class="bi bi-exclamation-circle me-2"></i>中等相互作用
                                                    </h6>
                                                    <p class="mb-1"><strong>卡托普利 + 布洛芬</strong></p>
                                                    <small>降压效果减弱</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="alert alert-info">
                                                    <h6 class="alert-heading">
                                                        <i class="bi bi-info-circle me-2"></i>轻度相互作用
                                                    </h6>
                                                    <p class="mb-1"><strong>连花清瘟 + 板蓝根</strong></p>
                                                    <small>中药协同作用</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `, 'modal-xl');
            
            // 加载药物选项到下拉框
            setTimeout(() => {
                loadMedicineOptions();
            }, 500);
        }

        // ========== 药品咨询相关函数 ==========
        
        // 处理药品搜索键盘事件
        function handleMedicineSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchMedicines();
            }
        }

        // 搜索药品
        async function searchMedicines() {
            const keyword = document.getElementById('medicineSearchInput')?.value?.trim();
            if (!keyword) {
                showCustomAlert('请输入药品名称或关键词', 'warning', '提示');
                return;
            }

            try {
                // 添加骨架屏效果
                showLoadingInResults('medicineSearchResults', '正在搜索药品...');
                document.getElementById('medicineSearchInput')?.classList.add('skeleton');
                
                const response = await fetch(`/api/medicines/search?name=${encodeURIComponent(keyword)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('搜索请求失败');
                }

                const result = await response.json();
                if (result.success && result.data) {
                    displayMedicineSearchResults(result.data);
                } else {
                    showNoMedicineResults();
                }
            } catch (error) {
                console.error('搜索药品失败:', error);
                showMedicineSearchError();
            } finally {
                // 移除骨架屏效果
                document.getElementById('medicineSearchInput')?.classList.remove('skeleton');
            }
        }

        // 按分类搜索药品
        async function searchMedicinesByCategory(category) {
            try {
                showLoadingInResults('medicineSearchResults', `正在搜索${category}相关药品...`);
                
                // 使用分类搜索API
                const response = await fetch(`/api/medicines?category=${encodeURIComponent(category)}&page=0&size=100`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('搜索请求失败');
                }

                const result = await response.json();
                // 处理分页数据结构
                if (result.success && result.data && result.data.content && result.data.content.length > 0) {
                    displayMedicineSearchResults(result.data.content);
                } else {
                    showNoMedicineResults(category);
                }
            } catch (error) {
                console.error('按分类搜索药品失败:', error);
                showMedicineSearchError();
            }
        }

        // 显示药品搜索结果
        function displayMedicineSearchResults(medicines) {
            const resultsContainer = document.getElementById('medicineSearchResults');
            if (!resultsContainer) return;

            if (!medicines || medicines.length === 0) {
                showNoMedicineResults();
                return;
            }

            let html = `
                <div class="search-results-header mb-3">
                    <h6 class="text-muted">
                        <i class="bi bi-search me-2"></i>找到 ${medicines.length} 个相关药品
                    </h6>
                </div>
                <div class="medicine-results-grid">
            `;

            medicines.forEach(medicine => {
                const stockStatus = getStockStatus(medicine.stock);
                const availabilityBadge = medicine.available ? 
                    '<span class="badge bg-success">可用</span>' : 
                    '<span class="badge bg-danger">停用</span>';

                html += `
                    <div class="medicine-card card shadow-sm mb-3" data-medicine-id="${medicine.id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title text-primary mb-1">${medicine.name}</h6>
                                <div class="d-flex gap-2">
                                    ${availabilityBadge}
                                    ${stockStatus.badge}
                                </div>
                            </div>
                            
                            <div class="medicine-info mb-3">
                                <div class="row g-2 text-sm">
                                    <div class="col-6">
                                        <i class="bi bi-upc text-muted me-2"></i>
                                        <span class="text-muted">编码：</span>${medicine.code}
                                    </div>
                                    <div class="col-6">
                                        <i class="bi bi-box text-muted me-2"></i>
                                        <span class="text-muted">规格：</span>${medicine.specification}
                                    </div>
                                    <div class="col-6">
                                        <i class="bi bi-currency-dollar text-muted me-2"></i>
                                        <span class="text-muted">价格：</span>¥${medicine.price}/${medicine.unit}
                                    </div>
                                    <div class="col-6">
                                        <i class="bi bi-box-seam text-muted me-2"></i>
                                        <span class="text-muted">库存：</span>${medicine.stock} ${medicine.unit}
                                    </div>
                                </div>
                            </div>

                            ${medicine.manufacturer ? `
                                <div class="mb-2">
                                    <i class="bi bi-building text-muted me-2"></i>
                                    <span class="text-muted">生产厂家：</span>${medicine.manufacturer}
                                </div>
                            ` : ''}

                            <div class="medicine-actions d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="viewMedicineDetails(${medicine.id})">
                                    <i class="bi bi-eye me-1"></i>详细信息
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="showMedicineUsage(${medicine.id})">
                                    <i class="bi bi-info-circle me-1"></i>用法用量
                                </button>
                                ${medicine.stock > 0 ? `
                                    <button class="btn btn-outline-warning btn-sm" onclick="consultMedicine(${medicine.id})">
                                        <i class="bi bi-chat-dots me-1"></i>咨询
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            resultsContainer.innerHTML = html;
        }

        // 获取库存状态
        function getStockStatus(stock) {
            if (stock <= 0) {
                return {
                    badge: '<span class="badge bg-danger">缺货</span>',
                    class: 'danger'
                };
            } else if (stock <= 10) {
                return {
                    badge: '<span class="badge bg-warning">库存不足</span>',
                    class: 'warning'
                };
            } else {
                return {
                    badge: '<span class="badge bg-success">库存充足</span>',
                    class: 'success'
                };
            }
        }

        // 显示无搜索结果
        function showNoMedicineResults(category = '') {
            const resultsContainer = document.getElementById('medicineSearchResults');
            if (!resultsContainer) return;

            const categoryText = category ? `"${category}"` : '';
            resultsContainer.innerHTML = `
                <div class="no-results text-center py-5">
                    <div class="icon-circle icon-circle-muted mx-auto mb-3">
                        <i class="bi bi-search" style="font-size: 2rem;"></i>
                    </div>
                    <h6 class="text-muted">未找到${categoryText}相关药品</h6>
                    <p class="text-muted mb-3">请尝试使用其他关键词搜索</p>
                    <button class="btn btn-outline-primary" onclick="document.getElementById('medicineSearchInput').focus()">
                        <i class="bi bi-search me-2"></i>重新搜索
                    </button>
                </div>
            `;
        }

        // 显示搜索错误
        function showMedicineSearchError() {
            const resultsContainer = document.getElementById('medicineSearchResults');
            if (!resultsContainer) return;

            resultsContainer.innerHTML = `
                <div class="search-error text-center py-4">
                    <div class="icon-circle icon-circle-danger mx-auto mb-3">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    </div>
                    <h6 class="text-danger">搜索失败</h6>
                    <p class="text-muted mb-3">网络连接异常，请稍后重试</p>
                    <button class="btn btn-outline-danger" onclick="searchMedicines()">
                        <i class="bi bi-arrow-clockwise me-2"></i>重试
                    </button>
                </div>
            `;
        }

        // 查看药品详细信息
        async function viewMedicineDetails(medicineId) {
            try {
                const response = await fetch(`/api/medicines/${medicineId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('获取药品信息失败');
                }

                const result = await response.json();
                if (result.success && result.data) {
                    showMedicineDetailsModal(result.data);
                } else {
                    showCustomAlert('获取药品信息失败', 'error', '错误');
                }
            } catch (error) {
                console.error('获取药品详情失败:', error);
                showCustomAlert('获取药品信息失败，请稍后重试', 'error', '错误');
            }
        }

        // 显示药品详情模态框
        function showMedicineDetailsModal(medicine) {
            const stockStatus = getStockStatus(medicine.stock);
            
            showModal('药品详细信息', `
                <div class="medicine-details">
                    <div class="row g-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-capsule me-2"></i>${medicine.name}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label text-muted">药品编码</label>
                                            <div class="form-control-plaintext">${medicine.code}</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label text-muted">规格</label>
                                            <div class="form-control-plaintext">${medicine.specification}</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label text-muted">单位</label>
                                            <div class="form-control-plaintext">${medicine.unit}</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label text-muted">价格</label>
                                            <div class="form-control-plaintext text-primary fw-bold">¥${medicine.price}</div>
                                        </div>
                                        ${medicine.manufacturer ? `
                                            <div class="col-12">
                                                <label class="form-label text-muted">生产厂家</label>
                                                <div class="form-control-plaintext">${medicine.manufacturer}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-info-circle me-2"></i>状态信息
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">可用状态</label>
                                        <div>
                                            ${medicine.available ? 
                                                '<span class="badge bg-success fs-6">可用</span>' : 
                                                '<span class="badge bg-danger fs-6">停用</span>'
                                            }
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">库存状态</label>
                                        <div>
                                            ${stockStatus.badge}
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label text-muted">库存数量</label>
                                        <div class="form-control-plaintext fw-bold">${medicine.stock} ${medicine.unit}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${medicine.indication || medicine.dosage || medicine.sideEffects || medicine.contraindications ? `
                        <div class="mt-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-book me-2"></i>药品说明
                                    </h6>
                                </div>
                                <div class="card-body">
                                    ${medicine.indication ? `
                                        <div class="mb-3">
                                            <h6 class="text-primary">
                                                <i class="bi bi-check-circle me-2"></i>适应症
                                            </h6>
                                            <p class="mb-0">${medicine.indication}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${medicine.dosage ? `
                                        <div class="mb-3">
                                            <h6 class="text-info">
                                                <i class="bi bi-clock me-2"></i>用法用量
                                            </h6>
                                            <p class="mb-0">${medicine.dosage}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${medicine.sideEffects ? `
                                        <div class="mb-3">
                                            <h6 class="text-warning">
                                                <i class="bi bi-exclamation-triangle me-2"></i>不良反应
                                            </h6>
                                            <p class="mb-0">${medicine.sideEffects}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${medicine.contraindications ? `
                                        <div class="mb-0">
                                            <h6 class="text-danger">
                                                <i class="bi bi-x-circle me-2"></i>禁忌症
                                            </h6>
                                            <p class="mb-0">${medicine.contraindications}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, 'modal-lg');
        }

        // 显示药品用法用量
        function showMedicineUsage(medicineId) {
            viewMedicineDetails(medicineId);
        }

        // 药品咨询
        function consultMedicine(medicineId) {
            showCustomAlert('药品咨询功能正在开发中\n\n如需详细咨询，请：\n• 联系药师：内线8888\n• 访问药房窗口\n• 查看药品说明书', 'info', '咨询提示');
        }

        // 检查药物相互作用
        // 加载药物列表到下拉框
        async function loadMedicineOptions() {
            try {
                const response = await fetch('/api/medicines?page=0&size=100', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('获取药物列表失败');
                }

                const result = await response.json();
                if (result.success && result.data && result.data.content) {
                    const medicines = result.data.content;
                    const select1 = document.getElementById('medicine1Select');
                    const select2 = document.getElementById('medicine2Select');
                    
                    // 清空现有选项
                    select1.innerHTML = '<option value="">请选择药物...</option>';
                    select2.innerHTML = '<option value="">请选择药物...</option>';
                    
                    // 按分类排序药物
                    medicines.sort((a, b) => {
                        if (a.category !== b.category) {
                            return a.category.localeCompare(b.category);
                        }
                        return a.name.localeCompare(b.name);
                    });
                    
                    // 添加药物选项
                    medicines.forEach(medicine => {
                        const option1 = document.createElement('option');
                        option1.value = medicine.name;
                        option1.textContent = `${medicine.name} (${medicine.category})`;
                        select1.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = medicine.name;
                        option2.textContent = `${medicine.name} (${medicine.category})`;
                        select2.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error('加载药物列表失败:', error);
                showCustomAlert('加载药物列表失败，请刷新页面重试', 'error', '加载失败');
            }
        }

        // 快速选择药物组合
        function selectMedicinePair(medicine1, medicine2) {
            document.getElementById('medicine1Select').value = medicine1;
            document.getElementById('medicine2Select').value = medicine2;
            
            // 自动检查相互作用
            setTimeout(() => {
                checkMedicineInteraction();
            }, 300);
        }

        function checkMedicineInteraction() {
            const medicine1 = document.getElementById('medicine1Select')?.value?.trim();
            const medicine2 = document.getElementById('medicine2Select')?.value?.trim();
            
            if (!medicine1 || !medicine2) {
                showCustomAlert('请选择两种药物', 'warning', '选择提醒');
                return;
            }

            if (medicine1.toLowerCase() === medicine2.toLowerCase()) {
                showCustomAlert('请选择两种不同的药物', 'warning', '选择提醒');
                return;
            }

            // 显示加载状态
            const resultsDiv = document.getElementById('interactionResults');
            resultsDiv.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">检查中...</span>
                    </div>
                    <p class="mt-2 text-muted">正在检查药物相互作用...</p>
                </div>
            `;

            // 模拟异步检查过程
            setTimeout(() => {
                displayInteractionResults(medicine1, medicine2);
            }, 1000);
        }

        // 显示药物相互作用结果
        function displayInteractionResults(medicine1, medicine2) {
            const resultsContainer = document.getElementById('interactionResults');
            if (!resultsContainer) return;

            // 模拟检查结果（实际应用中应该调用专业的药物相互作用数据库）
            const interactions = getSimulatedInteractions(medicine1, medicine2);
            
            let html = `
                <div class="interaction-results-header mb-3">
                    <h6 class="text-muted">
                        <i class="bi bi-shield-check me-2"></i>相互作用检查结果：${medicine1} × ${medicine2}
                    </h6>
                </div>
            `;

            if (interactions.length === 0) {
                html += `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>安全：</strong>未发现明显的药物相互作用，但仍建议在医师指导下使用。
                    </div>
                `;
            } else {
                interactions.forEach(interaction => {
                    const alertClass = interaction.severity === 'high' ? 'alert-danger' : 
                                     interaction.severity === 'medium' ? 'alert-warning' : 'alert-info';
                    const icon = interaction.severity === 'high' ? 'bi-exclamation-triangle' : 
                               interaction.severity === 'medium' ? 'bi-exclamation-circle' : 'bi-info-circle';
                    
                    html += `
                        <div class="alert ${alertClass}">
                            <h6 class="alert-heading">
                                <i class="bi ${icon} me-2"></i>${interaction.title}
                            </h6>
                            <p class="mb-1">${interaction.description}</p>
                            <small class="text-muted">${interaction.recommendation}</small>
                        </div>
                    `;
                });
            }

            html += `
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        此结果仅供参考，具体用药请咨询专业医师或药师。
                    </small>
                </div>
            `;

            resultsContainer.innerHTML = html;
        }

        // 模拟药物相互作用数据（实际应用中应该使用专业数据库）
        function getSimulatedInteractions(medicine1, medicine2) {
            const interactions = [];
            
            // 基于常用药品的药物相互作用数据库
            const commonInteractions = [
                // 严重相互作用 (high)
                {
                    drugs: ['华法林', '阿司匹林'],
                    severity: 'high',
                    title: '严重出血风险',
                    description: '两种药物都具有抗凝血作用，同时使用可能显著增加出血风险，特别是胃肠道出血。',
                    recommendation: '必须在医师严密监护下使用，定期检查凝血功能，调整剂量。'
                },
                {
                    drugs: ['阿莫西林', '华法林'],
                    severity: 'high',
                    title: '抗凝效果增强',
                    description: '阿莫西林可能增强华法林的抗凝效果，增加出血风险。',
                    recommendation: '密切监测凝血指标，必要时调整华法林剂量。'
                },
                {
                    drugs: ['头孢克肟', '华法林'],
                    severity: 'high',
                    title: '出血风险增加',
                    description: '头孢类抗生素可能增强华法林的抗凝作用，导致出血风险增加。',
                    recommendation: '联用期间需密切监测凝血功能，调整华法林剂量。'
                },
                {
                    drugs: ['奥美拉唑', '华法林'],
                    severity: 'high',
                    title: '代谢干扰',
                    description: '奥美拉唑可能抑制华法林的代谢，增强其抗凝效果。',
                    recommendation: '联用时需监测凝血功能，可能需要减少华法林剂量。'
                },
                {
                    drugs: ['安定', '999感冒灵'],
                    severity: 'high',
                    title: '中枢抑制增强',
                    description: '两药联用可能导致过度镇静和呼吸抑制，特别危险。',
                    recommendation: '避免同时使用，如必须联用需严密监护。'
                },

                // 中等相互作用 (medium)
                {
                    drugs: ['钙尔奇d', '阿莫西林'],
                    severity: 'medium',
                    title: '吸收干扰',
                    description: '钙离子可能影响阿莫西林的吸收，降低抗生素效果。',
                    recommendation: '建议两种药物间隔2小时以上服用。'
                },
                {
                    drugs: ['钙尔奇d', '头孢克肟'],
                    severity: 'medium',
                    title: '抗生素吸收减少',
                    description: '钙离子可能与头孢克肟形成络合物，影响药物吸收。',
                    recommendation: '间隔服用，钙剂与抗生素至少间隔2小时。'
                },
                {
                    drugs: ['奥美拉唑', '维生素c'],
                    severity: 'medium',
                    title: '胃酸环境改变',
                    description: '奥美拉唑降低胃酸可能影响维生素C的稳定性和吸收。',
                    recommendation: '可考虑调整服药时间或选择肠溶制剂。'
                },
                {
                    drugs: ['多潘立酮', '奥美拉唑'],
                    severity: 'medium',
                    title: '胃肠动力影响',
                    description: '两药作用机制不同，但都影响胃肠功能，需注意协调使用。',
                    recommendation: '按医嘱调整用药时间，观察胃肠道症状。'
                },
                {
                    drugs: ['布洛芬', '阿司匹林'],
                    severity: 'medium',
                    title: '胃肠道刺激增强',
                    description: '两种非甾体抗炎药联用可能增加胃肠道出血和溃疡风险。',
                    recommendation: '避免长期联用，必要时加用胃保护剂。'
                },
                {
                    drugs: ['对乙酰氨基酚', '999感冒灵'],
                    severity: 'medium',
                    title: '重复用药风险',
                    description: '999感冒灵中含有对乙酰氨基酚，联用可能导致过量。',
                    recommendation: '避免重复用药，注意总剂量不超过安全范围。'
                },
                {
                    drugs: ['硝苯地平', '阿司匹林'],
                    severity: 'medium',
                    title: '血压影响',
                    description: '阿司匹林可能轻微影响硝苯地平的降压效果。',
                    recommendation: '定期监测血压，必要时调整降压药剂量。'
                },
                {
                    drugs: ['卡托普利', '布洛芬'],
                    severity: 'medium',
                    title: '降压效果减弱',
                    description: '布洛芬可能减弱ACE抑制剂的降压效果，并增加肾功能损害风险。',
                    recommendation: '监测血压和肾功能，考虑使用其他止痛药。'
                },
                {
                    drugs: ['沙丁胺醇', '复方甘草片'],
                    severity: 'medium',
                    title: '心血管负担',
                    description: '两药都可能影响心率，联用需注意心血管反应。',
                    recommendation: '监测心率和血压，出现心悸时及时就医。'
                },
                {
                    drugs: ['氨溴索', '复方甘草片'],
                    severity: 'medium',
                    title: '祛痰机制重叠',
                    description: '两种祛痰药作用机制不同，联用需注意痰液性质变化。',
                    recommendation: '观察痰液变化，避免过度祛痰导致呼吸道干燥。'
                },

                // 轻度相互作用 (low)
                {
                    drugs: ['维生素c', '复合维生素b'],
                    severity: 'low',
                    title: '轻微相互作用',
                    description: '维生素C可能轻微影响B族维生素的稳定性，但临床意义不大。',
                    recommendation: '正常剂量下可以同时服用，注意储存条件。'
                },
                {
                    drugs: ['连花清瘟', '板蓝根'],
                    severity: 'low',
                    title: '中药协同作用',
                    description: '两种中药都有清热解毒作用，联用可能有协同效果。',
                    recommendation: '可以联用，但注意总体用药剂量，避免过度清热。'
                },
                {
                    drugs: ['蒙脱石散', '多潘立酮'],
                    severity: 'low',
                    title: '胃肠道药物',
                    description: '蒙脱石散可能轻微影响其他药物的吸收。',
                    recommendation: '建议间隔1-2小时服用，先服多潘立酮。'
                },
                {
                    drugs: ['红霉素软膏', '碘伏'],
                    severity: 'low',
                    title: '外用药物配伍',
                    description: '两种外用药物一般不建议同时在同一部位使用。',
                    recommendation: '可先用碘伏消毒，待干燥后再涂抹红霉素软膏。'
                },
                {
                    drugs: ['云南白药', '红霉素软膏'],
                    severity: 'low',
                    title: '外用药物叠加',
                    description: '两种外用药物同时使用可能影响各自的药效发挥。',
                    recommendation: '建议分时段使用或在不同部位使用。'
                },
                {
                    drugs: ['银杏叶', '谷维素'],
                    severity: 'low',
                    title: '神经系统调节',
                    description: '两药都有调节神经系统的作用，联用一般安全。',
                    recommendation: '可以联用，注意观察神经系统症状的改善情况。'
                },
                {
                    drugs: ['罗红霉素', '维生素c'],
                    severity: 'low',
                    title: '轻微影响',
                    description: '维生素C的酸性可能轻微影响罗红霉素的稳定性。',
                    recommendation: '间隔服用更佳，或选择肠溶制剂。'
                },
                {
                    drugs: ['双氯芬酸钠', '蒙脱石散'],
                    severity: 'low',
                    title: '胃肠保护',
                    description: '蒙脱石散可能对双氯芬酸钠引起的胃肠道刺激有保护作用。',
                    recommendation: '可以联用，蒙脱石散有助于减少胃肠道不良反应。'
                }
            ];

            // 检查是否匹配已知的相互作用
            for (const interaction of commonInteractions) {
                const drugs = interaction.drugs.map(d => d.toLowerCase());
                const med1 = medicine1.toLowerCase();
                const med2 = medicine2.toLowerCase();
                
                if ((drugs.includes(med1) && drugs.includes(med2)) ||
                    (med1.includes(drugs[0]) && med2.includes(drugs[1])) ||
                    (med1.includes(drugs[1]) && med2.includes(drugs[0]))) {
                    interactions.push(interaction);
                    break;
                }
            }

            return interactions;
        }

        // 在结果容器中显示加载状态
        function showLoadingInResults(containerId, message) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = `
                <div class="loading-state text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted">${message}</p>
                </div>
            `;
        }

        function openNotifications() {
            showModal('工作通知', `
                <div class="p-4">
                    <div class="text-center mb-4">
                        <div class="function-icon icon-info mx-auto mb-3">
                            <i class="bi bi-bell"></i>
                        </div>
                        <h5>工作通知与提醒</h5>
                    </div>
                    
                    <div class="list-group">
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">系统维护通知</h6>
                                <small>2小时前</small>
                            </div>
                            <p class="mb-1">今晚21:00-22:00系统维护，请提前保存工作。</p>
                            <small>系统管理员</small>
                        </div>
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">新增科室医生</h6>
                                <small>1天前</small>
                            </div>
                            <p class="mb-1">心内科新增李医生，从下周一开始接诊。</p>
                            <small>人事部</small>
                        </div>
                    </div>
                </div>
            `);
        }


        // 合并的病人查询与挂号服务 - 简化版
        function openPatientSearchAndRegistration() {
            showModal('病人查询与挂号服务', `
                <div class="p-4">
                    <div class="text-center mb-4">
                        <div class="function-icon icon-primary mx-auto mb-3">
                            <i class="bi bi-person-plus-fill"></i>
                        </div>
                        <h5>病人查询与挂号服务</h5>
                        <p class="text-muted">查询病人信息，为病人提供专业的挂号预约服务</p>
                    </div>
                    
                    <!-- 病人搜索区域 -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-search"></i> 病人信息查询</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">按姓名查询</label>
                                    <input type="text" class="form-control" placeholder="输入病人姓名" id="searchByName" onkeypress="handleSearchKeyPress(event)">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">按身份证查询</label>
                                    <input type="text" class="form-control" placeholder="输入身份证号" id="searchByIdCard" maxlength="18" onkeypress="handleSearchKeyPress(event)">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">按手机号查询</label>
                                    <input type="text" class="form-control" placeholder="输入手机号" id="searchByPhone" maxlength="11" onkeypress="handleSearchKeyPress(event)">
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-primary" onclick="executePatientSearch()">
                                    <i class="bi bi-search"></i> 开始查询
                                </button>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>提示：</strong>支持模糊查询，可输入姓名、身份证号或手机号的任意部分
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 查询结果显示区域 -->
                    <div id="patientSearchResults" class="mt-3" style="display: none;">
                        <!-- 动态加载搜索结果 -->
                    </div>
                    
                    <div class="alert alert-success mt-3">
                        <h6><i class="bi bi-lightbulb"></i> 服务说明</h6>
                        <ul class="mb-0 small">
                            <li><strong>查询病人：</strong>通过姓名、身份证或手机号搜索病人档案</li>
                            <li><strong>查看详情：</strong>点击"详情"按钮查看病人完整信息</li>
                            <li><strong>协助挂号：</strong>点击"挂号"按钮为病人预约医生</li>
                            <li><strong>数据同步：</strong>所有操作与管理端数据库实时同步</li>
                        </ul>
                    </div>
                </div>
            `);
        }
        
        // 添加综合服务台功能
        function openComprehensiveService() {
            showModal('综合服务台', `
                <div class="p-4">
                    <div class="text-center mb-4">
                        <div class="function-icon icon-success mx-auto mb-3">
                            <i class="bi bi-headset"></i>
                        </div>
                        <h5>综合服务台</h5>
                        <p class="text-muted">为您提供全方位的医院服务咨询</p>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card service-card" onclick="showEmergencyInfo()">
                                <div class="card-body text-center">
                                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2">紧急情况处理</h6>
                                    <p class="small text-muted">急诊流程、紧急联系方式</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card service-card" onclick="showAccessibilityInfo()">
                                <div class="card-body text-center">
                                    <i class="bi bi-person-wheelchair text-info" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2">无障碍服务</h6>
                                    <p class="small text-muted">轮椅租借、无障碍设施</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card service-card" onclick="showTransportInfo()">
                                <div class="card-body text-center">
                                    <i class="bi bi-geo-alt text-warning" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2">交通指引</h6>
                                    <p class="small text-muted">公交路线、停车信息</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card service-card" onclick="showContactInfo()">
                                <div class="card-body text-center">
                                    <i class="bi bi-telephone text-success" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2">联系方式</h6>
                                    <p class="small text-muted">各科室电话、服务热线</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-primary mt-4">
                        <h6><i class="bi bi-info-circle"></i> 服务承诺</h6>
                        <ul class="mb-0 small">
                            <li>24小时急诊服务，全年无休</li>
                            <li>专业医护团队，贴心服务</li>
                            <li>完善的无障碍设施</li>
                            <li>便民服务，患者至上</li>
                        </ul>
                    </div>
                </div>
            `);
        }
        
        // 紧急情况信息
        function showEmergencyInfo() {
            showCustomAlert('紧急情况请立即拨打:\n\n🚑 急救电话: 120\n🏥 医院急诊: 直接前往1楼急诊科\n📞 医院总机: 400-xxx-xxxx\n\n急诊科24小时开放，随时为您服务！', 'warning', '紧急联系方式');
        }
        
        // 无障碍服务信息
        function showAccessibilityInfo() {
            showCustomAlert('无障碍服务设施:\n\n♿ 轮椅租借: 1楼服务台免费提供\n🚗 无障碍停车位: 地下停车场B区\n🚪 无障碍通道: 各楼层均有设置\n🚽 无障碍卫生间: 每层均有配备\n\n如需协助，请联系服务台: 8001', 'info', '无障碍服务');
        }
        
        // 交通指引信息
        function showTransportInfo() {
            showCustomAlert('交通指引:\n\n🚌 公交路线:\n- 1路、15路、32路（医院站）\n- 8路、22路（人民医院站）\n\n🚗 自驾路线:\n- 地下停车场: 300个车位\n- 地面停车场: 100个车位\n- 前2小时免费停车\n\n🚕 出租车: 可直达医院正门', 'info', '交通指引');
        }
        
        // 联系方式信息
        function showContactInfo() {
            showCustomAlert('医院联系方式:\n\n📞 总机: 400-xxx-xxxx\n📞 急诊科: 8000\n📞 服务台: 8001\n📞 投诉热线: 8002\n📞 预约挂号: 8005\n\n🕐 服务时间:\n- 门诊: 8:00-17:30\n- 急诊: 24小时', 'info', '联系方式');
        }
        
        // 辅助功能 - 保留原有的搜索功能供内部调用
        function searchPatients() {
            showModal('病人信息查询', `
                <div class="p-4">
                    <div class="text-center mb-4">
                        <div class="function-icon icon-primary mx-auto mb-3">
                            <i class="bi bi-person-search"></i>
                        </div>
                        <h5>病人信息查询</h5>
                        <p class="text-muted">输入病人信息进行查询，为病人提供专业的接待服务</p>
                    </div>
                    
                    <!-- 多种查询方式 -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-search"></i> 病人信息查询</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">按姓名查询</label>
                                    <input type="text" class="form-control" placeholder="输入病人姓名" id="searchByName" onkeypress="handleSearchKeyPress(event)">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">按身份证查询</label>
                                    <input type="text" class="form-control" placeholder="输入身份证号" id="searchByIdCard" maxlength="18" onkeypress="handleSearchKeyPress(event)">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">按手机号查询</label>
                                    <input type="text" class="form-control" placeholder="输入手机号" id="searchByPhone" maxlength="11" onkeypress="handleSearchKeyPress(event)">
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-primary" onclick="executePatientSearch()">
                                    <i class="bi bi-search"></i> 开始查询
                                </button>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>提示：</strong>支持模糊查询，可输入姓名、身份证号或手机号的任意部分
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 查询结果显示区域 -->
                    <div id="patientSearchResults" class="mt-3" style="display: none;">
                        <!-- 动态加载搜索结果 -->
                    </div>
                </div>
            `);
        }
        
        // 处理回车键搜索
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                executePatientSearch();
            }
        }
        
        // 执行病人查询
        function executePatientSearch() {
            const name = document.getElementById('searchByName').value.trim();
            const idCard = document.getElementById('searchByIdCard').value.trim();
            const phone = document.getElementById('searchByPhone').value.trim();
            
            if (!name && !idCard && !phone) {
                showCustomAlert('请至少输入一种查询条件', 'warning', '输入提示');
                return;
            }
            
            // 构建查询关键词
            const keyword = name || idCard || phone;
            performPatientSearch(keyword);
        }
        
        // 执行实际的病人搜索 - 连接管理端相同的API
        async function performPatientSearch(keyword) {
            try {
                const token = localStorage.getItem('token');
                
                // 显示加载状态
                const resultsContainer = document.getElementById('patientSearchResults');
                resultsContainer.innerHTML = `
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">搜索中...</span>
                            </div>
                            <p class="mt-2 text-muted">正在搜索病人信息...</p>
                        </div>
                    </div>
                `;
                resultsContainer.style.display = 'block';
                
                // 调用管理端相同的API接口
                const response = await fetch(`/api/patients/search?keyword=${encodeURIComponent(keyword)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        displayPatientSearchResults(result.data);
                    } else {
                        showNoSearchResults();
                    }
                } else {
                    console.error('搜索请求失败:', response.status, response.statusText);
                    showSearchError();
                }
            } catch (error) {
                console.error('搜索病人失败:', error);
                showSearchError();
            }
        }
        
        // 显示病人搜索结果
        function displayPatientSearchResults(patients) {
            const resultsContainer = document.getElementById('patientSearchResults');
            
            const resultsHtml = `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-person-check"></i> 找到 ${patients.length} 位病人</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            ${patients.map(patient => `
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-2">
                                                <h6 class="mb-0 me-2">${patient.name}</h6>
                                                <span class="badge ${patient.gender === '男' ? 'bg-primary' : 'bg-info'}">${patient.gender}</span>
                                                <span class="badge bg-secondary ms-1">${calculateAge(patient.birthDate)}岁</span>
                                            </div>
                                            <div class="row g-2 small text-muted">
                                                <div class="col-md-4">
                                                    <i class="bi bi-credit-card"></i> ${patient.idCard || '未提供身份证'}
                                                </div>
                                                <div class="col-md-4">
                                                    <i class="bi bi-telephone"></i> ${patient.phone || '未提供电话'}
                                                </div>
                                                <div class="col-md-4">
                                                    <i class="bi bi-geo-alt"></i> ${patient.address || '未提供地址'}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <button class="btn btn-primary btn-sm me-1" onclick="viewPatientDetails(${patient.id})">
                                                <i class="bi bi-eye"></i> 详情
                                            </button>
                                            <button class="btn btn-success btn-sm" onclick="guideRegistrationForPatient(${patient.id})">
                                                <i class="bi bi-calendar-plus"></i> 挂号
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            resultsContainer.innerHTML = resultsHtml;
            resultsContainer.style.display = 'block';
        }
        
        // 显示无搜索结果
        function showNoSearchResults() {
            const resultsContainer = document.getElementById('patientSearchResults');
            resultsContainer.innerHTML = `
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">未找到匹配的病人</h5>
                        <p class="text-muted">请检查输入信息或联系管理员添加病人档案</p>
                        <div class="alert alert-info mt-3">
                            <small>
                                <i class="bi bi-info-circle"></i> 
                                <strong>提示：</strong>如需添加新病人，请联系管理员在管理系统中添加病人档案
                            </small>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.style.display = 'block';
        }
        
        // 显示搜索错误
        function showSearchError() {
            const resultsContainer = document.getElementById('patientSearchResults');
            resultsContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    搜索时发生错误，请稍后重试或联系技术支持
                </div>
            `;
            resultsContainer.style.display = 'block';
        }
        
        // 计算年龄
        function calculateAge(birthDate) {
            if (!birthDate) return '未知';
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }
        
        // 查看病人详细信息
        async function viewPatientDetails(patientId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/patients/${patientId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showPatientDetailsModal(result.data);
                    }
                }
            } catch (error) {
                console.error('获取病人详情失败:', error);
                showCustomAlert('获取病人信息失败', 'error', '加载错误');
            }
        }
        
        // 显示病人详情模态框
        function showPatientDetailsModal(patient) {
            showModal('病人详细信息', `
                <div class="row">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <table class="table table-sm">
                            <tr><td>姓名:</td><td><strong>${patient.name}</strong></td></tr>
                            <tr><td>性别:</td><td>${patient.gender}</td></tr>
                            <tr><td>年龄:</td><td>${calculateAge(patient.birthDate)}岁</td></tr>
                            <tr><td>身份证:</td><td>${patient.idCard || '未提供'}</td></tr>
                            <tr><td>电话:</td><td>${patient.phone || '未提供'}</td></tr>
                            <tr><td>邮箱:</td><td>${patient.email || '未提供'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>其他信息</h6>
                        <table class="table table-sm">
                            <tr><td>地址:</td><td>${patient.address || '未提供'}</td></tr>
                            <tr><td>紧急联系人:</td><td>${patient.emergencyContact || '未提供'}</td></tr>
                            <tr><td>紧急电话:</td><td>${patient.emergencyPhone || '未提供'}</td></tr>
                            <tr><td>过敏史:</td><td>${patient.allergies || '无'}</td></tr>
                            <tr><td>病史:</td><td>${patient.medicalHistory || '无'}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <button class="btn btn-primary me-2" onclick="guideRegistrationForPatient(${patient.id})">
                        <i class="bi bi-calendar-plus"></i> 协助挂号
                    </button>
                    <button class="btn btn-success" onclick="checkPatientPayments(${patient.id})">
                        <i class="bi bi-receipt"></i> 查看收费记录
                    </button>
                </div>
            `);
        }

        function guideRegistration() {
            guideRegistrationForPatient(null);
        }
        
        // 为指定病人或通用挂号指导
        async function guideRegistrationForPatient(patientId = null) {
            try {
                // 获取科室和医生数据
                const token = localStorage.getItem('token');
                const [departmentsResponse, doctorsResponse] = await Promise.all([
                    fetch('/api/doctors/departments', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/doctors/available', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);
                
                const departmentsResult = await departmentsResponse.json();
                const doctorsResult = await doctorsResponse.json();
                
                if (!departmentsResult.success || !doctorsResult.success) {
                    throw new Error('获取医生信息失败');
                }
                
                const departments = departmentsResult.data || [];
                const doctors = doctorsResult.data || [];
                
                const content = `
                    <div class="p-4">
                        <div class="text-center mb-4">
                            <div class="function-icon icon-primary mx-auto mb-3">
                                <i class="bi bi-calendar-plus"></i>
                            </div>
                            <h5>协助挂号服务</h5>
                            <p class="text-muted">为病人提供专业的挂号指导和预约服务</p>
                        </div>
                        
                        ${patientId ? `<input type="hidden" id="selectedPatientId" value="${patientId}">` : `
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> 
                                <strong>注意：</strong>请先在病人查询中选择病人，或手动输入病人ID
                                <div class="mt-2">
                                    <input type="number" class="form-control" placeholder="输入病人ID" id="manualPatientId">
                                </div>
                            </div>
                        `}
                        
                        <!-- 挂号表单 -->
                        <form id="registrationForm">
                            <div class="row g-3">
                                <!-- 科室选择 -->
                                <div class="col-md-6">
                                    <label for="departmentSelect" class="form-label">
                                        <i class="bi bi-building"></i> 选择科室 <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="departmentSelect" onchange="filterDoctorsByDepartment()" required>
                                        <option value="">请选择科室</option>
                                        ${departments.map(dept => `<option value="${dept}">${dept}</option>`).join('')}
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                
                                <!-- 医生选择 -->
                                <div class="col-md-6">
                                    <label for="doctorSelect" class="form-label">
                                        <i class="bi bi-person-badge"></i> 选择医生 <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="doctorSelect" onchange="updateConsultationFee()" required>
                                        <option value="">请先选择科室</option>
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                
                                <!-- 预约时间 -->
                                <div class="col-md-6">
                                    <label for="appointmentTime" class="form-label">
                                        <i class="bi bi-calendar-event"></i> 预约时间 <span class="text-danger">*</span>
                                    </label>
                                    <input type="datetime-local" class="form-control" id="appointmentTime" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                                
                                <!-- 挂号费 -->
                                <div class="col-md-6">
                                    <label for="registrationFee" class="form-label">
                                        <i class="bi bi-currency-dollar"></i> 挂号费 <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="registrationFee" 
                                               step="0.01" min="0.01" max="9999.99" required readonly>
                                        <span class="input-group-text">元</span>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>
                                
                                <!-- 症状描述 -->
                                <div class="col-12">
                                    <label for="symptoms" class="form-label">
                                        <i class="bi bi-clipboard-pulse"></i> 症状描述
                                    </label>
                                    <textarea class="form-control" id="symptoms" rows="3" 
                                              placeholder="请描述病人的主要症状和不适..." maxlength="500"></textarea>
                                    <div class="form-text">选填，最多500字符</div>
                                    <div class="invalid-feedback"></div>
                                </div>
                                
                                <!-- 备注信息 -->
                                <div class="col-12">
                                    <label for="registrationNotes" class="form-label">
                                        <i class="bi bi-journal-text"></i> 备注信息
                                    </label>
                                    <textarea class="form-control" id="registrationNotes" rows="2" 
                                              placeholder="其他需要说明的信息..." maxlength="500"></textarea>
                                    <div class="form-text">选填，最多500字符</div>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <!-- 医生信息展示 -->
                            <div id="doctorInfo" class="mt-3" style="display: none;">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> 医生信息</h6>
                                    </div>
                                    <div class="card-body" id="doctorInfoContent">
                                        <!-- 动态加载医生信息 -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 温馨提示 -->
                            <div class="alert alert-info mt-3">
                                <h6><i class="bi bi-lightbulb"></i> 温馨提示</h6>
                                <ul class="mb-0 small">
                                    <li>请根据病人症状选择合适的科室和医生</li>
                                    <li>预约时间请选择医生的工作时间内</li>
                                    <li>挂号费将根据医生级别自动设置</li>
                                    <li>挂号成功后请提醒病人按时就诊</li>
                                </ul>
                            </div>
                        </form>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg me-2" onclick="submitRegistration()">
                                <i class="bi bi-check-circle"></i> 确认挂号
                            </button>
                            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle"></i> 取消
                            </button>
                        </div>
                    </div>
                `;
                
                // 存储医生数据供后续使用
                window.availableDoctors = doctors;
                
                showModal('协助挂号服务', content);
                
                // 设置最小预约时间为当前时间
                const now = new Date();
                const minDateTime = new Date(now.getTime() + 30 * 60000); // 30分钟后
                document.getElementById('appointmentTime').min = minDateTime.toISOString().slice(0, 16);
                
            } catch (error) {
                console.error('加载挂号服务失败:', error);
                showCustomAlert('加载挂号服务失败，请稍后重试', 'error', '加载失败');
            }
        }
        
        // 根据科室筛选医生
        function filterDoctorsByDepartment() {
            const departmentSelect = document.getElementById('departmentSelect');
            const doctorSelect = document.getElementById('doctorSelect');
            const selectedDepartment = departmentSelect.value;
            
            // 清空医生选择
            doctorSelect.innerHTML = '<option value="">请选择医生</option>';
            document.getElementById('registrationFee').value = '';
            document.getElementById('doctorInfo').style.display = 'none';
            
            if (selectedDepartment && window.availableDoctors) {
                const departmentDoctors = window.availableDoctors.filter(doctor => 
                    doctor.department === selectedDepartment
                );
                
                departmentDoctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.id;
                    option.textContent = `${doctor.name} - ${doctor.title}`;
                    option.dataset.doctor = JSON.stringify(doctor);
                    doctorSelect.appendChild(option);
                });
                
                if (departmentDoctors.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '该科室暂无可用医生';
                    doctorSelect.appendChild(option);
                }
            }
        }
        
        // 更新挂号费和显示医生信息
        function updateConsultationFee() {
            const doctorSelect = document.getElementById('doctorSelect');
            const selectedOption = doctorSelect.options[doctorSelect.selectedIndex];
            
            if (selectedOption.value && selectedOption.dataset.doctor) {
                const doctor = JSON.parse(selectedOption.dataset.doctor);
                
                // 设置挂号费（使用医生的诊疗费作为挂号费）
                document.getElementById('registrationFee').value = doctor.consultationFee || '50.00';
                
                // 显示医生信息
                document.getElementById('doctorInfoContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h6>${doctor.name} <span class="badge bg-primary ms-2">${doctor.title}</span></h6>
                            <p class="mb-1"><strong>科室：</strong>${doctor.department}</p>
                            <p class="mb-1"><strong>专长：</strong>${doctor.specialization || '暂无'}</p>
                            <p class="mb-1"><strong>简介：</strong>${doctor.introduction || '暂无'}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="text-success">
                                <i class="bi bi-check-circle"></i> 可预约
                            </div>
                            <div class="mt-2">
                                <strong class="text-primary">￥${doctor.consultationFee || '50.00'}</strong>
                                <small class="text-muted d-block">诊疗费</small>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('doctorInfo').style.display = 'block';
            } else {
                document.getElementById('registrationFee').value = '';
                document.getElementById('doctorInfo').style.display = 'none';
            }
        }
        
        // 提交挂号申请 - 同步到管理端数据库
        async function submitRegistration() {
            try {
                // 清除之前的错误提示
                clearRegistrationFormErrors();
                
                // 获取表单数据
                const patientId = document.getElementById('selectedPatientId')?.value || document.getElementById('manualPatientId')?.value;
                const doctorId = document.getElementById('doctorSelect').value;
                const appointmentTime = document.getElementById('appointmentTime').value;
                const registrationFee = document.getElementById('registrationFee').value;
                const symptoms = document.getElementById('symptoms').value.trim();
                const notes = document.getElementById('registrationNotes').value.trim();
                
                // 验证必填字段
                if (!patientId) {
                    showCustomAlert('请先选择病人或输入病人ID', 'warning', '选择提示');
                    return;
                }
                
                if (!doctorId) {
                    showFieldError('doctorSelect', '请选择医生');
                    return;
                }
                
                if (!appointmentTime) {
                    showFieldError('appointmentTime', '请选择预约时间');
                    return;
                }
                
                if (!registrationFee || isNaN(parseFloat(registrationFee))) {
                    showFieldError('registrationFee', '请输入有效的挂号费');
                    return;
                }
                
                // 构建挂号数据 - 与管理端格式一致
                const registrationData = {
                    patient: { id: parseInt(patientId) },
                    doctor: { id: parseInt(doctorId) },
                    appointmentTime: new Date(appointmentTime).toISOString(),
                    registrationFee: parseFloat(registrationFee),
                    status: 'PENDING' // 默认状态为待就诊
                };
                
                // 添加可选字段
                if (symptoms) {
                    registrationData.symptoms = symptoms;
                }
                if (notes) {
                    registrationData.notes = notes;
                }
                
                // 发送挂号请求到管理端相同的API
                const token = localStorage.getItem('token');
                const response = await fetch('/api/registrations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registrationData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // 挂号成功
                    const doctorName = document.getElementById('doctorSelect').options[document.getElementById('doctorSelect').selectedIndex].textContent;
                    showCustomAlert('挂号成功！\n\n' +
                          `病人ID：${patientId}\n` +
                          `医生：${doctorName}\n` +
                          `时间：${new Date(appointmentTime).toLocaleString('zh-CN')}\n` +
                          `挂号费：￥${registrationFee}\n\n` +
                          '挂号信息已同步到管理端，请提醒病人按时就诊！', 'success', '挂号成功');
                    
                    // 发送通知
                    if (window.notificationHelper) {
                        try {
                            const notificationData = {
                                id: result.data?.id || Date.now().toString(),
                                patientName: `病人ID: ${patientId}`,
                                doctorName: doctorName,
                                appointmentTime: appointmentTime
                            };
                            await window.notificationHelper.sendRegistrationNotification('create', notificationData);
                            console.log('员工端挂号通知发送成功');
                        } catch (notifyError) {
                            console.error('发送通知失败:', notifyError);
                        }
                    }
                    
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // 刷新统计数据
                    loadTodayStats();
                    
                } else {
                    // 处理验证错误
                    if (result.data && typeof result.data === 'object') {
                        showRegistrationFormErrors(result.data);
                        showCustomAlert('输入信息有误，请查看标红的字段提示并修正', 'warning', '输入错误');
                    } else {
                        showCustomAlert('挂号失败：' + (result.message || '未知错误'), 'error', '挂号失败');
                    }
                }
                
            } catch (error) {
                console.error('提交挂号失败:', error);
                showCustomAlert('挂号失败，请稍后重试', 'error', '网络错误');
            }
        }
        
        // 清除挂号表单错误提示
        function clearRegistrationFormErrors() {
            const fields = ['departmentSelect', 'doctorSelect', 'appointmentTime', 'registrationFee', 'symptoms', 'registrationNotes'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('is-invalid');
                    const feedback = field.parentNode.querySelector('.invalid-feedback');
                    if (feedback) {
                        feedback.textContent = '';
                    }
                }
            });
        }
        
        // 显示字段错误
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.add('is-invalid');
                const feedback = field.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.textContent = message;
                }
                field.focus();
            }
        }
        
        // 显示挂号表单验证错误
        function showRegistrationFormErrors(fieldErrors) {
            const fieldMap = {
                'patient': 'selectedPatientId',
                'doctor': 'doctorSelect',
                'appointmentTime': 'appointmentTime',
                'registrationFee': 'registrationFee',
                'symptoms': 'symptoms',
                'notes': 'registrationNotes'
            };
            
            for (const [fieldName, errorMessage] of Object.entries(fieldErrors)) {
                const fieldId = fieldMap[fieldName];
                if (fieldId) {
                    showFieldError(fieldId, errorMessage);
                }
            }
        }
        
        // 查看病人收费记录
        async function checkPatientPayments(patientId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/patient/${patientId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data.length > 0) {
                        displayPatientPayments(result.data);
                    } else {
                        showNoPaymentRecords();
                    }
                } else {
                    showNoPaymentRecords();
                }
            } catch (error) {
                console.error('获取收费记录失败:', error);
                showNoPaymentRecords();
            }
        }
        
        // 显示病人收费记录
        function displayPatientPayments(payments) {
            const paymentsHtml = payments.length > 0 ? payments.map(payment => `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${payment.paymentType || '收费项目'}</h6>
                        <small>${new Date(payment.createdAt).toLocaleDateString()}</small>
                    </div>
                    <p class="mb-1">金额: <strong class="text-success">¥${payment.amount}</strong> | 状态: 
                        <span class="badge ${payment.status === 'PAID' ? 'bg-success' : payment.status === 'PENDING' ? 'bg-warning' : 'bg-secondary'}">
                            ${payment.status === 'PAID' ? '已支付' : payment.status === 'PENDING' ? '待支付' : '已退款'}
                        </span>
                    </p>
                    <small class="text-muted">${payment.description || '无备注'}</small>
                </div>
            `).join('') : '<div class="text-center text-muted py-4">暂无收费记录</div>';
            
            showModal('病人收费记录', `
                <div class="p-4">
                    <h6 class="mb-3">收费记录</h6>
                    <div class="list-group" style="max-height: 400px; overflow-y: auto;">
                        ${paymentsHtml}
                    </div>
                </div>
            `);
        }
        
        // 显示无收费记录
        function showNoPaymentRecords() {
            showModal('收费记录', `
                <div class="text-center p-4">
                    <i class="bi bi-receipt" style="font-size: 3rem; color: #ccc;"></i>
                    <h5 class="mt-3">暂无收费记录</h5>
                    <p class="text-muted">该病人暂时没有收费记录</p>
                </div>
            `);
        }

        function showHospitalInfo() {
            showModal('医院信息咨询', `
                <div class="p-4">
                    <div class="text-center mb-4">
                        <div class="function-icon icon-info mx-auto mb-3">
                            <i class="bi bi-info-circle"></i>
                        </div>
                        <h5>医院信息咨询服务</h5>
                        <p class="text-muted">为病人和家属提供全面的医院信息和就诊指导</p>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100 info-card" onclick="showDepartmentInfo()">
                                <div class="card-body text-center">
                                    <i class="bi bi-building" style="font-size: 2.5rem; color: var(--bs-primary);"></i>
                                    <h6 class="mt-2">科室分布</h6>
                                    <p class="small text-muted">各科室位置、专业特色、服务范围</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100 info-card" onclick="showScheduleInfo()">
                                <div class="card-body text-center">
                                    <i class="bi bi-clock" style="font-size: 2.5rem; color: var(--bs-success);"></i>
                                    <h6 class="mt-2">就诊时间</h6>
                                    <p class="small text-muted">门诊时间、急诊安排、节假日安排</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100 info-card" onclick="showNavigationInfo()">
                                <div class="card-body text-center">
                                    <i class="bi bi-geo-alt" style="font-size: 2.5rem; color: var(--bs-warning);"></i>
                                    <h6 class="mt-2">院内导航</h6>
                                    <p class="small text-muted">楼层分布、路线指引、便民设施</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100 info-card" onclick="showMedicalProcess()">
                                <div class="card-body text-center">
                                    <i class="bi bi-diagram-3" style="font-size: 2.5rem; color: var(--bs-info);"></i>
                                    <h6 class="mt-2">就诊流程</h6>
                                    <p class="small text-muted">挂号、就诊、检查、取药流程</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100 info-card" onclick="showPaymentInfo()">
                                <div class="card-body text-center">
                                    <i class="bi bi-credit-card" style="font-size: 2.5rem; color: var(--bs-danger);"></i>
                                    <h6 class="mt-2">收费标准</h6>
                                    <p class="small text-muted">挂号费、检查费、医保政策</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100 info-card" onclick="showFAQ()">
                                <div class="card-body text-center">
                                    <i class="bi bi-question-circle" style="font-size: 2.5rem; color: var(--bs-secondary);"></i>
                                    <h6 class="mt-2">常见问题</h6>
                                    <p class="small text-muted">就诊须知、注意事项、常见疑问</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-4">
                        <h6><i class="bi bi-lightbulb"></i> 温馨提示</h6>
                        <ul class="mb-0 small">
                            <li>如需详细咨询，请点击相应模块查看具体信息</li>
                            <li>紧急情况请直接前往急诊科或拨打120</li>
                            <li>如有其他疑问，可联系服务台或拨打医院总机</li>
                        </ul>
                    </div>
                </div>
            `);
        }
        
        // 科室分布信息
        function showDepartmentInfo() {
            showModal('科室分布信息', `
                <div class="p-4">
                    <h5 class="mb-4"><i class="bi bi-building text-primary"></i> 科室分布与专业特色</h5>
                    
                    <div class="accordion" id="departmentAccordion">
                        <!-- 门诊楼 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#outpatient">
                                    <i class="bi bi-hospital me-2"></i> 门诊楼（1-3层）
                                </button>
                            </h2>
                            <div id="outpatient" class="accordion-collapse collapse show" data-bs-parent="#departmentAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <h6 class="text-primary">一层</h6>
                                            <ul class="list-unstyled">
                                                <li><i class="bi bi-dot"></i> 挂号收费处</li>
                                                <li><i class="bi bi-dot"></i> 药房</li>
                                                <li><i class="bi bi-dot"></i> 急诊科</li>
                                                <li><i class="bi bi-dot"></i> 检验科</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-success">二层</h6>
                                            <ul class="list-unstyled">
                                                <li><i class="bi bi-dot"></i> 内科</li>
                                                <li><i class="bi bi-dot"></i> 外科</li>
                                                <li><i class="bi bi-dot"></i> 妇产科</li>
                                                <li><i class="bi bi-dot"></i> 儿科</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-warning">三层</h6>
                                            <ul class="list-unstyled">
                                                <li><i class="bi bi-dot"></i> 眼科</li>
                                                <li><i class="bi bi-dot"></i> 耳鼻喉科</li>
                                                <li><i class="bi bi-dot"></i> 口腔科</li>
                                                <li><i class="bi bi-dot"></i> 皮肤科</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 医技楼 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#medical">
                                    <i class="bi bi-gear me-2"></i> 医技楼（检查中心）
                                </button>
                            </h2>
                            <div id="medical" class="accordion-collapse collapse" data-bs-parent="#departmentAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-info">影像检查</h6>
                                            <ul class="list-unstyled">
                                                <li><i class="bi bi-camera"></i> X光室</li>
                                                <li><i class="bi bi-camera"></i> CT室</li>
                                                <li><i class="bi bi-camera"></i> MRI室</li>
                                                <li><i class="bi bi-camera"></i> 超声科</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-danger">功能检查</h6>
                                            <ul class="list-unstyled">
                                                <li><i class="bi bi-activity"></i> 心电图室</li>
                                                <li><i class="bi bi-activity"></i> 脑电图室</li>
                                                <li><i class="bi bi-lungs"></i> 肺功能室</li>
                                                <li><i class="bi bi-heart"></i> 心脏彩超</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 住院部 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#inpatient">
                                    <i class="bi bi-house me-2"></i> 住院部（4-8层）
                                </button>
                            </h2>
                            <div id="inpatient" class="accordion-collapse collapse" data-bs-parent="#departmentAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>楼层</th>
                                                    <th>科室</th>
                                                    <th>床位数</th>
                                                    <th>特色服务</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>4层</td>
                                                    <td>内科病房</td>
                                                    <td>40床</td>
                                                    <td>心血管、消化、呼吸专业</td>
                                                </tr>
                                                <tr>
                                                    <td>5层</td>
                                                    <td>外科病房</td>
                                                    <td>35床</td>
                                                    <td>普外、骨科、泌尿专业</td>
                                                </tr>
                                                <tr>
                                                    <td>6层</td>
                                                    <td>妇产科病房</td>
                                                    <td>30床</td>
                                                    <td>产科、妇科、新生儿护理</td>
                                                </tr>
                                                <tr>
                                                    <td>7层</td>
                                                    <td>儿科病房</td>
                                                    <td>25床</td>
                                                    <td>儿童专科、家庭陪护</td>
                                                </tr>
                                                <tr>
                                                    <td>8层</td>
                                                    <td>ICU重症监护</td>
                                                    <td>12床</td>
                                                    <td>24小时监护、专业护理</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 就诊时间信息
        function showScheduleInfo() {
            showModal('就诊时间安排', `
                <div class="p-4">
                    <h5 class="mb-4"><i class="bi bi-clock text-success"></i> 医院作息时间表</h5>
                    
                    <div class="row g-4">
                        <!-- 门诊时间 -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-hospital"></i> 门诊时间</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <td><strong>上午门诊</strong></td>
                                            <td>08:00 - 12:00</td>
                                        </tr>
                                        <tr>
                                            <td><strong>下午门诊</strong></td>
                                            <td>14:00 - 17:30</td>
                                        </tr>
                                        <tr>
                                            <td><strong>夜间门诊</strong></td>
                                            <td>18:00 - 21:00</td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td><strong>周末门诊</strong></td>
                                            <td>09:00 - 16:00</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 急诊时间 -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0"><i class="bi bi-lightning"></i> 急诊服务</h6>
                                </div>
                                <div class="card-body">
                                    <div class="text-center">
                                        <i class="bi bi-clock-history" style="font-size: 3rem; color: #dc3545;"></i>
                                        <h4 class="text-danger mt-2">24小时</h4>
                                        <p class="text-muted">全年无休，随时为您服务</p>
                                    </div>
                                    <div class="alert alert-danger">
                                        <small>
                                            <i class="bi bi-exclamation-triangle"></i>
                                            <strong>紧急情况：</strong>请直接前往急诊科或拨打120
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 专科门诊 -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="bi bi-calendar-week"></i> 专科门诊时间表</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>科室</th>
                                                    <th>周一</th>
                                                    <th>周二</th>
                                                    <th>周三</th>
                                                    <th>周四</th>
                                                    <th>周五</th>
                                                    <th>周六</th>
                                                    <th>周日</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><strong>心内科</strong></td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-warning">上午</td>
                                                    <td class="bg-secondary text-white">休息</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>骨科</strong></td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-warning">上午</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-warning">下午</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-warning">上午</td>
                                                    <td class="bg-secondary text-white">休息</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>妇产科</strong></td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-success text-white">全天</td>
                                                    <td class="bg-warning">上午</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 节假日安排 -->
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <h6><i class="bi bi-calendar-event"></i> 节假日安排</h6>
                                <ul class="mb-0">
                                    <li><strong>法定节假日：</strong>急诊正常开放，门诊安排值班医生</li>
                                    <li><strong>春节期间：</strong>初一至初三门诊停诊，急诊24小时开放</li>
                                    <li><strong>其他假期：</strong>提前在医院官网和大厅公布具体安排</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 院内导航信息
        function showNavigationInfo() {
            showModal('院内导航指引', `
                <div class="p-4">
                    <h5 class="mb-4"><i class="bi bi-geo-alt text-warning"></i> 院内导航与便民设施</h5>
                    
                    <div class="row g-4">
                        <!-- 主要路线 -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-signpost"></i> 主要路线指引</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="text-success">🚪 从正门进入</h6>
                                        <small class="text-muted">
                                            正门 → 大厅服务台 → 挂号收费处 → 各科室电梯
                                        </small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="text-info">🚗 从停车场进入</h6>
                                        <small class="text-muted">
                                            地下停车场 → B1电梯 → 1楼大厅 → 各科室
                                        </small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="text-danger">🚑 急诊通道</h6>
                                        <small class="text-muted">
                                            急诊专用通道 → 急诊科 → 抢救室/观察室
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 电梯分布 -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-arrow-up-square"></i> 电梯分布</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <td><i class="bi bi-1-square text-primary"></i> <strong>A座电梯</strong></td>
                                            <td>门诊科室专用</td>
                                        </tr>
                                        <tr>
                                            <td><i class="bi bi-2-square text-success"></i> <strong>B座电梯</strong></td>
                                            <td>住院部专用</td>
                                        </tr>
                                        <tr>
                                            <td><i class="bi bi-3-square text-warning"></i> <strong>C座电梯</strong></td>
                                            <td>医技楼检查专用</td>
                                        </tr>
                                        <tr>
                                            <td><i class="bi bi-4-square text-danger"></i> <strong>货梯</strong></td>
                                            <td>医疗设备运输</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 便民设施 -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="bi bi-house-heart"></i> 便民服务设施</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <h6 class="text-primary">🏪 生活服务</h6>
                                            <ul class="list-unstyled small">
                                                <li><i class="bi bi-shop"></i> 便利店（1楼）</li>
                                                <li><i class="bi bi-cup-hot"></i> 咖啡厅（2楼）</li>
                                                <li><i class="bi bi-bank"></i> ATM机（1楼大厅）</li>
                                                <li><i class="bi bi-wifi"></i> 免费WiFi覆盖</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-success">♿ 无障碍设施</h6>
                                            <ul class="list-unstyled small">
                                                <li><i class="bi bi-person-wheelchair"></i> 轮椅通道</li>
                                                <li><i class="bi bi-elevator"></i> 无障碍电梯</li>
                                                <li><i class="bi bi-p-square"></i> 残疾人停车位</li>
                                                <li><i class="bi bi-door-open"></i> 无障碍卫生间</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-warning">🚗 停车服务</h6>
                                            <ul class="list-unstyled small">
                                                <li><i class="bi bi-car-front"></i> 地下停车场（300位）</li>
                                                <li><i class="bi bi-geo-alt"></i> 地面停车场（100位）</li>
                                                <li><i class="bi bi-clock"></i> 24小时开放</li>
                                                <li><i class="bi bi-currency-dollar"></i> 前2小时免费</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-danger">📞 联系服务</h6>
                                            <ul class="list-unstyled small">
                                                <li><i class="bi bi-telephone"></i> 服务台：8001</li>
                                                <li><i class="bi bi-headset"></i> 投诉热线：8002</li>
                                                <li><i class="bi bi-shield-check"></i> 保安室：8003</li>
                                                <li><i class="bi bi-tools"></i> 维修服务：8004</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 就诊流程信息
        function showMedicalProcess() {
            showModal('就诊流程指引', `
                <div class="p-4">
                    <h5 class="mb-4"><i class="bi bi-diagram-3 text-info"></i> 完整就诊流程</h5>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <!-- 流程步骤 -->
                            <div class="process-container">
                                <div class="process-step">
                                    <div class="step-number bg-primary">1</div>
                                    <div class="step-content">
                                        <h6>预约挂号</h6>
                                        <p class="small text-muted">
                                            • 现场挂号：1楼挂号收费处<br>
                                            • 自助挂号：大厅自助机<br>
                                            • 网上预约：医院官网/APP<br>
                                            • 电话预约：400-xxx-xxxx
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="process-step">
                                    <div class="step-number bg-success">2</div>
                                    <div class="step-content">
                                        <h6>候诊就医</h6>
                                        <p class="small text-muted">
                                            • 按挂号单到相应科室<br>
                                            • 在候诊区等待叫号<br>
                                            • 配合医生进行检查<br>
                                            • 如实告知病史症状
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="process-step">
                                    <div class="step-number bg-warning">3</div>
                                    <div class="step-content">
                                        <h6>检查化验</h6>
                                        <p class="small text-muted">
                                            • 根据医嘱进行相关检查<br>
                                            • 到医技楼完成影像检查<br>
                                            • 检验科抽血化验<br>
                                            • 等待检查结果
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="process-step">
                                    <div class="step-number bg-info">4</div>
                                    <div class="step-content">
                                        <h6>复诊取药</h6>
                                        <p class="small text-muted">
                                            • 携带检查结果复诊<br>
                                            • 医生开具处方或治疗方案<br>
                                            • 到收费处缴费<br>
                                            • 药房取药并了解用法
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="process-step">
                                    <div class="step-number bg-secondary">5</div>
                                    <div class="step-content">
                                        <h6>后续随访</h6>
                                        <p class="small text-muted">
                                            • 按医嘱按时服药<br>
                                            • 定期复查随访<br>
                                            • 如有异常及时就医<br>
                                            • 保持与医生沟通
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- 重要提醒 -->
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> 重要提醒</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-warning">
                                        <h6>就诊须知</h6>
                                        <ul class="small mb-0">
                                            <li>请携带身份证或医保卡</li>
                                            <li>提前30分钟到达医院</li>
                                            <li>空腹检查需禁食8小时</li>
                                            <li>请如实告知过敏史</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <h6>特殊情况</h6>
                                        <ul class="small mb-0">
                                            <li>急诊：直接前往急诊科</li>
                                            <li>发热：先到发热门诊</li>
                                            <li>儿童：需家长陪同</li>
                                            <li>孕妇：告知怀孕情况</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                .process-container {
                    position: relative;
                }
                
                .process-step {
                    display: flex;
                    align-items: flex-start;
                    margin-bottom: 2rem;
                    position: relative;
                }
                
                .step-number {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    margin-right: 1rem;
                    flex-shrink: 0;
                }
                
                .step-content {
                    flex: 1;
                    padding-top: 0.25rem;
                }
                
                .process-step:not(:last-child)::after {
                    content: '';
                    position: absolute;
                    left: 19px;
                    top: 40px;
                    width: 2px;
                    height: 2rem;
                    background: #dee2e6;
                }
                </style>
            `);
        }
        
        // 收费标准信息
        function showPaymentInfo() {
            showModal('收费标准说明', `
                <div class="p-4">
                    <h5 class="mb-4"><i class="bi bi-credit-card text-danger"></i> 医疗收费标准</h5>
                    
                    <div class="row g-4">
                        <!-- 挂号费用 -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-receipt"></i> 挂号费用标准</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <td>普通门诊</td>
                                            <td class="text-end"><strong>¥15</strong></td>
                                        </tr>
                                        <tr>
                                            <td>副主任医师</td>
                                            <td class="text-end"><strong>¥25</strong></td>
                                        </tr>
                                        <tr>
                                            <td>主任医师</td>
                                            <td class="text-end"><strong>¥35</strong></td>
                                        </tr>
                                        <tr>
                                            <td>专家门诊</td>
                                            <td class="text-end"><strong>¥50</strong></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>急诊挂号</td>
                                            <td class="text-end"><strong>¥20</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 检查费用 -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-camera"></i> 常见检查费用</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <td>血常规</td>
                                            <td class="text-end"><strong>¥25</strong></td>
                                        </tr>
                                        <tr>
                                            <td>尿常规</td>
                                            <td class="text-end"><strong>¥15</strong></td>
                                        </tr>
                                        <tr>
                                            <td>胸部X光</td>
                                            <td class="text-end"><strong>¥80</strong></td>
                                        </tr>
                                        <tr>
                                            <td>腹部B超</td>
                                            <td class="text-end"><strong>¥120</strong></td>
                                        </tr>
                                        <tr>
                                            <td>心电图</td>
                                            <td class="text-end"><strong>¥30</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 医保政策 -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="bi bi-shield-check"></i> 医保政策说明</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <h6 class="text-primary">城镇职工医保</h6>
                                            <ul class="small">
                                                <li>门诊报销比例：70%-90%</li>
                                                <li>住院报销比例：85%-95%</li>
                                                <li>起付线：门诊500元，住院1000元</li>
                                                <li>年度最高支付限额：30万元</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-success">城乡居民医保</h6>
                                            <ul class="small">
                                                <li>门诊报销比例：50%-70%</li>
                                                <li>住院报销比例：70%-85%</li>
                                                <li>起付线：门诊200元，住院500元</li>
                                                <li>年度最高支付限额：20万元</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-warning">新农合</h6>
                                            <ul class="small">
                                                <li>门诊报销比例：40%-60%</li>
                                                <li>住院报销比例：60%-80%</li>
                                                <li>起付线：门诊100元，住院300元</li>
                                                <li>年度最高支付限额：15万元</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 支付方式 -->
                        <div class="col-12">
                            <div class="alert alert-success">
                                <h6><i class="bi bi-credit-card-2-front"></i> 支付方式</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>现金支付：</strong>人民币现金，收费处找零<br>
                                        <strong>银行卡：</strong>支持各大银行借记卡、信用卡<br>
                                        <strong>医保卡：</strong>社保卡直接结算
                                    </div>
                                    <div class="col-md-6">
                                        <strong>移动支付：</strong>微信支付、支付宝<br>
                                        <strong>预付费：</strong>住院预交金、门诊充值卡<br>
                                        <strong>分期付款：</strong>大额医疗费用可申请分期
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 常见问题
        function showFAQ() {
            showModal('常见问题解答', `
                <div class="p-4">
                    <h5 class="mb-4"><i class="bi bi-question-circle text-secondary"></i> 常见问题解答</h5>
                    
                    <div class="accordion" id="faqAccordion">
                        <!-- 挂号相关 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                    <i class="bi bi-calendar-plus me-2"></i> 挂号预约相关问题
                                </button>
                            </h2>
                            <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <strong>Q: 如何预约挂号？</strong><br>
                                        <small class="text-muted">A: 可通过现场挂号、自助机、官网、APP或电话预约。建议提前1-7天预约。</small>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Q: 挂号费可以退吗？</strong><br>
                                        <small class="text-muted">A: 就诊前2小时可申请退号，需携带挂号单到收费处办理。</small>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Q: 忘记带身份证怎么办？</strong><br>
                                        <small class="text-muted">A: 可使用电子身份证、驾驶证或户口本等有效证件。</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 就诊相关 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                    <i class="bi bi-hospital me-2"></i> 就诊流程相关问题
                                </button>
                            </h2>
                            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <strong>Q: 需要空腹检查的项目有哪些？</strong><br>
                                        <small class="text-muted">A: 血糖、血脂、肝功能、腹部B超等需要空腹8-12小时。</small>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Q: 检查结果多久能出来？</strong><br>
                                        <small class="text-muted">A: 血常规30分钟，生化检查2-4小时，影像检查当天出结果。</small>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Q: 可以代替家人取检查结果吗？</strong><br>
                                        <small class="text-muted">A: 可以，需携带患者身份证和代办人身份证。</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 收费相关 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                    <i class="bi bi-credit-card me-2"></i> 收费医保相关问题
                                </button>
                            </h2>
                            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <strong>Q: 医保卡忘记带怎么办？</strong><br>
                                        <small class="text-muted">A: 可先自费就诊，3个月内携带相关材料到医保办申请报销。</small>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Q: 哪些费用不能报销？</strong><br>
                                        <small class="text-muted">A: 美容整形、健康体检、预防接种等非治疗性项目不在报销范围。</small>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Q: 异地医保如何结算？</strong><br>
                                        <small class="text-muted">A: 需提前在参保地办理异地就医备案手续，可直接结算。</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 其他问题 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                                    <i class="bi bi-gear me-2"></i> 其他常见问题
                                </button>
                            </h2>
                            <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <strong>Q: 医院有WiFi吗？</strong><br>
                                        <small class="text-muted">A: 有免费WiFi，网络名称"Hospital-Free"，关注医院微信公众号获取密码。</small>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Q: 停车如何收费？</strong><br>
                                        <small class="text-muted">A: 前2小时免费，之后每小时5元，24小时最高30元。</small>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Q: 可以带食物进入病房吗？</strong><br>
                                        <small class="text-muted">A: 普通病房可以，但ICU等特殊科室有严格限制，请遵守科室规定。</small>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Q: 如何投诉或建议？</strong><br>
                                        <small class="text-muted">A: 可到服务台现场反映，拨打投诉热线8002，或通过官网在线反馈。</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        function collectFeedback() {
            showModal('意见建议收集', `
                <div class="p-4">
                    <div class="text-center mb-4">
                        <div class="function-icon icon-warning mx-auto mb-3">
                            <i class="bi bi-chat-left-text"></i>
                        </div>
                        <h5>意见建议收集</h5>
                        <p class="text-muted">收集病人和家属的宝贵意见，帮助我们改进服务质量</p>
                    </div>
                    
                    <form id="feedbackForm">
                        <div class="row g-3">
                            <!-- 联系人信息 -->
                            <div class="col-md-6">
                                <label for="contactName" class="form-label">
                                    <i class="bi bi-person"></i> 联系人姓名 <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="contactName" 
                                       placeholder="请输入您的姓名" maxlength="50" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="contactPhone" class="form-label">
                                    <i class="bi bi-telephone"></i> 联系电话
                                </label>
                                <input type="tel" class="form-control" id="contactPhone" 
                                       placeholder="请输入您的电话" maxlength="20">
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label for="contactEmail" class="form-label">
                                    <i class="bi bi-envelope"></i> 邮箱地址
                                </label>
                                <input type="email" class="form-control" id="contactEmail" 
                                       placeholder="请输入您的邮箱（选填）" maxlength="100">
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- 反馈类型 -->
                            <div class="col-12">
                                <label for="feedbackType" class="form-label">
                                    <i class="bi bi-tags"></i> 反馈类型 <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="feedbackType" required>
                                    <option value="">请选择反馈类型</option>
                                    <option value="投诉">投诉</option>
                                    <option value="建议">建议</option>
                                    <option value="表扬">表扬</option>
                                    <option value="咨询">咨询</option>
                                    <option value="其他">其他</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- 反馈内容 -->
                            <div class="col-12">
                                <label for="feedbackContent" class="form-label">
                                    <i class="bi bi-chat-square-text"></i> 详细内容 <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="feedbackContent" rows="6" 
                                          placeholder="请详细描述您的意见或建议，我们会认真对待每一条反馈..." 
                                          maxlength="2000" required></textarea>
                                <div class="form-text">
                                    <span id="contentLength">0</span>/2000 字符
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <!-- 温馨提示 -->
                        <div class="alert alert-info mt-3">
                            <h6><i class="bi bi-info-circle"></i> 温馨提示</h6>
                            <ul class="mb-0 small">
                                <li>您的反馈对我们非常重要，我们会认真处理每一条意见</li>
                                <li>如需回复，请务必留下准确的联系方式</li>
                                <li>我们承诺在3个工作日内给予回复</li>
                                <li>您的个人信息将严格保密</li>
                            </ul>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-primary btn-lg me-2" onclick="submitFeedback()">
                                <i class="bi bi-send"></i> 提交反馈
                            </button>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle"></i> 取消
                            </button>
                        </div>
                    </form>
                </div>
            `);
            
            // 添加字符计数功能
            document.getElementById('feedbackContent').addEventListener('input', function() {
                const length = this.value.length;
                document.getElementById('contentLength').textContent = length;
                
                if (length > 1800) {
                    document.getElementById('contentLength').style.color = '#dc3545';
                } else if (length > 1500) {
                    document.getElementById('contentLength').style.color = '#fd7e14';
                } else {
                    document.getElementById('contentLength').style.color = '#6c757d';
                }
            });
        }
        
        // 提交反馈 - 永久存储到数据库
        async function submitFeedback() {
            try {
                // 清除之前的错误提示
                clearFeedbackFormErrors();
                
                // 获取表单数据
                const contactName = document.getElementById('contactName').value.trim();
                const contactPhone = document.getElementById('contactPhone').value.trim();
                const contactEmail = document.getElementById('contactEmail').value.trim();
                const feedbackType = document.getElementById('feedbackType').value;
                const content = document.getElementById('feedbackContent').value.trim();
                
                // 验证必填字段
                let hasError = false;
                
                if (!contactName) {
                    showFeedbackFieldError('contactName', '请输入联系人姓名');
                    hasError = true;
                }
                
                if (!feedbackType) {
                    showFeedbackFieldError('feedbackType', '请选择反馈类型');
                    hasError = true;
                }
                
                if (!content) {
                    showFeedbackFieldError('feedbackContent', '请输入反馈内容');
                    hasError = true;
                } else if (content.length < 10) {
                    showFeedbackFieldError('feedbackContent', '反馈内容至少需要10个字符');
                    hasError = true;
                }
                
                // 验证邮箱格式（如果填写了）
                if (contactEmail && !isValidEmail(contactEmail)) {
                    showFeedbackFieldError('contactEmail', '请输入有效的邮箱地址');
                    hasError = true;
                }
                
                if (hasError) {
                    return;
                }
                
                // 构建反馈数据
                const feedbackData = {
                    contactName: contactName,
                    contactPhone: contactPhone || null,
                    contactEmail: contactEmail || null,
                    feedbackType: feedbackType,
                    content: content
                };
                
                // 发送到后端API进行永久存储
                const token = localStorage.getItem('token');
                const response = await fetch('/api/feedbacks', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(feedbackData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // 提交成功
                    showFeedbackSuccessModal(result.data);
                } else {
                    // 处理验证错误
                    if (result.data && typeof result.data === 'object') {
                        showFeedbackFormErrors(result.data);
                        showCustomAlert('输入信息有误，请查看标红的字段提示并修正', 'warning', '输入错误');
                    } else {
                        showCustomAlert('提交失败：' + (result.message || '未知错误'), 'error', '提交失败');
                    }
                }
                
            } catch (error) {
                console.error('提交反馈失败:', error);
                showCustomAlert('提交失败，请稍后重试', 'error', '网络错误');
            }
        }
        
        // 显示反馈提交成功模态框
        function showFeedbackSuccessModal(feedback) {
            // 关闭当前模态框
            const currentModal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
            if (currentModal) {
                currentModal.hide();
            }
            
            // 显示成功消息
            setTimeout(() => {
                showModal('反馈提交成功', `
                    <div class="text-center p-4">
                        <div class="function-icon icon-success mx-auto mb-3">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <h5 class="text-success">反馈提交成功！</h5>
                        <p class="text-muted mt-3">感谢您的宝贵意见，我们已收到您的反馈</p>
                        
                        <div class="card bg-light mt-4">
                            <div class="card-body">
                                <div class="row text-start">
                                    <div class="col-4"><strong>反馈编号:</strong></div>
                                    <div class="col-8">#${feedback.id}</div>
                                    
                                    <div class="col-4"><strong>提交时间:</strong></div>
                                    <div class="col-8">${new Date(feedback.createdAt).toLocaleString('zh-CN')}</div>
                                    
                                    <div class="col-4"><strong>反馈类型:</strong></div>
                                    <div class="col-8">
                                        <span class="badge ${getFeedbackTypeBadgeClass(feedback.feedbackType)}">${feedback.feedbackType}</span>
                                    </div>
                                    
                                    <div class="col-4"><strong>处理状态:</strong></div>
                                    <div class="col-8">
                                        <span class="badge bg-warning">待处理</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-success mt-3">
                            <small>
                                <i class="bi bi-clock"></i> 
                                我们将在<strong>3个工作日内</strong>处理您的反馈并给予回复
                            </small>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-primary" data-bs-dismiss="modal">
                                <i class="bi bi-check"></i> 确定
                            </button>
                        </div>
                    </div>
                `);
            }, 300);
        }
        
        // 获取反馈类型对应的徽章样式
        function getFeedbackTypeBadgeClass(type) {
            const typeMap = {
                '投诉': 'bg-danger',
                '建议': 'bg-primary', 
                '表扬': 'bg-success',
                '咨询': 'bg-info',
                '其他': 'bg-secondary'
            };
            return typeMap[type] || 'bg-secondary';
        }
        
        // 清除反馈表单错误提示
        function clearFeedbackFormErrors() {
            const fields = ['contactName', 'contactPhone', 'contactEmail', 'feedbackType', 'feedbackContent'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('is-invalid');
                    const feedback = field.parentNode.querySelector('.invalid-feedback');
                    if (feedback) {
                        feedback.textContent = '';
                    }
                }
            });
        }
        
        // 显示反馈表单字段错误
        function showFeedbackFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.add('is-invalid');
                const feedback = field.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.textContent = message;
                }
                field.focus();
            }
        }
        
        // 显示反馈表单验证错误
        function showFeedbackFormErrors(fieldErrors) {
            const fieldMap = {
                'contactName': 'contactName',
                'contactPhone': 'contactPhone',
                'contactEmail': 'contactEmail',
                'feedbackType': 'feedbackType',
                'content': 'feedbackContent'
            };
            
            for (const [fieldName, errorMessage] of Object.entries(fieldErrors)) {
                const fieldId = fieldMap[fieldName];
                if (fieldId) {
                    showFeedbackFieldError(fieldId, errorMessage);
                }
            }
        }
        
        // 验证邮箱格式
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function loadPendingPayments() {
            showModal('代收费处理中心', `
                <div class="p-4">
                    <!-- 功能选择标签页 -->
                    <ul class="nav nav-pills mb-4 justify-content-center" id="paymentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active rounded-pill px-4 me-2" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-payments" type="button" role="tab">
                                <i class="bi bi-clock-history me-2"></i>待收费列表
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-pill px-4 me-2" id="search-tab" data-bs-toggle="tab" data-bs-target="#payment-search" type="button" role="tab">
                                <i class="bi bi-search me-2"></i>收费查询
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-pill px-4" id="stats-tab" data-bs-toggle="tab" data-bs-target="#payment-stats" type="button" role="tab">
                                <i class="bi bi-bar-chart me-2"></i>收费统计
                            </button>
                        </li>
                    </ul>

                    <!-- 标签页内容 -->
                    <div class="tab-content" id="paymentTabContent">
                        <!-- 待收费列表 -->
                        <div class="tab-pane fade show active" id="pending-payments" role="tabpanel">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="bi bi-list-check me-2"></i>待收费项目
                                    </h5>
                                    <button class="btn btn-light btn-sm" onclick="refreshPendingPayments()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>刷新
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div id="pendingPaymentsList">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                            <p class="text-muted">正在加载待收费数据...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 收费查询 -->
                        <div class="tab-pane fade" id="payment-search" role="tabpanel">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-gradient-info text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-search me-2"></i>收费查询
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="searchPatientName" class="form-label">
                                                <i class="bi bi-person me-1"></i>病人姓名
                                            </label>
                                            <input type="text" class="form-control" id="searchPatientName" placeholder="输入病人姓名">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="searchPaymentType" class="form-label">
                                                <i class="bi bi-tags me-1"></i>收费类型
                                            </label>
                                            <select class="form-select" id="searchPaymentType">
                                                <option value="">全部类型</option>
                                                <option value="REGISTRATION">挂号费</option>
                                                <option value="MEDICINE">药费</option>
                                                <option value="EXAMINATION">检查费</option>
                                                <option value="TREATMENT">治疗费</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="searchPaymentStatus" class="form-label">
                                                <i class="bi bi-check-circle me-1"></i>支付状态
                                            </label>
                                            <select class="form-select" id="searchPaymentStatus">
                                                <option value="">全部状态</option>
                                                <option value="PENDING">待支付</option>
                                                <option value="PAID">已支付</option>
                                                <option value="REFUNDED">已退费</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="searchDate" class="form-label">
                                                <i class="bi bi-calendar me-1"></i>创建日期
                                            </label>
                                            <input type="date" class="form-control" id="searchDate">
                                        </div>
                                        <div class="col-12">
                                            <button class="btn btn-primary me-2" onclick="searchPayments()">
                                                <i class="bi bi-search me-1"></i>查询
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="clearPaymentSearch()">
                                                <i class="bi bi-x-circle me-1"></i>清空
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <div id="paymentSearchResults">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body text-center py-5">
                                            <i class="bi bi-search display-1 text-muted mb-3"></i>
                                            <p class="text-muted">请输入查询条件并点击查询按钮</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 收费统计 -->
                        <div class="tab-pane fade" id="payment-stats" role="tabpanel">
                            <!-- 统计卡片 -->
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm h-100 card-hover">
                                        <div class="card-body text-center p-4">
                                            <div class="icon-circle bg-warning bg-opacity-10 mx-auto mb-3">
                                                <i class="bi bi-clock-history display-6 text-warning"></i>
                                            </div>
                                            <h6 class="card-title text-muted mb-1">待收费</h6>
                                            <h2 class="text-warning mb-0" id="pendingCount">
                                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                            </h2>
                                            <small class="text-muted">笔</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm h-100 card-hover">
                                        <div class="card-body text-center p-4">
                                            <div class="icon-circle bg-success bg-opacity-10 mx-auto mb-3">
                                                <i class="bi bi-check-circle display-6 text-success"></i>
                                            </div>
                                            <h6 class="card-title text-muted mb-1">今日收费</h6>
                                            <h2 class="text-success mb-0" id="todayPaidCount">
                                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                            </h2>
                                            <small class="text-muted">笔</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 今日收费明细 -->
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-gradient-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-list-ul me-2"></i>今日收费明细
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div id="todayPaymentDetails">
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                            <p class="text-muted">正在加载明细数据...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 自定义样式 -->
                <style>
                    .bg-gradient-primary {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    }
                    .bg-gradient-info {
                        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
                    }
                    .bg-gradient-secondary {
                        background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
                    }
                    .card-hover {
                        transition: all 0.3s ease;
                    }
                    .card-hover:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
                    }
                    .icon-circle {
                        width: 80px;
                        height: 80px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .avatar-circle {
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.2rem;
                    }
                    .nav-pills .nav-link {
                        background: transparent;
                        border: 2px solid #e9ecef;
                        color: #6c757d;
                        transition: all 0.3s ease;
                        font-weight: 500;
                    }
                    .nav-pills .nav-link:hover {
                        background: #f8f9fa;
                        border-color: #dee2e6;
                        transform: translateY(-2px);
                    }
                    .nav-pills .nav-link.active {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-color: transparent;
                        color: white;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    }
                    .payment-item {
                        border-left: 4px solid #667eea;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    }
                    .payment-item:hover {
                        background-color: #f8f9fa;
                        border-left-color: #764ba2;
                        transform: translateX(5px);
                    }
                    .payment-item::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(45deg, transparent 0%, rgba(102, 126, 234, 0.05) 50%, transparent 100%);
                        transform: translateX(-100%);
                        transition: transform 0.6s ease;
                    }
                    .payment-item:hover::before {
                        transform: translateX(100%);
                    }
                    @keyframes fadeInUp {
                        from {
                            opacity: 0;
                            transform: translateY(30px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    @keyframes pulse {
                        0% {
                            transform: scale(1);
                        }
                        50% {
                            transform: scale(1.05);
                        }
                        100% {
                            transform: scale(1);
                        }
                    }
                    .btn-success:hover {
                        animation: pulse 0.3s ease;
                    }
                    .card {
                        border-radius: 15px;
                        overflow: hidden;
                    }
                    .card-header {
                        border-bottom: none;
                        font-weight: 600;
                    }
                    .form-control:focus, .form-select:focus {
                        border-color: #667eea;
                        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
                    }
                    .btn-primary {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        transition: all 0.3s ease;
                    }
                    .btn-primary:hover {
                        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
                        transform: translateY(-2px);
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    }
                    .table-responsive {
                        border-radius: 10px;
                        overflow: hidden;
                    }
                    .table thead th {
                        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                        border: none;
                        font-weight: 600;
                        color: #495057;
                    }
                    .badge {
                        font-size: 0.75rem;
                        font-weight: 500;
                    }
                    .spinner-border-sm {
                        width: 1rem;
                        height: 1rem;
                    }
                </style>
            `);
            
            // 加载待收费数据
            loadPendingPaymentsList();
            loadPaymentStatistics();
        }

        // 加载待收费列表
        async function loadPendingPaymentsList() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showCustomAlert('请先登录', 'warning', '认证失败');
                    return;
                }

                const response = await fetch('/api/payments?status=PENDING&size=20', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayPendingPayments(result.data.content || []);
                } else {
                    document.getElementById('pendingPaymentsList').innerHTML = `
                        <div class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                            <p>加载失败: ${result.message || '未知错误'}</p>
                            <button class="btn btn-outline-primary" onclick="loadPendingPaymentsList()">重试</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载待收费列表失败:', error);
                document.getElementById('pendingPaymentsList').innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="bi bi-wifi-off fs-1 mb-3"></i>
                        <p>网络错误，请稍后重试</p>
                        <button class="btn btn-outline-primary" onclick="loadPendingPaymentsList()">重试</button>
                    </div>
                `;
            }
        }

        // 显示待收费列表
        function displayPendingPayments(payments) {
            const container = document.getElementById('pendingPaymentsList');
            
            if (!payments || payments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <div class="icon-circle bg-success bg-opacity-10 mx-auto mb-3">
                            <i class="bi bi-check-circle display-6 text-success"></i>
                        </div>
                        <h5 class="text-muted">暂无待收费项目</h5>
                        <p class="text-muted mb-0">所有收费都已处理完成</p>
                    </div>
                `;
                return;
            }

            let html = '';
            
            payments.forEach((payment, index) => {
                const patientName = payment.patient?.name || '未知病人';
                const paymentTypeText = getPaymentTypeText(payment.paymentType);
                const statusBadge = getPaymentStatusBadge(payment.status);
                const createdAt = new Date(payment.createdAt).toLocaleString('zh-CN');
                
                html += `
                    <div class="payment-item p-3 border-bottom" style="animation: fadeInUp 0.3s ease ${index * 0.1}s both;">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle bg-primary bg-opacity-10 me-3">
                                        <i class="bi bi-person text-primary"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1 fw-bold">${patientName}</h6>
                                        <small class="text-muted">ID: ${payment.patient?.id || '-'}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <span class="badge bg-info bg-opacity-75 px-3 py-2">${paymentTypeText}</span>
                            </div>
                            <div class="col-md-2">
                                <h5 class="text-primary mb-0 fw-bold">¥${payment.amount}</h5>
                                <small class="text-muted">金额</small>
                            </div>
                            <div class="col-md-2">
                                ${statusBadge}
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted d-block">${createdAt}</small>
                            </div>
                            <div class="col-md-1">
                                <div class="btn-group-vertical btn-group-sm">
                                    <button class="btn btn-success btn-sm mb-1" onclick="processPayment(${payment.id})" title="立即收费">
                                        <i class="bi bi-credit-card"></i>
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="viewPaymentDetails(${payment.id})" title="查看详情">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${payment.description ? `
                            <div class="row mt-2">
                                <div class="col-12">
                                    <div class="alert alert-light py-2 mb-0">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            ${payment.description}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 处理收费
        async function processPayment(paymentId) {
            const confirmed = await showCustomConfirm(
                '确认要处理这笔收费吗？\n\n处理后将标记为已支付状态。',
                '确认收费'
            );
            
            if (!confirmed) return;

            try {
                const token = localStorage.getItem('token');
                const transactionId = 'TXN' + Date.now(); // 生成简单的交易ID
                
                const response = await fetch(`/api/payments/${paymentId}/pay?transactionId=${transactionId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showCustomAlert('收费处理成功！\n\n交易ID: ' + transactionId, 'success', '收费成功');
                    // 刷新列表
                    refreshPendingPayments();
                    loadPaymentStatistics();
                } else {
                    showCustomAlert('收费处理失败:\n' + (result.message || '未知错误'), 'error', '处理失败');
                }
            } catch (error) {
                console.error('处理收费失败:', error);
                showCustomAlert('收费处理失败，请检查网络连接', 'error', '网络错误');
            }
        }

        // 查看收费详情
        async function viewPaymentDetails(paymentId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments/${paymentId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showPaymentDetailsModal(result.data);
                } else {
                    showCustomAlert('获取收费详情失败:\n' + (result.message || '未知错误'), 'error', '加载失败');
                }
            } catch (error) {
                console.error('获取收费详情失败:', error);
                showCustomAlert('获取收费详情失败，请检查网络连接', 'error', '网络错误');
            }
        }

        // 显示收费详情模态框
        function showPaymentDetailsModal(payment) {
            const patientName = payment.patient?.name || '未知病人';
            const paymentTypeText = getPaymentTypeText(payment.paymentType);
            const statusBadge = getPaymentStatusBadge(payment.status);
            const createdAt = new Date(payment.createdAt).toLocaleString('zh-CN');
            const paidAt = payment.paidAt ? new Date(payment.paidAt).toLocaleString('zh-CN') : '-';
            
            showModal('收费详情', `
                <div class="p-3">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>基本信息</h6>
                            <table class="table table-sm">
                                <tr><td>收费单号:</td><td><strong>${payment.id}</strong></td></tr>
                                <tr><td>病人姓名:</td><td>${patientName}</td></tr>
                                <tr><td>收费类型:</td><td><span class="badge bg-info">${paymentTypeText}</span></td></tr>
                                <tr><td>金额:</td><td><strong class="text-primary">¥${payment.amount}</strong></td></tr>
                                <tr><td>数量:</td><td>${payment.quantity}</td></tr>
                                <tr><td>支付方式:</td><td>${payment.paymentMethod || '-'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>状态信息</h6>
                            <table class="table table-sm">
                                <tr><td>当前状态:</td><td>${statusBadge}</td></tr>
                                <tr><td>创建时间:</td><td>${createdAt}</td></tr>
                                <tr><td>支付时间:</td><td>${paidAt}</td></tr>
                                <tr><td>交易ID:</td><td>${payment.transactionId || '-'}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    ${payment.description ? `
                        <div class="mt-3">
                            <h6>描述信息</h6>
                            <p class="text-muted">${payment.description}</p>
                        </div>
                    ` : ''}
                    
                    ${payment.notes ? `
                        <div class="mt-3">
                            <h6>备注</h6>
                            <p class="text-muted">${payment.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="mt-4 text-center">
                        ${payment.status === 'PENDING' ? `
                            <button class="btn btn-success me-2" onclick="processPayment(${payment.id})">
                                <i class="bi bi-credit-card"></i> 立即收费
                            </button>
                        ` : ''}
                        ${payment.status === 'PAID' ? `
                            <button class="btn btn-warning me-2" onclick="processRefund(${payment.id})">
                                <i class="bi bi-arrow-return-left"></i> 申请退费
                            </button>
                        ` : ''}
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> 关闭
                        </button>
                    </div>
                </div>
            `);
        }

        // 处理退费
        async function processRefund(paymentId) {
            const confirmed = await showCustomConfirm(
                '确认要申请退费吗？\n\n退费后将无法撤销。',
                '确认退费'
            );
            
            if (!confirmed) return;

            try {
                const token = localStorage.getItem('token');
                
                const response = await fetch(`/api/payments/${paymentId}/refund`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showCustomAlert('退费申请成功！', 'success', '退费成功');
                    // 关闭详情模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('universalModal'));
                    if (modal) modal.hide();
                    // 刷新数据
                    refreshPendingPayments();
                    loadPaymentStatistics();
                } else {
                    showCustomAlert('退费申请失败:\n' + (result.message || '未知错误'), 'error', '退费失败');
                }
            } catch (error) {
                console.error('处理退费失败:', error);
                showCustomAlert('退费申请失败，请检查网络连接', 'error', '网络错误');
            }
        }

        // 刷新待收费列表
        function refreshPendingPayments() {
            loadPendingPaymentsList();
        }

        // 获取支付类型文本
        function getPaymentTypeText(type) {
            const types = {
                'REGISTRATION': '挂号费',
                'MEDICINE': '药费',
                'EXAMINATION': '检查费',
                'TREATMENT': '治疗费'
            };
            return types[type] || type;
        }

        // 获取支付状态徽章
        function getPaymentStatusBadge(status) {
            const badges = {
                'PENDING': '<span class="badge bg-warning">待支付</span>',
                'PAID': '<span class="badge bg-success">已支付</span>',
                'REFUNDED': '<span class="badge bg-secondary">已退费</span>'
            };
            return badges[status] || `<span class="badge bg-light text-dark">${status}</span>`;
        }

        // 加载收费统计
        async function loadPaymentStatistics() {
            try {
                const token = localStorage.getItem('token');
                
                // 加载今日统计
                const statsResponse = await fetch('/api/payments/statistics/today', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (statsResponse.ok) {
                    const statsResult = await statsResponse.json();
                    if (statsResult.success) {
                        updatePaymentStatistics(statsResult.data);
                    }
                }

                // 加载待收费数量
                const pendingResponse = await fetch('/api/payments?status=PENDING&size=1', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (pendingResponse.ok) {
                    const pendingResult = await pendingResponse.json();
                    if (pendingResult.success) {
                        document.getElementById('pendingCount').textContent = pendingResult.data.totalElements || 0;
                    }
                }

            } catch (error) {
                console.error('加载收费统计失败:', error);
            }
        }

        // 更新收费统计显示
        function updatePaymentStatistics(stats) {
            console.log('收到统计数据:', stats);
            
            // stats 是数组格式: [status, count, total_amount]
            let todayPaidCount = 0;
            
            if (Array.isArray(stats) && stats.length > 0) {
                stats.forEach(stat => {
                    console.log('处理统计项:', stat);
                    if (stat && stat.length >= 3 && stat[0] === 'PAID') {
                        todayPaidCount = stat[1] || 0;
                        console.log('找到PAID状态数据:', { count: todayPaidCount });
                    }
                });
            } else {
                console.log('统计数据为空或格式不正确');
            }
            
            // 更新显示
            const paidCountElement = document.getElementById('todayPaidCount');
            
            if (paidCountElement) {
                paidCountElement.textContent = todayPaidCount;
            }
            
            console.log('统计数据更新完成:', { todayPaidCount });
            
            // 加载今日收费明细
            loadTodayPaymentDetails();
        }

        // 加载今日收费明细
        async function loadTodayPaymentDetails() {
            try {
                const token = localStorage.getItem('token');
                const today = new Date().toISOString().split('T')[0];
                
                const response = await fetch(`/api/payments?status=PAID&size=10&sortBy=paidAt&sortDir=desc`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayTodayPaymentDetails(result.data.content || []);
                }
            } catch (error) {
                console.error('加载今日收费明细失败:', error);
                document.getElementById('todayPaymentDetails').innerHTML = `
                    <div class="text-center text-muted py-3">
                        <p>加载失败</p>
                    </div>
                `;
            }
        }

        // 显示今日收费明细
        function displayTodayPaymentDetails(payments) {
            const container = document.getElementById('todayPaymentDetails');
            
            if (!payments || payments.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <p>今日暂无收费记录</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr>';
            html += '<th>时间</th><th>病人</th><th>类型</th><th>金额</th><th>方式</th></tr></thead><tbody>';
            
            payments.forEach(payment => {
                const paidAt = payment.paidAt ? new Date(payment.paidAt).toLocaleTimeString('zh-CN') : '-';
                const patientName = payment.patient?.name || '未知';
                const paymentTypeText = getPaymentTypeText(payment.paymentType);
                
                html += `
                    <tr>
                        <td>${paidAt}</td>
                        <td>${patientName}</td>
                        <td><span class="badge bg-info bg-opacity-75">${paymentTypeText}</span></td>
                        <td><strong>¥${payment.amount}</strong></td>
                        <td>${payment.paymentMethod || '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // 搜索收费记录
        async function searchPayments() {
            const patientName = document.getElementById('searchPatientName').value.trim();
            const paymentType = document.getElementById('searchPaymentType').value;
            const paymentStatus = document.getElementById('searchPaymentStatus').value;
            const searchDate = document.getElementById('searchDate').value;
            
            // 构建查询参数
            const params = new URLSearchParams();
            params.append('size', '20');
            
            if (paymentType) params.append('paymentType', paymentType);
            if (paymentStatus) params.append('status', paymentStatus);
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payments?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    let filteredPayments = result.data.content || [];
                    
                    // 前端过滤病人姓名和日期（如果后端不支持）
                    if (patientName) {
                        filteredPayments = filteredPayments.filter(payment => 
                            payment.patient?.name?.includes(patientName)
                        );
                    }
                    
                    if (searchDate) {
                        filteredPayments = filteredPayments.filter(payment => 
                            payment.createdAt.startsWith(searchDate)
                        );
                    }
                    
                    displaySearchResults(filteredPayments);
                } else {
                    showCustomAlert('查询失败:\n' + (result.message || '未知错误'), 'error', '查询失败');
                }
            } catch (error) {
                console.error('搜索收费记录失败:', error);
                showCustomAlert('搜索失败，请检查网络连接', 'error', '网络错误');
            }
        }

        // 显示搜索结果
        function displaySearchResults(payments) {
            const container = document.getElementById('paymentSearchResults');
            
            if (!payments || payments.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search fs-1 mb-3"></i>
                        <p>未找到符合条件的收费记录</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr>';
            html += '<th>单号</th><th>病人</th><th>类型</th><th>金额</th><th>状态</th><th>创建时间</th><th>操作</th></tr></thead><tbody>';
            
            payments.forEach(payment => {
                const patientName = payment.patient?.name || '未知病人';
                const paymentTypeText = getPaymentTypeText(payment.paymentType);
                const statusBadge = getPaymentStatusBadge(payment.status);
                const createdAt = new Date(payment.createdAt).toLocaleString('zh-CN');
                
                html += `
                    <tr>
                        <td><strong>${payment.id}</strong></td>
                        <td>${patientName}</td>
                        <td><span class="badge bg-info">${paymentTypeText}</span></td>
                        <td><strong class="text-primary">¥${payment.amount}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="viewPaymentDetails(${payment.id})" title="查看详情">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${payment.status === 'PENDING' ? `
                                <button class="btn btn-success btn-sm ms-1" onclick="processPayment(${payment.id})" title="收费">
                                    <i class="bi bi-credit-card"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // 清空搜索条件
        function clearPaymentSearch() {
            document.getElementById('searchPatientName').value = '';
            document.getElementById('searchPaymentType').value = '';
            document.getElementById('searchPaymentStatus').value = '';
            document.getElementById('searchDate').value = '';
            
            document.getElementById('paymentSearchResults').innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-search fs-1 mb-3"></i>
                    <p>请输入查询条件并点击查询按钮</p>
                </div>
            `;
        }

        // 显示模态框
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            
            // 确保先清除任何现有的模态框
            const existingModal = bootstrap.Modal.getInstance(document.getElementById('universalModal'));
            if (existingModal) {
                existingModal.dispose();
            }
            
            // 创建新的模态框实例
            const modal = new bootstrap.Modal(document.getElementById('universalModal'), {
                backdrop: true,
                keyboard: true,
                focus: true
            });
            
            // 监听模态框关闭事件，确保完全清理
            document.getElementById('universalModal').addEventListener('hidden.bs.modal', function () {
                // 移除所有可能残留的backdrop
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                
                // 恢复body的样式
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // 清理模态框内容
                document.getElementById('modalBody').innerHTML = '';
            }, { once: true });
            
            modal.show();
        }

        // 强制清理所有模态框残留
        function forceCleanupModals() {
            // 移除所有backdrop
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // 恢复body样式
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // 隐藏所有模态框
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
                modal.classList.remove('show');
                modal.setAttribute('aria-hidden', 'true');
                modal.removeAttribute('aria-modal');
                modal.removeAttribute('role');
            });
            
            console.log('已强制清理所有模态框残留');
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                // 清理可能的模态框残留
                forceCleanupModals();
                
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
            }
        }

        // ============ 通知系统相关功能 ============
        
        // 初始化通知系统
        function initializeNotificationSystem() {
            checkNotificationCount();
            // 每30秒检查一次通知
            setInterval(checkNotificationCount, 30000);
        }
        
        // 打开通知中心
        function openNotificationCenter() {
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
            modal.show();
            
            // 加载通知数据
            loadNotificationsModal();
        }
        
        // 检查未读通知数量
        async function checkNotificationCount() {
            try {
                if (window.notificationAPI) {
                    const response = await window.notificationAPI.getUnreadCount();
                    if (response.success) {
                        updateNotificationBadge(response.data);
                        return;
                    }
                }
                
                // 备用：使用模拟数据
                const unreadCount = Math.floor(Math.random() * 5) + 1; // 1-5个未读通知
                updateNotificationBadge(unreadCount);
            } catch (error) {
                console.error('检查通知失败:', error);
                updateNotificationBadge(0);
            }
        }
        
        // 更新通知徽章
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'block';
                    badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // ============ 通知模态框相关功能 ============
        
        let modalNotifications = [];
        let modalFilteredNotifications = [];
        
        // 加载通知数据到模态框
        async function loadNotificationsModal() {
            try {
                if (window.notificationAPI) {
                    const response = await window.notificationAPI.getNotifications();
                    if (response.success) {
                        modalNotifications = response.data;
                        modalFilteredNotifications = [...modalNotifications];
                        
                        renderNotificationsModal();
                        updateModalStatistics();
                        updateModalOnlineStatus('online');
                        return;
                    }
                }
                
                // 如果API调用失败，显示空列表而不是模拟数据
                modalNotifications = [];
                modalFilteredNotifications = [];
                renderNotificationsModal();
                updateModalStatistics();
                updateModalOnlineStatus('offline');
                
            } catch (error) {
                console.error('加载模态框通知失败:', error);
                updateModalOnlineStatus('offline');
                
                // 如果出错，显示空列表而不是模拟数据
                modalNotifications = [];
                modalFilteredNotifications = [];
                renderNotificationsModal();
                updateModalStatistics();
            }
        }
        
        // 生成模拟通知数据（用于模态框）
        function generateMockNotificationsForModal() {
            const modules = ['patient', 'doctor', 'registration', 'payment', 'medicine'];
            const operations = ['CREATE', 'UPDATE', 'DELETE'];
            const mockData = [];
            
            // 生成最近20条通知
            for (let i = 0; i < 20; i++) {
                const module = modules[Math.floor(Math.random() * modules.length)];
                const operation = operations[Math.floor(Math.random() * operations.length)];
                const timestamp = new Date(Date.now() - Math.random() * 3 * 24 * 60 * 60 * 1000); // 3天内
                
                mockData.push({
                    id: `modal_notification_${i + 1}`,
                    module: module,
                    operation: operation,
                    title: getNotificationTitleForModal(module, operation),
                    content: getNotificationContentForModal(module, operation),
                    timestamp: timestamp,
                    isRead: Math.random() > 0.4, // 40%的概率为未读
                    operatorName: '管理员' + (Math.floor(Math.random() * 3) + 1),
                    entityId: Math.floor(Math.random() * 1000) + 1,
                    entityName: getEntityNameForModal(module)
                });
            }
            
            return mockData.sort((a, b) => b.timestamp - a.timestamp);
        }
        
        // 获取通知标题（模态框用）
        function getNotificationTitleForModal(module, operation) {
            const titles = {
                patient: { CREATE: '新增病人信息', UPDATE: '更新病人信息', DELETE: '删除病人记录' },
                doctor: { CREATE: '新增医生信息', UPDATE: '更新医生信息', DELETE: '删除医生记录' },
                registration: { CREATE: '新建挂号记录', UPDATE: '更新挂号信息', DELETE: '取消挂号记录' },
                payment: { CREATE: '新增收费记录', UPDATE: '更新收费信息', DELETE: '删除收费记录' },
                medicine: { CREATE: '新增药品信息', UPDATE: '更新药品库存', DELETE: '删除药品记录' }
            };
            return titles[module][operation];
        }
        
        // 获取通知内容（模态框用）
        function getNotificationContentForModal(module, operation) {
            const contents = {
                patient: {
                    CREATE: '管理员新增了一位病人的基本信息，请及时关注相关就诊安排',
                    UPDATE: '病人信息已更新，请确认相关医疗记录的准确性',
                    DELETE: '病人记录已被删除，相关挂号和收费记录也已同步删除'
                },
                doctor: {
                    CREATE: '新医生信息已录入系统，请协助完善相关排班安排',
                    UPDATE: '医生信息已更新，请确认科室安排和专业信息',
                    DELETE: '医生记录已删除，相关挂号记录已同步处理'
                },
                registration: {
                    CREATE: '新挂号记录已生成，请协助病人完成后续就诊流程',
                    UPDATE: '挂号信息已更新，请关注预约时间和科室变更',
                    DELETE: '挂号记录已取消，如有相关收费请及时处理退费'
                },
                payment: {
                    CREATE: '新收费记录已创建，请确认收费项目和金额准确性',
                    UPDATE: '收费信息已更新，请核对相关收费详情',
                    DELETE: '收费记录已删除，如需退费请按相关流程处理'
                },
                medicine: {
                    CREATE: '新药品已入库，请及时更新药房库存信息',
                    UPDATE: '药品信息已更新，请关注库存变动和价格调整',
                    DELETE: '药品记录已删除，请确认相关处方和库存状态'
                }
            };
            return contents[module][operation];
        }
        
        // 获取实体名称（模态框用）
        function getEntityNameForModal(module) {
            const names = {
                patient: ['张三', '李四', '王五', '赵六', '孙七'],
                doctor: ['陈医生', '刘医生', '周医生', '吴医生', '郑医生'],
                registration: ['门诊挂号', '专家号', '急诊挂号', '体检预约', '复诊预约'],
                payment: ['挂号费', '检查费', '药费', '治疗费', '床位费'],
                medicine: ['阿莫西林', '头孢克肟', '布洛芬', '阿司匹林', '维生素C']
            };
            const nameList = names[module];
            return nameList[Math.floor(Math.random() * nameList.length)];
        }
        
        // 渲染模态框通知列表
        function renderNotificationsModal() {
            const listContainer = document.getElementById('modalNotificationList');
            const noNotifications = document.getElementById('modalNoNotifications');
            
            if (modalFilteredNotifications.length === 0) {
                listContainer.innerHTML = '';
                listContainer.appendChild(noNotifications);
                return;
            }
            
            listContainer.innerHTML = '';
            
            modalFilteredNotifications.forEach(notification => {
                const notificationElement = createModalNotificationElement(notification);
                listContainer.appendChild(notificationElement);
            });
        }
        
        // 创建模态框通知元素
        function createModalNotificationElement(notification) {
            const div = document.createElement('div');
            div.className = `list-group-item list-group-item-action p-3 mb-2 border rounded ${notification.isRead ? '' : 'border-primary border-2'}`;
            div.style.position = 'relative';
            div.style.backgroundColor = notification.isRead ? '#fff' : '#f8f9fa';
            
            const moduleIcon = getModuleIconForModal(notification.module);
            const operationColor = getOperationColorForModal(notification.operation);
            const timeAgo = getTimeAgoForModal(notification.timestamp);
            
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi ${moduleIcon} me-2 text-${getModuleColorForModal(notification.module)}"></i>
                            <h6 class="mb-0 me-2">${notification.title}</h6>
                            <span class="badge bg-${operationColor} bg-opacity-75">${getOperationTextForModal(notification.operation)}</span>
                            ${!notification.isRead ? '<span class="badge bg-danger ms-2">新</span>' : ''}
                        </div>
                        <p class="mb-2 text-muted small">${notification.content}</p>
                        <div class="d-flex align-items-center text-muted small">
                            <i class="bi bi-person me-1"></i>
                            <span class="me-3">${notification.operatorName}</span>
                            <i class="bi bi-clock me-1"></i>
                            <span class="me-3">${timeAgo}</span>
                            <i class="bi bi-tag me-1"></i>
                            <span>${notification.entityName}</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="markAsReadModal('${notification.id}')">
                                    <i class="bi bi-check me-2"></i>标记为已读
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="deleteNotificationModal('${notification.id}')">
                                    <i class="bi bi-trash me-2"></i>删除通知
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            // 点击通知标记为已读
            div.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    markAsReadModal(notification.id);
                }
            });
            
            return div;
        }
        
        // 获取模块图标（模态框用）
        function getModuleIconForModal(module) {
            const icons = {
                patient: 'bi-person-heart',
                doctor: 'bi-person-badge',
                registration: 'bi-calendar-plus',
                payment: 'bi-receipt',
                medicine: 'bi-capsule'
            };
            return icons[module] || 'bi-info-circle';
        }
        
        // 获取模块颜色（模态框用）
        function getModuleColorForModal(module) {
            const colors = {
                patient: 'purple',
                doctor: 'primary',
                registration: 'success',
                payment: 'warning',
                medicine: 'info'
            };
            return colors[module] || 'secondary';
        }
        
        // 获取操作颜色（模态框用）
        function getOperationColorForModal(operation) {
            const colors = {
                CREATE: 'success',
                UPDATE: 'primary',
                DELETE: 'danger'
            };
            return colors[operation] || 'secondary';
        }
        
        // 获取操作文本（模态框用）
        function getOperationTextForModal(operation) {
            const texts = {
                CREATE: '新增',
                UPDATE: '修改',
                DELETE: '删除'
            };
            return texts[operation] || operation;
        }
        
        // 获取时间差（模态框用）
        function getTimeAgoForModal(timestamp) {
            const now = new Date();
            // 确保timestamp是Date对象
            const notificationTime = typeof timestamp === 'number' ? new Date(timestamp) : new Date(timestamp);
            const diff = now - notificationTime;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return '刚刚';
            if (minutes < 60) return `${minutes}分钟前`;
            if (hours < 24) return `${hours}小时前`;
            if (days < 7) return `${days}天前`;
            return notificationTime.toLocaleDateString('zh-CN');
        }
        
        // 更新模态框统计数据
        function updateModalStatistics() {
            const total = modalNotifications.length;
            const unread = modalNotifications.filter(n => !n.isRead).length;
            const today = modalNotifications.filter(n => {
                const today = new Date();
                const notificationDate = new Date(n.timestamp);
                return notificationDate.toDateString() === today.toDateString();
            }).length;
            const thisWeek = modalNotifications.filter(n => {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                // 确保时间戳比较的一致性
                const notificationTime = typeof n.timestamp === 'number' ? n.timestamp : new Date(n.timestamp).getTime();
                return notificationTime >= weekAgo.getTime();
            }).length;
            
            document.getElementById('modalTotalNotifications').textContent = total;
            document.getElementById('modalUnreadNotifications').textContent = unread;
            document.getElementById('modalTodayNotifications').textContent = today;
            document.getElementById('modalWeeklyNotifications').textContent = thisWeek;
        }
        
        // 过滤模态框通知
        function filterNotificationsModal() {
            const moduleFilter = document.getElementById('modalModuleFilter').value;
            const statusFilter = document.getElementById('modalStatusFilter').value;
            
            modalFilteredNotifications = modalNotifications.filter(notification => {
                const moduleMatch = moduleFilter === 'all' || notification.module === moduleFilter;
                const statusMatch = statusFilter === 'all' || 
                    (statusFilter === 'read' && notification.isRead) ||
                    (statusFilter === 'unread' && !notification.isRead);
                
                return moduleMatch && statusMatch;
            });
            
            renderNotificationsModal();
        }
        
        // 标记为已读（模态框）
        async function markAsReadModal(notificationId) {
            try {
                if (window.notificationAPI) {
                    await window.notificationAPI.markAsRead(notificationId);
                }
                
                const notification = modalNotifications.find(n => n.id === notificationId);
                if (notification && !notification.isRead) {
                    notification.isRead = true;
                    updateModalStatistics();
                    renderNotificationsModal();
                    
                    // 同时更新主页面的通知徽章
                    checkNotificationCount();
                }
            } catch (error) {
                console.error('标记为已读失败:', error);
            }
        }
        
        // 全部标记为已读（模态框）
        async function markAllAsReadModal() {
            try {
                if (window.notificationAPI) {
                    await window.notificationAPI.markAllAsRead();
                }
                
                modalNotifications.forEach(n => n.isRead = true);
                updateModalStatistics();
                renderNotificationsModal();
                showCustomAlert('所有通知已标记为已读', 'success', '操作成功');
                
                // 同时更新主页面的通知徽章
                checkNotificationCount();
            } catch (error) {
                console.error('标记所有为已读失败:', error);
                showCustomAlert('操作失败', 'error', '错误');
            }
        }
        
        // 删除通知（模态框）
        async function deleteNotificationModal(notificationId) {
            if (confirm('确定要删除这条通知吗？')) {
                try {
                    if (window.notificationAPI) {
                        await window.notificationAPI.deleteNotification(notificationId);
                    }
                    
                    modalNotifications = modalNotifications.filter(n => n.id !== notificationId);
                    filterNotificationsModal();
                    updateModalStatistics();
                    showCustomAlert('通知已删除', 'success', '操作成功');
                    
                    // 同时更新主页面的通知徽章
                    checkNotificationCount();
                } catch (error) {
                    console.error('删除通知失败:', error);
                    showCustomAlert('删除失败', 'error', '错误');
                }
            }
        }
        
        // 清空所有通知（模态框）
        async function clearAllNotificationsModal() {
            if (confirm('确定要清空所有通知吗？此操作不可撤销。')) {
                try {
                    if (window.notificationAPI) {
                        await window.notificationAPI.clearAllNotifications();
                    }
                    
                    modalNotifications = [];
                    modalFilteredNotifications = [];
                    renderNotificationsModal();
                    updateModalStatistics();
                    showCustomAlert('所有通知已清空', 'success', '操作成功');
                    
                    // 同时更新主页面的通知徽章
                    checkNotificationCount();
                } catch (error) {
                    console.error('清空通知失败:', error);
                    showCustomAlert('清空失败', 'error', '错误');
                }
            }
        }
        
        // 刷新模态框通知
        async function refreshNotificationsModal() {
            const refreshBtn = document.querySelector('[onclick="refreshNotificationsModal()"]');
            refreshBtn.classList.add('refreshing');
            
            try {
                await loadNotificationsModal();
                showCustomAlert('通知已刷新', 'success', '刷新成功');
            } catch (error) {
                showCustomAlert('刷新失败', 'error', '错误');
            } finally {
                refreshBtn.classList.remove('refreshing');
            }
        }
        
        // 更新模态框在线状态
        function updateModalOnlineStatus(status) {
            const statusElement = document.getElementById('modalOnlineStatus');
            if (statusElement) {
                if (status === 'online') {
                    statusElement.textContent = '在线';
                    statusElement.className = 'badge bg-success ms-2';
                } else {
                    statusElement.textContent = '离线';
                    statusElement.className = 'badge bg-danger ms-2';
                }
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAuth()) {
                // 页面加载时清理可能的残留
                forceCleanupModals();
                
                updateTime();
                setInterval(updateTime, 1000);
                loadTodayStats();
                
                // 初始化通知系统
                initializeNotificationSystem();
                
                // 绑定药品实时搜索
                _bindMedicineLiveSearch();
            }
            
            // 添加键盘快捷键：Ctrl+Shift+C 强制清理模态框
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    forceCleanupModals();
                    showCustomAlert('已强制清理模态框残留！', 'success', '清理完成');
                }
            });
            
            // 添加Escape键清理功能
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // 检查是否有模态框打开
                    const openModal = document.querySelector('.modal.show');
                    if (!openModal) {
                        // 如果没有模态框但页面仍然被遮罩，强制清理
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop || document.body.classList.contains('modal-open')) {
                            forceCleanupModals();
                        }
                    }
                }
            });
        });
    </script>

    <!-- 自定义美化弹出窗口 -->
    <div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="customAlertHeader">
                    <h5 class="modal-title" id="customAlertModalLabel">
                        <i class="bi bi-info-circle-fill" id="customAlertIcon"></i>
                        <span id="customAlertTitle">提示</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body" id="customAlertBody">
                    <div id="customAlertContent"></div>
                </div>
                <div class="modal-footer" id="customAlertFooter">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="customAlertOkBtn">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义确认对话框 -->
    <div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="customConfirmModalLabel">
                        <i class="bi bi-question-circle-fill"></i>
                        确认操作
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body" id="customConfirmBody">
                    <div id="customConfirmContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" id="customConfirmOkBtn">确定</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 自定义弹出窗口样式 */
        .custom-alert-success .modal-header {
            background-color: #d1edff;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .custom-alert-success .bi {
            color: #28a745;
        }
        
        .custom-alert-error .modal-header {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .custom-alert-error .bi {
            color: #dc3545;
        }
        
        .custom-alert-warning .modal-header {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .custom-alert-warning .bi {
            color: #ffc107;
        }
        
        .custom-alert-info .modal-header {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .custom-alert-info .bi {
            color: #17a2b8;
        }
        
        #customAlertContent {
            white-space: pre-line;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 16px;
        }
        
        #customConfirmContent {
            white-space: pre-line;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 16px;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* 通知模态框样式优化 */
        .notification-container {
            border-radius: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .notification-container .list-group-item {
            border: none;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
        }
        
        .notification-container .list-group-item:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .notification-container .list-group-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .notification-container .list-group-item:hover::before {
            opacity: 1;
        }
        
        .notification-container .border-primary {
            border-left: 4px solid #0d6efd !important;
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.05) 0%, rgba(255, 255, 255, 0.95) 100%);
        }
        
        .notification-container .border-primary::before {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            opacity: 1;
        }
        
        /* 通知统计卡片样式 */
        .notification-stats .card {
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .notification-stats .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .notification-stats .card-body {
            padding: 1.5rem;
        }
        
        .notification-stats .display-6 {
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* 模态框头部样式 */
        .modal-header.bg-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%) !important;
            border-bottom: 2px solid rgba(255, 193, 7, 0.3);
        }
        
        .modal-title {
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* 筛选器样式 */
        .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        /* 按钮样式优化 */
        .btn-outline-success:hover,
        .btn-outline-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* 刷新动画优化 */
        .refreshing {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { 
                transform: rotate(0deg);
            }
            to { 
                transform: rotate(360deg);
            }
        }
        
        /* 响应式优化 */
        @media (max-width: 768px) {
            .notification-container {
                margin: 0 -15px;
                border-radius: 0;
            }
            
            .notification-container .list-group-item {
                border-radius: 0;
                margin-bottom: 1px;
            }
        }
        
        /* 通知徽章样式 */
        .badge.bg-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }
        
        .badge.bg-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%) !important;
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .modal-xl {
                max-width: 95%;
            }
            
            .notification-container {
                max-height: 300px !important;
            }
            
            .row.g-3 .col-md-3 {
                margin-bottom: 0.5rem;
            }
        }
    </style>

    <script>
        // 自定义弹出窗口函数
        function showCustomAlert(message, type = 'info', title = '提示') {
            const modal = document.getElementById('customAlertModal');
            const header = document.getElementById('customAlertHeader');
            const icon = document.getElementById('customAlertIcon');
            const titleElement = document.getElementById('customAlertTitle');
            const content = document.getElementById('customAlertContent');
            const okBtn = document.getElementById('customAlertOkBtn');
            
            // 清除之前的样式类
            modal.className = 'modal fade';
            
            // 设置内容
            titleElement.textContent = title;
            content.textContent = message;
            
            // 根据类型设置样式和图标
            switch (type) {
                case 'success':
                    modal.classList.add('custom-alert-success');
                    icon.className = 'bi bi-check-circle-fill';
                    okBtn.className = 'btn btn-success';
                    break;
                case 'error':
                    modal.classList.add('custom-alert-error');
                    icon.className = 'bi bi-exclamation-triangle-fill';
                    okBtn.className = 'btn btn-danger';
                    break;
                case 'warning':
                    modal.classList.add('custom-alert-warning');
                    icon.className = 'bi bi-exclamation-triangle-fill';
                    okBtn.className = 'btn btn-warning';
                    break;
                case 'info':
                default:
                    modal.classList.add('custom-alert-info');
                    icon.className = 'bi bi-info-circle-fill';
                    okBtn.className = 'btn btn-primary';
                    break;
            }
            
            // 显示模态框
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }
        
        // 自定义确认对话框
        function showCustomConfirm(message, title = '确认操作') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const content = document.getElementById('customConfirmContent');
                const confirmBtn = document.getElementById('customConfirmOkBtn');
                
                // 设置内容
                content.textContent = message;
                
                // 清除之前的事件监听器
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                // 添加确定按钮事件监听器
                newConfirmBtn.addEventListener('click', function() {
                    const bootstrapModal = bootstrap.Modal.getInstance(modal);
                    bootstrapModal.hide();
                    resolve(true);
                });
                
                // 添加取消和关闭事件监听器
                const handleCancel = () => {
                    resolve(false);
                    modal.removeEventListener('hidden.bs.modal', handleCancel);
                };
                
                modal.addEventListener('hidden.bs.modal', handleCancel, { once: true });
                
                // 显示模态框
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
            });
        }
        
        // 重写原生alert函数
        window.originalAlert = window.alert;
        window.alert = function(message) {
            showCustomAlert(message, 'info');
        };
        
        // Toast 提示函数
        function showToast(msg, variant='dark'){
            const el = document.getElementById('globalToast');
            el.className = `toast text-white bg-${variant} border-0`;
            document.getElementById('globalToastBody').textContent = msg;
            new bootstrap.Toast(el, {delay:2200}).show();
        }

        // 键盘快捷键监听器
        document.addEventListener('keydown', (e)=>{
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            const k = e.key.toLowerCase();
            if(k==='r'){ openPatientReception(); showToast('打开：病人接待','primary'); }
            if(k==='p'){ openPendingPayments(); showToast('打开：待收费','success'); }
            if(k==='m'){ openMedicineQuery(); showToast('打开：药品咨询','danger'); }
            if(k==='n'){ openNotificationCenter(); showToast('打开：通知中心','warning'); }
        });

        // 防抖函数
        function debounce(fn, delay=300){
            let t; 
            return (...args)=>{ 
                clearTimeout(t); 
                t=setTimeout(()=>fn.apply(this,args), delay); 
            };
        }

        // 输入即搜：长度≥2才触发
        const _bindMedicineLiveSearch = ()=>{
            const el = document.getElementById('medicineSearchInput');
            if(!el) return;
            el.addEventListener('input', debounce(()=>{
                const kw = el.value.trim();
                if(kw.length>=2) searchMedicines();
            }, 300));
        };

        // ========== 新增的交互功能 ==========
        
        // 1) 按钮水波纹
        document.addEventListener('click', (e)=>{
            const btn = e.target.closest('.btn, .btn-modern');
            if(!btn) return;
            const r = btn.getBoundingClientRect();
            const s = document.createElement('span');
            s.className = 'ripple';
            s.style.left = (e.clientX - r.left) + 'px';
            s.style.top  = (e.clientY - r.top) + 'px';
            btn.appendChild(s);
            setTimeout(()=>s.remove(), 650);
        });

        // 2) KPI 数字滚动（与 setKpiWithDelta 共存）
        function animateNumber(el, to, isCurrency=false){
            const from = 0, dur = 600, start = performance.now();
            function step(now){
                const p = Math.min((now - start)/dur, 1);
                const val = Math.round(from + (to-from)*p);
                el.textContent = isCurrency ? ('¥' + (val.toFixed ? val.toFixed(2) : val).toString()) : String(val);
                if(p<1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        // 3) 图表初始化
        let chartLine, chartDonut;
        function initCharts(){
            const l = document.getElementById('chartLine');
            const d = document.getElementById('chartDonut');
            if(l){
                chartLine = new Chart(l, {
                    type:'line',
                    data:{ labels:['08:00','10:00','12:00','14:00','16:00','18:00'],
                        datasets:[
                            { 
                                label:'挂号数', 
                                data:[0,0,0,0,0,0], 
                                tension:.35, 
                                borderColor:'#8B5CF6', 
                                backgroundColor:'rgba(139,92,246,0.1)',
                                fill: true
                            },
                            { 
                                label:'收入(¥)', 
                                data:[0,0,0,0,0,0], 
                                tension:.35, 
                                yAxisID:'y1', 
                                borderColor:'#10B981', 
                                backgroundColor:'rgba(16,185,129,0.1)',
                                fill: true
                            }
                        ]
                    },
                    options:{ 
                        responsive:true, 
                        interaction:{mode:'index',intersect:false},
                        scales:{ 
                            y:{
                                beginAtZero:true,
                                title: {
                                    display: true,
                                    text: '挂号数'
                                }
                            }, 
                            y1:{
                                position:'right', 
                                grid:{drawOnChartArea:false},
                                beginAtZero:true,
                                title: {
                                    display: true,
                                    text: '收入(¥)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            }
            if(d){
                chartDonut = new Chart(d,{
                    type:'doughnut',
                    data:{ labels:['待收费','在院病人'],
                        datasets:[{ 
                            data:[0,0], 
                            backgroundColor:['#F87171','#8B5CF6'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options:{ 
                        cutout:'65%', 
                        plugins:{
                            legend:{
                                display:true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            // 初始化后立即加载数据
            loadTimeSeriesData();
        }

        // 4) 卡片3D倾斜效果
        function addTilt(el){
            const max = 6; // 最大倾斜角
            el.addEventListener('mousemove', (e)=>{
                const r = el.getBoundingClientRect();
                const x = (e.clientX - r.left)/r.width  * 2 - 1;
                const y = (e.clientY - r.top )/r.height * 2 - 1;
                el.style.transform = `translateY(-8px) rotateY(${x*max}deg) rotateX(${-y*max}deg)`;
            });
            el.addEventListener('mouseleave', ()=>{
                el.style.transform = ''; // 让原有 :hover 动画接管
            });
        }

        // 5) 进度环设置函数
        function setRingProgress(circleId, percent){
            const c = document.getElementById(circleId);
            if(!c) return;
            const L = 2 * Math.PI * 25;            // 与 CSS dasharray 保持一致
            c.style.strokeDasharray = L;
            c.style.strokeDashoffset = L * (1 - Math.max(0,Math.min(1,percent)));
        }
        
        // 6) 加载时间序列数据
        async function loadTimeSeriesData() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('未找到认证令牌，跳过时间序列数据加载');
                    return;
                }
                
                const response = await fetch('/api/dashboard/time-series', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && chartLine) {
                        const data = result.data;
                        
                        // 更新折线图数据
                        chartLine.data.labels = data.labels;
                        chartLine.data.datasets[0].data = data.registrationData;
                        chartLine.data.datasets[1].data = data.revenueData.map(val => parseFloat(val));
                        chartLine.update('active');
                        
                        console.log('时间序列数据加载成功:', data);
                    }
                } else {
                    console.error('加载时间序列数据失败:', response.status);
                }
            } catch (error) {
                console.error('加载时间序列数据时发生错误:', error);
            }
        }

        // 7) 定期数据刷新
        function startDataRefresh() {
            // 每5分钟刷新一次数据
            setInterval(() => {
                console.log('定期刷新数据...');
                loadStaffStats();
            }, 5 * 60 * 1000); // 5分钟
        }

        // 初始化所有功能
        document.addEventListener('DOMContentLoaded', ()=>{
            initCharts();
            document.querySelectorAll('.function-card, .stats-card').forEach(addTilt);
            startDataRefresh();
        });

        
    </script>

    <!-- Toast 容器 -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
        <div id="globalToast" class="toast align-items-center text-white bg-dark border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="globalToastBody">操作完成</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>
</body>
</html>
